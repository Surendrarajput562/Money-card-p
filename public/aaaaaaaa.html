<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Rupi - Premium Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* Base & Global Styles (Improved UI) */
body{font-family:'Poppins',sans-serif;margin:0;padding:0;background:linear-gradient(135deg,#ffd700,#f0e68c);color:#222;min-height:100vh;}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);box-shadow:0 2px 10px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100;}
header h1{margin:0;font-size:20px;font-weight:700;color:#111;}
/* Navigation */
nav{display:flex;flex-direction:column;width:120px;background:rgba(255,255,255,0.1);backdrop-filter:blur(15px);padding-top:10px;position:fixed;top:0;bottom:0;overflow-y:auto;border-right:1px solid rgba(255,255,255,0.3);}
nav button{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 0;border:none;background:none;color:#111;cursor:pointer;transition:background 0.3s, color 0.3s;}
nav button:hover{background:rgba(255,255,255,0.3);}
nav button img{width:28px;height:28px;margin-bottom:4px;filter:invert(0.1);opacity:0.85;}
nav button span{font-size:12px;font-weight:600;}
nav button.active{background:#ffd700;color:#000;box-shadow:0 0 15px rgba(255,215,0,0.5);border-radius:0;}

/* Main Content */
main{margin-left:130px;padding:20px;}
section{display:none;}
section.active{display:block;}
h2{color:#444;border-bottom:2px solid #ffda47;padding-bottom:5px;margin-top:0;}

/* Form Elements & Cards */
input,textarea,select{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:rgba(255,255,255,0.98);box-sizing:border-box;}
button.primary{background:#ffd700;padding:12px 15px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;margin-top:10px;transition:background 0.2s;}
button.primary:hover{background:#ffc700;}

.card{background:rgba(255,255,255,0.95);padding:15px;margin:12px 0;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.08);border-left:4px solid #ffd700;}
.small{font-size:13px;color:#555}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
img.thumb{width:100%;height:140px;object-fit:cover;border-radius:8px}
.row{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;}
.badge{display:inline-block;padding:6px 10px;border-radius:15px;background:#fff7e6;border:1px solid #ffda47;font-weight:600;font-size:12px;color:#333;}
.meta{font-size:13px;color:#666}
/* Updated style for product images within order list */
.prod-thumb{width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid rgba(0,0,0,0.06)} 

/* Action Buttons (Approve/Reject) */
.btn-approve, .btn-reject {padding: 8px 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; font-size: 12px;}
.btn-approve {background: #4CAF50; color: white;}
.btn-reject {background: #F44336; color: white; margin-left: 5px;}
.btn-approve:hover, .btn-reject:hover {opacity: 0.8;}

/* Preloader & Loader */
#preloader{position:fixed;top:0;left:0;width:100%;height:100%;background:#ffffffdd;z-index:9999;display:flex;align-items:center;justify-content:center;transition:opacity 0.5s;}
.loader{border:6px solid #f3f3f3;border-top:6px solid #ffd700;border-radius:50%;width:50px;height:50px;animation:spin 1.5s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* New Feature Styles */
.loan-controls, .gold-rate-controls{display:flex;gap:8px;align-items:center;margin-top:8px;}
.loan-controls input, .gold-rate-controls input{width:100px;margin:0;padding:8px;}

/* Support Chat Bubbles */
.chat-message{border-left: 3px solid #ffda47; padding-left: 10px; margin-top: 5px; font-style: italic; background:#fff8e6; padding:8px; border-radius:4px;} 
.admin-reply-container {margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; display: flex; gap: 8px;}
.admin-reply-container textarea {margin: 0; flex-grow: 1; height: 40px; padding: 5px; font-size: 14px;}

.status-badge{background:#e6f7ff; margin-right:5px; font-size:10px; padding:3px 6px; border-radius:10px; font-weight: 500;}

/* Search Bar Styling */
.search-bar{display:flex;gap:10px;margin-bottom:20px;}
.search-bar input, .search-bar select{flex:1;min-width:120px;padding:10px;border-radius:6px;border:1px solid #ccc;background:rgba(255,255,255,0.95);}
.search-bar button{flex-shrink:0;}

/* Offers and Coupons */
.coupon-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;}
.coupon-code{font-weight:700;color:#007bff;}

/* Loan Approval Controls Adjustment */
.loan-controls-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    width: 100%;
    max-width: 400px;
}
.loan-controls-grid input {
    width: 100%;
    margin: 0;
    padding: 8px;
    box-sizing: border-box;
}
.loan-controls-grid textarea {
    grid-column: span 2;
    margin: 0;
    padding: 8px;
    box-sizing: border-box;
}
.loan-controls-grid button {
    grid-column: span 2;
    margin-left: 0 !important; 
    margin-top: 5px !important;
}

/* EMI Payment Card Specifics */
.emi-detail-item {
    padding: 8px 0;
    border-bottom: 1px dashed #f0f0f0;
}
.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px;
}

.tool-btn {
    padding: 12px;
    border: none;
    background: #0084ff;
    color: white;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: 0.2s;
}

.tool-btn:hover {
    background: #005fcc;
}

</style>
</head>
<body>

<div id="preloader">
    <div class="loader"></div>
</div>

<header>
<h1>Gold Rupi — Admin Panel</h1>
<div style="display:flex;gap:12px;align-items:center">
<div class="small" id="admin-email">admin</div>
<button onclick="logout()" style="padding:8px 12px;border-radius:8px;border:none;background:#fff8ea;cursor:pointer;font-weight:600;">Logout</button>
</div>
</header>

<nav>
<button data-tab="dashboard" class="active"><img src="https://img.icons8.com/ios-filled/50/000000/dashboard-layout.png"/><span>Dashboard</span></button>
<button data-tab="users"><img src="https://img.icons8.com/ios-filled/50/000000/collaborator-male.png"/><span>Users</span></button>
<button data-tab="categories"><img src="https://img.icons8.com/ios-filled/50/000000/categorize.png"/><span>Categories</span></button>
<button data-tab="products"><img src="https://img.icons8.com/ios-filled/50/000000/shop.png"/><span>Products</span></button>
<button data-tab="orders"><img src="https://img.icons8.com/ios-filled/50/000000/order-history.png"/><span>Orders</span></button>
<button data-tab="wallet"><img src="https://img.icons8.com/ios-filled/50/000000/wallet.png"/><span>Wallet Req</span></button>
<button data-tab="withdraw"><img src="https://img.icons8.com/ios-filled/50/000000/money-transfer.png"/><span>Withdraw Req</span></button>
<button data-tab="gold"><img src="https://img.icons8.com/ios-filled/50/000000/gold-bar.png"/><span>Gold Req</span></button>
<button data-tab="refer"><img src="https://img.icons8.com/ios-filled/50/000000/referral.png"/><span>Refer Req</span></button>
<button data-tab="kyc"><img src="https://img.icons8.com/ios-filled/50/000000/id-card.png"/><span>KYC Req</span></button>
<button data-tab="loan"><img src="https://img.icons8.com/ios-filled/50/000000/receive-cash.png"/><span>Loan Req</span></button>
<button data-tab="emi-payments"><img src="https://img.icons8.com/ios-filled/50/000000/receive-cash.png"/><span>EMI Payments</span></button>
<button data-tab="support"><img src="https://img.icons8.com/ios-filled/50/000000/speech-bubble.png"/><span>Support/Chat</span></button>
<button data-tab="earn-money"><img src="https://img.icons8.com/ios-filled/50/000000/money.png"/><span>Earn Money</span></button>
<button data-tab="offers"><img src="https://img.icons8.com/ios-filled/50/000000/discount.png"/><span>Offers</span></button>
<button data-tab="notifications"><img src="https://img.icons8.com/ios-filled/50/000000/notification.png"/><span>Notifs</span></button>

</nav>

<main>
<section id="dashboard" class="active">
<h2>Dashboard Overview</h2>
<div id="stats" class="card"></div>
   <!-- NEW 20 BUTTON SECTION -->
   
<h3>Global Search & Filter</h3>
<div class="card search-bar">
    <input type="text" id="global-search-input" placeholder="Search by Order ID, User Name, Email, Mobile..." onkeyup="">
    <select id="filter-status" onchange="filterOrders()">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="paid">Paid</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
        <option value="packed">Packed</option>
    </select>
</div>

<h3>Gold Rate Management (₹/Gram)</h3>
<div class="card gold-rate-controls">
    <input type="number" id="gold-rate-input" placeholder="Current Gold Rate (₹)" step="0.01">
    <button class="primary" onclick="setGoldRate()">Update Gold Rate</button>
    <div id="current-gold-rate" class="badge">Rate: Loading...</div>
</div>

<h3>Quick Recent Activity</h3>
<div id="recent" class="grid"></div>

</section>   <!-- ⭐ THIS WAS MISSING – Dashboard section closed here -->


<!-- ⭐ NOW Quick Tools WILL SHOW -->
<section id="quick-tools" class="section active" style="display:block;">
    <h2>Quick Tools ⭐</h2>

    <div class="card" style="padding:15px">
        <div class="tools-grid">

            <button class="tool-btn" onclick="location.href='admincantrol.html'">admincantro</button>
            <button class="tool-btn" onclick="location.href='rebook.html'">rebook</button>
            <button class="tool-btn" onclick="location.href='example3.html'">Tool 3</button>
            <button class="tool-btn" onclick="location.href='example4.html'">Tool 4</button>
            <button class="tool-btn" onclick="location.href='example5.html'">Tool 5</button>

            <button class="tool-btn" onclick="location.href='example6.html'">Tool 6</button>
            <button class="tool-btn" onclick="location.href='example7.html'">Tool 7</button>
            <button class="tool-btn" onclick="location.href='example8.html'">Tool 8</button>
            <button class="tool-btn" onclick="location.href='example9.html'">Tool 9</button>
            <button class="tool-btn" onclick="location.href='example10.html'">Tool 10</button>

            <button class="tool-btn" onclick="location.href='example11.html'">Tool 11</button>
            <button class="tool-btn" onclick="location.href='example12.html'">Tool 12</button>
            <button class="tool-btn" onclick="location.href='example13.html'">Tool 13</button>
            <button class="tool-btn" onclick="location.href='example14.html'">Tool 14</button>
            <button class="tool-btn" onclick="location.href='example15.html'">Tool 15</button>

            <button class="tool-btn" onclick="location.href='example16.html'">Tool 16</button>
            <button class="tool-btn" onclick="location.href='example17.html'">Tool 17</button>
            <button class="tool-btn" onclick="location.href='example18.html'">Tool 18</button>
            <button class="tool-btn" onclick="location.href='example19.html'">Tool 19</button>
            <button class="tool-btn" onclick="location.href='example20.html'">Tool 20</button>

        </div>
    </div>
</section>





















<section id="users">

    <h2>All Users</h2>
    <div id="user-list"></div>
</section>

<section id="categories">
<h2>Manage Categories</h2>
<div class="card">
<input id="cat-name" placeholder="Category Name (eg: men, women, sari, fashion)">
<input type="file" id="cat-image">
<button class="primary" onclick="addCategory()">Add / Update Category</button>
</div>
<h3>All Categories</h3>
<div id="category-list" class="grid"></div>
</section>

<section id="products">
<h2>Manage Products</h2>
<div class="card">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<input id="prod-name" placeholder="Product Name">
<input id="prod-brand" placeholder="Brand">
<input id="prod-price" placeholder="Price" type="number">
<input id="prod-discount" placeholder="Discount % (optional)" type="number">
</div>
<textarea id="prod-desc" placeholder="Description"></textarea>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px; margin: 8px 0;">
    <select id="prod-colors" multiple style="min-height:100px;">
        <option value="" disabled>Select Colors (Hold Ctrl/Cmd to select multiple)</option>
    </select>
    <select id="prod-sizes" multiple style="min-height:100px;">
        <option value="" disabled>Select Sizes (Hold Ctrl/Cmd to select multiple)</option>
    </select>
</div>
<div style="display:flex;gap:8px;align-items:center">
<select id="prod-category"></select>
<input type="file" id="prod-images" multiple>
<button class="primary" onclick="addProduct()">Add Product</button>
</div>
</div>
<h3>All Products</h3>
<div id="product-list" class="grid"></div>
</section>

<section id="orders">
<h2>Orders</h2>
<div id="orders-list-container"></div>
</section>

<section id="wallet">
<h2>Wallet Add Requests</h2>
<div id="wallet-requests"></div>
</section>

<section id="withdraw">
    <h2>Wallet Withdrawal Requests</h2>
    <div id="withdraw-requests"></div>
</section>

<section id="gold">
<h2>Gold Buy Requests</h2>
<div id="gold-requests"></div>
</section>

<section id="refer">
<h2>Refer Cash Requests (₹100)</h2>
<div id="refer-requests"></div>
</section>

<section id="kyc">
<h2>KYC Requests</h2>
<div id="kyc-requests"></div>
</section>

<section id="loan">
<h2>Loan Requests</h2>
<div id="loan-requests-list"></div>
</section>

<section id="emi-payments">
    <h2>EMI Payment Verification</h2>
    <div id="emi-payment-requests"></div>
</section>

<section id="support">
<h2>Support & Chat Messages</h2>
<div id="support-messages-list"></div>
</section>

<section id="earn-money">
    <h2>Manage Earn Money Opportunities</h2>
    <div class="card">
        <input id="em-title" placeholder="Opportunity Title">
        <input id="em-price" placeholder="Earning Amount (₹)" type="number">
        <textarea id="em-desc" placeholder="Detailed Description"></textarea>
        <input type="file" id="em-image">
        <button class="primary" onclick="addEarnMoneyOpportunity()">Post Opportunity</button>
    </div>
    <h3>All Opportunities</h3>
    <div id="earn-money-list" class="grid"></div>
</section>

<section id="offers">
    <h2>Manage Offers & Coupons</h2>
    <div class="card">
        <div style="display:flex;gap:10px;align-items:center;">
            <input id="coupon-prefix" placeholder="Prefix (e.g., SAVE)" style="width:100px;flex-grow:0;">
            <input id="coupon-amount" placeholder="Discount Amount (₹)" type="number">
            <input id="coupon-min-order" placeholder="Min Order (₹)" type="number">
            <select id="coupon-type">
                <option value="fixed">Fixed Amount</option>
                <option value="percent">Percentage (%)</option>
            </select>
            <button class="primary" onclick="generateAndSaveCoupon()" style="margin-top:0;">Generate & Save Coupon</button>
        </div>
        <input id="coupon-expiry" type="date" style="width:50%;" >
    </div>
    <h3>Active Coupons</h3>
    <div id="coupon-list"></div>
</section>

<section id="notifications">
    <h2>Send Notifications</h2>
    <div class="card">
        <select id="notif-target">
            <option value="all">All Users</option>
            </select>
        <input id="notif-title" placeholder="Notification Title (e.g., Offer Alert!)">
        <textarea id="notif-body" placeholder="Notification Message (e.g., Get 10% off today!)"></textarea>
        <button class="primary" onclick="sendNotification()">Send Notification</button>
    </div>
    <h3>Recent Notifications</h3>
    <div id="recent-notifications-list"></div>
</section>
</main>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
// IMPORTANT: Make sure your Firebase Realtime Database security rules are set up
// to allow read/write access to 'users', 'orders', 'payment_requests', 'gold_requests',
// 'loan_requests', 'support_messages', 'kyc_requests', 'refer_cash_requests', 'withdraw_requests', 'earn_money', 'coupons', and 'notifications'
// from the admin's authentication scope.

// ---------- CONFIG ----------
const firebaseConfig = {
apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
authDomain: "smbrand-4543a.firebaseapp.com",
databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
projectId: "smbrand-4543a",
storageBucket: "smbrand-4543a.appspot.com", 
messagingSenderId: "720775550032",
appId: "1:720775550032:web:0622548a007597778bad55",
measurementId: "G-3LS5W6F8QW"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage(); 
const imgbbKey = '021a2437b889915669b66554687bf17f';
const adminEmail = 'rajputsurendra562@gmail.com';
let currentUser = null; 

let categoriesData = {};
let allOrdersData = {}; // Cache all orders for filtering

// --- NEW: Product Options Data for Multi-Selects ---
const availableColors = ['Black', 'White', 'Red', 'Blue', 'Green', 'Yellow', 'Pink', 'Purple', 'Orange', 'Grey', 'Brown', 'Gold', 'Silver', 'Maroon', 'Teal', 'Navy'];
const availableSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '28', '30', '32', '34', '36', 'Free Size'];
// --- END NEW ---

db.ref('categories').on('value', snap => {
    categoriesData = snap.val() || {};
    populateCategorySelect();
});
// ---------- PRELOADER HANDLER --------
function showPreloader(){
    document.getElementById('preloader').style.display = 'flex';
    document.getElementById('preloader').style.opacity = '1';
}
function hidePreloader(){
  const preloader = document.getElementById('preloader');
  if(preloader){
    preloader.style.opacity = '0';
    setTimeout(() => { preloader.style.display = 'none'; }, 500);
  }
}
showPreloader();

document.addEventListener('DOMContentLoaded', ()=>{
    loadCategories();  
    loadProducts();   
    setupProductOptions(); 
    loadOrders(); // Load all orders initially
});

// ---------- TABS ----------
const tabs = document.querySelectorAll('nav button[data-tab]');
const sections = document.querySelectorAll('main section');
tabs.forEach(tab=>tab.addEventListener('click',()=>{
tabs.forEach(t=>t.classList.remove('active'));
sections.forEach(s=>s.classList.remove('active'));
tab.classList.add('active');
const tabId = tab.dataset.tab;
document.getElementById(tabId).classList.add('active');
if (tabId === 'users') loadUsers(); 
if (tabId === 'categories') loadCategories(); 
if (tabId === 'products') loadProducts(); 
if (tabId === 'orders') loadOrders(); 
if (tabId === 'wallet') loadWalletRequests(); 
if (tabId === 'withdraw') loadWithdrawRequests(); 
if (tabId === 'gold') loadGoldRequests(); 
if (tabId === 'refer') loadReferRequests(); 
if (tabId === 'kyc') loadKYCRequests(); 
if (tabId === 'loan') loadLoanRequests(); 
if (tabId === 'emi-payments') loadEmiPaymentRequests(); // NEW: Load EMI Payments
if (tabId === 'support') loadSupportMessages(); 
if (tabId === 'earn-money') loadEarnMoneyOpportunities();
if (tabId === 'offers') loadCoupons(); 
if (tabId === 'notifications') loadRecentNotifications(); 
}));

// ---------- AUTH ----------
auth.onAuthStateChanged(user=>{
if(!user) return window.location.href='rupe.html';
if(user.email !== adminEmail) return window.location.href='rupe.html';

currentUser = user;
document.getElementById('admin-email').innerText = user.email;

// Load all data on successful login
loadStats(); loadCategories(); loadProducts();
loadOrders(); loadWalletRequests(); loadWithdrawRequests(); loadGoldRequests(); loadReferRequests(); loadKYCRequests();
loadLoanRequests(); 
loadSupportMessages(); 
loadGoldRate(); // Load initial gold rate

listenRealtimeChanges();
hidePreloader(); 
});

function logout(){ auth.signOut().then(()=>window.location.href='rupe.html'); }


/* -------- GOLD RATE MANAGEMENT -------- */
function loadGoldRate() {
    db.ref('gold_settings/current_rate').once('value').then(snap => {
        const rate = snap.val() || 0;
        document.getElementById('current-gold-rate').innerText = `Rate: ₹${rate.toFixed(2)}/g`;
        document.getElementById('gold-rate-input').value = rate;
    }).catch(e => console.error("Error loading gold rate:", e));
}

function setGoldRate() {
    const rateInput = document.getElementById('gold-rate-input');
    const newRate = parseFloat(rateInput.value);

    if (isNaN(newRate) || newRate <= 0) {
        return alert('Please enter a valid gold rate.');
    }

    if (!confirm(`Confirm new Gold Rate: ₹${newRate.toFixed(2)}/Gram?`)) return;

    db.ref('gold_settings').update({ current_rate: newRate, last_updated: Date.now() })
        .then(() => {
            alert('Gold Rate updated successfully!');
            loadGoldRate();
        })
        .catch(error => {
            console.error("Error updating gold rate:", error);
            alert('Failed to update Gold Rate.');
        });
}

/* -------- STATS & RECENT -------- */
function loadStats(){
  Promise.all([
    db.ref('users').once('value'),
    db.ref('orders').once('value'),
    db.ref('wallet_requests').once('value'),
    db.ref('products').once('value'),
    db.ref('categories').once('value'),
    db.ref('loan_requests').once('value'), 
    db.ref('support_messages').once('value') 
  ]).then(([u,o,p,prods,cats,loan,support])=>{
    const loanReqCount = Object.values(loan.val() || {}).filter(r => r.status === 'pending').length; // Filter pending loans
    const supportMsgCount = Object.values(support.val() || {}).filter(r => r.status !== 'resolved').length; // Filter unresolved messages
    
    const statsDiv = document.getElementById('stats');
    statsDiv.innerHTML = `
      <div class="row">
        <div class="card"><div class="small">Users</div><div class="badge">${u.numChildren()}</div></div>
        <div class="card"><div class="small">Orders</div><div class="badge">${o.numChildren()}</div></div>
        <div class="card"><div class="small">Wallet Add Reqs</div><div class="badge">${p.numChildren()}</div></div>
        <div class="card"><div class="small">Pending Loan Reqs</div><div class="badge" style="background:${loanReqCount > 0 ? '#ffc700' : '#fff7e6'}">${loanReqCount}</div></div>
        <div class="card"><div class="small">Unresolved Msgs</div><div class="badge" style="background:${supportMsgCount > 0 ? '#ffc700' : '#fff7e6'}">${supportMsgCount}</div></div>
        <div class="card"><div class="small">Products</div><div class="badge">${prods.numChildren()}</div></div>
      </div>
    `;
  }).catch(e=>console.warn('stats load error', e));
  // recent small list
  const recent = document.getElementById('recent'); recent.innerHTML = '';
  db.ref('wallet_requests').limitToLast(6).once('value').then(snap=>{
    const data = snap.val()||{};
    Object.keys(data).reverse().forEach(k=>{
      const r = data[k];
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<div class="meta">Wallet Add • ₹${r.amount || 0}</div><div class="small">user: ${r.user.substring(0, 8)}...</div>`;
      recent.appendChild(el);
    });
  });
}

/* -------- USER LISTING -------- */
function loadUsers() {
    db.ref('users').once('value').then(snap => {
        const data = snap.val() || {};
        const list = document.getElementById('user-list');
        list.innerHTML = '';

        Object.keys(data).reverse().forEach(uid => {
            const u = data[uid];
            const kycStatus = u.kyc && u.kyc.status === 'verified' ? 'Verified' : (u.kyc && u.kyc.status === 'rejected' ? 'Rejected' : 'Pending/N/A');
            const loanStatus = u.loan_application ? u.loan_application.status : 'N/A';
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${u.name || 'User ' + uid.substring(0, 5)}</strong><br>
                        <small>Email: ${u.email || 'N/A'}</small><br>
                        <small>Mobile: ${u.mobile || 'N/A'}</small><br>
                        <small>Wallet: ₹${(u.wallet || 0).toFixed(2)} | Gold: ${u.gold_balance || 0} g</small>
                    </div>
                    <div style="text-align:right;">
                        <span class="badge" style="background:${kycStatus === 'Verified' ? '#d0f0d0' : '#ffe0e0'}; margin-bottom:5px;">KYC: ${kycStatus}</span>
                        <span class="badge" style="background:${loanStatus === 'approved' ? '#d0f0f0' : '#ffe0e0'}; margin-bottom:5px;">Loan: ${loanStatus}</span>
                        <a href="https://wa.me/91${u.mobile}" target="_blank" class="badge" style="background:#25d366; color:white; margin-top:5px;">WhatsApp</a>
                    </div>
                </div>
            `;
            list.appendChild(card);
        });
    }).catch(e => console.error('Error loading users:', e));
}


/* -------- IMAGE UPLOAD HELPER (imgbb) -------- */
function uploadImg(file){
  return new Promise((resolve,reject)=>{
    const form = new FormData(); form.append('image', file);
    axios.post('https://api.imgbb.com/1/upload?key='+imgbbKey, form).then(res=>{
      resolve(res.data.data.url);
    }).catch(err=>reject(err));
  });
}

/* -------- CATEGORIES -------- */
async function addCategory(){
    const nameInput = document.getElementById('cat-name');
    const imageInput = document.getElementById('cat-image');
    const name = nameInput.value.trim();
    const imageFile = imageInput.files[0];

    if(!name || !imageFile){
        return alert('Please enter a Category Name and select an Image.');
    }
    
    showPreloader();
    try {
        const imageUrl = await uploadImg(imageFile);
        const newCatRef = db.ref('categories').push();
        
        await newCatRef.set({ name, image: imageUrl, createdAt: Date.now() });

        alert(`Category "${name}" added successfully!`);
        nameInput.value = '';
        imageInput.value = '';
        loadCategories(); 
        populateCategorySelect();

    } catch(e) {
        console.error('Error adding category:', e);
        alert('Failed to add category. Image upload or database write failed.');
    } finally {
        hidePreloader();
    }
}

function loadCategories(){ 
    db.ref('categories').on('value', snap=>{
        const data = snap.val()||{};
        const list = document.getElementById('category-list');
        list.innerHTML = '';
        Object.keys(data).reverse().forEach(k=>{
            const cat = data[k];
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `
                <img src="${cat.image}" class="thumb" alt="${cat.name} Category"/>
                <div style="margin-top:8px">
                    <strong>${cat.name}</strong>
                    <div class="row">
                        <button onclick="viewCategoryItems('${k}')" class="primary" style="padding:5px 8px; font-size:12px; margin-top:5px;">View Items</button>
                        <button onclick="deleteCategory('${k}')" class="btn-reject" style="padding:5px 8px; font-size:12px; margin-left:0; margin-top:5px;">Delete</button>
                    </div>
                </div>
            `;
            list.appendChild(card);
        });
    });
    populateCategorySelect();
}

function viewCategoryItems(catId){ 
    alert('Functionality to view category items (products) not fully implemented yet. Category ID: ' + catId);
}

function deleteCategory(catId){ 
    if(!confirm('Are you sure you want to delete this category? All related products will lose their category link.')) return;
    db.ref('categories/' + catId).remove().then(()=>{
        alert('Category deleted successfully.');
        loadCategories();
    }).catch(e=>console.error('Error deleting category:', e));
}


// -------- Setup Color and Size Multi-Selects --------
function setupProductOptions() {
    const colorSelect = document.getElementById('prod-colors');
    const sizeSelect = document.getElementById('prod-sizes');

    if (colorSelect) {
        colorSelect.innerHTML = '<option value="" disabled>Select Colors (Hold Ctrl/Cmd to select multiple)</option>';
        availableColors.forEach(color => {
            const option = document.createElement('option');
            option.value = color;
            option.textContent = color;
            colorSelect.appendChild(option);
        });
    }

    if (sizeSelect) {
        sizeSelect.innerHTML = '<option value="" disabled>Select Sizes (Hold Ctrl/Cmd to select multiple)</option>';
        availableSizes.forEach(size => {
            const option = document.createElement('option');
            option.value = size;
            option.textContent = size;
            sizeSelect.appendChild(option);
        });
    }
}
// --------------------------------------------------------

/* -------- PRODUCTS -------- */
async function addProduct(){ 
    const name = document.getElementById('prod-name').value.trim();
    const brand = document.getElementById('prod-brand').value.trim();
    const price = parseFloat(document.getElementById('prod-price').value);
    
    const colors = Array.from(document.getElementById('prod-colors').selectedOptions).map(option => option.value).join(', ');
    const sizes = Array.from(document.getElementById('prod-sizes').selectedOptions).map(option => option.value).join(', ');
    
    const discount = parseFloat(document.getElementById('prod-discount').value) || 0;
    const desc = document.getElementById('prod-desc').value.trim();
    const categoryId = document.getElementById('prod-category').value;
    const imageFiles = document.getElementById('prod-images').files;

    if (!name || !brand || isNaN(price) || price <= 0 || !desc || !categoryId || imageFiles.length === 0) {
        return alert('Please fill all required fields (Name, Brand, Price, Description, Category, Images).');
    }

    showPreloader();
    try {
        const uploadPromises = Array.from(imageFiles).map(file => uploadImg(file));
        const imageUrls = await Promise.all(uploadPromises);
        const imagesString = imageUrls.join(',');

        const newProdRef = db.ref('products').push();
        await newProdRef.set({
            name, brand, price, color: colors, size: sizes, discount, description: desc, category: categoryId, images: imagesString, createdAt: Date.now()
        });

        alert(`Product "${name}" added successfully!`);
        // Clear form
        document.getElementById('products').querySelectorAll('input, textarea').forEach(el => {
            if (el.type !== 'file' && el.id !== 'prod-category') el.value = '';
            if (el.id === 'prod-discount') el.value = '';
        });
        document.getElementById('prod-category').value = '';
        document.getElementById('prod-images').value = '';
        Array.from(document.getElementById('prod-colors').options).forEach(opt => opt.selected = false);
        Array.from(document.getElementById('prod-sizes').options).forEach(opt => opt.selected = false);

        loadProducts(); 

    } catch(e) {
        console.error('Error adding product:', e);
        alert('Failed to add product. Please check image size/format or network.');
    } finally {
        hidePreloader();
    }
}

function loadProducts(){
    db.ref('products').on('value', snap=>{
        const data = snap.val() || {};
        const list = document.getElementById('product-list');
        list.innerHTML = '';

        Object.keys(data).reverse().forEach(k=>{
            const p = data[k];
            const firstImage = (p.images && p.images.split(',')[0]) || 'https://via.placeholder.com/100x140?text=No+Image';
            const statusText = p.stock && p.stock > 0 ? 'In Stock' : 'Out of Stock';
            const statusColor = p.stock && p.stock > 0 ? 'green' : 'red';

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${firstImage}" class="thumb" alt="${p.name}">
                <div style="margin-top:8px">
                    <strong>${p.name}</strong>
                    <div class="meta">Brand: ${p.brand || 'N/A'}</div>
                    <div class="meta">Price: ₹${p.price || 0} ${p.discount ? `(${p.discount}% off)` : ''}</div>
                    <div class="meta">Category: ${categoriesData[p.category] ? categoriesData[p.category].name : 'N/A'}</div>
                    <div class="meta" style="color:${statusColor}; font-weight:bold;">Status: ${statusText}</div>

                    <div class="row" style="margin-top:6px; display:flex; gap:6px;">
                        <button onclick="editProduct('${k}')" class="primary" style="padding:5px 8px; font-size:12px;">Edit</button>
                        <button onclick="deleteProduct('${k}')" class="btn-reject" style="padding:5px 8px; font-size:12px;">Delete</button>
                    </div>
                </div>
            `;
            list.appendChild(card);
        });
    });
}

function editProduct(pid){ 
    alert('Edit functionality for product ' + pid + ' not implemented.');
}

function deleteProduct(pid){ 
    if(!confirm('Are you sure you want to delete this product?')) return;
    db.ref('products/' + pid).remove().then(()=>{
        alert('Product deleted successfully.');
        loadProducts();
    }).catch(e=>console.error('Error deleting product:', e));
}

function populateCategorySelect(){ 
    db.ref('categories').once('value').then(snap=>{
        const data = snap.val()||{};
        const select = document.getElementById('prod-category');
        select.innerHTML = '<option value="">Select Category</option>';
        Object.keys(data).forEach(k=>{
            const cat = data[k];
            const option = document.createElement('option');
            option.value = k;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    }).catch(e=>console.error('Error populating categories:', e));
}


/* -------- ORDERS MANAGEMENT & FILTERING (MASSIVE UPDATE) -------- */
async function loadOrders() {
    const ordersList = document.getElementById('orders-list-container'); 
    ordersList.innerHTML = 'Loading orders...'; 

    // Fetch all users and products once to map data
    const [uSnap, pSnap, oSnap] = await Promise.all([
        db.ref('users').once('value'),
        db.ref('products').once('value'),
        db.ref('orders').once('value')
    ]);

    // Cache all orders and reload the view
    allOrdersData = oSnap.val() || {};
    renderOrders(); 
}

async function renderOrders(filterKey = '', filterStatus = '') {
    const ordersList = document.getElementById('orders-list-container');
    ordersList.innerHTML = '';
    
    // Fetch users and products again if not cached (safety)
    const [uSnap, pSnap] = await Promise.all([
        db.ref('users').once('value'),
        db.ref('products').once('value')
    ]);
    const usersData = uSnap.val() || {};
    const productsData = pSnap.val() || {};

    // Get filter values if not passed
    const fKey = filterKey || document.getElementById('global-search-input').value.toLowerCase();
    const fStatus = filterStatus || document.getElementById('filter-status').value;


    const orderKeys = Object.keys(allOrdersData).reverse();

    for (const oid of orderKeys) {
        const o = allOrdersData[oid];
        const u = usersData[o.user] || {};
        const userName = (u.name || 'unknown').toLowerCase();
        const userEmail = (u.email || '').toLowerCase();
        const userMobile = (u.mobile || '').toLowerCase();
        const currentStatus = (o.status || 'pending');

        // Check against filters
        const matchesKey = !fKey || 
                           oid.toLowerCase().includes(fKey) || 
                           userName.includes(fKey) || 
                           userEmail.includes(fKey) || 
                           userMobile.includes(fKey);

        const matchesStatus = !fStatus || currentStatus === fStatus;

        if (!matchesKey || !matchesStatus) continue;

        // --- IMPROVED PRODUCT RENDERING (Using 'items' from user snippet as 'products') ---
        const itemsToDisplay = o.items || o.products; // Fallback to 'products' key
        const productsHTML = itemsToDisplay ? Object.keys(itemsToDisplay)
            .map(pid => {
                const item = itemsToDisplay[pid];
                // Try to get full product data for images/details if not in order object
                const p = productsData[pid] || {}; 
                const firstImage = (item.image || p.image || p.images?.split(',')[0]) || 'https://via.placeholder.com/60x60?text=No+Image';

                return `
                <div style="display:flex; gap:10px; margin-top:8px; border-bottom:1px dashed #eee; padding-bottom:8px;">
                    <img src="${firstImage}" class="prod-thumb" alt="${item.name || 'Product'}"/>
                    <div style="flex-grow:1;">
                        <strong>${item.name || 'Product Not Found'} (x${item.qty || 1})</strong><br>
                        <span class="small">Price: ₹${item.price || 0} | **Selected:** Size: ${item.size || 'N/A'} | Color: ${item.color || 'N/A'}</span><br>
                    </div>
                </div>`;
            }).join('') : '<small>No products found for this order.</small>';
        // --- END IMPROVED PRODUCT RENDERING ---

        // Get Status History
        const history = o.status_history ? Object.values(o.status_history).sort((a,b) => a.at - b.at) : [];
        const historyHTML = history.map(h => {
            const time = new Date(h.at).toLocaleDateString('en-IN', {day:'2-digit', month:'short', hour: '2-digit', minute:'2-digit'});
            return `<span class="badge status-badge" style="background:#e6f7ff; margin-right:5px;">${h.status.toUpperCase()} (${time})</span>`;
        }).join('');

        const wrapper = document.createElement('div'); wrapper.className='card';
        wrapper.innerHTML = `
            <div style="display:flex;gap:12px;margin-bottom:10px;border-bottom:1px solid #f0f0f0;padding-bottom:10px;">
                <div style="flex:1">
                    <strong>Order #${oid} • Total: ₹${o.total || 0}</strong><br>
                    <small>User: ${u.name || 'unknown'} | Email: ${u.email || 'N/A'} | Mobile: ${u.mobile || 'N/A'}</small><br>
                    <small>Address: ${o.address ? (o.address.house + ', ' + o.address.city) || 'N/A' : 'N/A'}</small><br>
                    <small>Payment: ${o.utr ? `UTR: ${o.utr} | Status: ${o.status}` : 'COD/N/A'} | Current Status: <strong>${(currentStatus).toUpperCase()}</strong></small>
                </div>
                <div>
                    <select id="order-status-${oid}" onchange="updateOrderStatus('${oid}')">
                        <option value="payment_pending">Payment Pending</option>
                        <option value="paid">Paid/Processing</option>
                        <option value="packed">Packed</option>
                        <option value="out_for_delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom:15px;">
                <strong class="small" style="display:block; margin-bottom:5px;">Order Items:</strong>
                ${productsHTML}
            </div>
            
            <div style="border-top:1px solid #f0f0f0; padding-top:10px;">
                <strong class="small" style="display:block; margin-bottom:5px;">Process Flow:</strong>
                ${historyHTML || '<span class="small">No process history recorded.</span>'}
            </div>
        `;
        ordersList.appendChild(wrapper);
        // Set the current status
        const sel = document.getElementById('order-status-'+oid); 
        if(sel) sel.value = currentStatus;
    }
    if (ordersList.innerHTML === '') {
        ordersList.innerHTML = '<div class="card">No orders found matching the filter criteria.</div>';
    }
}

function filterOrders() {
    const filterKey = document.getElementById('global-search-input').value.toLowerCase();
    const filterStatus = document.getElementById('filter-status').value;
    renderOrders(filterKey, filterStatus);
}


function updateOrderStatus(oid){
  const newStatus = document.getElementById('order-status-'+oid).value;

  db.ref('orders/'+oid).once('value').then(snap=>{
    const order = snap.val();

    if(!order) return alert('Order not found!');
    
    if (order.status === newStatus) {
        alert(`Order status is already set to "${newStatus.toUpperCase()}".`);
        document.getElementById('order-status-'+oid).value = order.status; 
        return; 
    }

    if(!confirm(`Confirm update status of Order #${oid} to "${newStatus.toUpperCase()}"?`)) {
        document.getElementById('order-status-'+oid).value = order.status;
        return; 
    }

    const historyEntry = {
        status: newStatus,
        at: Date.now(),
        updated_by: currentUser.email || 'Admin'
    };
    
    db.ref('orders/'+oid+'/status').set(newStatus).then(()=>{
        db.ref('orders/'+oid+'/status_history').push(historyEntry);
        
        if(order.user){
          // Update status in user's profile order history
          db.ref('users/'+order.user+'/order_history/'+oid+'/status').set(newStatus);
        }
        
        alert(`Order status updated to ${newStatus.toUpperCase()}.`);
        loadOrders(); // Reload to update filtered view
    }).catch(error => {
        console.error("Error updating order status:", error);
        alert('Failed to update order status.');
        document.getElementById('order-status-'+oid).value = order.status;
    });
  });
}


/* -------- WALLET ADD REQUESTS -------- */
function loadWalletRequests(){
  db.ref('wallet_requests').once('value', snap=>{ 
    const data = snap.val()||{};
    const list = document.getElementById('wallet-requests');
    list.innerHTML=''; 
    Object.keys(data).reverse().forEach(k=>{
      const r = data[k];
      db.ref('users/'+r.user).once('value').then(uSnap=>{
        const u = uSnap.val()||{};
        const statusText = r.status==='pending' ? 'Payment Pending' : r.status==='completed' ? 'Payment Done' : r.status==='failed' ? 'Rejected' : r.status;
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Wallet Add • ₹${r.amount}</strong><br>
              <small>User: ${u.name || 'unknown'} • ${u.email || 'N/A'}</small><br>
              <small>Mobile: ${u.mobile || 'N/A'}</small><br>
              <small>UTR: ${r.utr || 'N/A'}</small><br>
              <small>Status: ${statusText}</small>
            </div>
            ${r.status==='pending'
              ? `<div style="display:flex;gap:5px;">
                 <button onclick="approveWallet('${k}', '${r.user}', ${r.amount})" class="btn-approve">Approve</button>
                 <button onclick="rejectWallet('${k}', '${r.user}')" class="btn-reject">Reject</button>
                 </div>`
              : `<span class="badge" style="background:${r.status==='completed' ? '#d0f0d0' : '#ffe0e0'}">${statusText}</span>`}
          </div>
        `;
        list.appendChild(card);
      });
    });
  });
}

function approveWallet(rid, uid, amount){
  if(!confirm(`Approve ₹${amount} for user ${uid}?`)) return;

  db.ref('wallet_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    db.ref('wallet_requests/'+rid+'/status').set('completed');
    // Ensure the wallet history update is comprehensive
    db.ref('users/'+uid+'/wallet_history/'+rid).update({status:'completed', updated_at: Date.now(), type:'add_money'});
    db.ref('users/'+uid+'/wallet').transaction(curr => Number(curr||0) + Number(amount));
    alert('Wallet request approved and balance updated');
    loadWalletRequests(); 
  });
}

function rejectWallet(rid, uid){
  if(!confirm('Reject wallet request?')) return;

  db.ref('wallet_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    db.ref('wallet_requests/'+rid+'/status').set('failed');
    db.ref('users/'+uid+'/wallet_history/'+rid).update({status:'failed', updated_at: Date.now(), type:'add_money'});
    alert('Wallet request rejected');
    loadWalletRequests(); 
  });
}

/* -------- WITHDRAWAL REQUESTS LOGIC (UPDATED FOR REFUND) -------- */
function loadWithdrawRequests(){
  db.ref('withdraw_requests').once('value', snap=>{ 
    const data = snap.val()||{};
    const list = document.getElementById('withdraw-requests');
    list.innerHTML=''; 
    Object.keys(data).reverse().forEach(k=>{
      const r = data[k];
      db.ref('users/'+r.user).once('value').then(uSnap=>{
        const u = uSnap.val()||{};
        const statusText = r.status==='pending' ? 'Pending' : r.status==='completed' ? 'Paid' : r.status==='failed' ? 'Rejected' : r.status;
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Withdrawal • ₹${r.amount}</strong><br>
              <small>User: ${u.name || 'unknown'} • ${u.email || 'N/A'}</small><br>
              <small>Mobile: ${u.mobile || 'N/A'}</small><br>
              <small>Bank/UPI Note: ${r.note || 'N/A'}</small><br>
              <small>Status: ${statusText}</small>
            </div>
            ${r.status==='pending'
              ? `<div style="display:flex;gap:5px;">
                 <button onclick="approveWithdraw('${k}', '${r.user}', ${r.amount})" class="btn-approve">Approve & Pay</button>
                 <button onclick="rejectWithdraw('${k}', '${r.user}', ${r.amount})" class="btn-reject">Reject & Refund</button>
                 </div>`
              : `<span class="badge" style="background:${r.status==='completed' ? '#d0f0d0' : '#ffe0e0'}">${statusText}</span>`}
          </div>
        `;
        list.appendChild(card);
      });
    });
  });
}

function approveWithdraw(rid, uid, amount){
  if(!confirm(`Confirm **payment** of ₹${amount} to user ${uid}? (This marks the withdrawal as COMPLETED - NO REFUND)`)) return;

  db.ref('withdraw_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    // The amount is already deducted from the user's wallet in the app logic. 
    // Here we just mark it as paid.
    db.ref('withdraw_requests/'+rid+'/status').set('completed');
    // Update user's wallet history status
    db.ref('users/'+uid+'/wallet_history/'+rid).update({status:'completed', updated_at: Date.now()});
    alert('Withdrawal request approved. **Payment is assumed to be made now.**');
    loadWithdrawRequests(); 
  });
}

function rejectWithdraw(rid, uid, amount){
  if(!confirm(`Reject withdrawal request? The amount ₹${amount} will be refunded to the user's wallet.`)) return;

  db.ref('withdraw_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    db.ref('withdraw_requests/'+rid+'/status').set('failed');
    
    // Refund the amount to the user's wallet
    db.ref('users/'+uid+'/wallet').transaction(curr => Number(curr||0) + Number(amount));
    
    // Update user's wallet history status and mark as refunded
    db.ref('users/'+uid+'/wallet_history/'+rid).update({status:'failed', updated_at: Date.now(), refund_amount: amount});
    
    alert('Withdrawal request rejected and amount refunded to wallet.');
    loadWithdrawRequests(); 
  });
}
/* -------- END WITHDRAWAL REQUESTS LOGIC -------- */


/* -------- GOLD REQUESTS -------- */
function loadGoldRequests(){
  db.ref('gold_requests').once('value', snap=>{ 
    const data = snap.val()||{};
    const list = document.getElementById('gold-requests'); list.innerHTML=''; 
    Object.keys(data).reverse().forEach(k=>{
      const r = data[k];
      db.ref('users/'+r.user).once('value').then(uSnap=>{
        const u = uSnap.val()||{};
        const statusText = r.status==='pending' ? 'Payment Pending' : r.status==='completed' ? 'Payment Done' : r.status==='failed' ? 'Rejected' : r.status;
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Gold Buy • ₹${r.amount} • ${r.grams} g</strong><br>
              <small>User: ${u.name || 'unknown'} • ${u.email || 'N/A'}</small><br>
              <small>Mobile: ${u.mobile || 'N/A'}</small><br>
              <small>UTR: ${r.utr || 'N/A'}</small><br>
              <small>Status: ${statusText}</small>
            </div>
            ${r.status==='pending'
              ? `<div style="display:flex;gap:5px;">
                 <button onclick="approveGold('${k}', '${r.user}', ${r.grams})" class="btn-approve">Approve</button>
                 <button onclick="rejectGold('${k}', '${r.user}')" class="btn-reject">Reject</button>
                 </div>`
              : `<span class="badge" style="background:${r.status==='completed' ? '#d0f0d0' : '#ffe0e0'}">${statusText}</span>`}
          </div>
        `;
        list.appendChild(card);
      });
    });
  });
}
function approveGold(rid, uid, grams){
  if(!confirm(`Approve ${grams} grams gold for user ${uid}?`)) return;

  db.ref('gold_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    db.ref('gold_requests/'+rid+'/status').set('completed');
    db.ref('users/'+uid+'/gold_history/'+rid).update({status:'completed', updated_at: Date.now()});
    db.ref('users/'+uid+'/gold_balance').transaction(curr => Number(curr||0) + Number(grams));
    alert('Gold request approved and balance updated');
    loadGoldRequests(); 
  });
}

function rejectGold(rid, uid){
  if(!confirm('Reject gold request?')) return;

  db.ref('gold_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    db.ref('gold_requests/'+rid+'/status').set('failed');
    db.ref('users/'+uid+'/gold_history/'+rid).update({status:'failed', updated_at: Date.now()});
    alert('Gold request rejected');
    loadGoldRequests(); 
  });
}


/* -------- REFER REQUESTS -------- */
function loadReferRequests(){
  db.ref('refer_cash_requests').once('value',snap=>{ 
    const data = snap.val()||{};
    const list = document.getElementById('refer-requests'); list.innerHTML=''; 
    Object.keys(data).reverse().forEach(k=>{
      const r = data[k];
      db.ref('users/'+r.user).once('value').then(uSnap=>{
        const u = uSnap.val()||{};
        const statusText = r.status==='pending' ? 'Pending' : r.status==='success' ? 'Credited' : r.status;
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><div><strong>Referral Bonus Request (₹100)</strong></div>
        <div class="small">User: ${u.name || 'unknown'} • ${u.email || 'N/A'} • ${u.mobile || ''}</div>
        <div class="small">Status: ${statusText}</div></div>
        ${r.status==='pending'
          ? `<div style="display:flex;gap:5px;"><button onclick="verifyRefer('${k}', '${r.user}')" class="btn-approve">Verify & Credit ₹100</button><button onclick="rejectRefer('${k}')" class="btn-reject">Reject</button></div>`
          : `<span class="badge" style="background:${r.status==='success' ? '#d0f0d0' : '#ffe0e0'}">${statusText}</span>`}
        </div>`;
        list.appendChild(card);
      });
    });
  });
}
function verifyRefer(rid, uid){
  if(!confirm('Approve ₹100 referral bonus?')) return;
  db.ref('refer_cash_requests/'+rid+'/status').once('value').then(snap => {
    const currentStatus = snap.val();
    if (currentStatus !== 'pending') return alert('Request already processed. Refresh the page.');

    db.ref('refer_cash_requests/'+rid+'/status').set('success').then(()=>{
      db.ref('users/'+uid+'/wallet').transaction(curr => Number(curr||0) + 100);
      db.ref('users/'+uid+'/wallet_history/'+('ref'+rid)).set({id:rid, amount:100, status:'completed', type:'refer_bonus', at:Date.now()});
      db.ref('users/'+uid+'/refer_history/'+rid).set({status:'success'}); 
      alert('Referral approved and ₹100 credited');
      loadReferRequests();
    });
  });
}
function rejectRefer(rid){ 
  if(!confirm('Reject referral request?')) return;
  db.ref('refer_cash_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');
    
    db.ref('refer_cash_requests/'+rid+'/status').set('rejected'); 
    alert('Referral request rejected');
    loadReferRequests();
  });
}


/* -------- KYC REQUESTS (FIXED to hide PAN number) -------- */
function loadKYCRequests(){
  db.ref('kyc_requests').once('value',snap=>{ 
    const data = snap.val()||{};
    const list = document.getElementById('kyc-requests'); list.innerHTML=''; 
    Object.keys(data).reverse().forEach(k=>{
      const r = data[k];
      db.ref('users/'+r.user).once('value').then(uSnap=>{
        const u = uSnap.val()||{};
        const statusText = r.status==='pending' ? 'Pending' : r.status==='verified' ? 'Verified' : r.status;
        const panNumberDisplay = r.number ? 'PAN: ***' + r.number.slice(-4) : 'PAN: N/A'; // Masked PAN
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <div style="display:flex;gap:12px">
            <div style="flex:1">
              <div><strong>KYC for: ${r.name || 'N/A'}</strong> • ${panNumberDisplay}</div>
              <div class="small">User: ${u.name || 'unknown'} • ${u.email || 'N/A'} • ${u.mobile || ''}</div>
              <div style="margin-top:10px;">
                <a href="${r.pan_photo || '#'}" target="_blank" class="badge">View PAN Photo</a>
                <span class="badge">Status: ${statusText}</span>
              </div>
            </div>
            ${r.status==='pending' 
              ? `<div style="display:flex;flex-direction:column;gap:5px;">
                 <button onclick="verifyKYC('${k}', '${r.user}', '${r.number}')" class="btn-approve">Verify</button>
                 <button onclick="rejectKYC('${k}', '${r.user}')" class="btn-reject">Reject</button>
                 </div>`
              : ''}
          </div>
        `;
        list.appendChild(card);
      });
    });
  });
}
function verifyKYC(rid, uid, panNumber){
  if(!confirm('Verify KYC for this user? (One time only)')) return;
  db.ref('kyc_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    db.ref('kyc_requests/'+rid+'/status').set('verified').then(()=>{
      db.ref('users/'+uid+'/kyc').set({status:'verified', number:panNumber, verified_at:Date.now(), kyc_id:rid});
      alert('KYC verified for user');
      loadKYCRequests();
    });
  });
}
function rejectKYC(rid, uid){
  if(!confirm('Reject KYC for this user?')) return;
  db.ref('kyc_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    db.ref('kyc_requests/'+rid+'/status').set('rejected').then(()=>{
      db.ref('users/'+uid+'/kyc').set({status:'rejected', kyc_id:rid, rejected_at:Date.now()});
      alert('KYC rejected for user');
      loadKYCRequests();
    });
  });
}

/* -------- LOAN REQUESTS (UPDATED EMI LOGIC) -------- */
function loadLoanRequests(){
  db.ref('loan_requests').once('value', snap=>{ 
    const data = snap.val()||{};
    const list = document.getElementById('loan-requests-list');
    list.innerHTML=''; 
    Object.keys(data).reverse().forEach(k=>{
      const r = data[k];
      db.ref('users/'+r.user).once('value').then(uSnap=>{
        const u = uSnap.val()||{};
        
        const approvedAmount = r.approved_amount || 0;
        const statusText = r.status==='pending' ? 'Pending Review' : r.status==='approved' ? `Approved (₹${approvedAmount})` : r.status==='rejected' ? 'Rejected' : r.status==='reviewed' ? `Offer Sent (₹${approvedAmount})` : r.status;
        const panNumberDisplay = r.panNumber ? 'PAN: ***' + r.panNumber.slice(-4) : 'PAN: N/A'; // Masked PAN
        const references = r.references ? r.references.map(ref => `${ref.name} (${ref.mobile})`).join(' | ') : 'N/A';

        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <strong>Loan Request: ₹${r.amount || 0}</strong> (ID: ${k})<br>
              <small>User: ${u.name || 'unknown'} • ${u.email || 'N/A'}</small><br>
              <small>Mobile: ${u.mobile || 'N/A'} | ${panNumberDisplay}</small><br>
              <small>Profession: ${r.profession || 'N/A'} | Income: ${r.income || 'N/A'}</small><br>
              <small>References: ${references}</small><br>
              <a href="${r.panPhotoUrl || '#'}" target="_blank" class="badge">View PAN Proof</a>
              <small class="meta">Status: ${statusText.toUpperCase()}</small>
              ${r.status!=='pending' ? `<div class="meta" style="margin-top:5px;">Approved EMI: ₹${r.emi_amount || 0} for ${r.emi_months || 0} Months</div>` : ''}
            </div>
            ${r.status==='pending'
              ? `<div class="loan-controls-grid">
                   <input type="number" id="loan-amt-${k}" placeholder="Amt to Approve" value="${r.amount || 0}" style="grid-column: span 2;">
                   <input type="number" id="loan-roi-${k}" placeholder="ROI (%)" value="12">
                   <input type="number" id="loan-tenure-${k}" placeholder="Tenure (Months)" value="6">
                   <input type="number" id="loan-fee-${k}" placeholder="Proc. Fee (₹)" value="100">
                   <input type="number" id="loan-insurance-${k}" placeholder="Insurance (₹)" value="0">
                   <textarea id="loan-custom-offer-msg-${k}" placeholder="Custom Offer Message (optional)" rows="2"></textarea>
                   <button onclick="sendLoanOffer('${k}', '${r.user}')" class="btn-approve">Send Offer</button>
                   <button onclick="rejectLoan('${k}', '${r.user}')" class="btn-reject">Reject Loan</button>
                 </div>`
              : `<span class="badge" style="background:${r.status==='approved' ? '#d0f0d0' : '#ffe0e0'}">${statusText}</span>`}
          </div>
        `;
        list.appendChild(card);
      });
    });
  });
}

function sendLoanOffer(rid, uid){
  const approvedAmount = document.getElementById(`loan-amt-${rid}`).value;
  const roi = document.getElementById(`loan-roi-${rid}`).value;
  const tenure = document.getElementById(`loan-tenure-${rid}`).value;
  const procFee = document.getElementById(`loan-fee-${rid}`).value;
  const insurance = document.getElementById(`loan-insurance-${rid}`).value;
  const customMessage = document.getElementById(`loan-custom-offer-msg-${rid}`).value;

  if(!approvedAmount || approvedAmount <= 0) return alert('Enter a valid approval amount.');
  if(!roi || roi <= 0) return alert('Enter a valid ROI.');
  if(!tenure || tenure <= 0 || tenure % 1 !== 0) return alert('Enter a valid tenure in whole months.');

  // Calculate Simple EMI/Interest (for user info, a proper app uses complex calculations)
  const totalInterest = (approvedAmount * roi * tenure) / 1200;
  const totalRepay = Number(approvedAmount) + totalInterest + Number(procFee) + Number(insurance);
  const emiAmount = (totalRepay / tenure).toFixed(2);
  const firstDueDate = Date.now() + (30 * 24 * 60 * 60 * 1000); // Rough 30 days from now

  if(!confirm(`Send offer: ₹${approvedAmount} | EMI: ₹${emiAmount} for ${tenure} months. Total Repayment: ₹${totalRepay.toFixed(2)}?`)) return;

  db.ref('loan_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending') return alert('Request already processed. Refresh the page.');

    // 1. Update Loan Request Status to 'reviewed' (offer sent, awaiting user acceptance)
    db.ref('loan_requests/'+rid).update({
        status: 'reviewed',
        approved_amount: Number(approvedAmount),
        roi: Number(roi),
        tenure_months: Number(tenure),
        processing_fee: Number(procFee),
        insurance_amount: Number(insurance),
        emi_amount: Number(emiAmount),
        emi_months: Number(tenure), // Using tenure as emi_months for clarity
        total_interest: totalInterest.toFixed(2),
        total_repayment: totalRepay.toFixed(2),
        first_due_date: firstDueDate,
        offer_sent_at: Date.now()
    });
    
    // 2. Update User's loan application status to 'reviewed'
    db.ref('users/'+uid+'/loan_application').set({
      id: rid,
      status: 'reviewed', // Offer sent, awaiting user acceptance
      approved_amount: Number(approvedAmount),
      emi_amount: Number(emiAmount),
      emi_months: Number(tenure),
      offer_sent_at: Date.now()
    });
    
    // 3. Send Notification to User
    const notifPayload = {
        title: `Loan Offer Ready: ₹${approvedAmount}`,
        body: customMessage || `Your loan offer of ₹${approvedAmount} is ready! EMI: ₹${emiAmount} for ${tenure} months. Review and accept now.`,
        target: uid,
        sent_at: Date.now(),
        sender: currentUser.email
    };
    db.ref('notifications').push(notifPayload);


    alert(`Loan Offer ${rid} sent to user. Awaiting acceptance.`);
    loadLoanRequests();
  });
}

function rejectLoan(rid, uid){
  if(!confirm('Reject loan request?')) return;

  db.ref('loan_requests/'+rid+'/status').once('value').then(snap => {
    if (snap.val() !== 'pending' && snap.val() !== 'reviewed') return alert('Request already processed. Refresh the page.');

    db.ref('loan_requests/'+rid+'/status').set('rejected');
    
    // Also update user's loan application status
    db.ref('users/'+uid+'/loan_application').set({id: rid, status: 'rejected', rejected_at: Date.now()});
    
    alert(`Loan request ${rid} rejected.`);
    loadLoanRequests();
  });
}
/* -------- END LOAN REQUESTS LOGIC -------- */


/* -------- NEW: EMI PAYMENT VERIFICATION LOGIC -------- */
function loadEmiPaymentRequests(){
  // Load payments marked as 'pending' with type 'emi_repayment'
  db.ref('payment_requests').orderByChild('type').equalTo('emi_repayment').once('value', snap=>{ 
    const data = snap.val()||{};
    const list = document.getElementById('emi-payment-requests');
    list.innerHTML=''; 
    
    // Filter only pending requests
    const pendingRequests = Object.entries(data).filter(([,r]) => r.status === 'pending');

    if(pendingRequests.length === 0) {
        list.innerHTML = '<div class="card">No pending EMI payment requests found.</div>';
        return;
    }

    pendingRequests.reverse().forEach(([k, r])=>{
      db.ref('users/'+r.user).once('value').then(uSnap=>{
        const u = uSnap.val()||{};
        
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <strong>EMI Repayment: ₹${r.amount}</strong> (UTR: ${r.utr})<br>
              <div class="emi-detail-item"><small>User: ${u.name || 'unknown'} • ${u.email || 'N/A'}</small></div>
              <div class="emi-detail-item"><small>EMI ID: ${r.emiId}</small></div>
              <div class="emi-detail-item"><small>Date: ${new Date(r.created_at).toLocaleString()}</small></div>
              <div class="emi-detail-item"><small>Status: **PENDING VERIFICATION**</small></div>
              ${r.screenshotUrl ? `<a href="${r.screenshotUrl}" target="_blank" class="badge" style="margin-top:5px;">View Payment Screenshot</a>` : ''}
            </div>
            <div style="display:flex;flex-direction:column;gap:5px;">
                 <button onclick="verifyEmiPayment('${k}', '${r.user}', '${r.emiId}')" class="btn-approve">Verify & Mark Paid</button>
                 <button onclick="markLatePayment('${k}', '${r.user}', '${r.emiId}')" class="primary" style="background:#ffc700; margin-left:0;">Mark Late & Paid</button>
                 <button onclick="rejectEmiPayment('${k}', '${r.user}', '${r.emiId}')" class="btn-reject" style="margin-left:0;">Reject UTR</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    });
  });
}

function verifyEmiPayment(pid, uid, emiId) {
    if(!confirm('Confirm EMI payment is verified and mark the EMI as PAID?')) return;

    db.ref('payment_requests/'+pid+'/status').set('completed');
    
    // Update user's EMI status to 'paid'
    db.ref('users/'+uid+'/loan_emis/'+emiId+'/status').set('paid');
    db.ref('users/'+uid+'/loan_emis/'+emiId+'/paid_at').set(Date.now());
    
    alert('EMI payment verified and marked as PAID.');
    loadEmiPaymentRequests();
    loadStats(); // Update stats
}

function markLatePayment(pid, uid, emiId) {
    if(!confirm('Confirm EMI payment is verified but late, and mark the EMI as PAID (Late)?')) return;
    
    // In a real system, this would apply late fee. Here we just mark status.
    db.ref('payment_requests/'+pid+'/status').set('completed_late');
    
    // Update user's EMI status to 'paid_late'
    db.ref('users/'+uid+'/loan_emis/'+emiId+'/status').set('paid_late');
    db.ref('users/'+uid+'/loan_emis/'+emiId+'/paid_at').set(Date.now());
    
    alert('EMI payment verified and marked as PAID (Late).');
    loadEmiPaymentRequests();
}

function rejectEmiPayment(pid, uid, emiId) {
    if(!confirm('Reject this EMI payment? (The user must re-submit or contact support)')) return;
    
    db.ref('payment_requests/'+pid+'/status').set('rejected');
    
    // Revert user's EMI status to 'overdue' or 'due'
    db.ref('users/'+uid+'/loan_emis/'+emiId).once('value').then(snap => {
        const emi = snap.val();
        if (emi.due_date < Date.now()) {
             db.ref('users/'+uid+'/loan_emis/'+emiId+'/status').set('overdue');
        } else {
             db.ref('users/'+uid+'/loan_emis/'+emiId+'/status').set('due');
        }
    });

    alert('EMI payment rejected.');
    loadEmiPaymentRequests();
}
/* -------- END EMI PAYMENT VERIFICATION LOGIC -------- */


/* -------- SUPPORT/CHAT MESSAGES (Enhanced with Reply) -------- */
function loadSupportMessages(){
  db.ref('support_messages').once('value', snap=>{ 
    const data = snap.val()||{};
    const list = document.getElementById('support-messages-list');
    list.innerHTML=''; 

    Object.keys(data).reverse().forEach(k=>{
      const r = data[k];
      db.ref('users/'+r.user).once('value').then(uSnap=>{
        const u = uSnap.val()||{};
        
        const statusText = r.status==='new' ? 'NEW' : r.status==='resolved' ? 'RESOLVED' : r.status;
        
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <strong>${r.subject || 'No Subject'}</strong><br>
              <div class="small">User: ${u.name || 'unknown'} • ${u.email || 'N/A'} • ${u.mobile || ''} (UID: ${r.user})</div>
              <div class="chat-message">User Message: ${r.message}</div>
              <small class="meta">Status: ${statusText}</small>
              
              <div class="admin-reply-container">
                <textarea id="admin-reply-${k}" placeholder="Type your reply to the user..."></textarea>
                <button onclick="sendAdminReply('${r.user}', '${k}')" class="primary" style="padding: 8px; margin: 0; align-self: stretch; width: 80px;">Reply</button>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
              ${r.status!=='resolved'
                ? `<button onclick="markSupportResolved('${k}')" class="btn-approve">Mark Resolved</button>`
                : `<span class="badge" style="background:#e8f5e9">Resolved ✓</span>`}
              <a href="https://wa.me/91${u.mobile}" target="_blank" style="text-align:center;text-decoration:none;padding:5px 8px;border-radius:8px;background:#25d366;color:white;font-size:12px;font-weight:600;">Reply (WhatsApp)</a>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    });
  });
}

function sendAdminReply(uid, messageId) {
    const replyTextarea = document.getElementById(`admin-reply-${messageId}`);
    const message = replyTextarea.value.trim();

    if (!message) return alert('Please enter a reply message.');

    const adminMessage = {
        id: 'adm'+Date.now(),
        sender: 'admin',
        message: message,
        created_at: Date.now()
    };
    
    // We'll use the 'chat_support' node from the user's snippet for 2-way chat
    db.ref('chat_support/'+uid).push(adminMessage).then(() => {
        // Also update the support message status to 'replied' or 'in_progress'
        db.ref('support_messages/'+messageId+'/status').set('in_progress'); 
        db.ref('support_messages/'+messageId+'/last_reply_at').set(Date.now());
        
        replyTextarea.value = '';
        alert('Reply sent to user via in-app chat.');
        loadSupportMessages();
    }).catch(e => {
        alert('Failed to send reply.');
        console.error(e);
    });
}

function markSupportResolved(mid){
  if(!confirm('Mark this support message as resolved?')) return;
  db.ref('support_messages/'+mid+'/status').set('resolved').then(()=>{
    alert('Message marked as resolved');
    loadSupportMessages();
  });
}

/* -------- NEW: EARN MONEY SECTION LOGIC -------- */
async function addEarnMoneyOpportunity() {
    const title = document.getElementById('em-title').value.trim();
    const price = parseFloat(document.getElementById('em-price').value);
    const desc = document.getElementById('em-desc').value.trim();
    const imageFile = document.getElementById('em-image').files[0];

    if (!title || isNaN(price) || price <= 0 || !desc || !imageFile) {
        return alert('Please fill all fields and select an image.');
    }

    showPreloader();
    try {
        const imageUrl = await uploadImg(imageFile);
        const newOppRef = db.ref('earn_money').push();
        
        await newOppRef.set({ title, price, description: desc, image: imageUrl, createdAt: Date.now(), is_active: true });

        alert(`Earn Money Opportunity "${title}" posted successfully!`);
        document.getElementById('em-title').value = '';
        document.getElementById('em-price').value = '';
        document.getElementById('em-desc').value = '';
        document.getElementById('em-image').value = '';
        loadEarnMoneyOpportunities(); 

    } catch(e) {
        console.error('Error adding earn money opportunity:', e);
        alert('Failed to post opportunity.');
    } finally {
        hidePreloader();
    }
}

function loadEarnMoneyOpportunities(){
    db.ref('earn_money').on('value', snap=>{
        const data = snap.val()||{};
        const list = document.getElementById('earn-money-list');
        list.innerHTML = '';
        Object.keys(data).reverse().forEach(k=>{
            const opp = data[k];
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `
                <img src="${opp.image}" class="thumb" alt="${opp.title}"/>
                <div style="margin-top:8px">
                    <strong>${opp.title}</strong>
                    <div class="meta">Earning: ₹${opp.price}</div>
                    <div class="meta">${opp.description.substring(0, 50)}...</div>
                    <div class="row">
                        <button onclick="toggleOpportunityStatus('${k}', ${opp.is_active})" class="primary" style="padding:5px 8px; font-size:12px; margin-top:5px; background:${opp.is_active ? '#4CAF50' : '#f44336'};">
                            ${opp.is_active ? 'Disable' : 'Enable'}
                        </button>
                        <button onclick="deleteOpportunity('${k}')" class="btn-reject" style="padding:5px 8px; font-size:12px; margin-left:0; margin-top:5px;">Delete</button>
                    </div>
                </div>
            `;
            list.appendChild(card);
        });
    });
}

function toggleOpportunityStatus(key, isActive) {
    db.ref('earn_money/' + key).update({ is_active: !isActive })
        .then(() => alert(`Opportunity status toggled to ${!isActive ? 'Active' : 'Disabled'}.`))
        .catch(e => console.error('Error toggling status:', e));
}

function deleteOpportunity(key) {
    if(!confirm('Are you sure you want to delete this opportunity?')) return;
    db.ref('earn_money/' + key).remove()
        .then(() => alert('Opportunity deleted.'))
        .catch(e => console.error('Error deleting opportunity:', e));
}
/* -------- END EARN MONEY SECTION LOGIC -------- */


/* -------- NEW: OFFERS & COUPONS LOGIC -------- */
function generateCouponCode(prefix) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = prefix.toUpperCase();
    for (let i = 0; i < (8 - prefix.length); i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

function generateAndSaveCoupon() {
    const prefix = document.getElementById('coupon-prefix').value.trim() || 'GOLD';
    const amount = parseFloat(document.getElementById('coupon-amount').value);
    const minOrder = parseFloat(document.getElementById('coupon-min-order').value) || 0;
    const type = document.getElementById('coupon-type').value;
    const expiryDate = document.getElementById('coupon-expiry').value;

    if (isNaN(amount) || amount <= 0) return alert('Enter a valid discount amount.');
    if (!expiryDate) return alert('Please select an expiry date.');

    const couponCode = generateCouponCode(prefix.substring(0, 4));
    
    if (!confirm(`Generate coupon code ${couponCode} for ${amount} ${type === 'percent' ? '%' : '₹'} off?`)) return;

    showPreloader();
    db.ref('coupons/' + couponCode).set({
        code: couponCode,
        discount_type: type, // 'fixed' or 'percent'
        discount_amount: amount,
        min_order: minOrder,
        expiry_date: new Date(expiryDate).getTime(),
        is_active: true,
        created_at: Date.now(),
        uses: 0
    }).then(() => {
        alert(`Coupon ${couponCode} created and saved!`);
        document.getElementById('coupon-prefix').value = '';
        document.getElementById('coupon-amount').value = '';
        document.getElementById('coupon-min-order').value = '';
        document.getElementById('coupon-expiry').value = '';
        loadCoupons();
    }).catch(e => {
        console.error('Error saving coupon:', e);
        alert('Failed to save coupon.');
    }).finally(() => hidePreloader());
}

function loadCoupons(){
    db.ref('coupons').on('value', snap=>{
        const data = snap.val()||{};
        const list = document.getElementById('coupon-list');
        list.innerHTML = '';
        Object.keys(data).reverse().forEach(k=>{
            const c = data[k];
            const expiry = new Date(c.expiry_date).toLocaleDateString();
            const discountText = c.discount_type === 'percent' ? `${c.discount_amount}% OFF` : `₹${c.discount_amount} OFF`;
            
            const item = document.createElement('div'); item.className = 'card coupon-item';
            item.innerHTML = `
                <div>
                    <span class="coupon-code">${c.code}</span>
                    <div class="meta">${discountText} (Min Order: ₹${c.min_order})</div>
                    <div class="meta">Expires: ${expiry} | Used: ${c.uses || 0}</div>
                </div>
                <div>
                    <button onclick="toggleCouponStatus('${c.code}', ${c.is_active})" class="primary" style="padding:5px 8px; font-size:12px; margin-top:0; background:${c.is_active ? '#4CAF50' : '#f44336'};">
                        ${c.is_active ? 'Disable' : 'Enable'}
                    </button>
                    <button onclick="deleteCoupon('${c.code}')" class="btn-reject" style="padding:5px 8px; font-size:12px; margin-left:5px; margin-top:0;">Delete</button>
                </div>
            `;
            list.appendChild(item);
        });
    });
}

function toggleCouponStatus(code, isActive) {
    db.ref('coupons/' + code).update({ is_active: !isActive })
        .then(() => alert(`Coupon ${code} status toggled to ${!isActive ? 'Active' : 'Disabled'}.`))
        .catch(e => console.error('Error toggling status:', e));
}

function deleteCoupon(code) {
    if(!confirm(`Are you sure you want to delete coupon ${code}?`)) return;
    db.ref('coupons/' + code).remove()
        .then(() => alert('Coupon deleted.'))
        .catch(e => console.error('Error deleting coupon:', e));
}
/* -------- END OFFERS & COUPONS LOGIC -------- */


/* -------- NEW: NOTIFICATION LOGIC (DATA ONLY) -------- */
function sendNotification(){
    const target = document.getElementById('notif-target').value;
    const title = document.getElementById('notif-title').value.trim();
    const body = document.getElementById('notif-body').value.trim();

    if (!title || !body) return alert('Title and Message body are required.');

    const notif = {
        title,
        body,
        target, // 'all' or a specific UID
        sent_at: Date.now(),
        sender: currentUser.email
    };

    if (target === 'all') {
        if (!confirm('Confirm sending this notification to ALL users?')) return;
        // In a real app, this would trigger an FCM HTTP request
        // For now, we save it to the database
        db.ref('notifications').push(notif).then(() => {
            alert('Notification saved for ALL users (FCM send logic must be handled server-side).');
            document.getElementById('notif-title').value = '';
            document.getElementById('notif-body').value = '';
            loadRecentNotifications();
        });
    } else {
        // Individual notification logic (often not used in this way)
        alert('Individual notification feature is not fully developed. Sending to all is recommended for now.');
    }
}

function loadRecentNotifications(){
    db.ref('notifications').limitToLast(10).once('value', snap=>{
        const data = snap.val()||{};
        const list = document.getElementById('recent-notifications-list');
        list.innerHTML = '';
        
        Object.keys(data).reverse().forEach(k=>{
            const n = data[k];
            const time = new Date(n.sent_at).toLocaleString();
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `
                <div>
                    <strong>${n.title}</strong>
                    <div class="small">${n.body}</div>
                    <div class="meta">Target: ${n.target === 'all' ? 'All Users' : n.target} | Sent: ${time}</div>
                </div>
            `;
            list.appendChild(card);
        });
    });
}
/* -------- END NOTIFICATION LOGIC -------- */


/* -------- REALTIME LISTENERS -------- */
function listenRealtimeChanges(){
  db.ref('orders').on('value', snap => {
    allOrdersData = snap.val() || {};
    loadStats(); // Update stats
    renderOrders(); // Re-render with current filters
  }); 
  db.ref('gold_settings/current_rate').on('value', ()=> { loadGoldRate(); });
  db.ref('wallet_requests').on('value', ()=> { loadStats(); }); // Update stats on new request
  db.ref('withdraw_requests').on('value', ()=> { loadStats(); }); // Update stats on new request
}

/* -------- INITIAL calls to populate UI (safe) -------- */
populateCategorySelect();

</script>
</body>
</html>

