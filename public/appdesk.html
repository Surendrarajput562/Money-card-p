<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ЁЯСС Admin Console - App & Payment Management</title>
    <style>
        /* CSS Styles */
        body { font-family: 'Arial', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 30px; }
        .tab-menu { display: flex; justify-content: center; margin-bottom: 25px; border-bottom: 2px solid #eee; }
        .tab-menu button { background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 16px; font-weight: bold; color: #555; transition: all 0.3s; }
        .tab-menu button.active { color: #007bff; border-bottom: 3px solid #007bff; }
        .tab-content { padding: 20px 0; }
        fieldset { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        legend { font-size: 1.2em; font-weight: bold; color: #333; padding: 0 10px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="email"], input[type="password"], textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        input[type="file"] { margin-top: 10px; }
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #218838; }
        button:disabled { background-color: #999; cursor: not-allowed; }
        #upload-status, #verification-message, #auth-status, #history-status, #app-status { margin-top: 15px; padding: 10px; border-radius: 4px; font-weight: bold; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 14px; }
        table th { background-color: #007bff; color: white; }
        .action-btn { background-color: #ffc107; color: #333; padding: 6px 10px; margin-right: 5px; font-size: 14px; border: none; border-radius: 3px; cursor: pointer; }
        .action-btn.approve { background-color: #28a745; color: white; }
        .action-btn.reject { background-color: #dc3545; color: white; }
        .action-btn.edit { background-color: #17a2b8; color: white; }
        .action-btn.delete { background-color: #dc3545; color: white; }

        /* App Cards for Management */
        #apps-management-list { display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 20px; padding: 10px; }
        .app-manage-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 15px; width: 300px; }
        .app-manage-card h4 { margin-top: 0; color: #007bff; }
        .app-manage-card img { width: 60px; height: 60px; border-radius: 12px; margin-right: 10px; float: left; }
        .app-manage-card .details { overflow: hidden; }
        .app-manage-card .actions { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }

        /* Login Page Styling */
        #login-page { max-width: 400px; margin: 100px auto; padding: 40px; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .google-btn { background-color: #db4437; color: white; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div id="login-page">
    <h2>ЁЯФС рдПрдбрдорд┐рди рд▓реЙрдЧ рдЗрди</h2>
    <div id="auth-status" style="margin-bottom: 20px;"></div>

    <fieldset>
        <legend>рдИрдореЗрд▓ рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб</legend>
        <label for="login-email">рдИрдореЗрд▓:</label>
        <input type="email" id="login-email" required>
        <label for="login-password">рдкрд╛рд╕рд╡рд░реНрдб:</label>
        <input type="password" id="login-password" required>
        <button onclick="emailPasswordLogin()">рд▓реЙрдЧ рдЗрди рдХрд░реЗрдВ</button>
    </fieldset>

    <fieldset style="margin-top: 20px;">
        <legend>рдпрд╛</legend>
        <button class="google-btn" onclick="googleLogin()">
            <i class="ri-google-fill" style="font-style: normal; margin-right: 10px;"></i> Google рд╕реЗ рд▓реЙрдЧ рдЗрди рдХрд░реЗрдВ
        </button>
    </fieldset>
</div>


<div class="container" id="main-admin-console" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>ЁЯСС рдПрдбрдорд┐рди рдХрдВрд╕реЛрд▓</h1>
        <button onclick="adminLogout()">ЁЯЪк рд▓реЙрдЧрдЖрдЙрдЯ</button>
    </div>

    <div class="tab-menu">
        <button id="tab-upload" class="active" onclick="openTab('upload')">тЮХ рдирдпрд╛ рдРрдк рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ</button>
        <button id="tab-apps" onclick="openTab('apps')">ЁЯТ╛ рдРрдкреНрд╕ рдкреНрд░рдмрдВрдзрди</button> <button id="tab-verify" onclick="openTab('verify')">тЬЕ рдкреЗрдореЗрдВрдЯ рд╕рддреНрдпрд╛рдкрди</button>
        <button id="tab-history" onclick="openTab('history')">ЁЯУЬ рдкреЗрдореЗрдВрдЯ рд╣рд┐рд╕реНрдЯреНрд░реА</button> <button id="tab-moderation" onclick="openTab('moderation')">ЁЯТм рд░рд┐рд╡реНрдпреВ рдореЙрдбрд░реЗрдЯ рдХрд░реЗрдВ</button>
    </div>

    <div id="upload" class="tab-content">
        <h2>ЁЯЪА рдРрдк рд╕рдмрдорд┐рд╢рди рдлреНрд▓реЛ</h2>
        <form id="app-upload-form">
            <div class="step open" id="shatter-1">
                <div class="step-header" onclick="toggleShatter(1)">1. рдРрдк рд╡рд┐рд╡рд░рдг <span id="arrow-1">тЦ╢</span></div>
                <div class="step-body"><fieldset>
                    <label for="app-name">рдРрдк рдХрд╛ рдирд╛рдо:</label><input type="text" id="app-name" required>
                    <label for="app-category">рдХреИрдЯреЗрдЧрд░реА:</label><select id="app-category" required><option value="">-- рдЪреБрдиреЗрдВ --</option></select>
                    <label for="app-short-desc">рдЫреЛрдЯрд╛ рд╡рд┐рд╡рд░рдг (Max 80):</label><textarea id="app-short-desc" rows="2" maxlength="80" required></textarea>
                    <label for="app-full-desc">рдкреВрд░рд╛ рд╡рд┐рд╡рд░рдг:</label><textarea id="app-full-desc" rows="5" required></textarea>
                    <button type="button" onclick="nextShatter(1, 2)">рдЖрдЧреЗ рдмрдврд╝реЗрдВ</button>
                </fieldset></div>
            </div>
            <div class="step" id="shatter-2">
                <div class="step-header" onclick="toggleShatter(2)">2. рдореАрдбрд┐рдпрд╛ рдФрд░ рдлрд╝рд╛рдЗрд▓ рдЕрдкрд▓реЛрдб <span id="arrow-2">тЦ╢</span></div>
                <div class="step-body"><fieldset>
                    <label for="app-icon-file">рдРрдк рдЖрдЗрдХреЙрди (R2/ImgBB):</label><input type="file" id="app-icon-file" accept="image/*" required>
                    <label for="app-screenshots-files">рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ (Max 8):</label><input type="file" id="app-screenshots-files" accept="image/*" multiple required>
                    <label for="app-apk-file">APK рдлрд╝рд╛рдЗрд▓ (R2):</label><input type="file" id="app-apk-file" accept=".apk" required>
                    <label for="cover-upload-target">Icon Upload Target:</label><select id="cover-upload-target"><option value="r2">R2 (Recommended)</option><option value="imgbb">ImgBB</option></select>
                    <button type="button" onclick="nextShatter(2, 3)">рдЖрдЧреЗ рдмрдврд╝реЗрдВ</button>
                </fieldset></div>
            </div>
            <div class="step" id="shatter-3">
                <div class="step-header" onclick="toggleShatter(3)">3. рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рдг рдФрд░ рдкрдмреНрд▓рд┐рд╢ <span id="arrow-3">тЦ╢</span></div>
                <div class="step-body"><fieldset>
                    <legend>рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рдг</legend>
                    <label for="app-type">рдРрдк рдХрд╛ рдкреНрд░рдХрд╛рд░:</label><select id="app-type" required onchange="togglePricingFields()"><option value="Free">рдлреНрд░реА</option><option value="Paid">рдкреЗрдб (рдПрдХрдореБрд╢реНрдд)</option><option value="Subscription">рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди</option></select>
                    <div id="paid-fields" style="display:none;"><label for="app-price">рдРрдк рдХреАрдордд (тВ╣):</label><input type="number" id="app-price" min="1" value="100"><label for="upi-qr-code-url">UPI QR Code URL (Payment QR):</label><input type="text" id="upi-qr-code-url" value="https://i.ibb.co/CKTVnyGq/Screenshot-20251126-043755-GPay-Business.jpg" required></div>
                    <div id="subscription-fields" style="display:none;"><label for="sub-monthly">рдорд╛рд╕рд┐рдХ рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди (тВ╣):</label><input type="number" id="sub-monthly" min="1" value="50"><label for="sub-yearly">рд╡рд╛рд░реНрд╖рд┐рдХ рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди (тВ╣):</label><input type="number" id="sub-yearly" min="1" value="500"></div>
                    <button type="submit" id="upload-app-btn">ЁЯФе рдРрдк рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ рдФрд░ рдкрдмреНрд▓рд┐рд╢ рдХрд░реЗрдВ</button>
                    <p id="upload-status"></p>
                </fieldset></div>
            </div>
        </form>
    </div>

    <div id="apps" class="tab-content" style="display:none;">
        <h2>ЁЯТ╛ рд╕рднреА рдРрдкреНрд╕ рдХрд╛ рдкреНрд░рдмрдВрдзрди</h2>
        <p id="app-status">рдРрдкреНрд╕ рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...</p>
        <button onclick="loadAppsForManagement()">ЁЯФД рдРрдкреНрд╕ рд▓реЛрдб рдХрд░реЗрдВ</button>
        <div id="apps-management-list">
            </div>

        <div id="edit-app-modal" class="modal" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div class="modal-content" style="background: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 700px;">
                <span style="float: right; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="closeEditModal()">&times;</span>
                <h3>рдРрдк рдПрдбрд┐рдЯ рдХрд░реЗрдВ: <span id="edit-app-name-title"></span></h3>
                <form id="edit-app-form">
                    <input type="hidden" id="edit-app-id">
                    
                    <fieldset>
                        <legend>рд╡рд┐рд╡рд░рдг</legend>
                        <label for="edit-name">рдирд╛рдо:</label><input type="text" id="edit-name" required>
                        <label for="edit-category">рдХреИрдЯреЗрдЧрд░реА:</label><select id="edit-category" required></select>
                        <label for="edit-shortDesc">рдЫреЛрдЯрд╛ рд╡рд┐рд╡рд░рдг:</label><textarea id="edit-shortDesc" rows="2" required></textarea>
                        <label for="edit-fullDesc">рдкреВрд░рд╛ рд╡рд┐рд╡рд░рдг:</label><textarea id="edit-fullDesc" rows="5" required></textarea>
                    </fieldset>
                    
                    <fieldset>
                        <legend>рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рдг</legend>
                        <label for="edit-type">рдРрдк рдХрд╛ рдкреНрд░рдХрд╛рд░:</label><select id="edit-type" required onchange="toggleEditPricingFields()">
                            <option value="Free">рдлреНрд░реА</option><option value="Paid">рдкреЗрдб (рдПрдХрдореБрд╢реНрдд)</option><option value="Subscription">рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди</option>
                        </select>
                        <div id="edit-paid-fields"><label for="edit-price">рдРрдк рдХреАрдордд (тВ╣):</label><input type="number" id="edit-price" min="0"></div>
                        <div id="edit-subscription-fields" style="display:none;"><label for="edit-subMonthly">рдорд╛рд╕рд┐рдХ (тВ╣):</label><input type="number" id="edit-subMonthly" min="0"></div>
                        <label for="edit-qrUrl">UPI QR URL:</label><input type="text" id="edit-qrUrl">
                    </fieldset>

                    <fieldset>
                        <legend>рдореАрдбрд┐рдпрд╛/рдлрд╝рд╛рдЗрд▓ рдЕрдкрдбреЗрдЯ (рдХреЗрд╡рд▓ рдирдИ рдлрд╝рд╛рдЗрд▓ рдЪреБрдирдиреЗ рдкрд░ рдЕрдкрдбреЗрдЯ рд╣реЛрдЧрд╛)</legend>
                        <p>рдХрд░рдВрдЯ рдЖрдЗрдХреЙрди: <img id="current-icon" style="width: 50px; height: 50px; border-radius: 10px;"></p>
                        <label for="edit-icon-file">рдирдпрд╛ рдРрдк рдЖрдЗрдХреЙрди:</label><input type="file" id="edit-icon-file" accept="image/*">
                        <label for="edit-apk-file">рдирдпрд╛ APK рдлрд╝рд╛рдЗрд▓:</label><input type="file" id="edit-apk-file" accept=".apk">
                        <label for="edit-screenshots-files">рдирдП рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ (рд╕рднреА рдкреБрд░рд╛рдиреЗ рд╣рдЯ рдЬрд╛рдПрдВрдЧреЗ):</label><input type="file" id="edit-screenshots-files" accept="image/*" multiple>
                    </fieldset>
                    
                    <button type="submit">тЬЕ рдЕрдкрдбреЗрдЯ рдФрд░ рд╕реЗрд╡ рдХрд░реЗрдВ</button>
                </form>
            </div>
        </div>
    </div>


    <div id="verify" class="tab-content" style="display:none;">
        <h2>ЁЯТ│ UTR рдкреЗрдореЗрдВрдЯ рд╕рддреНрдпрд╛рдкрди</h2>
        <p id="verification-message">рдпрд╣рд╛рдВ рдкреЗрдВрдбрд┐рдВрдЧ рдкреЗрдореЗрдВрдЯреНрд╕ рдХреА рд╕реВрдЪреА рджрд┐рдЦреЗрдЧреАред</p>
        <button onclick="loadPendingPayments()">ЁЯФД рдкреЗрдВрдбрд┐рдВрдЧ рдкреЗрдореЗрдВрдЯреНрд╕ рд▓реЛрдб рдХрд░реЗрдВ</button>
        <table id="pending-payments-list">
            <thead>
                <tr>
                    <th>UTR</th>
                    <th>рдРрдк</th>
                    <th>рд░рд╛рд╢рд┐</th>
                    <th>рдпреВрдЬрд░ ID</th>
                    <th>рд╕реНрдерд┐рддрд┐</th>
                    <th>рдПрдХреНрд╢рди</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div id="history" class="tab-content" style="display:none;">
        <h2>ЁЯУЬ рдкреЗрдореЗрдВрдЯ рд╣рд┐рд╕реНрдЯреНрд░реА</h2>
        <p id="history-status">рдЕрдкреНрд░реВрд╡ рдФрд░ рд░рд┐рдЬреЗрдХреНрдЯреЗрдб рдкреЗрдореЗрдВрдЯреНрд╕ рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...</p>
        <button onclick="loadPaymentHistory()">ЁЯФД рд╣рд┐рд╕реНрдЯреНрд░реА рд▓реЛрдб рдХрд░реЗрдВ</button>
        <table id="payment-history-list">
            <thead>
                <tr>
                    <th>UTR</th>
                    <th>рдРрдк</th>
                    <th>рд░рд╛рд╢рд┐</th>
                    <th>рдпреВрдЬрд░ ID</th>
                    <th>рд╕реНрдЯреЗрдЯрд╕</th>
                    <th>рд╡реЗрд░реАрдлрд╛рдИрдб</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div id="moderation" class="tab-content" style="display:none;">
        <h2>ЁЯТм рд░рд┐рд╡реНрдпреВ рдореЙрдбрд░реЗрд╢рди</h2>
        <p id="review-moderation-message">рд╕рднреА рдирд╡реАрдирддрдо рд░рд┐рд╡реНрдпреВрдЬ рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...</p>
        <button onclick="loadReviews()">ЁЯФД рд░рд┐рд╡реНрдпреВрдЬ рд▓реЛрдб рдХрд░реЗрдВ</button>
        <div id="reviews-list">
            </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
        authDomain: "smbrand-4543a.firebaseapp.com",
        databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
        projectId: "smbrand-4543a",
        storageBucket: "smbrand-4543a.firebasestorage.app",
        messagingSenderId: "720775550032",
        appId: "1:720775550032:web:0622548a007597778bad55",
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const auth = firebase.auth();

    const imgbbKey = '021a2437b889915669b66554687bf17f';
    const R2_WORKER_URL = 'https://cold-snow-e955.surendrarathode040.workers.dev';
    let allApps = []; // Global storage for app management
    
    // --- AUTHENTICATION & UI CONTROL (Unchanged) ---
    function showLoginPage() {
        document.getElementById('login-page').style.display = 'block';
        document.getElementById('main-admin-console').style.display = 'none';
    }

    function showAdminConsole() {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('main-admin-console').style.display = 'block';
        loadCategories(); 
        openTab('upload'); 
    }
    
    async function checkAdminAccess(user) { /* ... Auth Logic ... */ 
        const statusDiv = document.getElementById('auth-status');
        statusDiv.innerHTML = '';
        
        if (!user) {
            showLoginPage();
            return;
        }

        try {
            statusDiv.innerHTML = 'рдПрдХреНрд╕реЗрд╕ рдХреА рдЬрд╛рдБрдЪ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ...';
            const adminEmailRef = db.ref('ADMIN_CONTROL_LISTS/adminEmail');
            const snapshot = await adminEmailRef.once('value');
            const primaryAdminEmail = snapshot.val();

            if (user.email === primaryAdminEmail) {
                statusDiv.innerHTML = `<p class="success">рд╕рдлрд▓рддрд╛! рдПрдбрдорд┐рди рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдЧ рдЗрди: ${user.email}</p>`;
                showAdminConsole();
            } else {
                statusDiv.innerHTML = `<p class="error">рдПрдХреНрд╕реЗрд╕ рдЕрд╕реНрд╡реАрдХреГрдд: рдпрд╣ рдХрдВрд╕реЛрд▓ рдХреЗрд╡рд▓ рдкреНрд░рд╛рдЗрдорд░реА рдПрдбрдорд┐рди (${primaryAdminEmail}) рдХреЗ рд▓рд┐рдП рд╣реИред</p>`;
                auth.signOut(); 
                showLoginPage();
            }
        } catch (error) {
            console.error("Error checking admin email:", error);
            statusDiv.innerHTML = `<p class="error">Database Error: рдПрдбрдорд┐рди рдИрдореЗрд▓ рд▓реЛрдб рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛ред ${error.message}</p>`;
            auth.signOut();
            showLoginPage();
        }
    }
    
    async function emailPasswordLogin() { /* ... Auth Logic ... */ 
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const statusDiv = document.getElementById('auth-status');
        statusDiv.innerHTML = 'рд▓реЙрдЧ рдЗрди рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...';

        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            statusDiv.innerHTML = `<p class="error">рд▓реЙрдЧ рдЗрди рд╡рд┐рдлрд▓: ${error.message}</p>`;
        }
    }
    async function googleLogin() { /* ... Auth Logic ... */
        const provider = new firebase.auth.GoogleAuthProvider();
        const statusDiv = document.getElementById('auth-status');
        statusDiv.innerHTML = 'Google рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...';

        try {
            await auth.signInWithPopup(provider);
        } catch (error) {
            statusDiv.innerHTML = `<p class="error">Google рд▓реЙрдЧ рдЗрди рд╡рд┐рдлрд▓: ${error.message}</p>`;
        }
     }
    function adminLogout() { auth.signOut(); alert('рдЖрдк рд▓реЙрдЧрдЖрдЙрдЯ рд╣реЛ рдЧрдП рд╣реИрдВред'); }

    // --- UPLOAD UTILITIES (Unchanged) ---
    async function uploadImgbb(file){ /* ... ImgBB Logic ... */
        const base64Image = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
        const form = new FormData();
        form.append('image', base64Image);
        const res = await axios.post(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, form);
        return res.data.data.url;
    }

    async function uploadR2(file, prefix){ /* ... R2 Logic ... */
        const fd = new FormData();
        fd.append("file", file, file.name);
        fd.append("prefix", prefix);

        const resp = await fetch(R2_WORKER_URL, { method: "POST", body: fd });

        if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`R2 Upload failed. Status: ${resp.status}. Response: ${text}`);
        }
        const json = await resp.json();
        if (json.publicURL) {
            return json.publicURL;
        } else {
            throw new Error('R2 Worker did not return public URL.');
        }
    }
    
    // --- SHATTER UI LOGIC (Unchanged) ---
    function toggleShatter(stepNum) {
        const shatter = document.getElementById(`shatter-${stepNum}`);
        shatter.classList.toggle('open');
    }

    function nextShatter(current, next) {
        const currentShatter = document.getElementById(`shatter-${current}`);
        const requiredInputs = currentShatter.querySelectorAll('[required]');
        let isValid = true;
        requiredInputs.forEach(input => {
            if (!input.value || (input.type === 'file' && input.files.length === 0)) {
                isValid = false;
                input.style.borderColor = 'red';
            } else {
                input.style.borderColor = '#ccc';
            }
        });

        if (isValid) {
            document.getElementById(`shatter-${current}`).classList.remove('open');
            document.getElementById(`shatter-${next}`).classList.add('open');
        } else {
            alert('рдХреГрдкрдпрд╛ рд╕рднреА рдЖрд╡рд╢реНрдпрдХ рдлрд╝реАрд▓реНрдб рднрд░реЗрдВ/рдлрд╝рд╛рдЗрд▓реЗрдВ рдЪреБрдиреЗрдВред');
        }
    }
    
    // --- TAB SWITCHING AND PRICING TOGGLE (Updated for new tabs) ---
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-menu button').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).style.display = 'block';
        document.getElementById('tab-' + tabName).classList.add('active');
        
        if (tabName === 'verify') { loadPendingPayments(); }
        if (tabName === 'history') { loadPaymentHistory(); } // New call
        if (tabName === 'apps') { loadAppsForManagement(); } // New call
        if (tabName === 'moderation') { loadReviews(); }
    }

    function togglePricingFields() { /* ... Logic ... */
        const appType = document.getElementById('app-type').value;
        document.getElementById('paid-fields').style.display = (appType === 'Paid') ? 'block' : 'none';
        document.getElementById('subscription-fields').style.display = (appType === 'Subscription') ? 'block' : 'none';
    }

    // --- CATEGORY LOADING (Modified to populate edit modal as well) ---
    async function loadCategories() {
        try {
            const categorySelects = document.querySelectorAll('#app-category, #edit-category');
            categorySelects.forEach(select => select.querySelectorAll('option:not([value=""])').forEach(option => option.remove()));

            const allCategoriesSnapshot = await db.ref('APP_STORE_CATEGORIES').once('value');
            const allCategories = allCategoriesSnapshot.val();

            if (allCategories) {
                Object.keys(allCategories).forEach(majorCat => {
                    const subCats = allCategories[majorCat];
                    if (typeof subCats === 'object' && subCats !== null) {
                        Object.keys(subCats).forEach(subCat => {
                            categorySelects.forEach(select => {
                                const option = document.createElement('option');
                                option.value = subCat; 
                                option.textContent = `${majorCat} > ${subCat}`; 
                                select.appendChild(option);
                            });
                        });
                    }
                });
            } else {
                 categorySelects.forEach(select => {
                    const option = document.createElement('option');
                    option.value = 'General';
                    option.textContent = 'General (Fallback)';
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Error loading categories:", error);
        }
    }
    
    // --- UPLOAD APP LOGIC (Unchanged) ---
    document.getElementById('app-upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('upload-app-btn');
        const statusP = document.getElementById('upload-status');
        btn.disabled = true;
        statusP.className = '';
        statusP.innerHTML = 'Status: рдЕрдкрд▓реЛрдб рд╢реБрд░реВ рд╣реЛ рд░рд╣рд╛ рд╣реИ...';

        const appData = {
            name: document.getElementById('app-name').value.trim(),
            category: document.getElementById('app-category').value,
            shortDesc: document.getElementById('app-short-desc').value.trim(),
            fullDesc: document.getElementById('app-full-desc').value.trim(),
            type: document.getElementById('app-type').value,
            coverUploadTarget: document.getElementById('cover-upload-target').value,
            iconFile: document.getElementById('app-icon-file').files[0],
            screenshotFiles: document.getElementById('app-screenshots-files').files,
            apkFile: document.getElementById('app-apk-file').files[0],
            qrUrl: document.getElementById('upi-qr-code-url').value.trim()
        };
        
        if (appData.type === 'Paid') { appData.price = Number(document.getElementById('app-price').value); } 
        else if (appData.type === 'Subscription') { appData.subMonthly = Number(document.getElementById('sub-monthly').value); appData.subYearly = Number(document.getElementById('sub-yearly').value); }

        try {
            const appId = 'app' + Date.now();
            const safeName = appData.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            let uploadedUrls = {};

            statusP.innerHTML = 'Status: рдРрдк рдЖрдЗрдХреЙрди рдЕрдкрд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...';
            const iconUploader = (appData.coverUploadTarget === 'r2') ? (file) => uploadR2(file, 'app-icons/') : uploadImgbb;
            uploadedUrls.iconUrl = await iconUploader(appData.iconFile);
            
            statusP.innerHTML = `Status: ${appData.screenshotFiles.length} рд╕реНрдХреНрд░реАрдирд╢реЙрдЯреНрд╕ рдЕрдкрд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...`;
            const screenshotUploadPromises = Array.from(appData.screenshotFiles).map((file, index) => uploadR2(file, `app-screenshots/${safeName}-${index}/`));
            uploadedUrls.screenshotUrls = await Promise.all(screenshotUploadPromises);

            statusP.innerHTML = 'Status: APK рдлрд╝рд╛рдЗрд▓ R2 рдкрд░ рдЕрдкрд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...';
            uploadedUrls.apkUrl = await uploadR2(appData.apkFile, `app-apks/${safeName}/`);

            statusP.innerHTML = 'Status: Firebase рдореЗрдВ рд╕рднреА рд╡рд┐рд╡рд░рдг рд╕реЗрд╡ рдХрд┐рдП рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ... ЁЯФе';
            
            const dataToSave = {
                id: appId,
                name: appData.name, developer: auth.currentUser ? auth.currentUser.email : 'Admin Console (Unknown)', 
                category: appData.category, shortDesc: appData.shortDesc, fullDesc: appData.fullDesc,
                type: appData.type, iconUrl: uploadedUrls.iconUrl, screenshotUrls: uploadedUrls.screenshotUrls,
                apkUrl: uploadedUrls.apkUrl, downloadCount: 0, rating: 0, reviewCount: 0,
                isPublished: true, upiQrUrl: appData.qrUrl, createdAt: Date.now()
            };
            if (appData.type === 'Paid') { dataToSave.price = appData.price; } 
            else if (appData.type === 'Subscription') { dataToSave.subMonthly = appData.subMonthly; dataToSave.subYearly = appData.subYearly; }

            await db.ref('APPS/' + appId).set(dataToSave); 
            
            statusP.innerHTML = `Success! рдРрдк "${appData.name}" рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрд▓реЛрдб рд╣реЛ рдЧрдпрд╛ рд╣реИред`;
            statusP.classList.add('success');
            document.getElementById('app-upload-form').reset(); 
            document.getElementById('shatter-3').classList.remove('open');
            document.getElementById('shatter-1').classList.add('open'); 

        } catch(err) {
            console.error('Upload Error:', err);
            statusP.innerHTML = 'Error: рдЕрдкрд▓реЛрдб рд╡рд┐рдлрд▓ рд░рд╣рд╛ред ' + (err.message || '');
            statusP.classList.add('error');
        } finally {
            btn.disabled = false;
        }
    });

    // ----------------------------------------------------
    // --- PAYMENT VERIFICATION & HISTORY LOGIC (UPDATED) ---
    // ----------------------------------------------------

    async function loadPendingPayments() {
        const tbody = document.getElementById('pending-payments-list').getElementsByTagName('tbody')[0];
        const statusP = document.getElementById('verification-message');
        tbody.innerHTML = '';
        statusP.className = '';
        statusP.innerHTML = 'рдкреЗрдВрдбрд┐рдВрдЧ рдкреЗрдореЗрдВрдЯреНрд╕ рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...';
        
        try {
            // Loading only 'pending' requests from PENDING_PAYMENTS
            const snapshot = await db.ref('PENDING_PAYMENTS').orderByChild('status').equalTo('pending').once('value');
            const payments = snapshot.val();

            if (!payments) {
                statusP.innerHTML = 'рдХреЛрдИ рдкреЗрдВрдбрд┐рдВрдЧ рдкреЗрдореЗрдВрдЯ рдирд╣реАрдВ рдорд┐рд▓рд╛ред';
                return;
            }
            
            Object.keys(payments).forEach(key => {
                const payment = payments[key];
                
                const row = tbody.insertRow();
                row.insertCell().textContent = payment.utr || 'N/A';
                row.insertCell().textContent = payment.appName || payment.appId || 'N/A';
                row.insertCell().textContent = 'тВ╣' + payment.amount; 
                row.insertCell().textContent = payment.userId ? payment.userId.substring(0, 5) + '...' : 'N/A'; 
                row.insertCell().textContent = payment.status;
                
                const actionCell = row.insertCell();
                
                const approveBtn = document.createElement('button');
                approveBtn.className = 'action-btn approve';
                approveBtn.textContent = 'рдЕрдкреНрд░реВрд╡';
                approveBtn.onclick = () => handlePaymentAction(key, payment.userId, payment.appId, 'approved'); 
                actionCell.appendChild(approveBtn);
                
                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'action-btn reject';
                rejectBtn.textContent = 'рд░рд┐рдЬреЗрдХреНрдЯ';
                rejectBtn.onclick = () => handlePaymentAction(key, payment.userId, payment.appId, 'rejected'); 
                actionCell.appendChild(rejectBtn);
            });
            statusP.innerHTML = `рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ ${tbody.rows.length} рдкреЗрдВрдбрд┐рдВрдЧ рдкреЗрдореЗрдВрдЯреНрд╕ рд▓реЛрдб рдХрд┐рдП рдЧрдПред`;

        } catch (error) {
            console.error("Error loading payments:", error);
            statusP.innerHTML = 'рдкреЗрдореЗрдВрдЯреНрд╕ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рдПрд░рд░ред';
            statusP.classList.add('error');
        }
    }

    async function handlePaymentAction(paymentKey, userId, appId, status) {
        if (!confirm(`рдХреНрдпрд╛ рдЖрдк рдЗрд╕ рдкреЗрдореЗрдВрдЯ рдХреЛ '${status}' рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`)) return;

        try {
            // Step 1: Update PENDING_PAYMENTS status (This keeps the record)
            await db.ref('PENDING_PAYMENTS/' + paymentKey).update({ 
                status: status, 
                adminVerifiedAt: Date.now(),
                adminEmail: auth.currentUser ? auth.currentUser.email : 'Unknown'
            });

            if (status === 'approved' && appId && userId) {
                // Step 2: Grant access to the user
                await db.ref('users/' + userId + '/purchased_apps/' + appId).set({
                    purchasedAt: Date.now(),
                    paymentKey: paymentKey, 
                    accessType: 'full'
                });
                alert(`рдкреЗрдореЗрдВрдЯ рдЕрдкреНрд░реВрд╡ рд╣реЛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдпреВрдЬрд╝рд░ рдХреЛ рдРрдк рдПрдХреНрд╕реЗрд╕ рдорд┐рд▓ рдЧрдпрд╛ рд╣реИред`);
            } else if (status === 'rejected') {
                 alert(`рдкреЗрдореЗрдВрдЯ рд░рд┐рдЬреЗрдХреНрдЯ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред`);
            }
            
            loadPendingPayments(); // Refresh the pending list

        } catch (error) {
            console.error(`Error handling action:`, error);
            alert(`рдПрдХреНрд╢рди рд╡рд┐рдлрд▓: ${error.message}`);
        }
    }
    
    // --- PAYMENT HISTORY LOGIC (NEW) ---
    async function loadPaymentHistory() {
        const tbody = document.getElementById('payment-history-list').getElementsByTagName('tbody')[0];
        const statusP = document.getElementById('history-status');
        tbody.innerHTML = '';
        statusP.className = '';
        statusP.innerHTML = 'рдкреЗрдореЗрдВрдЯ рд╣рд┐рд╕реНрдЯреНрд░реА рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...';

        try {
            // Load all payments (approved and rejected) from PENDING_PAYMENTS
            const snapshot = await db.ref('PENDING_PAYMENTS').once('value');
            const payments = snapshot.val();
            
            if (!payments) {
                statusP.innerHTML = 'рдХреЛрдИ рдкреЗрдореЗрдВрдЯ рд╣рд┐рд╕реНрдЯреНрд░реА рдирд╣реАрдВ рдорд┐рд▓реАред';
                return;
            }

            const historyArray = Object.keys(payments)
                .map(key => ({ key, ...payments[key] }))
                .filter(p => p.status !== 'pending') // Filter out pending ones
                .sort((a, b) => b.adminVerifiedAt - a.adminVerifiedAt); // Show newest first

            historyArray.forEach(payment => {
                const row = tbody.insertRow();
                const date = payment.adminVerifiedAt ? new Date(payment.adminVerifiedAt).toLocaleDateString() : 'N/A';
                
                row.insertCell().textContent = payment.utr || 'N/A';
                row.insertCell().textContent = payment.appName || 'N/A';
                row.insertCell().textContent = 'тВ╣' + payment.amount;
                row.insertCell().textContent = payment.userId ? payment.userId.substring(0, 5) + '...' : 'N/A';
                row.insertCell().textContent = payment.status;
                row.insertCell().textContent = date;
                row.style.backgroundColor = (payment.status === 'approved') ? '#d4edda' : '#f8d7da';
            });

            statusP.innerHTML = `рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ ${historyArray.length} рд░рд┐рдХреЙрд░реНрдб рд▓реЛрдб рдХрд┐рдП рдЧрдПред`;

        } catch (error) {
            console.error("Error loading payment history:", error);
            statusP.innerHTML = 'рдкреЗрдореЗрдВрдЯ рд╣рд┐рд╕реНрдЯреНрд░реА рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рдПрд░рд░ред';
            statusP.classList.add('error');
        }
    }

    // ----------------------------------------------------
    // --- APPS MANAGEMENT LOGIC (NEW) ---
    // ----------------------------------------------------

    async function loadAppsForManagement() {
        const listDiv = document.getElementById('apps-management-list');
        const statusP = document.getElementById('app-status');
        listDiv.innerHTML = '';
        statusP.className = '';
        statusP.innerHTML = 'рдРрдкреНрд╕ рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...';
        
        try {
            const snapshot = await db.ref('APPS').once('value');
            const apps = snapshot.val();
            allApps = [];

            if (!apps) {
                statusP.innerHTML = 'рдХреЛрдИ рдРрдк рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИред';
                return;
            }

            allApps = Object.keys(apps).map(key => ({ id: key, ...apps[key] }));
            
            allApps.forEach(app => {
                const card = document.createElement('div');
                card.className = 'app-manage-card';
                
                let priceText = app.type === 'Free' ? 'FREE' : 
                                app.type === 'Paid' ? `тВ╣${app.price}` : 
                                `тВ╣${app.subMonthly}/рдорд╛рд╣`;

                card.innerHTML = `
                    <img src="${app.iconUrl}" alt="${app.name} Icon">
                    <div class="details">
                        <h4>${app.name} (${app.id.substring(3, 8)})</h4>
                        <p><strong>рдкреНрд░рдХрд╛рд░:</strong> ${app.type} | <strong>рдХреАрдордд:</strong> ${priceText}</p>
                        <p><strong>рдХреИрдЯреЗрдЧрд░реА:</strong> ${app.category}</p>
                    </div>
                    <div class="actions">
                        <button class="action-btn edit" onclick="openEditModal('${app.id}')">рдПрдбрд┐рдЯ/рдЕрдкрдбреЗрдЯ</button>
                        <button class="action-btn delete" onclick="deleteApp('${app.id}', '${app.name}')">рдбрд┐рд▓реАрдЯ</button>
                    </div>
                `;
                listDiv.appendChild(card);
            });

            statusP.innerHTML = `рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ ${allApps.length} рдРрдкреНрд╕ рд▓реЛрдб рдХрд┐рдП рдЧрдПред`;

        } catch (error) {
            console.error("Error loading apps:", error);
            statusP.innerHTML = 'рдРрдкреНрд╕ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рдПрд░рд░ред';
            statusP.classList.add('error');
        }
    }

    // --- APP EDIT MODAL LOGIC ---
    function openEditModal(appId) {
        const app = allApps.find(a => a.id === appId);
        if (!app) return alert('рдРрдк рдбреЗрдЯрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ред');

        document.getElementById('edit-app-id').value = appId;
        document.getElementById('edit-app-name-title').textContent = app.name;
        document.getElementById('edit-name').value = app.name;
        document.getElementById('edit-category').value = app.category; // Assumes categories are loaded
        document.getElementById('edit-shortDesc').value = app.shortDesc;
        document.getElementById('edit-fullDesc').value = app.fullDesc;
        document.getElementById('edit-type').value = app.type;
        document.getElementById('edit-price').value = app.price || 0;
        document.getElementById('edit-subMonthly').value = app.subMonthly || 0;
        document.getElementById('edit-qrUrl').value = app.upiQrUrl || '';
        document.getElementById('current-icon').src = app.iconUrl;

        toggleEditPricingFields(); // Show correct fields based on app.type
        document.getElementById('edit-app-modal').style.display = 'block';
    }

    function toggleEditPricingFields() {
        const appType = document.getElementById('edit-type').value;
        document.getElementById('edit-paid-fields').style.display = (appType === 'Paid') ? 'block' : 'none';
        document.getElementById('edit-subscription-fields').style.display = (appType === 'Subscription') ? 'block' : 'none';
    }

    function closeEditModal() {
        document.getElementById('edit-app-modal').style.display = 'none';
        document.getElementById('edit-app-form').reset();
    }

    document.getElementById('edit-app-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const appId = document.getElementById('edit-app-id').value;
        const app = allApps.find(a => a.id === appId);
        if (!app) return alert('рддреНрд░реБрдЯрд┐: рдРрдк рдбреЗрдЯрд╛ рдЧрд╛рдпрдм рд╣реИред');

        const btn = document.querySelector('#edit-app-form button[type="submit"]');
        btn.disabled = true;

        const updateData = {};
        const iconFile = document.getElementById('edit-icon-file').files[0];
        const apkFile = document.getElementById('edit-apk-file').files[0];
        const screenshotFiles = document.getElementById('edit-screenshots-files').files;
        const safeName = app.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();

        try {
            // 1. Handle Media Updates
            if (iconFile) {
                alert('рдирдпрд╛ рдЖрдЗрдХреЙрди рдЕрдкрд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...');
                const iconUploader = (app.coverUploadTarget === 'r2') ? (file) => uploadR2(file, 'app-icons/') : uploadImgbb;
                updateData.iconUrl = await iconUploader(iconFile);
            }
            if (apkFile) {
                alert('рдирдпрд╛ APK рдЕрдкрд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...');
                updateData.apkUrl = await uploadR2(apkFile, `app-apks/${safeName}/`);
            }
            if (screenshotFiles.length > 0) {
                alert('рдирдП рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдЕрдкрд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...');
                const screenshotUploadPromises = Array.from(screenshotFiles).map((file, index) => 
                    uploadR2(file, `app-screenshots/${safeName}-${index}-v2/`)
                );
                updateData.screenshotUrls = await Promise.all(screenshotUploadPromises);
            }

            // 2. Handle Text/Price Updates
            updateData.name = document.getElementById('edit-name').value.trim();
            updateData.category = document.getElementById('edit-category').value;
            updateData.shortDesc = document.getElementById('edit-shortDesc').value.trim();
            updateData.fullDesc = document.getElementById('edit-fullDesc').value.trim();
            updateData.type = document.getElementById('edit-type').value;
            updateData.upiQrUrl = document.getElementById('edit-qrUrl').value.trim();

            if (updateData.type === 'Paid') {
                updateData.price = Number(document.getElementById('edit-price').value);
                updateData.subMonthly = null; // Clear subscription fields
                updateData.subYearly = null;
            } else if (updateData.type === 'Subscription') {
                updateData.subMonthly = Number(document.getElementById('edit-subMonthly').value);
                updateData.subYearly = Number(document.getElementById('edit-subYearly').value);
                updateData.price = null; // Clear paid fields
            } else if (updateData.type === 'Free') {
                 updateData.price = null;
                 updateData.subMonthly = null;
                 updateData.subYearly = null;
            }
            
            // 3. Save to Firebase
            await db.ref('APPS/' + appId).update(updateData); 
            
            alert(`рдРрдк "${updateData.name}" рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрдбреЗрдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИ!`);
            closeEditModal();
            loadAppsForManagement(); // Refresh the list

        } catch(err) {
            console.error('Update Error:', err);
            alert('рддреНрд░реБрдЯрд┐: рдРрдк рдЕрдкрдбреЗрдЯ рд╡рд┐рдлрд▓ рд░рд╣рд╛ред ' + (err.message || ''));
        } finally {
            btn.disabled = false;
        }
    });

    async function deleteApp(appId, appName) {
        if (!confirm(`рдЪреЗрддрд╛рд╡рдиреА: рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ рдРрдк "${appName}" рдХреЛ рд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ DELETE рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?`)) return;

        try {
            await db.ref('APPS/' + appId).remove();
            
            // Optionally remove reviews/ratings related to this app if required by your logic
            // await db.ref('RATINGS_REVIEWS/' + appId).remove(); 

            alert(`рдРрдк "${appName}" рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдбрд┐рд▓реАрдЯ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред`);
            loadAppsForManagement(); // Refresh the list
        } catch (error) {
            console.error("Deletion Error:", error);
            alert('рдбрд┐рд▓реАрд╢рди рд╡рд┐рдлрд▓: ' + error.message);
        }
    }


    // --- REVIEW MODERATION LOGIC (Unchanged) ---
    async function loadReviews() { /* ... Logic ... */ 
        const reviewListDiv = document.getElementById('reviews-list');
        const statusP = document.getElementById('review-moderation-message');
        reviewListDiv.innerHTML = '';
        statusP.className = '';
        statusP.innerHTML = 'рд░рд┐рд╡реНрдпреВрдЬ рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ...';

        try {
            const snapshot = await db.ref('RATINGS_REVIEWS').once('value');
            const reviewsByItem = snapshot.val();
            let reviewArray = [];

            if (reviewsByItem) {
                Object.keys(reviewsByItem).forEach(itemId => {
                    const itemReviews = reviewsByItem[itemId];
                    Object.keys(itemReviews).forEach(reviewId => {
                        reviewArray.push({ id: reviewId, itemId: itemId, ...itemReviews[reviewId] });
                    });
                });
            }

            if (reviewArray.length === 0) { statusP.innerHTML = 'рдХреЛрдИ рд░рд┐рд╡реНрдпреВ рдирд╣реАрдВ рдорд┐рд▓рд╛ред'; return; }
            
            reviewArray.reverse();
            
            reviewArray.forEach(review => {
                const div = document.createElement('div');
                div.style.border = '1px solid #ddd';
                div.style.padding = '10px';
                div.style.margin = '10px 0';
                div.innerHTML = `
                    <p><strong>рдЖрдЗрдЯрдо ID:</strong> ${review.itemId} (${review.item_type || 'N/A'})</p>
                    <p><strong>рдпреВрдЬрд░ ID:</strong> ${review.user_id ? review.user_id.substring(0, 10) + '...' : 'N/A'}</p>
                    <p><strong>рд░реЗрдЯрд┐рдВрдЧ:</strong> ${review.rating} тнР</p>
                    <p><strong>рд░рд┐рд╡реНрдпреВ:</strong> ${review.review_text}</p>
                    <button class="action-btn" onclick="moderateReview('${review.itemId}', '${review.id}', true)">рд╣рд╛рдЗрдб рдХрд░реЗрдВ</button>
                    <button class="action-btn" style="background-color: #dc3545;" onclick="moderateReview('${review.itemId}', '${review.id}', false)">рдбрд┐рд▓реАрдЯ рдХрд░реЗрдВ</button>
                `;
                reviewListDiv.appendChild(div);
            });
            statusP.innerHTML = `рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ ${reviewArray.length} рд░рд┐рд╡реНрдпреВрдЬ рд▓реЛрдб рдХрд┐рдП рдЧрдПред`;
            
        } catch (error) {
            console.error("Error loading reviews:", error);
            statusP.innerHTML = 'рд░рд┐рд╡реНрдпреВрдЬ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рдПрд░рд░ред';
            statusP.classList.add('error');
        }
    }

    async function moderateReview(itemId, reviewId, hide) { /* ... Logic ... */
        if (hide && !confirm('рдХреНрдпрд╛ рдЖрдк рдЗрд╕ рд░рд┐рд╡реНрдпреВ рдХреЛ рдЫрд┐рдкрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╣ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдореМрдЬреВрдж рд░рд╣реЗрдЧрд╛ред')) return;
        if (!hide && !confirm('рдХреНрдпрд╛ рдЖрдк рдЗрд╕ рд░рд┐рд╡реНрдпреВ рдХреЛ рд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ DELETE рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?')) return;

        try {
            if (hide) {
                await db.ref('RATINGS_REVIEWS/' + itemId + '/' + reviewId).update({ hidden: true });
            } else {
                await db.ref('RATINGS_REVIEWS/' + itemId + '/' + reviewId).remove();
            }
            alert(hide ? 'рд░рд┐рд╡реНрдпреВ рдЫрд┐рдкрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред' : 'рд░рд┐рд╡реНрдпреВ рдбрд┐рд▓реАрдЯ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред');
            loadReviews();
        } catch (error) {
            console.error("Moderation Error:", error);
            alert(`рдореЙрдбрд░реЗрд╢рди рд╡рд┐рдлрд▓: ${error.message}`);
        }
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(checkAdminAccess);
    });

</script>
</body>
</html>

