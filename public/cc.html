<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>gold rupi - user (fixed)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
/* --- Variables & Reset --- */
:root{
  --gold: #d4af37;
  --gold-light: #ffeb95;
  --gold-strong: #c59b2d;
  --glass: rgba(255,255,255,0.14);
  --card: rgba(255,255,255,0.9); /* Lighter card background for contrast */
  --bg-color: #fffaf0;
  --accent: #1f2937;
  --error: #ef4444;
  --success: #10b981;
  --pending: #f59e0b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background: linear-gradient(180deg, var(--bg-color), #fff3d6);
  color:var(--accent);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* --- Utility Classes --- */
.h1{font-weight:700;font-size:18px}
.small{font-size:13px;color:#444}
.small-muted{font-size:12px;color:#666}
.container{padding:12px 16px 80px}
.section{display:none}
.section.active{display:block}
.field-hidden{display:none !important;}

/* --- Header & Navigation --- */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 16px;
  background:rgba(255, 255, 255, 0.9); /* Opaque for readability */
  backdrop-filter:blur(8px);
  position:sticky; top:0; z-index:100;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.brand{ display:flex;align-items:center;gap:10px; }
.logo{
  width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--gold-light));
  display:flex;align-items:center;justify-content:center;font-weight:800;color:#111;
  box-shadow:0 6px 20px rgba(197,155,45,0.18);
}
.top-right{display:flex;gap:10px;align-items:center}
.cart-icon{position:relative;cursor:pointer}
.cart-count{
  position:absolute;right:-8px;top:-8px;background:var(--error);color:#fff;border-radius:50%;
  width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;
}

/* --- Search Bar & Filter --- */
.search-bar{
  padding:10px;border-radius:12px;border:none;width:100%;
  background:rgba(255,255,255,0.7);margin:12px 16px;display:flex;gap:10px;align-items:center;
}
.search-bar input{
  border:none;background:transparent;outline:none;width:100%;font-size:15px;
  flex:1; padding: 4px 0;
}
.search-bar select{
  border:none;background:transparent;padding:4px 0;
}

/* --- Cards & Grid --- */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
.card{
  background:var(--card);
  border-radius:14px;padding:12px;
  box-shadow:0 6px 24px rgba(0,0,0,0.06);
  border: 1px solid rgba(0,0,0,0.05); /* subtle border */
}
.product-img{width:100%;height:160px;object-fit:cover;border-radius:10px;margin-bottom:8px}
.pmeta{display:flex;justify-content:space-between;align-items:center}
.pname{font-weight:600}
.pprice{font-weight:700;color:var(--gold-strong)}

/* --- Form Elements --- */
input[type="text"], input[type="number"], input[type="file"], select{
  width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;
  margin-top:4px;margin-bottom:8px;
  font-family:'Poppins',sans-serif;
  font-size:14px;
}
label.small{
  display:block;margin-top:8px;font-weight:500;
}

/* --- Buttons --- */
.btn{
  background:var(--gold);border:none;padding:10px 14px;border-radius:10px;
  color:#111;font-weight:600;cursor:pointer;
  transition:background 0.2s, transform 0.1s;
}
.btn:hover{background:var(--gold-strong);}
.btn:active{transform:scale(0.98);}
.btn.secondary{
  background:transparent;border:1px solid rgba(0,0,0,0.1);color:var(--accent);
  font-weight:400;
}
.btn.secondary:hover{background:rgba(0,0,0,0.05);}
.row{display:flex;gap:10px;flex-wrap:wrap}

/* --- Bottom Nav --- */
.bottom-nav{
  position:fixed;left:0;right:0;bottom:0;height:66px;
  background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,1));
  display:flex;justify-content:space-around;
  box-shadow:0 -4px 10px rgba(0,0,0,0.05);
  z-index:1000;
}
.navbtn{
  display:flex;flex-direction:column;align-items:center;font-size:12px;color:#222;cursor:pointer;
  padding:8px 0;width:20%;
}
.navbtn img{width:22px;height:22px;margin-bottom:2px;opacity:0.6}
.navbtn.active{color:var(--gold-strong);font-weight:600;}
.navbtn.active img{
  filter:drop-shadow(0 0 3px var(--gold-strong));
  opacity:1;
}

/* --- Section Specifics --- */
.gold-box{
  background:linear-gradient(90deg, var(--gold-light), #fff9ed);
  padding:16px;border-radius:12px;margin:8px 0;
  border-left: 4px solid var(--gold-strong);
}
.note{font-size:13px;color:#333}

.history .card{
  background:var(--card);
  margin-bottom:8px;
  border-left:4px solid var(--gold-strong);
}
.cart-list .card{
  display:flex;gap:10px;align-items:center;padding:10px;margin-bottom:8px;
}
.cart-list img{width:72px;height:72px;object-fit:cover;border-radius:8px}

.profile-top{display:flex;gap:12px;align-items:center}
.profile-photo{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid var(--gold-strong);box-shadow:0 6px 18px rgba(0,0,0,0.08)}
.section-title{display:flex;justify-content:space-between;align-items:center}

/* --- Modals & Overlay --- */
.overlay{
  position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.7);
  display:none;align-items:center;justify-content:center;z-index:9999;
}
.overlay .modal{
  width:92%;max-width:760px;background:#fff;padding:16px;border-radius:12px;
  max-height:90vh;overflow:auto;
  animation: fadeIn 0.3s;
}
@keyframes fadeIn { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }

.overlay .images{display:flex;gap:8px;overflow-x:auto;margin-bottom:8px}
.overlay img{height:220px;object-fit:cover;border-radius:8px}

/* --- Status Badges --- */
.status-badge{
  padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;text-transform:capitalize;
  display:inline-block;
}
.status-pending{background:var(--pending);color:#fff;}
.status-paid, .status-completed, .status-delivered{background:var(--success);color:#fff;}
.status-rejected, .status-failed{background:var(--error);color:#fff;}
.status-default{background:#e5e7eb;color:#4b5563;}

/* --- Chat Support --- */
.chat-container{
  max-height: 400px; overflow-y: auto; margin-bottom: 12px; padding: 8px;
  background: #f9f9f9; border-radius: 8px;
}
.message-bubble{
  padding: 8px 12px; border-radius: 18px; max-width: 80%; margin-bottom: 6px;
  line-height: 1.4;
}
.user-message{
  background: var(--gold-light); align-self: flex-end; margin-left: auto;
  border-bottom-right-radius: 2px;
}
.admin-message{
  background: #e2e8f0; align-self: flex-start; margin-right: auto;
  border-bottom-left-radius: 2px;
}
.chat-input-row{display:flex; gap:8px; margin-top:12px;}
.chat-input-row input{flex:1; margin-bottom:0;}

/* --- Responsive --- */
@media (min-width:900px){
.container{max-width:980px;margin:0 auto}
.search-bar{max-width:980px;margin:12px auto}
}
</style>

</head>
<body>
<div class="header">
  <div class="brand">
    <div class="logo">gr</div>
    <div>
      <div class="h1">gold rupi</div>
      <div class="small">buy gold ‚Ä¢ shop ‚Ä¢ wallet</div>
    </div>
  </div>
  <div class="top-right">
    <div class="small-muted" id="goldrate-display">rate: ‚Çπ6500 / g</div>
    <div class="small-muted" id="wallet-mini">wallet: ‚Çπ0</div>
    <div class="cart-icon" onclick="showTab('cart')" title="Cart">
      <img src="https://img.icons8.com/ios-filled/30/000000/shopping-cart.png" alt="cart">
      <div id="cart-count" class="cart-count" style="display:none">0</div>
    </div>
  </div>
</div>
<div class="search-bar">
  <input id="search-input" placeholder="search products, brand, color, category..." />
  <select id="category-filter">
    <option value="">all categories</option>
  </select>
  <button class="btn secondary" onclick="applyFilter()">filter</button>
</div>

<div class="container">
  <div id="home" class="section active">
    <div class="section-title">
      <h2>welcome back üëã</h2>
      <div class="small-muted" id="signup-bonus-note"></div>
    </div>
    <div class="card gold-box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700;font-size:16px">current gold rate</div>
          <div style="font-weight:800;font-size:20px;color:var(--gold-strong)">‚Çπ <span id="gold-rate">6500</span> / g</div>
          <div style="font-weight:700;font-size:16px;margin-top:8px">my gold balance</div>
          <div style="font-weight:800;font-size:20px;color:var(--gold-strong)"><span id="gold-balance-display">0.0000</span> g</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">fast actions</div>
          <div class="row" style="margin-top:10px">
            <button class="btn secondary" onclick="showTab('shop')">shop</button>
            <button class="btn" onclick="showTab('gold')">buy gold</button>
          </div>
        </div>
      </div>
    </div>
    <h3 style="margin-top:16px">latest products</h3>
    <div id="latest-products" class="grid"></div>
  </div>

  <div id="shop" class="section">
    <h2>shop</h2>
    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="search-shop" placeholder="search in shop..." style="flex:1;margin-bottom:0;">
        <select id="cat-shop" style="min-width:140px;margin-bottom:0;"><option value="">all categories</option></select>
        <button class="btn" onclick="searchShop()">search</button>
      </div>
    </div>
    <div id="product-list" class="grid"></div>
  </div>

  <div id="cart" class="section">
    <h2>cart üõí</h2>
    <div id="cart-list" class="cart-list"></div>
    <div style="margin-top:12px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>subtotal:</strong> ‚Çπ <span id="cart-subtotal">0</span></div>
          <div style="display:flex;gap:8px">
            <button class="btn secondary" onclick="clearCart()">clear</button>
            <button class="btn" onclick="openCheckoutModal()">buy / checkout</button>
          </div>
        </div>
        <div style="margin-top:8px" class="small">Delivery address will be used from your profile.</div>
      </div>
    </div>
  </div>

  <div id="gold" class="section">
    <h2>buy gold ü•á</h2>
    <div class="card gold-box">
      <div style="font-weight:700;font-size:18px">Your Gold Balance: <span id="gold-balance-main">0.0000</span> g</div>
    </div>
    <div class="card">
      <div style="display:flex;gap:10px;align-items:flex-start">
        <div style="flex:1">
          <label class="small">enter amount (‚Çπ, min 50)</label>
          <input id="gold-amount" type="number" placeholder="amount in ‚Çπ">
          <label class="small">enter utr (12 digits)</label>
          <input id="gold-utr" type="text" placeholder="12 digit utr">
          <div style="margin-top:8px" class="note small">scan the upi qr and paste utr then submit.</div>
        </div>
        <div style="width:140px;text-align:center">
          <img id="gold-qr-img" src="https://i.ibb.co/CKTVnyGq/Screenshot-20251126-043755-GPay-Business.jpg" style="width:100%;border-radius:10px">
          <div class="small" style="margin-top:6px">scan & pay</div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" onclick="buyGold()">submit request</button>
        <button class="btn secondary" onclick="showHistory('gold')">my gold history</button>
      </div>
    </div>
    <h3 style="margin-top:16px">gold transactions</h3>
    <div id="gold-status-list" style="margin-top:12px"></div>
  </div>

  <div id="wallet" class="section">
    <h2>wallet üí≥</h2>
    <div class="card gold-box">
      <div style="font-weight:700;font-size:18px">Current Balance: ‚Çπ <span id="wallet-balance-main">0</span></div>
    </div>
    <div class="card">
      <div style="min-width:100%">
        <h4 style="margin-top:0;">add money</h4>
        <label class="small">add amount</label>
        <input id="wallet-add-amount" type="number" placeholder="amount">
        <label class="small">enter utr (12 digits)</label>
        <input id="wallet-utr" type="text" placeholder="12 digit utr">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="addWallet()">request add</button>
          <button class="btn secondary" onclick="openWithdrawModal()">withdraw</button>
        </div>
        <div style="margin-top:8px" class="small-muted">Scan QR below to add money (UTR required).</div>
        <img id="wallet-qr" src="https://i.ibb.co/CKTVnyGq/Screenshot-20251126-043755-GPay-Business.jpg" style="width:140px;border-radius:8px;margin-top:8px;">
      </div>
    </div>
    <h3 style="margin-top:16px">wallet history</h3>
    <div id="wallet-history-list" style="margin-top:12px"></div>
  </div>

  <div id="profile" class="section">
    <div class="section-title">
      <h2>profile üë§</h2>
      <div>
        <button class="btn secondary" onclick="showHistory('orders')">my orders</button>
        <button class="btn secondary" onclick="logout()">logout</button>
      </div>
    </div>
    <div class="card profile-top">
      <img id="profile-photo" class="profile-photo" src="https://via.placeholder.com/84" alt="profile">
      <div style="flex:1">
        <div id="profile-view">
          <div style="display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <div id="profile-name-display" style="font-weight:700">Name</div>
              <div id="profile-mobile-display" class="small-muted">Mobile</div>
              <div class="small-muted">Refer Code: <strong id="my-refer">N/A</strong></div>
            </div>
            <div>
              <button class="btn secondary" onclick="toggleProfileEdit()">edit</button>
            </div>
          </div>
        </div>
        <div id="profile-edit" class="field-hidden" style="margin-top:8px">
          <input id="profile-name" placeholder="name">
          <input id="profile-mobile" placeholder="mobile">
          <div style="margin-top:6px">
            <input type="file" id="profile-upload" style="margin-bottom:0;">
            <button class="btn secondary" onclick="uploadProfile()">upload photo</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="saveProfile()">save profile</button>
            <button class="btn secondary" onclick="toggleProfileEdit(true)">cancel</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card" style="margin-top:12px">
      <h3>address üè°</h3>
      <div id="address-view">
        <div class="small-muted" id="address-display">No saved address</div>
        <div style="margin-top:8px"><button class="btn" onclick="toggleAddressEdit()">edit address</button></div>
      </div>
      <div id="address-edit" class="field-hidden" style="margin-top:8px">
        <input id="addr-house" placeholder="house / street">
        <input id="addr-city" placeholder="city">
        <input id="addr-district" placeholder="district">
        <input id="addr-country" placeholder="country">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="saveAddress()">save address</button>
          <button class="btn secondary" onclick="toggleAddressEdit(true)">cancel</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Saved address will autofill at checkout.</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>kyc (aadhaar) üõ°Ô∏è</h3>
      <div id="kyc-block">
        <div id="kyc-status-display" class="small-muted" style="margin-bottom:8px;"></div>
        <input id="kyc-name" placeholder="aadhaar name">
        <input id="kyc-number" placeholder="aadhaar number">
        <label class="small">Aadhaar Front Photo</label>
        <input type="file" id="kyc-front" style="margin-bottom:0;">
        <label class="small">Aadhaar Back Photo</label>
        <input type="file" id="kyc-back" style="margin-bottom:0;">
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" onclick="uploadKYC()">submit kyc</button>
        </div>
      </div>
    </div>
    
    <div class="card" style="margin-top:12px">
      <h3>refer & earn ü§ù</h3>
      <div class="small">your refer code: <strong id="my-refer-code">N/A</strong></div>
      <p class="small">terms: referred friend must buy gold ‚â• ‚Çπ50. only first friend counts. admin approval required.</p>
      <input id="refer-friend-name" placeholder="friend name">
      <input id="refer-friend-email" placeholder="friend email">
      <input id="refer-friend-mobile" placeholder="friend mobile">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="submitRefer()">submit refer</button>
        <button class="btn secondary" onclick="showHistory('refer')">refer history</button>
      </div>
      <div id="refer-history-list" style="margin-top:10px"></div>
    </div>

    <div class="card history" style="margin-top:12px">
      <h3>quick history</h3>
      <div id="quick-history"></div>
    </div>
  </div>

  <div id="loan" class="section">
    <h2>quick loan üíµ</h2>
    <div id="active-loan-display" class="card gold-box" style="margin-bottom:12px;">
      <div style="font-weight:700">No Active Loan</div>
    </div>
    <div id="loan-form-block" class="card">
      <h4 style="margin-top:0;">apply for loan</h4>
      <label class="small">amount needed (min ‚Çπ5000)</label>
      <input id="loan-amount" type="number" placeholder="amount in ‚Çπ">
      <input id="loan-pan-number" placeholder="pan number">
      <input id="loan-profession" placeholder="profession">
      <label class="small">pan photo</label>
      <input type="file" id="loan-pan-photo" style="margin-bottom:0;">
      <label class="small">reference 1 (name/mobile)</label>
      <input id="loan-ref1" placeholder="reference 1">
      <label class="small">reference 2 (name/mobile)</label>
      <input id="loan-ref2" placeholder="reference 2">
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="submitLoanRequest()">apply now</button>
        <button class="btn secondary" onclick="showHistory('loan')">loan history</button>
      </div>
    </div>
    <h3 style="margin-top:16px">loan history</h3>
    <div id="loan-history-list" style="margin-top:12px"></div>
  </div>

  <div id="support" class="section">
    <h2>support chat üí¨</h2>
    <div class="card">
      <h4 style="margin-top:0;">live chat with admin</h4>
      <div id="chat-messages" class="chat-container">
        </div>
      <div class="chat-input-row">
        <input id="support-message-input" placeholder="type your message...">
        <button class="btn" onclick="sendMessage()">send</button>
      </div>
    </div>
  </div>

  <div id="orders-full-list" style="margin-top:12px"></div>
</div>

<div id="overlay" class="overlay" onclick="overlayClicked(event)">
  <div class="modal" id="overlay-modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700" id="modal-title">Product</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="modal-price" style="font-weight:800;color:var(--gold-strong)"></div>
        <button class="btn" onclick="modalAddToCart()">add to cart</button>
        <button class="btn secondary" onclick="closeOverlay()">close</button>
      </div>
    </div>
    <div class="images" id="modal-images" style="margin-top:8px"></div>
    <div id="modal-desc" style="margin-top:8px;color:#333"></div>
    <div class="small" id="modal-meta" style="margin-top:8px;color:#555"></div>
  </div>
</div>

<div id="checkout-overlay" class="overlay" style="display:none">
  <div class="modal">
    <h3>checkout üõí</h3>
    <div id="checkout-items" style="max-height:250px;overflow-y:auto;margin-bottom:12px;padding:8px;border:1px solid #eee;border-radius:8px;"></div>
    <div class="card" style="margin-bottom:12px; padding:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>subtotal:</strong> ‚Çπ <span id="checkout-subtotal-display">0</span></div>
      </div>
    </div>
    <form id="checkout-form">
      <h4>delivery address</h4>
      <div id="checkout-address-display" class="small-muted" style="margin-bottom:8px;"></div>
      <button type="button" class="btn secondary" onclick="toggleAddressEdit()">edit address in profile</button>

      <h4 style="margin-top:12px;">payment details</h4>
      <div class="small-muted" style="margin-bottom:8px;">Use UPI QR code (in gold tab) to pay total amount and enter UTR below.</div>
      <label class="small">enter utr (12 digits)</label>
      <input id="checkout-utr" placeholder="UTR" maxlength="12">
      <div style="display:flex;gap:8px;margin-top:12px">
        <button type="button" class="btn" onclick="confirmCheckout()">submit order</button>
        <button type="button" class="btn secondary" onclick="closeCheckoutModal()">cancel</button>
      </div>
    </form>
  </div>
</div>

<div id="withdraw-overlay" class="overlay" style="display:none">
  <div class="modal">
    <h3>withdraw from wallet üí∏</h3>
    <div>
      <label class="small">amount</label>
      <input id="withdraw-amount" type="number" placeholder="amount">
      <label class="small" style="margin-top:8px">UPI / account note (optional)</label>
      <input id="withdraw-note" placeholder="upi or bank details (for admin)">
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" onclick="submitWithdraw()">submit withdraw request</button>
      <button class="btn secondary" onclick="closeWithdrawModal()">cancel</button>
    </div>
  </div>
</div>

<div id="loan-accept-overlay" class="overlay" style="display:none">
  <div class="modal">
    <h3 id="loan-accept-title">loan offer from admin</h3>
    <div id="loan-offer-details"></div>
    <div style="margin-top:12px; border-top:1px solid #eee; padding-top:12px;">
      <p class="small-muted">by accepting, you agree to the repayment schedule set by admin.</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="acceptLoanOffer()">accept loan</button>
        <button class="btn secondary" onclick="rejectLoanOffer()">reject offer</button>
      </div>
    </div>
  </div>
</div>

<div class="bottom-nav">
  <div class="navbtn active" data-target="home" onclick="navClick(event)">
    <img src="https://img.icons8.com/ios-filled/50/000000/home.png" alt="home"/><div>home</div>
  </div>
  <div class="navbtn" data-target="shop" onclick="navClick(event)">
    <img src="https://img.icons8.com/ios-filled/50/000000/shop.png" alt="shop"/><div>shop</div>
  </div>
  <div class="navbtn" data-target="gold" onclick="navClick(event)">
    <img src="https://img.icons8.com/ios-filled/50/000000/gold-bar.png" alt="gold"/><div>gold</div>
  </div>
  <div class="navbtn" data-target="wallet" onclick="navClick(event)">
    <img src="https://img.icons8.com/ios-filled/50/000000/wallet.png" alt="wallet"/><div>wallet</div>
  </div>
  <div class="navbtn" data-target="loan" onclick="navClick(event)">
    <img src="https://img.icons8.com/ios-filled/50/000000/us-dollar-coin.png" alt="loan"/><div>loan</div>
  </div>
  <div class="navbtn" data-target="profile" onclick="navClick(event)">
    <img src="https://img.icons8.com/ios-filled/50/000000/user-male-circle.png" alt="profile"/><div>profile</div>
  </div>
  <div class="navbtn" data-target="support" onclick="navClick(event)">
    <img src="https://img.icons8.com/ios-filled/50/000000/chat.png" alt="support"/><div>support</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
// ---------- config ----------
const firebaseConfig = {
  apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
  authDomain: "smbrand-4543a.firebaseapp.com",
  databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
  projectId: "smbrand-4543a",
  storageBucket: "smbrand-4543a.firebasestorage.app",
  messagingSenderId: "720775550032",
  appId: "1:720775550032:web:0622548a007597778bad55",
  measurementId: "G-3LS5W6F8QW"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const imgbbKey = '021a2437b889915669b66554687bf17f';

// ---------- state ----------
let currentUser = null;
let productsData = {};
let cart = {};
let modalProductId = null;
const GOLD_RATE = 6500;
const SIGNUP_BONUS = 100;
const REFER_GOLD_MIN = 50;

let currentLoanOffer = null; // for loan acceptance flow

// ---------- helpers ----------
function navClick(e){
  document.querySelectorAll('.navbtn').forEach(n=>n.classList.remove('active'));
  e.currentTarget.classList.add('active');
  showTab(e.currentTarget.dataset.target);
}
function showTab(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  closeOverlay();
  closeCheckoutModal();
  closeWithdrawModal();
}

// overlay
function openOverlay(){ document.getElementById('overlay').style.display = 'flex'; }
function closeOverlay(){ document.getElementById('overlay').style.display = 'none'; modalProductId = null; }
function overlayClicked(e){
  if(e.target === document.getElementById('overlay')) closeOverlay();
}
function renderStatusBadge(status){
  status = status || 'pending';
  const statusLower = status.toLowerCase().replace(/\s/g, '_');
  let badgeClass = 'status-default';
  if(['pending', 'submitted', 'in_review'].includes(statusLower)) badgeClass = 'status-pending';
  if(['paid', 'completed', 'delivered', 'verified', 'success'].includes(statusLower)) badgeClass = 'status-paid';
  if(['rejected', 'failed', 'cancelled'].includes(statusLower)) badgeClass = 'status-rejected';

  return `<div class="status-badge ${badgeClass}">${status.toUpperCase()}</div>`;
}
function generateReferCode(uid){
    // Simple 8 char code from UID + timestamp hash
    const hash = btoa(uid + Date.now()).replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
    return hash.substring(0, 8);
}

// ---------- auth check ----------
auth.onAuthStateChanged(async user=>{
  if(!user) return window.location.href='rupe.html';
  currentUser = user;

  document.getElementById('gold-rate').innerText = GOLD_RATE;
  document.getElementById('goldrate-display').innerText = `rate: ‚Çπ${GOLD_RATE} / g`;

  // --- Signup Bonus & Refer Code Generation ---
  try {
    const uSnap = await db.ref('users/'+currentUser.uid).once('value');
    const userData = uSnap.val() || {};

    if(!userData.signup_bonus_given){
      await db.ref('users/'+currentUser.uid+'/wallet').transaction(curr => (Number(curr || 0) + SIGNUP_BONUS));
      await db.ref('users/'+currentUser.uid+'/wallet_history/bonus_'+Date.now()).set({id:'bonus_'+Date.now(), amount:SIGNUP_BONUS, type:'bonus', status:'completed', created_at:Date.now()});
      await db.ref('users/'+currentUser.uid+'/signup_bonus_given').set(true);
      document.getElementById('signup-bonus-note').innerText = `‚Çπ${SIGNUP_BONUS} signup bonus added`;
      setTimeout(()=>document.getElementById('signup-bonus-note').innerText = '', 5000);
    }
    if(!userData.refer){
        const newReferCode = generateReferCode(currentUser.uid);
        await db.ref('users/'+currentUser.uid+'/refer').set(newReferCode);
    }

  } catch(e){ console.warn('initial setup failed', e); }

  loadUserProfile();
  loadProducts();
  loadCartFromDb();
  loadQuickHistory();
  loadReferHistory();
  loadWalletHistory();
  loadGoldHistory(); // load gold history for immediate view
  loadOrderHistory(); // load order history for immediate view
  loadLoanHistory(); // load loan history for immediate view
  listenPaymentRequests();
  listenLoanOffers();
  loadChatMessages();
});

// ---------- user profile & address (FIXED) ----------
function loadUserProfile(){
  db.ref('users/'+currentUser.uid).on('value',snap=>{
    const d = snap.val()||{};
    // view
    document.getElementById('profile-name-display').innerText = d.name || 'Unnamed';
    document.getElementById('profile-mobile-display').innerText = d.mobile || '';
    document.getElementById('profile-name').value = d.name||'';
    document.getElementById('profile-mobile').value = d.mobile||'';
    document.getElementById('profile-photo').src = d.photo||'https://via.placeholder.com/84';
    document.getElementById('my-refer').innerText = d.refer||'N/A';
    document.getElementById('my-refer-code').innerText = d.refer||'N/A';
    document.getElementById('wallet-balance-main').innerText = d.wallet||0;
    document.getElementById('wallet-mini').innerText = `wallet: ‚Çπ${d.wallet||0}`;
    document.getElementById('gold-balance-display').innerText = (d.gold_balance || 0).toFixed(4);
    document.getElementById('gold-balance-main').innerText = (d.gold_balance || 0).toFixed(4);
    // address
    if(d.address){
      const a = d.address;
      const ad = `${a.house||''}, ${a.city||''}, ${a.district||''}, ${a.country||''}`;
      document.getElementById('address-display').innerText = ad;
      document.getElementById('checkout-address-display').innerText = ad;
      document.getElementById('addr-house').value = a.house||'';
      document.getElementById('addr-city').value = a.city||'';
      document.getElementById('addr-district').value = a.district||'';
      document.getElementById('addr-country').value = a.country||'';
    } else {
      document.getElementById('address-display').innerText = 'No saved address';
      document.getElementById('checkout-address-display').innerText = 'No saved address (please save in profile)';
    }
    // KYC
    const kycStatus = (d.kyc && d.kyc.status) || 'not submitted';
    document.getElementById('kyc-status-display').innerHTML = `Status: ${renderStatusBadge(kycStatus)}`;

    if(kycStatus === 'verified'){
      document.getElementById('kyc-block').innerHTML = `<div class="card" style="margin-top:0;"><div class="small">KYC Verified üéâ ‚Äî Aadhaar: ${d.kyc.number||'‚Äî'}</div></div>`;
    } else if (kycStatus === 'pending'){
      document.getElementById('kyc-block').innerHTML = `<div class="card" style="margin-top:0;"><div class="small">KYC Submitted, awaiting admin verification.</div></div>`;
    }
    // Loan Status Check
    if(d.active_loan){
      const loan = d.active_loan;
      document.getElementById('active-loan-display').innerHTML = `
        <div style="font-weight:700; color: var(--error)">Active Loan: ‚Çπ${loan.amount}</div>
        <div class="small">Repayment: ‚Çπ${loan.emi_amount || '‚Äî'} / ${loan.emi_frequency || '‚Äî'}</div>
        <div class="small-muted">Close Loan: Pay Total Outstanding & Submit UTR in Loan History.</div>
      `;
      document.getElementById('loan-form-block').classList.add('field-hidden');
    } else {
      document.getElementById('active-loan-display').innerHTML = `<div style="font-weight:700">No Active Loan</div>`;
      document.getElementById('loan-form-block').classList.remove('field-hidden');
    }

  });
}

function toggleProfileEdit(forceHide){
  const edit = document.getElementById('profile-edit');
  const view = document.getElementById('profile-view');
  if(forceHide){ edit.classList.add('field-hidden'); view.classList.remove('field-hidden'); return; }
  edit.classList.toggle('field-hidden');
  view.classList.toggle('field-hidden');
}
function saveProfile(){
  const name = document.getElementById('profile-name').value.trim();
  const mobile = document.getElementById('profile-mobile').value.trim();
  db.ref('users/'+currentUser.uid).update({name,mobile}).then(()=>{
    alert('profile saved');
    toggleProfileEdit(true);
  }).catch(e=>alert('save failed: '+e.message));
}
function uploadProfile(){
  const file = document.getElementById('profile-upload').files[0];
  if(!file){ alert('select photo'); return; }
  const form = new FormData(); form.append('image', file);
  axios.post('https://api.imgbb.com/1/upload?key='+imgbbKey, form)
  .then(res=>{
    const url = res.data.data.url;
    db.ref('users/'+currentUser.uid+'/photo').set(url);
    alert('photo uploaded');
  }).catch(e=>alert('upload failed'));
}

function toggleAddressEdit(forceHide){
  const edit = document.getElementById('address-edit');
  const view = document.getElementById('address-view');
  if(forceHide){ edit.classList.add('field-hidden'); view.classList.remove('field-hidden'); return; }
  edit.classList.toggle('field-hidden');
  view.classList.toggle('field-hidden');
}
function saveAddress(){
  const house = document.getElementById('addr-house').value.trim();
  const city = document.getElementById('addr-city').value.trim();
  const district = document.getElementById('addr-district').value.trim();
  const country = document.getElementById('addr-country').value.trim();
  if(!house || !city || !district || !country) return alert('fill all address fields');
  const addr = {house,city,district,country};
  db.ref('users/'+currentUser.uid+'/address').set(addr).then(()=>{
    alert('address saved successfully'); // FIXED: address save message
    toggleAddressEdit(true);
  }).catch(e=>alert('address save failed: '+e.message)); // FIXED: Error handling
}

// ---------- products, cart, checkout (UPDATED) ----------
function loadProducts(){
  db.ref('products').on('value',snap=>{
    productsData = snap.val() || {};
    const keys = Object.keys(productsData || {});
    renderProducts(keys.reverse());
    populateCategories();
    updateLatestPreview();
  });
}
function updateLatestPreview(){
  db.ref('products').limitToLast(6).once('value').then(snap=>{
    const data = snap.val()||{};
    const keys = Object.keys(data||{}).reverse();
    const cont = document.getElementById('latest-products'); cont.innerHTML='';
    keys.forEach(k=>{
      const p = data[k];
      const div = document.createElement('div'); div.className='card';
      div.innerHTML = `
        <img class="product-img" src="${(p.images && p.images[0])||'https://via.placeholder.com/300'}" alt="${p.name}">
        <div class="pmeta"><div class="pname">${p.name}</div><div class="pprice">‚Çπ${calcDiscountPrice(p.price,p.discount)}</div></div>
        <div class="small">${p.brand||''} ‚Ä¢ ${p.color||''}</div>
      `;
      div.addEventListener('click', ()=> openProductModal(k));
      cont.appendChild(div);
    });
  });
}
function renderProducts(keys){
  const cont = document.getElementById('product-list'); cont.innerHTML='';
  if(!keys || keys.length===0){ cont.innerHTML = '<div class="card">no products found</div>'; return; }
  keys.forEach(k=>{
    const p = productsData[k];
    const card = document.createElement('div'); card.className='card';
    const discPrice = calcDiscountPrice(p.price,p.discount);
    const priceHtml = `
      <div style="display:flex;align-items:center;gap:8px">
        <div class="pprice">‚Çπ${discPrice}</div>
        ${p.discount ? `<div class="small" style="text-decoration:line-through;color:#888">‚Çπ${p.price}</div><div class="small" style="color:var(--success)">${p.discount}% off</div>` : ''}
      </div>
    `;
    card.innerHTML = `
      <img class="product-img" src="${(p.images && p.images[0])||'https://via.placeholder.com/300'}" alt="${p.name}" />
      <div class="pmeta"><div class="pname">${p.name}</div>${priceHtml}</div>
      <div class="small">${p.brand? p.brand+' ‚Ä¢':''} ${p.color? p.color+' ‚Ä¢':''} ${p.size? 'size '+p.size:''}</div>
      <p style="margin:8px 0;color:#444">${p.description? p.description.substring(0, 50) + '...' : ''}</p>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" onclick="addToCart('${k}')">add to cart</button>
        <button class="btn secondary" onclick="openProductModal('${k}')">view</button>
      </div>
    `;
    cont.appendChild(card);
  });
}
function calcDiscountPrice(price, discount){
  if(!price) return 0;
  if(!discount) return Number(price);
  const p = Number(price);
  return Math.round((p * (100 - Number(discount))) / 100);
}

function renderCart(){
  const cont = document.getElementById('cart-list'); cont.innerHTML='';
  let subtotal = 0;
  Object.keys(cart).forEach(pid=>{
    const p = productsData[pid];
    if(!p) return;
    const qty = cart[pid];
    const price = calcDiscountPrice(p.price,p.discount);
    subtotal += Number(price || 0) * qty;
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <img src="${(p.images && p.images[0])||'https://via.placeholder.com/100'}" alt="${p.name}" />
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center"><strong>${p.name}</strong><div>‚Çπ${price}</div></div>
        <div class="small">qty: ${qty}</div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn secondary" onclick="decrement('${pid}')">-</button>
          <button class="btn" onclick="increment('${pid}')">+</button>
          <button class="btn secondary" style="margin-left:auto; background:var(--error); color:#fff; border:none;" onclick="removeFromCart('${pid}')">remove</button>
        </div>
      </div>
    `;
    cont.appendChild(div);
  });
  document.getElementById('cart-subtotal').innerText = subtotal;
  document.getElementById('checkout-subtotal-display').innerText = subtotal;
  updateCartCount();
  if (Object.keys(cart).length === 0) {
    cont.innerHTML = '<div class="card">your cart is empty</div>';
  }
}
function addToCart(pid){ cart[pid] = (cart[pid]||0)+1; saveCartToDb(); renderCart(); }
function increment(pid){ cart[pid] = (cart[pid]||0)+1; saveCartToDb(); renderCart(); }
function decrement(pid){ if(!cart[pid]) return; cart[pid] = cart[pid]-1; if(cart[pid]<=0) delete cart[pid]; saveCartToDb(); renderCart(); }
function removeFromCart(pid){ delete cart[pid]; saveCartToDb(); renderCart(); }
function clearCart(){ cart = {}; saveCartToDb(); renderCart(); }
function saveCartToDb(){
  if(!currentUser) return;
  db.ref('carts/'+currentUser.uid).set(cart);
}
function loadCartFromDb(){
  if(!currentUser) return;
  db.ref('carts/'+currentUser.uid).on('value',snap=>{
    cart = snap.val() || {};
    renderCart();
  });
}
function updateCartCount(){
  const count = Object.values(cart).reduce((s,v)=>s+v,0);
  const el = document.getElementById('cart-count');
  if(count>0){ el.style.display='flex'; el.innerText = count; } else { el.style.display='none'; }
}

function openCheckoutModal(){
  if(Object.keys(cart).length===0) return alert('cart empty');
  const itemsDiv = document.getElementById('checkout-items');
  itemsDiv.innerHTML = '';
  Object.keys(cart).forEach(pid=>{
    const p = productsData[pid];
    if(!p) return;
    const qty = cart[pid];
    const price = calcDiscountPrice(p.price,p.discount);
    const row = document.createElement('div');
    row.className = 'small';
    row.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${p.name} √ó ${qty}</div><div>‚Çπ${price * qty}</div></div>`;
    itemsDiv.appendChild(row);
  });

  document.getElementById('checkout-utr').value = '';
  document.getElementById('checkout-overlay').style.display = 'flex';
}
function closeCheckoutModal(){ document.getElementById('checkout-overlay').style.display = 'none'; }
async function confirmCheckout(){
  const utr = (document.getElementById('checkout-utr').value||'').trim();
  if(!utr || utr.length !== 12) return alert('enter valid 12-digit UTR');

  const addr = (await db.ref('users/'+currentUser.uid+'/address').once('value')).val();
  if(!addr || !addr.house) return alert('please save your delivery address in the profile tab first.');

  const orderId = 'o'+Date.now();
  const subtotal = Number(document.getElementById('cart-subtotal').innerText) || 0;
  const order = {
    id: orderId,
    user: currentUser.uid,
    items: cart,
    total: subtotal,
    address: addr,
    utr,
    status: 'pending',
    created_at: Date.now()
  };
  await db.ref('orders/'+orderId).set(order);
  await db.ref('users/'+currentUser.uid+'/order_history/'+orderId).set(order);
  await db.ref('payment_requests/'+orderId).set({type:'cart', user:currentUser.uid, orderId, amount: subtotal, utr, status:'pending', created_at:Date.now()});

  cart = {}; saveCartToDb(); // Clear cart after submission
  closeCheckoutModal();
  alert('order request sent (payment pending)');
  showTab('profile'); showHistory('orders');
}

// ---------- gold requests (FIXED) ----------
function buyGold(){
  const amount = Number(document.getElementById('gold-amount').value);
  const utr = (document.getElementById('gold-utr').value||'').trim();
  if(!amount || amount < 50) return alert('minimum ‚Çπ50');
  if(!utr || utr.length !== 12) return alert('enter 12-digit utr');
  const id = 'g'+Date.now();
  const grams = (amount / GOLD_RATE).toFixed(4);
  const payload = { id, user: currentUser.uid, amount, gold_rate: GOLD_RATE, grams, utr, status: 'pending', created_at: Date.now() };

  db.ref('gold_requests/'+id).set(payload);
  db.ref('users/'+currentUser.uid+'/gold_history/'+id).set(payload); // IMMEDIATE HISTORY
  db.ref('payment_requests/'+id).set({type:'gold', user:currentUser.uid, id, amount, utr, status:'pending', created_at:Date.now()});

  alert('gold purchase request sent to admin');
  document.getElementById('gold-amount').value = '';
  document.getElementById('gold-utr').value = '';
  showHistory('gold');
}

// ---------- wallet requests (FIXED) ----------
function addWallet(){
  const amount = Number(document.getElementById('wallet-add-amount').value);
  const utr = (document.getElementById('wallet-utr').value||'').trim();
  if(!amount || amount < 10) return alert('enter valid amount');
  if(!utr || utr.length !== 12) return alert('enter 12-digit utr');
  const id = 'w'+Date.now();
  const req = { id, user: currentUser.uid, amount, utr, status:'pending', created_at: Date.now() };

  db.ref('wallet_requests/'+id).set(req);
  db.ref('users/'+currentUser.uid+'/wallet_history/'+id).set({...req, type:'add'}); // IMMEDIATE HISTORY
  db.ref('payment_requests/'+id).set({type:'wallet', user:currentUser.uid, id, amount, utr, status:'pending', created_at:Date.now()});

  alert('wallet add request sent to admin');
  document.getElementById('wallet-add-amount').value = '';
  document.getElementById('wallet-utr').value = '';
  showHistory('wallet');
}

function openWithdrawModal(){ document.getElementById('withdraw-overlay').style.display = 'flex'; }
function closeWithdrawModal(){ document.getElementById('withdraw-overlay').style.display = 'none'; }
async function submitWithdraw(){
  const amount = Number(document.getElementById('withdraw-amount').value);
  const note = (document.getElementById('withdraw-note').value||'').trim();
  const currentBalance = Number(document.getElementById('wallet-balance-main').innerText) || 0;

  if(!amount || amount < 50) return alert('min withdraw ‚Çπ50');
  if(amount > currentBalance) return alert('insufficient wallet balance');

  const wid = 'wd'+Date.now();
  const payload = { id: wid, user: currentUser.uid, amount, note, status:'pending', created_at: Date.now() };

  // Deduct immediately (optimistic update), admin will verify
  db.ref('users/'+currentUser.uid+'/wallet').transaction(curr => Number(curr||0) - amount);

  db.ref('withdrawRequests/'+wid).set(payload);
  db.ref('users/'+currentUser.uid+'/wallet_history/'+wid).set({...payload, type:'withdraw'});

  alert('withdraw request sent (amount deducted, admin verification pending)');
  closeWithdrawModal();
  showHistory('wallet');
}

// ---------- refer (FIXED) ----------
async function submitRefer(){
  const name = document.getElementById('refer-friend-name').value.trim();
  const email = document.getElementById('refer-friend-email').value.trim();
  const mobile = document.getElementById('refer-friend-mobile').value.trim();
  if(!name || !email || !mobile) return alert('fill all friend details');

  const uSnap = await db.ref('users/'+currentUser.uid).once('value');
  const user = uSnap.val() || {};

  if(!user.refer) return alert('refer code not generated yet, try reloading profile.');

  const id = 'r'+Date.now();
  const req = { id, user: currentUser.uid, name, email, mobile, refer_code: user.refer, status:'pending', created_at: Date.now() };

  db.ref('refer_cash_requests/'+id).set(req);
  db.ref('users/'+currentUser.uid+'/refer_history/'+id).set(req); // IMMEDIATE HISTORY

  alert('refer request sent to admin for processing.');
  document.getElementById('refer-friend-name').value = '';
  document.getElementById('refer-friend-email').value = '';
  document.getElementById('refer-friend-mobile').value = '';
  showHistory('refer');
}
function loadReferHistory(){
  const list = document.getElementById('refer-history-list');
  list.innerHTML='';
  db.ref('users/'+currentUser.uid+'/refer_history').on('value',snap=>{
    const data = snap.val()||{};
    list.innerHTML='';
    const items = Object.values(data).sort((a,b)=>b.created_at - a.created_at);
    items.forEach(r=>{
      const d = document.createElement('div');
      d.className='card';
      d.innerHTML = `<div style="font-weight:600">${r.name} (${r.mobile})</div><div class="small-muted">${r.email}</div><div style="margin-top:4px;">${renderStatusBadge(r.status)}</div>`;
      list.appendChild(d);
    });
  });
}

// ---------- kyc (FIXED) ----------
async function uploadKYC(){
  const kycSnap = await db.ref('users/'+currentUser.uid+'/kyc').once('value');
  const existing = kycSnap.val();
  if(existing && (existing.status === 'verified' || existing.status === 'pending')) return alert('KYC already submitted or verified. Cannot resubmit.');

  const name = document.getElementById('kyc-name').value.trim();
  const number = document.getElementById('kyc-number').value.trim();
  const front = document.getElementById('kyc-front').files[0];
  const back = document.getElementById('kyc-back').files[0];

  if(!name || !number || number.length < 12 || !front || !back) return alert('fill all kyc fields and ensure Aadhaar number is valid');

  alert('uploading photos...');
  try {
    const r1 = await axios.post('https://api.imgbb.com/1/upload?key='+imgbbKey, (() => { const f = new FormData(); f.append('image', front); return f; })());
    const u1 = r1.data.data.url;

    const r2 = await axios.post('https://api.imgbb.com/1/upload?key='+imgbbKey, (() => { const f = new FormData(); f.append('image', back); return f; })());
    const u2 = r2.data.data.url;

    const id = 'k'+Date.now();
    const payload = {
      id, user: currentUser.uid, name, number,
      front_url: u1, back_url: u2,
      status:'pending',
      created_at: Date.now()
    };

    await db.ref('kyc_requests/'+id).set(payload);
    await db.ref('users/'+currentUser.uid+'/kyc').set({status:'pending', id, number});

    alert('kyc submitted to admin for verification');
  } catch(e){
    alert('submission failed: ' + (e.message || 'Image upload error'));
  }
}

// ---------- loan (NEW) ----------
async function submitLoanRequest(){
  const amount = Number(document.getElementById('loan-amount').value);
  const pan = document.getElementById('loan-pan-number').value.trim();
  const profession = document.getElementById('loan-profession').value.trim();
  const ref1 = document.getElementById('loan-ref1').value.trim();
  const ref2 = document.getElementById('loan-ref2').value.trim();
  const panPhoto = document.getElementById('loan-pan-photo').files[0];

  if(!amount || amount < 5000) return alert('min loan ‚Çπ5000');
  if(!pan || !profession || !ref1 || !ref2 || !panPhoto) return alert('fill all loan details and upload pan photo');

  alert('uploading pan photo...');
  try {
    const r = await axios.post('https://api.imgbb.com/1/upload?key='+imgbbKey, (() => { const f = new FormData(); f.append('image', panPhoto); return f; })());
    const pan_url = r.data.data.url;

    const id = 'l'+Date.now();
    const payload = {
      id, user: currentUser.uid, amount, pan, profession, ref1, ref2, pan_url,
      status:'in_review', created_at: Date.now()
    };

    await db.ref('loan_requests/'+id).set(payload);
    await db.ref('users/'+currentUser.uid+'/loan_history/'+id).set(payload);

    alert('loan application sent. We are reviewing your application.');
    document.getElementById('loan-amount').value = '';
    // Clear other fields...
  } catch(e){
    alert('loan submission failed: ' + (e.message || 'Error'));
  }
}

function listenLoanOffers(){
  // Listen for loan offers from admin
  db.ref('loan_offers').on('child_changed', snap => {
    const offer = snap.val();
    if(offer && offer.user === currentUser.uid && offer.status === 'offered'){
      currentLoanOffer = offer;
      document.getElementById('loan-accept-title').innerText = `loan offer for ‚Çπ${offer.amount}`;
      document.getElementById('loan-offer-details').innerHTML = `
        <div class="card">
          <div class="small">Offer Amount: <strong>‚Çπ${offer.amount}</strong></div>
          <div class="small">Total Repayable: <strong>‚Çπ${offer.repay_amount}</strong></div>
          <div class="small">EMI: <strong>‚Çπ${offer.emi_amount}</strong> (${offer.emi_frequency})</div>
          <div class="small-muted" style="margin-top:8px;">Admin Note: ${offer.admin_note || '‚Äî'}</div>
        </div>
      `;
      document.getElementById('loan-accept-overlay').style.display = 'flex';
      showTab('loan');
    }
  });
}

async function acceptLoanOffer(){
  if(!currentLoanOffer) return;
  const offer = currentLoanOffer;
  // Set loan as active and add to wallet
  await db.ref('users/'+currentUser.uid+'/active_loan').set({
    ...offer,
    status: 'active',
    accepted_at: Date.now(),
    outstanding: offer.repay_amount,
  });
  // Add amount to wallet
  await db.ref('users/'+currentUser.uid+'/wallet').transaction(curr => Number(curr||0) + Number(offer.amount));
  await db.ref('users/'+currentUser.uid+'/wallet_history/loan_credit_'+Date.now()).set({
    id: 'loan_credit_'+Date.now(), amount: Number(offer.amount), type:'loan_credit', status:'completed', created_at:Date.now()
  });
  // Update loan offer status
  await db.ref('loan_offers/'+offer.id+'/status').set('accepted');
  await db.ref('users/'+currentUser.uid+'/loan_history/'+offer.id+'/status').set('accepted');

  currentLoanOffer = null;
  document.getElementById('loan-accept-overlay').style.display = 'none';
  alert('loan accepted! amount credited to your wallet.');
}

async function rejectLoanOffer(){
  if(!currentLoanOffer) return;
  await db.ref('loan_offers/'+currentLoanOffer.id+'/status').set('rejected');
  await db.ref('users/'+currentUser.uid+'/loan_history/'+currentLoanOffer.id+'/status').set('rejected');
  currentLoanOffer = null;
  document.getElementById('loan-accept-overlay').style.display = 'none';
  alert('loan offer rejected.');
}

function loadLoanHistory(){
  const list = document.getElementById('loan-history-list');
  list.innerHTML='';
  db.ref('users/'+currentUser.uid+'/loan_history').on('value',snap=>{
    const data = snap.val()||{};
    list.innerHTML='';
    const items = Object.values(data).sort((a,b)=>b.created_at - a.created_at);

    items.forEach(l=>{
      const d = document.createElement('div');
      d.className='card history';
      d.innerHTML = `
        <div style="font-weight:600">request: ‚Çπ${l.amount}</div>
        <div class="small-muted">${new Date(l.created_at).toLocaleString()}</div>
        <div style="margin-top:4px;">${renderStatusBadge(l.status)}</div>
        ${l.status === 'active' || l.status === 'accepted' ? `
          <div class="small" style="margin-top:8px;">Outstanding: ‚Çπ${l.outstanding || l.repay_amount || l.amount}</div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <input type="text" placeholder="UTR for repayment" id="loan-utr-${l.id}">
            <button class="btn" onclick="submitLoanPayment('${l.id}', ${l.outstanding || l.repay_amount || l.amount})">close loan</button>
          </div>
        ` : ''}
      `;
      list.appendChild(d);
    });
  });
}

function submitLoanPayment(loanId, amount){
  const utr = document.getElementById(`loan-utr-${loanId}`).value.trim();
  if(!utr || utr.length !== 12) return alert('enter valid 12-digit UTR');

  const id = 'lpay'+Date.now();
  const payload = { id, user: currentUser.uid, loanId, amount, utr, status: 'pending', created_at: Date.now() };

  db.ref('loan_payments/'+id).set(payload);
  db.ref('payment_requests/'+id).set({type:'loan_pay', user:currentUser.uid, id, amount, utr, status:'pending', created_at:Date.now()});

  alert('loan payment request sent to admin. Your loan status will update once verified.');
}

// ---------- support chat (NEW) ----------
function loadChatMessages(){
  const chatBox = document.getElementById('chat-messages');
  chatBox.innerHTML = '';
  db.ref('support_chats/'+currentUser.uid).on('value', snap => {
    chatBox.innerHTML = '';
    const messages = snap.val() || {};
    const items = Object.values(messages).sort((a,b)=>a.created_at - b.created_at);

    items.forEach(msg => {
      const d = document.createElement('div');
      d.className = `message-bubble ${msg.sender === 'user' ? 'user-message' : 'admin-message'}`;
      d.innerText = msg.message;
      chatBox.appendChild(d);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

function sendMessage(){
  const input = document.getElementById('support-message-input');
  const message = input.value.trim();
  if(!message) return;

  const msgId = 'm'+Date.now();
  const payload = { id: msgId, sender: 'user', message, created_at: Date.now(), read: false };

  db.ref('support_chats/'+currentUser.uid+'/'+msgId).set(payload);
  // Also send to admin global log
  db.ref('admin_support_log/'+currentUser.uid+'/'+msgId).set(payload);

  input.value = '';
}

// ---------- history / quick lists (FIXED) ----------
function loadQuickHistory(){
  // Loads and displays mixed quick history (orders, gold, wallet)
  // ... (existing logic, ensuring it uses the updated data structure)
  const c = document.getElementById('quick-history');
  c.innerHTML = '<div class="small-muted">Loading history...</div>';

  db.ref('users/'+currentUser.uid).once('value').then(snap=>{
    const u = snap.val()||{};
    c.innerHTML = ''; // Clear loading

    const historyItems = [];

    const orders = u.order_history ? Object.values(u.order_history).map(o => ({...o, display_type: 'Order', value: o.total || 0})) : [];
    const golds = u.gold_history ? Object.values(u.gold_history).map(g => ({...g, display_type: 'Gold Buy', value: g.amount})) : [];
    const wallets = u.wallet_history ? Object.values(u.wallet_history).map(w => ({...w, display_type: `Wallet ${w.type||'Tx'}`, value: w.amount})) : [];
    const loans = u.loan_history ? Object.values(u.loan_history).map(l => ({...l, display_type: `Loan ${l.status==='active'?'Active':'Req'}`, value: l.amount})) : [];

    historyItems.push(...orders, ...golds, ...wallets, ...loans);
    historyItems.sort((a,b) => b.created_at - a.created_at);

    historyItems.slice(0, 6).forEach(item => {
      const d = document.createElement('div');
      d.className='card';
      d.innerHTML = `
        <div style="font-weight:600">${item.display_type} ‚Ä¢ ${item.id.substring(0, 8)}...</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">‚Çπ${item.value} ${item.grams ? `(${item.grams}g)` : ''}</div>
          ${renderStatusBadge(item.status)}
        </div>
      `;
      c.appendChild(d);
    });
    if (historyItems.length === 0) {
        c.innerHTML = '<div class="small-muted">No recent history.</div>';
    }
  });
}

function loadWalletHistory(){
  const list = document.getElementById('wallet-history-list');
  list.innerHTML='';
  db.ref('users/'+currentUser.uid+'/wallet_history').on('value',snap=>{
    const data = snap.val()||{};
    list.innerHTML='';
    const items = Object.values(data).sort((a,b)=>b.created_at - a.created_at);

    items.forEach(w=>{
      const d = document.createElement('div');
      d.className='card history';
      d.innerHTML = `
        <div style="font-weight:600">${w.type.toUpperCase()} ‚Ä¢ ‚Çπ${w.amount}</div>
        <div class="small-muted">${new Date(w.created_at).toLocaleString()}</div>
        <div style="margin-top:4px;">${renderStatusBadge(w.status)}</div>
      `;
      list.appendChild(d);
    });
    if (items.length === 0) { list.innerHTML = '<div class="card">No wallet history.</div>'; }
  });
}

function loadGoldHistory(){
  const list = document.getElementById('gold-status-list');
  list.innerHTML='';
  db.ref('users/'+currentUser.uid+'/gold_history').on('value',snap=>{
    const data = snap.val()||{};
    list.innerHTML='';
    const items = Object.values(data).sort((a,b)=>b.created_at - a.created_at);

    items.forEach(g=>{
      const d = document.createElement('div');
      d.className='card history';
      d.innerHTML = `
        <div style="font-weight:600">Buy: ‚Çπ${g.amount} ‚Üí ${Number(g.grams).toFixed(4)}g</div>
        <div class="small-muted">${new Date(g.created_at).toLocaleString()}</div>
        <div style="margin-top:4px;">${renderStatusBadge(g.status)}</div>
      `;
      list.appendChild(d);
    });
    if (items.length === 0) { list.innerHTML = '<div class="card">No gold purchase history.</div>'; }
  });
}

function loadOrderHistory(){
  const container = document.getElementById('orders-full-list');
  container.innerHTML = '<h3>My Orders</h3>';

  const wrapper = document.createElement('div');
  db.ref('users/'+currentUser.uid+'/order_history').on('value',snap=>{
    wrapper.innerHTML = '';
    const data = snap.val()||{};
    const items = Object.values(data).sort((a,b)=>b.created_at - a.created_at);

    items.forEach(o=>{
      const d = document.createElement('div');
      d.className='card history';

      const itemsSummary = o.items
        ? Object.keys(o.items).map(pid=>{
            const p = productsData[pid];
            return (p? p.name : pid) + (o.items[pid] ? ' x'+o.items[pid] : '');
          }).join(', ')
        : '‚Äî';

      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">${o.id || ''} ‚Ä¢ ‚Çπ${o.total||0}</div>
            <div class="small-muted">${new Date(o.created_at).toLocaleString()}</div>
            <div class="small" style="margin-top:6px">${itemsSummary}</div>
            <div class="small" style="margin-top:6px">Address: ${o.address ? `${o.address.house}, ${o.address.city}` : '‚Äî'}</div>
            <div class="small" style="margin-top:6px">UTR: ${o.utr||'‚Äî'}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">Status</div>
            <div style="margin-top:8px">${renderStatusBadge(o.status)}</div>
          </div>
        </div>
      `;
      wrapper.appendChild(d);
    });
    if (items.length === 0) { wrapper.innerHTML = '<div class="card">No order history.</div>'; }
  });
  container.appendChild(wrapper);
}

// ---------- listen to payment_requests (FIXED) ----------
function listenPaymentRequests(){
  db.ref('payment_requests').on('child_changed', handlePaymentRequest);
}
function handlePaymentRequest(snap){
  const pr = snap.val();
  if(!pr || pr.user !== currentUser.uid) return;

  const uid = pr.user;
  const key = pr.id || pr.orderId || snap.key;
  const status = pr.status ? pr.status.toLowerCase() : 'pending';

  if(!['completed', 'paid', 'success', 'rejected', 'failed'].includes(status)) return;

  // GOLD
  if(pr.type==='gold'){
    db.ref('users/'+uid+'/gold_history/'+key).once('value').then(s=>{
      const g = s.val();
      if(!g || g.status === 'completed') return;

      db.ref('users/'+uid+'/gold_history/'+key+'/status').set(status);
      if(status === 'completed' || status === 'success' || status === 'paid'){
        const grams = Number(g.grams || (g.amount / GOLD_RATE));
        db.ref('users/'+uid+'/gold_balance').transaction(curr => Number(curr||0) + grams);
      }
      alert(`Gold request ${key.substring(0,8)}... status: ${status.toUpperCase()}`);
    });
  }

  // WALLET ADD
  if(pr.type==='wallet'){
    db.ref('users/'+uid+'/wallet_history/'+key).once('value').then(h=>{
      if(h.exists() && h.val().status === 'completed') return;

      db.ref('users/'+uid+'/wallet_history/'+key+'/status').set(status);
      if(status === 'completed' || status === 'success' || status === 'paid'){
        db.ref('users/'+uid+'/wallet').transaction(curr => Number(curr||0) + Number(pr.amount));
        db.ref('users/'+uid+'/wallet_history/'+key+'/status').set('completed');
      } else if (status === 'rejected' || status === 'failed'){
          // Revert optimistic add logic if any, but since this is an ADD, no revert needed
      }
      alert(`Wallet Add request ${key.substring(0,8)}... status: ${status.toUpperCase()}`);
    });
  }
  // WALLET WITHDRAW (Admin approves from withdrawRequests)
  if(pr.type==='withdraw'){
     db.ref('users/'+uid+'/wallet_history/'+key).once('value').then(h=>{
      if(h.exists() && h.val().status === 'completed') return;
      db.ref('users/'+uid+'/wallet_history/'+key+'/status').set(status);
      if(status === 'rejected' || status === 'failed'){
          // Revert deduction for failed withdraw
          db.ref('users/'+uid+'/wallet').transaction(curr => Number(curr||0) + Number(pr.amount));
          db.ref('users/'+uid+'/wallet_history/'+key+'/status').set('failed');
      } else if (status === 'completed' || status === 'success'){
           db.ref('users/'+uid+'/wallet_history/'+key+'/status').set('completed');
      }
      alert(`Wallet Withdraw request ${key.substring(0,8)}... status: ${status.toUpperCase()}`);
    });
  }


  // CART
  if(pr.type==='cart'){
    const orderId = pr.orderId || key;
    db.ref('orders/'+orderId+'/status').set(status);
    db.ref('users/'+uid+'/order_history/'+orderId+'/status').set(status);
    alert(`Order ${orderId.substring(0,8)}... status: ${status.toUpperCase()}`);
  }
}

// ---------- logout ----------
function logout(){
  auth.signOut().then(()=> location.href='rupe.html');
}

// ---------- UI init ----------
document.getElementById('search-input').addEventListener('input', ()=>{
  if(!document.getElementById('search-input').value) applyFilter();
});
document.getElementById('search-shop').addEventListener('keydown', (e)=>{
  if(e.key==='Enter') searchShop();
});
document.getElementById('support-message-input').addEventListener('keydown', (e)=>{
  if(e.key==='Enter') sendMessage();
});
</script>
</body>
</html>

