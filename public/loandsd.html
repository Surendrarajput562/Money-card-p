<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Support Chat</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // --- FIREBASE CONFIG & INITIALIZATION ---
        
        // TODO: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
            authDomain: "smbrand-4543a.firebaseapp.com",
            databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
            projectId: "smbrand-4543a",
            appId: "1:720775550032:web:0622548a007597778bad55"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let selectedChatUid = null;
        let adminListenerRef = null; 

        // --- 1. LOGIN LOGIC ---
        function adminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("Admin logged in:", userCredential.user.uid);
                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('admin-chat-container').classList.remove('hidden');
                    loadUserList(); 
                })
                .catch((error) => {
                    console.error("Login Failed:", error.message);
                    errorElement.textContent = "Login Failed: " + error.message;
                });
        }

        // --- 2. LOAD USER LIST LOGIC ---
        function loadUserList() {
            const userListElement = document.getElementById('user-list');
            userListElement.innerHTML = ''; 

            db.ref('loan_support_chat').on('value', snapshot => {
                userListElement.innerHTML = ''; 
                if (!snapshot.exists()) {
                    userListElement.innerHTML = '<p style="padding: 15px; text-align: center; color: #666;">No active chats found.</p>';
                    return;
                }

                snapshot.forEach(childSnapshot => {
                    const uid = childSnapshot.key; 
                    let lastMessage = 'Start Chatting...';
                    
                    childSnapshot.forEach(messageSnapshot => {
                         const message = messageSnapshot.val();
                         if(message) {
                             // ✅ FIX 1 (Robust Read): Check 'text' first, then 'message'. This handles both user and old admin payloads.
                             lastMessage = message.text || message.message || 'New Message...'; 
                         }
                    });

                    const listItem = document.createElement('div');
                    listItem.className = 'chat-list-item';
                    listItem.id = `chat-user-${uid}`;
                    listItem.innerHTML = `
                        <strong>User ID: ${uid}</strong>
                        <p style="margin: 0; font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMessage}</p>
                    `;
                    listItem.onclick = () => selectChat(uid);
                    userListElement.appendChild(listItem);
                    
                    if (!selectedChatUid) {
                        selectChat(uid);
                    }
                });
            });
        }

        // --- 3. SELECT CHAT LOGIC ---
        function selectChat(uid) {
            if (selectedChatUid === uid) return; 

            if (selectedChatUid) {
                document.getElementById(`chat-user-${selectedChatUid}`).classList.remove('active');
                if (adminListenerRef) {
                    adminListenerRef.off(); 
                    console.log(`Removed listener for ${selectedChatUid}`);
                }
            }

            selectedChatUid = uid;
            document.getElementById(`chat-user-${uid}`).classList.add('active');
            document.getElementById('selected-user-header').textContent = `Chatting with User: ${uid}`;
            
            document.getElementById('admin-message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;

            listenForAdminChatMessages(uid);
        }

        // --- 4. LISTEN FOR MESSAGES LOGIC ---
        function listenForAdminChatMessages(uid) {
            const chatBody = document.getElementById('chat-messages');
            chatBody.innerHTML = ''; 

            adminListenerRef = db.ref('loan_support_chat/' + uid).limitToLast(50);

            adminListenerRef.on('child_added', snap => {
                const message = snap.val();
                if(!message) return;

                // Check sender: User sends 'sender': 'user'. Admin sends 'sender_type': 'admin'
                const isUser = (message.sender === 'user') || (message.sender_type === 'user'); 
                
                const msgElement = document.createElement('div');
                msgElement.className = `chat-message ${isUser ? 'chat-user' : 'chat-admin'}`; 

                const timestamp = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // ✅ FIX 2 (Robust Read): Use 'text' or fallback to 'message' for content.
                const messageContent = message.text || message.message || 'Error loading content (Undefined/Key Missing)';

                msgElement.innerHTML = `
                    ${messageContent}
                    <span class="chat-time">${timestamp}</span>
                `;

                chatBody.appendChild(msgElement);
                chatBody.scrollTop = chatBody.scrollHeight; 
            });
        }
        
        // --- 5. SEND MESSAGE LOGIC ---
        function sendAdminMessage() {
            if (!selectedChatUid) return alert("Please select a user first.");

            const input = document.getElementById('admin-message-input');
            const text = input.value.trim(); 

            if (text === "") return;

            const adminUser = auth.currentUser;
            if (!adminUser) return alert("Admin not logged in.");

            const newMessageRef = db.ref('loan_support_chat/' + selectedChatUid).push();

            const messagePayload = {
                sender: adminUser.uid, 
                sender_type: 'admin', 
                
                // ✅ FIX 3: Send admin message using 'text' field to ensure consistency with user client.
                text: text, 
                
                user_id: selectedChatUid, 
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            newMessageRef.set(messagePayload)
                .then(() => {
                    input.value = ''; 
                })
                .catch(error => {
                    console.error("Failed to send admin message:", error);
                    alert("Failed to send message: " + error.message);
                });
        }
        
        // --- IGNORE THIS SECTION ---
        // The following functions appear to be for the User/Client App and require 
        // a 'currentUser' variable, which is not defined in this Admin HTML.
        // It should be moved to your User App file. I am commenting it out here 
        // to prevent potential errors in the Admin panel.
        /*
        let isChatListening = false;
        function openSupportChat() {
            // ... (requires isGuest, which is undefined here)
        }

        function listenForChatMessages() {
            // ... (requires currentUser.uid, which is undefined here)
        }

        function sendChatMessage() {
            // ... (requires currentUser.uid, which is undefined here)
        }
        */
        // --- END IGNORE ---
    </script>
    
    <style>
        /* CSS styles remain the same as provided */
        body { font-family: sans-serif; margin: 0; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { display: flex; width: 90%; max-width: 1200px; height: 80vh; background-color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        .login-page { padding: 40px; text-align: center; width: 100%; max-width: 400px; }
        .chat-sidebar { width: 300px; border-right: 1px solid #eee; overflow-y: auto; background-color: #e9ecef; }
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; border-bottom: 1px solid #eee; background-color: #007bff; color: white; font-weight: bold; }
        .chat-list-item { padding: 15px; border-bottom: 1px solid #ddd; cursor: pointer; transition: background-color 0.2s; }
        .chat-list-item:hover, .chat-list-item.active { background-color: #cfe2ff; }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .message-input-area { padding: 15px; border-top: 1px solid #eee; display: flex; }
        .message-input-area input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px 0 0 4px; }
        .message-input-area button { padding: 10px 15px; background-color: #28a745; color: white; border: none; cursor: pointer; border-radius: 0 4px 4px 0; }
        
        /* Message styles for admin view */
        .chat-message { max-width: 70%; padding: 10px; margin-bottom: 10px; border-radius: 15px; position: relative; font-size: 14px; }
        .chat-user { background-color: #d1ecf1; align-self: flex-start; margin-right: auto; } 
        .chat-admin { background-color: #28a745; color: white; align-self: flex-end; margin-left: auto; } 
        .chat-time { display: block; font-size: 10px; margin-top: 5px; text-align: right; color: rgba(0, 0, 0, 0.6); }
        .chat-admin .chat-time { color: rgba(255, 255, 255, 0.8); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-container" class="login-page">
        <h2>Admin Login</h2>
        <input type="email" id="admin-email" placeholder="Admin Email" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc;">
        <input type="password" id="admin-password" placeholder="Password" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc;">
        <button onclick="adminLogin()" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px;">Login</button>
        <p id="login-error" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="admin-chat-container" class="container hidden">
        
        <div class="chat-sidebar">
            <div class="chat-header" style="background-color: #343a40;">User Chats</div>
            <div id="user-list">
                <p style="padding: 15px; text-align: center; color: #666;">Loading users...</p>
            </div>
        </div>

        <div class="chat-main">
            <div id="selected-user-header" class="chat-header">Select a User to Chat</div>
            
            <div id="chat-messages" class="chat-messages">
                </div>

            <div class="message-input-area">
                <input type="text" id="admin-message-input" placeholder="Type a reply..." disabled>
                <button onclick="sendAdminMessage()" id="send-btn" disabled>Send</button>
            </div>
        </div>
    </div>

</body>
</html>

