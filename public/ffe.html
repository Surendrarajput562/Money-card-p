<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Rupi - Fast Login</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gold: #ffd700; --dark: #0a0a0a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: var(--gold); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        .login-container { background: #111; padding: 35px 25px; border-radius: 24px; border: 1px solid var(--gold); width: 90%; max-width: 380px; box-shadow: 0 0 30px rgba(255, 215, 0, 0.15); text-align: center; }
        input { width: 100%; padding: 15px; margin: 12px 0; background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 12px; box-sizing: border-box; outline: none; }
        .btn { padding: 16px; background: var(--gold); color: black; border: none; font-weight: bold; border-radius: 12px; cursor: pointer; width: 100%; font-size: 17px; margin-top: 15px; transition: 0.2s; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        
        #face-section { display: none; }
        #camera-wrapper { margin: 20px auto; position: relative; width: 240px; height: 240px; background: #000; border-radius: 50%; overflow: hidden; border: 3px solid var(--gold); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .step-dots { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .dot { height: 8px; background: #333; border-radius: 10px; flex: 1; transition: 0.4s; }
        .dot.active { background: var(--gold); }
        
        #instruction { font-size: 18px; font-weight: bold; margin: 20px 0; color: #fff; }
        .scan-line { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #00ff00; box-shadow: 0 0 15px #00ff00; z-index: 30; animation: scanAnim 1.5s infinite; }
        @keyframes scanAnim { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        .hidden { display: none !important; }
    </style>
</head>
<body onload="preloadEverything()">

    <div id="login-ui" class="login-container">
        <h2>Gold Rupi Login</h2>
        <input type="email" id="log-email" placeholder="Email Address">
        <input type="password" id="log-pass" placeholder="Password">
        <button class="btn" onclick="submitLogin()">Login Karein</button>
    </div>

    <div id="face-section" class="login-container">
        <h2 id="face-title">Security Scan</h2>
        <div id="camera-wrapper">
            <div id="s-line" class="scan-line"></div>
            <video id="video" autoplay muted playsinline></video>
        </div>
        
        <div id="steps-container">
            <div id="steps-ui" class="step-dots">
                <div id="dot1" class="dot"></div><div id="dot2" class="dot"></div>
                <div id="dot3" class="dot"></div><div id="dot4" class="dot"></div>
                <div id="dot5" class="dot"></div>
            </div>
            <p id="instruction">Taiyari...</p>
        </div>

        <button id="next-step-btn" class="btn" style="display:none;" onclick="ultraFastScan()">Start Ultra-Fast Scan</button>
    </div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
    authDomain: "smbrand-4543a.firebaseapp.com",
    databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
    projectId: "smbrand-4543a",
    appId: "1:720775550032:web:0622548a007597778bad55"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentStep = 1, isClosed = false, savedFaceData = null, modelsReady = false;
let faceMesh, cameraControl;

async function preloadEverything() {
    const URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/models';
    await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(URL)
    ]);
    modelsReady = true;
    console.log("Ultra-Fast Models Loaded");
}

async function submitLogin() {
    const email = document.getElementById('log-email').value;
    const pass = document.getElementById('log-pass').value;
    if(!email || !pass) return;
    try {
        const res = await auth.signInWithEmailAndPassword(email, pass);
        const snap = await db.ref('face_verification/' + res.user.uid).once('value');
        if(snap.exists() && snap.val().faceData) savedFaceData = new Float32Array(snap.val().faceData);
        startFlow();
    } catch(err) { alert("Error: " + err.message); }
}

function startFlow() {
    document.getElementById('login-ui').classList.add('hidden');
    document.getElementById('face-section').style.display = 'block';
    const video = document.getElementById('video');

    if(savedFaceData) {
        document.getElementById('steps-container').innerHTML = "<p>Verifying...</p>";
        startMatchingLoop();
        return;
    }

    faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
    faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.6 });
    faceMesh.onResults(onLiveness);

    cameraControl = new Camera(video, {
        onFrame: async () => { await faceMesh.send({image: video}); },
        width: 640, height: 480
    });
    cameraControl.start();
}

function onLiveness(results) {
    if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;
    const landmarks = results.multiFaceLandmarks[0];
    const eye = Math.abs(landmarks[159].y - landmarks[145].y);
    const nx = landmarks[1].x, ny = landmarks[1].y;

    if(currentStep === 1 && eye < 0.012 && !isClosed) isClosed = true;
    else if(currentStep === 1 && eye > 0.018 && isClosed) { updateUI(1, "Step 2: Right Dekhein"); currentStep = 2; }
    else if(currentStep === 2 && nx < 0.35) { updateUI(2, "Step 3: Left Dekhein"); currentStep = 3; }
    else if(currentStep === 3 && nx > 0.65) { updateUI(3, "Step 4: Uper Dekhein"); currentStep = 4; }
    else if(currentStep === 4 && ny < 0.35) { updateUI(4, "Step 5: Niche Dekhein"); currentStep = 5; }
    else if(currentStep === 5 && ny > 0.65) {
        document.getElementById('steps-container').classList.add('hidden');
        document.getElementById('next-step-btn').style.display = 'block';
    }
}

async function ultraFastScan() {
    const btn = document.getElementById('next-step-btn');
    const video = document.getElementById('video');
    const line = document.getElementById('s-line');
    
    btn.innerText = "Scanning...";
    btn.disabled = true;

    // Turant stop mediapipe
    if(faceMesh) await faceMesh.close();
    const stream = video.srcObject;
    if (stream) stream.getTracks().forEach(t => t.stop());
    
    // Quick Restart
    setTimeout(async () => {
        const newStream = await navigator.mediaDevices.getUserMedia({ video: { width: 480 } });
        video.srcObject = newStream;
        line.style.display = "block";

        const scanLoop = setInterval(async () => {
            const d = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 160 }))
                                   .withFaceLandmarks().withFaceDescriptor();
            if(d) {
                clearInterval(scanLoop);
                btn.innerText = "SUCCESS!";
                await db.ref('face_verification/' + auth.currentUser.uid).set({ faceData: Array.from(d.descriptor) });
                window.location.href = "index.html";
            }
        }, 100); // 100ms ultra fast loop
    }, 400);
}

function startMatchingLoop() {
    setInterval(async () => {
        if(!modelsReady) return;
        const d = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if(d && faceapi.euclideanDistance(d.descriptor, savedFaceData) < 0.45) window.location.href = "index.html";
    }, 1000);
}

function updateUI(n, text) {
    document.getElementById(`dot${n}`).style.background = "lime";
    let next = document.getElementById(`dot${n+1}`);
    if(next) next.classList.add('active');
    document.getElementById('instruction').innerText = text;
}
</script>
</body>
</html>

