<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üëë Admin Panel - Premium eBook Management</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
/* Base Styles */
body { font-family:'Poppins',sans-serif; margin:0; background:#f4f4f4; color:#1f2937; }
header { background:#222; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; font-size:20px; font-weight:600; }
.container { padding:20px; max-width:1200px; margin:auto; }
/* Section and Card Styles */
section { margin-bottom:30px; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
h2 { color:#d4af37; margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px; }
.book-list, .payment-list, .coupon-list, .notification-log { display:flex; flex-direction:column; gap:10px; }
.book-item, .payment-item, .coupon-item { background:#f9f9f9; padding:15px; border-radius:5px; display:flex; align-items:center; justify-content:space-between; border:1px solid #eee; }
.book-item img { width:50px; height:70px; object-fit:cover; margin-right:10px; border:1px solid #ccc; }
/* Button and Form Styles */
button { padding:8px 15px; margin-left:5px; background:#d4af37; border:none; color:#fff; border-radius:5px; cursor:pointer; font-weight:600; transition:background 0.3s; }
button:hover { background:#c59b2d; }
.hidden { opacity:0.6; background:#fff3cd; }
.flex { display:flex; align-items:center; gap:10px; }
.flex-col { display:flex; flex-direction:column; align-items:flex-start; gap:5px; }
/* Updated Form for Upload Source */
.upload-form { display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; }
.upload-form input, .upload-form textarea, .upload-form select { padding:10px; border:1px solid #ccc; border-radius:5px; width:100%; box-sizing:border-box; }
.full-width { grid-column:1 / -1; }
/* Login & Progress */
#upload-progress { margin-top:10px; padding:10px; background:#e0f7fa; border-left:5px solid #00bcd4; display:none; font-weight:600; }
.login-form { max-width:400px; margin:50px auto; padding:30px; background:#fff; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
.login-form input { margin-bottom: 15px; }
.coupon-item strong { color:#007bff; }
.notif-form { display:flex; flex-direction:column; gap:10px; }
</style>
</head>
<body>

<div id="login-screen" class="login-form">
    <h2>Admin Login üîê</h2>
    <input type="email" id="admin-email" placeholder="Email" value="rajputsurendra562@gmail.com" required>
    <input type="password" id="admin-password" placeholder="Password (Banna@1712)" required>
    <button onclick="adminLogin()" class="full-width">Login</button>
</div>

<div id="admin-panel" style="display:none;">
    <header>
        <span>Admin Panel - Premium eBook</span>
        <button onclick="adminLogout()">Logout</button>
    </header>
    <div class="container">

    <section>
    <h2>‚ûï Add New Book (Upload & Metadata)</h2>
    <form id="add-book-form" class="upload-form">
        <input type="text" id="book-title" placeholder="Book Title" required>
        <input type="text" id="book-author" placeholder="Author Name" required>
        <select id="book-category" required>
            <option value="">Select Category</option>
            <option value="Novel">Novel</option>
            <option value="Comic">Comic</option>
            <option value="Science">Science</option>
            <option value="Biography">Biography</option>
            <option value="Fiction">Fiction</option>
        </select>
        <input type="number" id="book-price-monthly" placeholder="Price Monthly (‚Çπ299)" value="299" required>
        <input type="number" id="book-price-yearly" placeholder="Price Yearly (‚Çπ2999)" value="2999" required>
        <input type="number" id="book-discount" placeholder="Discount (%)" value="0">
        
        <textarea id="book-desc" class="full-width" placeholder="Book Description"></textarea>
        
        <select id="upload-source" required>
            <option value="imgbb">Upload to ImgBB (Fast)</option>
            <option value="r2">Upload to Cloudflare R2 (Permanent)</option>
        </select>
        <input type="file" id="book-cover" accept="image/*" required>
        <input type="file" id="book-pages" accept="image/*" multiple required>

        <div id="upload-progress" class="full-width">Uploading: <span id="progress-status">0/0</span> pages...</div>
        <button type="submit" class="full-width">üöÄ Upload Book</button>
    </form>
    </section>
    
    <section>
    <h2>üéÅ Coupon Code Management</h2>
    <div class="flex" style="margin-bottom:15px;">
        <input type="text" id="coupon-code" placeholder="CODE100" style="width:150px;">
        <input type="number" id="coupon-discount" placeholder="Discount (%)" style="width:100px;">
        <input type="date" id="coupon-expiry" title="Expiry Date" style="width:150px;">
        <button onclick="createCoupon()">Create Coupon</button>
    </div>
    <div id="coupon-list" class="coupon-list"></div>
    </section>

    <section>
    <h2>üì¢ Send Notifications (Basic)</h2>
    <div class="notif-form">
        <input type="text" id="notif-title" placeholder="Notification Title (e.g., New Coupon Alert!)">
        <textarea id="notif-body" placeholder="Notification Message (e.g., Use code NEWYEAR for 20% off!)"></textarea>
        <button onclick="sendNotification()">Send Global Notification</button>
    </div>
    </section>

    <section>
    <h2>üìö All Books / Manage</h2>
    <div id="book-list" class="book-list"></div>
    </section>

    <section>
    <h2>üí≥ Pending Subscription Requests</h2>
    <div id="payment-list" class="payment-list"></div>
    </section>

    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
// --- Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
    authDomain: "smbrand-4543a.firebaseapp.com",
    databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
    projectId: "smbrand-4543a",
    storageBucket: "smbrand-4543a.firebasestorage.app",
    messagingSenderId: "720775550032",
    appId: "1:720775550032:web:0622548a007597778bad55",
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();
const auth = firebase.auth();

const imgbbKey = '021a2437b889915669b66554687bf17f';
const ADMIN_EMAIL = 'rajputsurendra562@gmail.com'; 
const DUMMY_ADMIN_PASS = 'Banna@1712'; 

// ‚úÖ R2 WORKER CONFIG (Update this URL!)
const R2_WORKER_URL = 'https://ebookandapk-uploder.rajputsurendra562.workers.dev'; 

// --- Authentication (Same as before) ---
auth.onAuthStateChanged(user => {
    if (user && user.email === ADMIN_EMAIL) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('admin-panel').style.display = 'block';
        loadAdminData();
    } else {
        document.getElementById('login-screen').style.display = 'block';
        document.getElementById('admin-panel').style.display = 'none';
    }
});

function adminLogin() {
    const email = document.getElementById('admin-email').value;
    const password = document.getElementById('admin-password').value; 
    
    auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
            db.ref('adminEmail').set(ADMIN_EMAIL)
                .then(() => console.log("Admin email set in DB root successfully."))
                .catch(err => alert("Login successful but failed to confirm admin config in database: " + err.message));
        })
        .catch(error => {
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                auth.createUserWithEmailAndPassword(ADMIN_EMAIL, DUMMY_ADMIN_PASS)
                    .then(() => {
                        alert('Admin account created and logged in. (Please use this password for next login: Banna@1712)');
                        db.ref('adminEmail').set(ADMIN_EMAIL)
                            .then(() => console.log("Admin email set in DB root after creation."))
                            .catch(e => console.error("Error setting admin email after creation:", e));
                    })
                    .catch(e => alert('Login Failed: ' + e.message));
            } else {
                alert('Login Failed: ' + error.message);
            }
        });
}

function adminLogout() {
    auth.signOut();
}

// --- Data Loading & Management ---
function loadAdminData() {
    loadBooks();
    loadPayments();
    loadCoupons();
}

// --- UPLOAD HANDLERS ---

// 1. ImgBB Upload Handler (Base64)
async function uploadImgbb(file){
    const base64Image = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    const form = new FormData();
    form.append('image', base64Image); 

    const res = await axios.post(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, form);
    return res.data.data.url;
}

// 2. R2 Upload Handler (FormData POST to Worker)
async function uploadR2(file, isCover){
    const fd = new FormData();
    // File ko 'file' key ke saath bhejo, jaisa ki aapke dusre code mein tha
    fd.append("file", file, file.name); 
    
    // Optional: Agar cover hai toh ek alag prefix bhejo, pages hain toh alag
    const prefix = isCover ? "covers/" : "pages/";
    fd.append("prefix", prefix); 
    
    const resp = await fetch(R2_WORKER_URL, {
        method: "POST",
        body: fd
    });
    
    if (!resp.ok) {
        const text = await resp.text();
        console.error("R2 Worker Failed:", resp.status, text);
        throw new Error(`R2 Upload failed. Status: ${resp.status}. See console for Worker response.`);
    }

    const json = await resp.json();
    if (json.publicURL) {
        return json.publicURL; // Worker se public URL return hoga
    } else {
        throw new Error('R2 Worker did not return public URL.');
    }
}


// --- Add New Book Handler ---
document.getElementById('add-book-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    
    // Form values
    const title = document.getElementById('book-title').value.trim();
    const author = document.getElementById('book-author').value.trim();
    const priceMonthly = Number(document.getElementById('book-price-monthly').value);
    const priceYearly = Number(document.getElementById('book-price-yearly').value);
    const discount = Number(document.getElementById('book-discount').value);
    const category = document.getElementById('book-category').value.trim();
    const desc = document.getElementById('book-desc').value.trim();
    const coverFile = document.getElementById('book-cover').files[0];
    const pageFiles = Array.from(document.getElementById('book-pages').files);
    const uploadSource = document.getElementById('upload-source').value; // NEW!
    
    if(!title || !author || !priceMonthly || !priceYearly || !coverFile || pageFiles.length===0 || !category) {
        return alert('Please fill all required fields: Title, Author, Prices, Category, Cover, and Pages.');
    }

    // Set the appropriate upload function based on the selector
    const uploader = (uploadSource === 'r2') ? uploadR2 : uploadImgbb;
    
    const progressDiv = document.getElementById('upload-progress');
    const statusSpan = document.getElementById('progress-status');
    progressDiv.style.display = 'block';
    
    try{
        // 1. Upload cover
        statusSpan.innerText = `1/1 Cover... using ${uploadSource}`;
        const coverUrl = await uploader(coverFile, true); // true for isCover
        
        // 2. Upload pages with progress
        const pagesUrls = [];
        for(let i=0;i<pageFiles.length;i++){
            statusSpan.innerText = `Uploading Page ${i+1} of ${pageFiles.length}... using ${uploadSource}`;
            const url = await uploader(pageFiles[i], false); // false for isCover
            pagesUrls.push(url);
        }
        statusSpan.innerText = `All ${pageFiles.length} Pages Uploaded. Saving to Database...`;

        // 3. Save to Firebase
        const bookId = 'b'+Date.now();
        await db.ref('books/'+bookId).set({
            id: bookId, title, author, priceMonthly, priceYearly, discount, category, desc, coverUrl,
            pages: pagesUrls, pageCount: pagesUrls.length, hidden:false, createdAt:Date.now()
        });
        
        await db.ref('categories/'+category).set(true); 

        alert('Book uploaded successfully!');
        document.getElementById('add-book-form').reset();
        progressDiv.style.display = 'none';
        loadAdminData();
    }catch(err){
        console.error('Upload Error:', err);
        if (err.message && err.message.includes("permission_denied")) {
             alert('Error uploading book: Permission Denied. Check Firebase Rules.');
        } else {
             alert('Error uploading book: ' + (err.message || 'Check console'));
        }
        progressDiv.style.display = 'none';
    }
});
// --- Remaining Functions (loadBooks, previewBook, etc. are the same) ---

function loadBooks(){
    db.ref('books').once('value').then(snap=>{
        const data = snap.val()||{};
        const container = document.getElementById('book-list');
        container.innerHTML='';
        Object.values(data).sort((a,b)=>b.createdAt - a.createdAt).forEach(book=>{
            const finalMonthlyPrice = book.priceMonthly * (1 - (book.discount || 0) / 100);
            const div = document.createElement('div');
            div.className='book-item '+(book.hidden?'hidden':'');
            const source = book.coverUrl.includes(R2_WORKER_URL.split('/')[2]) ? 'R2' : 'ImgBB'; // Simple check
            div.innerHTML=`
            <div class="flex">
                <img src="${book.coverUrl}" alt="Cover">
                <div class="flex-col">
                    <strong>${book.title}</strong> (${book.category})<br>By ${book.author}
                    <div style="font-size:12px;">‚Çπ${finalMonthlyPrice.toFixed(0)}/mo | Discount: ${book.discount || 0}% | Pages: ${book.pageCount}</div>
                    <span style="color:${book.hidden?'red':'green'}; font-weight:600; font-size:12px;">Status: ${book.hidden?'Hidden':'Visible'} | Source: ${source}</span>
                </div>
            </div>
            <div class="flex">
                <button onclick="previewBook('${book.id}')">Preview</button>
                <button onclick="editBookDetails('${book.id}')">Edit Details</button>
                <button onclick="toggleVisibility('${book.id}',${book.hidden})">${book.hidden?'Show':'Hide'}</button>
                <button onclick="deleteBook('${book.id}')">Delete</button>
            </div>
            `;
            container.appendChild(div);
        });
        if (Object.keys(data).length === 0) container.innerHTML = '<p>No books uploaded yet.</p>';
    });
}
function previewBook(id){
    db.ref('books/'+id).once('value').then(snap=>{
        const book = snap.val();
        if(!book) return;
        let html = `<h3>${book.title} - Admin Preview</h3><p>${book.desc}</p><hr>`;
        book.pages.forEach((url, index)=>{ html+=`<img src="${url}" style="width:100%; max-width:500px; margin-bottom:15px; border:1px solid #ccc;">`; });
        const win = window.open('','_blank','width=600,height=700,scrollbars=yes');
        win.document.write(`<html><head><title>Admin Preview</title></head><body><div style="padding: 20px;">${html}</div></body></html>`);
    });
}
function editBookDetails(id){
    db.ref('books/'+id).once('value').then(snap => {
        const book = snap.val();
        if (!book) return;
        const newMonthly = prompt(`Enter new Monthly Price (Current: ‚Çπ${book.priceMonthly}):`);
        const newYearly = prompt(`Enter new Yearly Price (Current: ‚Çπ${book.priceYearly}):`);
        const newDiscount = prompt(`Enter new Discount Percentage (Current: ${book.discount || 0}%):`);

        const updates = {};
        if (newMonthly !== null && !isNaN(newMonthly) && newMonthly >= 0) updates.priceMonthly = Number(newMonthly);
        if (newYearly !== null && !isNaN(newYearly) && newYearly >= 0) updates.priceYearly = Number(newYearly);
        if (newDiscount !== null && !isNaN(newDiscount) && newDiscount >= 0 && newDiscount <= 100) updates.discount = Number(newDiscount);
        
        if(Object.keys(updates).length > 0) {
            db.ref('books/'+id).update(updates).then(()=>{ loadBooks(); alert('Book details updated!'); });
        } else {
            alert('No valid changes made.');
        }
    });
}
function toggleVisibility(id,hidden){ db.ref('books/'+id).update({hidden:!hidden}).then(()=>{ loadBooks(); }); }
function deleteBook(id){ if(confirm('Permanently delete this book?')) db.ref('books/'+id).remove().then(()=>{ loadBooks(); alert('Book deleted.'); }); }

// --- Payment Management Functions (Load, Approve, Reject) ---
function loadPayments(){
    db.ref('payments').orderByChild('status').equalTo('pending').once('value').then(snap=>{
        const data = snap.val()||{};
        const container = document.getElementById('payment-list');
        container.innerHTML='';
        Object.values(data).sort((a,b)=>b.timestamp - a.timestamp).forEach(p=>{
            const div = document.createElement('div');
            div.className='payment-item';
            div.innerHTML=`
            <div class="flex-col">
                <div><strong>üìß User:</strong> ${p.userEmail}</div>
                <div><strong>üìò Book ID:</strong> ${p.bookId} (<span style="color:#d4af37;">${p.plan.toUpperCase()}</span>)</div>
                <div><strong>üí∞ Amount:</b> ‚Çπ${p.amount}</div>
                <div><strong>üî¢ UTR:</strong> <span style="font-weight:bold; color:#0056b3;">**${p.utr}**</span></div>
                <div><strong>üïí Date:</strong> ${new Date(p.timestamp).toLocaleString()}</div>
            </div>
            <div class="flex">
                <button onclick="approvePayment('${p.id}', '${p.userEmail}', '${p.bookId}', '${p.plan}')">‚úÖ Approve</button>
                <button onclick="rejectPayment('${p.id}')">‚ùå Reject</button>
            </div>
            `;
            container.appendChild(div);
        });
        if(Object.keys(data).length === 0) container.innerHTML = '<p style="padding:10px;">üéâ No pending payment requests.</p>';
    });
}
function approvePayment(paymentId, userEmail, bookId, plan){
    const now = Date.now();
    let durationDays = (plan === 'monthly') ? 30 : (plan === 'yearly' ? 365 : 0);
    const expiryDate = now + (durationDays * 24 * 60 * 60 * 1000); 
    const userKey = userEmail.replace(/[.#$[\]]/g, '_'); 

    db.ref('payments/'+paymentId).update({status:'approved'}).then(()=>{
        db.ref('users/'+userKey+'/subscriptions/'+bookId).set({
            status:'approved', plan: plan, timestamp: now, expiresAt: expiryDate
        }).then(()=>{
            loadPayments();
            const notifId = 'notif'+Date.now();
            db.ref('notifications/'+notifId).set({
                id: notifId, recipient: userKey, 
                title: 'Subscription Approved! üéâ',
                body: `Your ${plan.toUpperCase()} subscription for Book ID ${bookId} has been approved. Expires: ${new Date(expiryDate).toLocaleDateString()}.`,
                timestamp: Date.now(), read: false
            });
            alert(`Payment approved & subscription unlocked for user ${userEmail}! Notification sent.`);
        });
    }).catch(err => alert('Error approving payment: ' + err.message));
}
function rejectPayment(id){
    if(confirm('Are you sure you want to reject this payment request?')) {
        db.ref('payments/'+id).update({status:'rejected'}).then(()=>{ loadPayments(); alert('Payment rejected.'); });
    }
}

// --- Coupon Management Functions (Create, Load, Delete) ---
function createCoupon() {
    const code = document.getElementById('coupon-code').value.trim().toUpperCase();
    const discount = Number(document.getElementById('coupon-discount').value);
    const expiryDate = document.getElementById('coupon-expiry').value;

    if (!code || isNaN(discount) || discount <= 0 || discount > 100 || !expiryDate) {
        return alert('Enter a valid code, discount (1-100%), and expiry date.');
    }

    const expiryTimestamp = new Date(expiryDate).getTime();
    if(expiryTimestamp < Date.now()) return alert('Expiry date must be in the future.');

    db.ref('coupons/' + code).set({
        code, discount, expiryTimestamp, createdAt: Date.now()
    }).then(() => {
        alert(`Coupon ${code} (${discount}% off) created successfully!`);
        document.getElementById('coupon-code').value = '';
        document.getElementById('coupon-discount').value = '';
        document.getElementById('coupon-expiry').value = '';
        loadCoupons();
    }).catch(e => alert('Error creating coupon: ' + e.message));
}

function loadCoupons() {
    db.ref('coupons').once('value').then(snap => {
        const data = snap.val() || {};
        const container = document.getElementById('coupon-list');
        container.innerHTML = '';
        
        Object.values(data).sort((a,b)=>b.createdAt - a.createdAt).forEach(coupon => {
            const expired = coupon.expiryTimestamp < Date.now();
            const div = document.createElement('div');
            div.className = 'coupon-item ' + (expired ? 'hidden' : '');
            div.innerHTML = `
            <div class="flex-col">
                <strong>${coupon.code}</strong>
                <div>Discount: ${coupon.discount}% Off</div>
                <div style="font-size:12px; color: ${expired ? 'red' : 'green'};">
                    Expires: ${new Date(coupon.expiryTimestamp).toLocaleDateString()} (${expired ? 'EXPIRED' : 'ACTIVE'})
                </div>
            </div>
            <button onclick="deleteCoupon('${coupon.code}')">Delete</button>
            `;
            container.appendChild(div);
        });
        if (Object.keys(data).length === 0) container.innerHTML = '<p>No coupons available.</p>';
    });
}

function deleteCoupon(code) {
    if(confirm(`Delete coupon code ${code}?`)) {
        db.ref('coupons/' + code).remove().then(() => { loadCoupons(); alert('Coupon deleted.'); });
    }
}

// --- Notification Sender ---
function sendNotification() {
    const title = document.getElementById('notif-title').value.trim();
    const body = document.getElementById('notif-body').value.trim();

    if (!title || !body) return alert('Enter both title and message body.');

    if(confirm('Send this notification to ALL users?')) {
        const notifId = 'notif'+Date.now();
        db.ref('notifications/'+notifId).set({
            id: notifId, recipient: 'global', // 'global' means all users
            title, body, timestamp: Date.now(), read: false
        }).then(() => {
            alert('Global notification sent successfully!');
            document.getElementById('notif-title').value = '';
            document.getElementById('notif-body').value = '';
        }).catch(e => alert('Error sending notification: ' + e.message));
    }
}
</script>
</body>
</html>

