<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gold Rupi - Mobile App</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* ==================================== */
        /* 5. UI/UX Requirements: CSS & Styling */
        /* ==================================== */
        :root {
            --primary-color: #ffd700; /* Gold */
            --secondary-color: #4a90e2; /* Accent Blue */
            --background-color: #f0f0f0; /* Light Neumorphism */
            --card-color: #ffffff;
            --text-color: #333;
            --glass-bg: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-light: -4px -4px 8px rgba(255, 255, 255, 0.7);
            --shadow-dark: 4px 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Base & Mobile-First Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }

        #app {
            width: 100%;
            max-width: 450px; /* Mobile View Constraint */
            min-height: 100vh;
            background: var(--background-color);
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Neumorphic/Glassmorphic Card & Container */
        .panel-container {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .card {
            background: var(--card-color);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-dark), var(--shadow-light);
            transition: transform 0.3s ease;
        }

        .card:hover {
            /* transform: translateY(-2px); */
        }
        
        /* Glassmorphic elements */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            padding: 15px;
            margin-bottom: 15px;
        }

        /* Buttons: Rounded, Soft Shadows, Smooth Animation */
        button, .btn {
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1), -2px -2px 5px rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease-in-out;
            width: 100%;
            margin-top: 10px;
        }

        button:active, .btn:active {
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.1), inset -2px -2px 5px rgba(255, 255, 255, 0.8);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #fff;
            color: var(--secondary-color);
        }
        
        .btn-small {
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
        }

        /* Inputs: Floating Labels, Validation */
        .input-group {
            position: relative;
            margin-bottom: 25px;
        }

        .input-group input:focus ~ label,
        .input-group input:not(:placeholder-shown) ~ label {
            top: -10px;
            left: 5px;
            font-size: 12px;
            color: var(--secondary-color);
            background: var(--background-color);
            padding: 0 5px;
        }
        
        .input-group label {
            position: absolute;
            top: 15px;
            left: 20px;
            color: #777;
            font-size: 16px;
            transition: all 0.2s ease;
            pointer-events: none;
        }

        .input-group input {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            background: #e0e0e0;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.1), inset -2px -2px 5px rgba(255, 255, 255, 0.8);
            outline: none;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
             box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.1), inset -1px -1px 2px rgba(255, 255, 255, 0.8), 0 0 5px var(--secondary-color);
        }
        
        /* Utility */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .error-message { color: #e74c3c; font-size: 14px; margin-top: -15px; margin-bottom: 10px; }
        .success-message { color: #2ecc71; font-size: 14px; margin-top: -15px; margin-bottom: 10px; }
        
        /* Headers and Typography */
        h1 { color: var(--primary-color); text-align: center; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        h2 { font-size: 20px; margin-bottom: 15px; color: #555; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }

        /* Navigation (Mobile Bottom Bar) */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--glass-border);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            bottom: 0;
            width: 100%;
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            flex: 1;
            padding: 5px;
            cursor: pointer;
            transition: color 0.2s;
            color: #777;
            font-size: 12px;
            font-weight: 500;
        }

        .nav-item i {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }

        .nav-item.active {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        /* Admin Header */
        .admin-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Transaction History & List Items */
        .history-list {
            list-style: none;
            padding: 0;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-status {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .status-Pending { background: #f1c40f; color: #333; }
        .status-Verified { background: #3498db; color: white; }
        .status-Successful, .status-Completed, .status-Delivered { background: #2ecc71; color: white; }
        .status-Rejected { background: #e74c3c; color: white; }
        
        .txn-details {
            display: flex;
            flex-direction: column;
        }
        
        .txn-amount { font-weight: 700; font-size: 16px; }
        .txn-date { font-size: 10px; color: #777; }
        
        /* QR Code display */
        .qr-display {
            width: 100%;
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .qr-display img {
            width: 80%;
            max-width: 250px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Admin Table Styling */
        .admin-table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 600px; /* Ensure mobile horizontal scroll */
        }
        
        .admin-table th, .admin-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .admin-table th {
            background-color: #ecf0f1;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .admin-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .admin-action-btn {
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            font-size: 12px;
            width: auto;
        }
        
        .admin-action-btn.approve { background: #2ecc71; color: white; }
        .admin-action-btn.reject { background: #e74c3c; color: white; }
        
        /* Font Awesome for Icons */
        @import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css");
        
    </style>
</head>
<body>

    <div id="app">
        <div id="main-content" class="panel-container">
            </div>

        <div id="user-nav" class="bottom-nav" style="display: none;">
            <div class="nav-item active" onclick="loadUserPanel('home')">
                <i class="fas fa-home"></i> Home
            </div>
            <div class="nav-item" onclick="loadUserPanel('gold')">
                <i class="fas fa-coins"></i> Gold
            </div>
            <div class="nav-item" onclick="loadUserPanel('wallet')">
                <i class="fas fa-wallet"></i> Wallet
            </div>
            <div class="nav-item" onclick="loadUserPanel('shop')">
                <i class="fas fa-shopping-bag"></i> Shop
            </div>
            <div class="nav-item" onclick="loadUserPanel('profile')">
                <i class="fas fa-user-circle"></i> Profile
            </div>
        </div>
    </div>

<script>
    // ====================================
    // 7. Implementation Notes: Firebase Configuration
    // ====================================
    const firebaseConfig = {
        apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
        authDomain: "smbrand-4543a.firebaseapp.com",
        databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
        projectId: "smbrand-4543a",
        storageBucket: "smbrand-4543a.firebasestorage.app",
        messagingSenderId: "720775550032",
        appId: "1:720775550032:web:0622548a007597778bad55",
        measurementId: "G-3LS5W6F8QW"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    // Core App State
    let currentUser = null;
    let isUserAdmin = false;
    const ADMIN_EMAIL = 'rajputsurendra562@gmail.com';
    const IMG_BB_API_KEY = "021a2437b889915669b66554687bf17f"; // Your ImgBB Key
    const GOLD_QR_URL = 'https://i.ibb.co/TMyZrvJw/Screenshot-20251115-135633-GPay-Business.jpg';
    
    const APP_STATE = {
        currentPanel: 'home'
    };
    
    // ====================================
    // Utility Functions
    // ====================================

    /** Simple Mobile Router / Content Loader */
    function loadContent(html, panelId) {
        document.getElementById('main-content').innerHTML = html;
        if (panelId) {
            APP_STATE.currentPanel = panelId;
            // Update active state in nav bar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeNav = document.querySelector(`.nav-item[onclick*="'${panelId}'"]`);
            if (activeNav) activeNav.classList.add('active');
        }
    }

    /** Display Messages */
    function displayMessage(id, message, isError = false) {
        const el = document.getElementById(id);
        if (el) {
            el.className = isError ? 'error-message' : 'success-message';
            el.textContent = message;
            setTimeout(() => el.textContent = '', 5000);
        }
    }
    
    /** Generate Unique Referral Code (8 characters) */
    function generateReferralCode() {
        return Math.random().toString(36).substring(2, 10).toUpperCase();
    }
    
    /** Simple Date/Time formatter */
    function formatDateTime(timestamp) {
        return new Date(timestamp).toLocaleString();
    }

    // ====================================
    // 1. Authentication (Signup/Login)
    // ====================================

    /** Initial check for authentication state */
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            isUserAdmin = user.email === ADMIN_EMAIL;
            
            // Check if user data exists in RTDB
            const userRef = db.ref('users/' + user.uid);
            const snapshot = await userRef.once('value');
            if (!snapshot.exists()) {
                 // Should not happen after successful signup, but good for safety
                console.error("User exists in Auth but not in DB.");
                auth.signOut();
                loadAuthPanel();
                return;
            }
            
            if (isUserAdmin) {
                loadAdminPanel();
            } else {
                loadUserPanel('home');
            }
        } else {
            currentUser = null;
            isUserAdmin = false;
            loadAuthPanel();
        }
        document.getElementById('user-nav').style.display = user && !isUserAdmin ? 'flex' : 'none';
    });
    
    /** Renders the Auth Panel (Login/Signup) */
    function loadAuthPanel(isSignup = false) {
        const title = isSignup ? 'Sign Up for Gold Rupi' : 'Login to Gold Rupi';
        const formId = isSignup ? 'signup-form' : 'login-form';
        const buttonText = isSignup ? 'Create Account' : 'Log In';
        const switchText = isSignup ? 'Already have an account? Log In' : 'Need an account? Sign Up';
        
        const html = `
            <div class="card">
                <h1 style="color:var(--secondary-color); font-size: 28px;">${title}</h1>
                <form id="${formId}">
                    <div id="auth-message" class="text-center"></div>
                    ${isSignup ? `
                    <div class="input-group">
                        <input type="text" id="signup-name" placeholder=" " required>
                        <label for="signup-name"><i class="fas fa-user"></i> Full Name</label>
                    </div>
                    <div class="input-group">
                        <input type="tel" id="signup-mobile" placeholder=" " pattern="[0-9]{10}" required>
                        <label for="signup-mobile"><i class="fas fa-mobile-alt"></i> Mobile Number</label>
                    </div>
                    ` : ''}
                    <div class="input-group">
                        <input type="email" id="${isSignup ? 'signup-email' : 'login-email'}" placeholder=" " required>
                        <label for="${isSignup ? 'signup-email' : 'login-email'}"><i class="fas fa-envelope"></i> Email</label>
                    </div>
                    <div class="input-group">
                        <input type="password" id="${isSignup ? 'signup-password' : 'login-password'}" placeholder=" " required>
                        <label for="${isSignup ? 'signup-password' : 'login-password'}"><i class="fas fa-lock"></i> Password</label>
                    </div>
                    ${isSignup ? `
                    <div class="input-group">
                        <input type="text" id="signup-referral" placeholder=" ">
                        <label for="signup-referral"><i class="fas fa-gift"></i> Referral Code (Optional)</label>
                    </div>
                    ` : ''}
                    <button type="submit">${buttonText}</button>
                </form>
                <button class="btn-secondary" onclick="loadAuthPanel(${!isSignup})">${switchText}</button>
            </div>
        `;
        loadContent(html);
        
        // Attach event listeners after loading content
        document.getElementById(formId).addEventListener('submit', (e) => {
            e.preventDefault();
            if (isSignup) {
                handleSignup();
            } else {
                handleLogin();
            }
        });
    }

    /** Handle User Signup */
    async function handleSignup() {
        const name = document.getElementById('signup-name').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const mobile = document.getElementById('signup-mobile').value.trim();
        const password = document.getElementById('signup-password').value;
        const referrerCode = document.getElementById('signup-referral').value.trim().toUpperCase();

        if (!name || !email || !mobile || !password) {
            displayMessage('auth-message', 'Please fill all required fields.', true);
            return;
        }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            const uid = user.uid;
            const ownReferralCode = generateReferralCode();
            const timestamp = firebase.database.ServerValue.TIMESTAMP;
            
            // Initial User Data Structure
            const userData = {
                name: name,
                email: email,
                mobile: mobile,
                referralCode: ownReferralCode,
                usedReferrerCode: referrerCode || null,
                createdAt: timestamp,
                balances: {
                    goldGrams: 0,
                    walletAmount: 0
                },
                status: {
                    firstGoldPurchase: false, // For signup bonus
                    referralBonusClaimed: false,
                    kycVerified: 'Pending'
                },
                history: {
                    gold: {},
                    wallet: {},
                    orders: {},
                    kyc: {}
                },
                // Add an entry to the referrals list if a referrer code was used
                ...(referrerCode && {referrerId: await getUserIdByReferralCode(referrerCode)}),
                kyc: {
                    aadhaarNumber: '',
                    frontPhotoUrl: '',
                    backPhotoUrl: '',
                    status: 'Pending'
                }
            };

            await db.ref('users/' + uid).set(userData);

            if (referrerCode) {
                // Check referrer's existence and record the referral
                const referrerId = await getUserIdByReferralCode(referrerCode);
                if (referrerId) {
                    await db.ref(`referrals/${referrerId}/${uid}`).set({
                        name: name,
                        email: email,
                        mobile: mobile,
                        goldPurchaseStatus: false,
                        bonusCredited: false,
                        signupDate: timestamp
                    });
                }
            }
            
            displayMessage('auth-message', 'Account created successfully! Redirecting...', false);

        } catch (error) {
            displayMessage('auth-message', `Signup Failed: ${error.message}`, true);
        }
    }
    
    /** Handle User/Admin Login */
    async function handleLogin() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
            displayMessage('auth-message', 'Please enter email and password.', true);
            return;
        }

        try {
            await auth.signInWithEmailAndPassword(email, password);
            // onAuthStateChanged will handle redirection
            displayMessage('auth-message', 'Login successful! Redirecting...', false);
        } catch (error) {
            displayMessage('auth-message', `Login Failed: ${error.message}`, true);
        }
    }

    /** Logout function */
    function handleLogout() {
        auth.signOut();
    }
    
    /** Utility to find UID by Referral Code */
    async function getUserIdByReferralCode(code) {
        const snapshot = await db.ref('users').orderByChild('referralCode').equalTo(code).once('value');
        if (snapshot.exists()) {
            return Object.keys(snapshot.val())[0];
        }
        return null;
    }

    // ====================================
    // 2. User Panel
    // ====================================

    /** Main function to render User Panel based on section */
    async function loadUserPanel(section) {
        if (!currentUser) return;
        
        let userSnapshot = await db.ref('users/' + currentUser.uid).once('value');
        let userData = userSnapshot.val();

        let html = `<div class="card"><div class="glass"><div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="border-bottom: none; color:var(--text-color);">Welcome, ${userData.name}!</h2>
            <button class="btn-small btn-secondary" onclick="handleLogout()">Logout</button>
        </div><p style="font-size: 14px; color:#777;">Email: ${userData.email}</p></div></div>`;
        
        switch (section) {
            case 'home':
                html += renderHomePanel(userData);
                break;
            case 'gold':
                html += await renderGoldPanel(userData);
                break;
            case 'wallet':
                html += await renderWalletPanel(userData);
                break;
            case 'shop':
                html += await renderShopPanel(userData);
                break;
            case 'profile':
                html += await renderProfilePanel(userData);
                break;
            default:
                html += renderHomePanel(userData);
        }
        
        loadContent(html, section);
    }

    /* --- 2a) Home Section --- */
    function renderHomePanel(userData) {
        return `
            <div class="card text-center">
                <h2><i class="fas fa-chart-line"></i> Dashboard Summary</h2>
                <div class="glass">
                    <p style="font-size: 18px; font-weight: 600; color: var(--primary-color);">Gold Balance: ${userData.balances.goldGrams.toFixed(4)} Grams</p>
                    <p style="font-size: 18px; font-weight: 600; color: var(--secondary-color);">Wallet Balance: ₹ ${userData.balances.walletAmount.toFixed(2)}</p>
                </div>
                <p class="mt-20" style="font-size:14px; color:#555;">**Quick Action**</p>
                <button onclick="loadUserPanel('gold')">Buy Gold Now</button>
                <button class="btn-secondary" onclick="loadUserPanel('wallet')">Add Money to Wallet</button>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-star"></i> Quick Status</h2>
                <ul class="history-list">
                    <li class="history-item">
                        <span>KYC Status</span>
                        <span class="history-status status-${userData.kyc.status}">${userData.kyc.status}</span>
                    </li>
                    <li class="history-item">
                        <span>First Gold Buy ≥ ₹50</span>
                        <span class="history-status status-${userData.status.firstGoldPurchase ? 'Successful' : 'Pending'}">${userData.status.firstGoldPurchase ? 'Done' : 'Pending'}</span>
                    </li>
                </ul>
            </div>
        `;
    }

    /* --- 2a) Gold Section --- */
    async function renderGoldPanel(userData) {
        const goldHistorySnapshot = await db.ref(`users/${currentUser.uid}/history/gold`).once('value');
        const goldHistory = goldHistorySnapshot.val() || {};
        
        let historyHtml = Object.keys(goldHistory).reverse().map(key => {
            const txn = goldHistory[key];
            return `
                <li class="history-item">
                    <div class="txn-details">
                        <span class="txn-amount">₹ ${txn.amount.toFixed(2)} (${txn.type === 'buy' ? '+' : '-'} ${txn.grams.toFixed(4)}g)</span>
                        <span style="font-size: 10px; color: #777;">UTR: ${txn.utr} | ${formatDateTime(txn.timestamp)}</span>
                    </div>
                    <span class="history-status status-${txn.status}">${txn.status}</span>
                </li>
            `;
        }).join('');

        return `
            <div class="card text-center">
                <h2><i class="fas fa-coins"></i> Gold Section</h2>
                <div class="glass" style="margin-bottom: 20px;">
                    <p style="font-size: 18px; font-weight: 600; color: var(--primary-color);">Current Balance: ${userData.balances.goldGrams.toFixed(4)} Grams</p>
                </div>
                
                <h3>Buy Gold (Min ₹50)</h3>
                <div class="qr-display">
                    <img src="${GOLD_QR_URL}" alt="Payment QR Code">
                    <p style="font-size: 12px; color:#777;">Scan QR & Pay (Min ₹50)</p>
                </div>
                
                <form id="gold-buy-form">
                    <div id="gold-message" class="text-center"></div>
                    <div class="input-group">
                        <input type="number" id="gold-buy-amount" placeholder=" " min="50" required>
                        <label for="gold-buy-amount"><i class="fas fa-rupee-sign"></i> Amount (₹)</label>
                    </div>
                    <div class="input-group">
                        <input type="text" id="gold-buy-utr" placeholder=" " pattern="[0-9]{12}" maxlength="12" required>
                        <label for="gold-buy-utr"><i class="fas fa-hashtag"></i> 12-digit UTR Number</label>
                    </div>
                    <button type="submit" id="gold-buy-btn">Buy Gold</button>
                </form>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-undo-alt"></i> Gold Withdraw (Deduct Grams)</h2>
                <form id="gold-withdraw-form">
                    <div id="gold-withdraw-message" class="text-center"></div>
                    <div class="input-group">
                        <input type="number" id="gold-withdraw-grams" placeholder=" " step="0.0001" required>
                        <label for="gold-withdraw-grams"><i class="fas fa-weight-hanging"></i> Grams to Withdraw</label>
                    </div>
                    <button type="submit" class="btn-secondary">Request Withdrawal</button>
                </form>
            </div>

            <div class="card">
                <h2><i class="fas fa-history"></i> Transaction History</h2>
                <ul class="history-list">
                    ${historyHtml || '<li class="text-center" style="color:#777;">No Gold Transactions Yet.</li>'}
                </ul>
            </div>
        `;
    }
    
    /** Handle Gold Buy */
    async function handleGoldBuy(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('gold-buy-amount').value);
        const utr = document.getElementById('gold-buy-utr').value.trim();
        const btn = document.getElementById('gold-buy-btn');

        if (isNaN(amount) || amount < 50) {
            displayMessage('gold-message', 'Minimum purchase amount is ₹50.', true);
            return;
        }
        if (utr.length !== 12 || !/^\d+$/.test(utr)) {
            displayMessage('gold-message', 'Please enter a valid 12-digit UTR number.', true);
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Processing...';

        try {
            const goldPricePerGram = 6000; // Mock price
            const grams = amount / goldPricePerGram;

            const txnRef = db.ref(`transactions/gold_buy`).push();
            await txnRef.set({
                type: 'buy',
                userId: currentUser.uid,
                amount: amount,
                grams: grams,
                utr: utr,
                status: 'Pending', // Key Step 4: Request sent as Pending
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Log to user history immediately
            await db.ref(`users/${currentUser.uid}/history/gold/${txnRef.key}`).set({
                type: 'buy',
                amount: amount,
                grams: grams,
                utr: utr,
                status: 'Pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            displayMessage('gold-message', 'Gold purchase request sent! Status is Pending Admin Verification.', false);
            document.getElementById('gold-buy-form').reset();
            loadUserPanel('gold'); // Refresh panel

        } catch (error) {
            displayMessage('gold-message', `Transaction Failed: ${error.message}`, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Buy Gold';
        }
    }
    
    /** Handle Gold Withdraw */
    async function handleGoldWithdraw(e) {
        e.preventDefault();
        const grams = parseFloat(document.getElementById('gold-withdraw-grams').value);

        if (isNaN(grams) || grams <= 0) {
            displayMessage('gold-withdraw-message', 'Please enter a valid amount of grams.', true);
            return;
        }
        
        const userSnapshot = await db.ref('users/' + currentUser.uid + '/balances/goldGrams').once('value');
        const currentGrams = userSnapshot.val() || 0;
        
        if (grams > currentGrams) {
            displayMessage('gold-withdraw-message', `Insufficient Gold Balance. Current: ${currentGrams.toFixed(4)}g`, true);
            return;
        }

        try {
            const txnRef = db.ref(`transactions/gold_withdraw`).push();
            await txnRef.set({
                type: 'withdraw',
                userId: currentUser.uid,
                grams: grams,
                status: 'Pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Log to user history
            await db.ref(`users/${currentUser.uid}/history/gold/${txnRef.key}`).set({
                type: 'withdraw',
                amount: 0,
                grams: grams,
                utr: 'N/A',
                status: 'Pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            displayMessage('gold-withdraw-message', 'Gold withdrawal request sent! Status is Pending Admin Approval.', false);
            document.getElementById('gold-withdraw-form').reset();
            loadUserPanel('gold'); // Refresh panel
        } catch (error) {
            displayMessage('gold-withdraw-message', `Withdrawal Failed: ${error.message}`, true);
        }
    }

    /* --- 2b) Wallet Section --- */
    async function renderWalletPanel(userData) {
        const walletHistorySnapshot = await db.ref(`users/${currentUser.uid}/history/wallet`).once('value');
        const walletHistory = walletHistorySnapshot.val() || {};

        let historyHtml = Object.keys(walletHistory).reverse().map(key => {
            const txn = walletHistory[key];
            const sign = txn.type === 'add' ? '+' : '-';
            return `
                <li class="history-item">
                    <div class="txn-details">
                        <span class="txn-amount">${sign} ₹ ${txn.amount.toFixed(2)}</span>
                        <span style="font-size: 10px; color: #777;">Type: ${txn.type} | UTR: ${txn.utr || 'N/A'} | ${formatDateTime(txn.timestamp)}</span>
                    </div>
                    <span class="history-status status-${txn.status}">${txn.status}</span>
                </li>
            `;
        }).join('');
        
        const canWithdraw = userData.status.firstGoldPurchase && userData.status.referralBonusClaimed; // Simplified minimum conditions
        
        return `
            <div class="card text-center">
                <h2><i class="fas fa-wallet"></i> Wallet Section</h2>
                <div class="glass" style="margin-bottom: 20px;">
                    <p style="font-size: 18px; font-weight: 600; color: var(--secondary-color);">Current Balance: ₹ ${userData.balances.walletAmount.toFixed(2)}</p>
                </div>
                
                <h3>Add Money</h3>
                <div class="qr-display">
                    <img src="${GOLD_QR_URL}" alt="Payment QR Code">
                    <p style="font-size: 12px; color:#777;">Scan QR & Pay to Add Money</p>
                </div>
                
                <form id="wallet-add-form">
                    <div id="wallet-message" class="text-center"></div>
                    <div class="input-group">
                        <input type="number" id="wallet-add-amount" placeholder=" " min="10" required>
                        <label for="wallet-add-amount"><i class="fas fa-rupee-sign"></i> Amount (₹)</label>
                    </div>
                    <div class="input-group">
                        <input type="text" id="wallet-add-utr" placeholder=" " pattern="[0-9]{12}" maxlength="12" required>
                        <label for="wallet-add-utr"><i class="fas fa-hashtag"></i> 12-digit UTR Number</label>
                    </div>
                    <button type="submit" id="wallet-add-btn">Add Money</button>
                </form>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-money-bill-wave"></i> Withdraw Money</h2>
                <div id="wallet-withdraw-message" class="text-center"></div>
                ${canWithdraw ? `
                    <form id="wallet-withdraw-form">
                        <div class="input-group">
                            <input type="number" id="wallet-withdraw-amount" placeholder=" " required>
                            <label for="wallet-withdraw-amount"><i class="fas fa-rupee-sign"></i> Amount (₹)</label>
                        </div>
                        <button type="submit" class="btn-secondary">Request Withdrawal</button>
                    </form>
                ` : `
                    <div class="glass text-center" style="background: rgba(255, 165, 0, 0.1);">
                        <p style="color: orange;">Withdrawal is currently restricted.</p>
                        <p style="font-size: 12px;">Conditions: First Gold Purchase (≥ ₹50) and Referral Bonus Eligibility must be met.</p>
                    </div>
                `}
            </div>

            <div class="card">
                <h2><i class="fas fa-history"></i> Wallet History</h2>
                <ul class="history-list">
                    ${historyHtml || '<li class="text-center" style="color:#777;">No Wallet Transactions Yet.</li>'}
                </ul>
            </div>
        `;
    }
    
    /** Handle Wallet Add Money */
    async function handleWalletAdd(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('wallet-add-amount').value);
        const utr = document.getElementById('wallet-add-utr').value.trim();
        const btn = document.getElementById('wallet-add-btn');

        if (isNaN(amount) || amount <= 0) {
            displayMessage('wallet-message', 'Please enter a valid amount.', true);
            return;
        }
        if (utr.length !== 12 || !/^\d+$/.test(utr)) {
            displayMessage('wallet-message', 'Please enter a valid 12-digit UTR number.', true);
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Processing...';

        try {
            const txnRef = db.ref(`transactions/wallet_add`).push();
            await txnRef.set({
                type: 'add',
                userId: currentUser.uid,
                amount: amount,
                utr: utr,
                status: 'Pending', // Key Step 4: Request sent as Pending
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Log to user history immediately
            await db.ref(`users/${currentUser.uid}/history/wallet/${txnRef.key}`).set({
                type: 'add',
                amount: amount,
                utr: utr,
                status: 'Pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            displayMessage('wallet-message', 'Add Money request sent! Status is Pending Admin Verification.', false);
            document.getElementById('wallet-add-form').reset();
            loadUserPanel('wallet'); // Refresh panel

        } catch (error) {
            displayMessage('wallet-message', `Transaction Failed: ${error.message}`, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Add Money';
        }
    }
    
    /** Handle Wallet Withdraw */
    async function handleWalletWithdraw(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('wallet-withdraw-amount').value);

        if (isNaN(amount) || amount <= 0) {
            displayMessage('wallet-withdraw-message', 'Please enter a valid withdrawal amount.', true);
            return;
        }

        const userSnapshot = await db.ref('users/' + currentUser.uid + '/balances/walletAmount').once('value');
        const currentAmount = userSnapshot.val() || 0;

        if (amount > currentAmount) {
            displayMessage('wallet-withdraw-message', `Insufficient Wallet Balance. Current: ₹${currentAmount.toFixed(2)}`, true);
            return;
        }
        
        try {
            const txnRef = db.ref(`transactions/wallet_withdraw`).push();
            await txnRef.set({
                type: 'withdraw',
                userId: currentUser.uid,
                amount: amount,
                status: 'Pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Log to user history
            await db.ref(`users/${currentUser.uid}/history/wallet/${txnRef.key}`).set({
                type: 'withdraw',
                amount: amount,
                utr: 'N/A',
                status: 'Pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            displayMessage('wallet-withdraw-message', 'Withdrawal request sent! Status is Pending Admin Approval.', false);
            document.getElementById('wallet-withdraw-form').reset();
            loadUserPanel('wallet'); // Refresh panel
        } catch (error) {
            displayMessage('wallet-withdraw-message', `Withdrawal Failed: ${error.message}`, true);
        }
    }

    /* --- 2c) Shop Section --- (Simplified due to complexity) */
    async function renderShopPanel(userData) {
        // This is a placeholder structure. Full product CRUD and Cart/Checkout logic is vast.
        // The transaction flow (UTR payment) is implemented in `handleShopBuy`.
        const productsSnapshot = await db.ref('products').once('value');
        const products = productsSnapshot.val() || {};
        
        let productsHtml = Object.keys(products).map(key => {
            const p = products[key];
            return `
                <div class="card" style="display:flex; gap:10px;">
                    <img src="${p.mainImage}" alt="${p.name}" style="width:80px; height:80px; object-fit:cover; border-radius:10px;">
                    <div style="flex-grow:1;">
                        <p style="font-weight:600;">${p.name}</p>
                        <p style="font-size:14px; color:#555;">₹${p.price.toFixed(2)} | Stock: ${p.stock}</p>
                        <button class="btn-small" onclick="showShopCheckout('${key}', ${p.price})">Buy Now</button>
                    </div>
                </div>
            `;
        }).join('');
        
        return `
            <div class="card">
                <h2><i class="fas fa-shopping-bag"></i> Shop Products</h2>
                <div id="shop-checkout-area">
                    </div>
                <div id="product-list">
                    ${productsHtml || '<p class="text-center" style="color:#777;">No products available yet.</p>'}
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-clipboard-list"></i> Order History</h2>
                <p class="text-center" style="color:#777;">Orders will appear here.</p>
            </div>
        `;
    }
    
    // Placeholder function to show a simplified checkout form
    function showShopCheckout(productId, price) {
        document.getElementById('product-list').style.display = 'none';
        
        document.getElementById('shop-checkout-area').innerHTML = `
            <h3>Checkout for Product ID: ${productId}</h3>
            <div class="glass text-center" style="margin-bottom: 15px;">
                <p style="font-size: 18px; font-weight: 600; color: #e67e22;">Total Amount: ₹${price.toFixed(2)}</p>
                <p style="font-size: 12px; color:#777;">Pay this amount via QR below, then enter UTR.</p>
            </div>
            
            <div class="qr-display">
                <img src="${GOLD_QR_URL}" alt="Payment QR Code">
            </div>
            
            <form id="shop-buy-form">
                <div id="shop-message" class="text-center"></div>
                <div class="input-group">
                    <input type="text" id="shop-address" placeholder=" " required>
                    <label for="shop-address"><i class="fas fa-map-marker-alt"></i> Full Address (H No, Street, City, Pin, Phone)</label>
                </div>
                <div class="input-group">
                    <input type="text" id="shop-buy-utr" placeholder=" " pattern="[0-9]{12}" maxlength="12" required>
                    <label for="shop-buy-utr"><i class="fas fa-hashtag"></i> 12-digit UTR Number</label>
                </div>
                <button type="submit" id="shop-buy-btn">Place Order & Pay</button>
                <button type="button" class="btn-secondary" onclick="loadUserPanel('shop')">Cancel</button>
            </form>
        `;
        
        document.getElementById('shop-buy-form').addEventListener('submit', (e) => handleShopBuy(e, productId, price));
    }
    
    /** Handle Shop Buy (Order Placement) */
    async function handleShopBuy(e, productId, amount) {
        e.preventDefault();
        const utr = document.getElementById('shop-buy-utr').value.trim();
        const address = document.getElementById('shop-address').value.trim();
        const btn = document.getElementById('shop-buy-btn');
        
        if (utr.length !== 12 || !/^\d+$/.test(utr)) {
            displayMessage('shop-message', 'Please enter a valid 12-digit UTR number.', true);
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Placing Order...';

        try {
            const txnRef = db.ref(`transactions/shop_order`).push();
            await txnRef.set({
                userId: currentUser.uid,
                productId: productId,
                amount: amount,
                utr: utr,
                address: address,
                status: 'Pending', // Key Step 4: Request sent as Pending
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Log to user history (Orders section)
            await db.ref(`users/${currentUser.uid}/history/orders/${txnRef.key}`).set({
                productId: productId,
                amount: amount,
                utr: utr,
                status: 'Pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            displayMessage('shop-message', 'Order placed successfully! Status is Pending Admin Verification.', false);
            document.getElementById('shop-buy-form').reset();
            loadUserPanel('shop'); // Refresh panel

        } catch (error) {
            displayMessage('shop-message', `Order Failed: ${error.message}`, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Place Order & Pay';
        }
    }

    /* --- 2d) Profile Section --- */
    async function renderProfilePanel(userData) {
        
        // This is a placeholder for KYC submission logic. File upload requires Firebase Storage.
        // For plain JS/HTML, ImgBB is required as per prompt, but this is complex to handle in a single file.
        // The implementation below assumes the photos are uploaded elsewhere and URLs are provided/stored.
        
        let kycStatus = userData.kyc.status;
        
        return `
            <div class="card">
                <h2><i class="fas fa-user-circle"></i> Profile & Info</h2>
                <div class="glass text-center">
                    <p style="font-size: 22px; font-weight: 700;">${userData.name}</p>
                    <p style="font-size: 14px; color:#555;">${userData.email} | ${userData.mobile}</p>
                    <button class="btn-small" style="margin-top: 10px;" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-id-card"></i> KYC Verification</h2>
                <div id="kyc-message" class="text-center"></div>
                <div class="glass text-center">
                    <p style="font-size: 16px; font-weight: 600;">Status: 
                        <span class="history-status status-${kycStatus}">${kycStatus}</span>
                    </p>
                    ${kycStatus === 'Pending' || kycStatus === 'Rejected' ? `
                        <p style="font-size: 12px; color: #e74c3c; margin-top: 5px;">*Admin Verification Required*</p>
                        <form id="kyc-submit-form">
                            <div class="input-group">
                                <input type="text" id="aadhaar-number" placeholder=" " pattern="[0-9]{12}" maxlength="12" required>
                                <label for="aadhaar-number"><i class="fas fa-id-badge"></i> Aadhaar Number</label>
                            </div>
                            <div class="input-group">
                                <input type="text" id="aadhaar-front" placeholder=" " required>
                                <label for="aadhaar-front"><i class="fas fa-camera"></i> Aadhaar Front Photo URL (via ImgBB)</label>
                            </div>
                            <div class="input-group">
                                <input type="text" id="aadhaar-back" placeholder=" " required>
                                <label for="aadhaar-back"><i class="fas fa-camera"></i> Aadhaar Back Photo URL (via ImgBB)</label>
                            </div>
                            <button type="submit">Submit KYC</button>
                        </form>
                    ` : `<p style="color: #2ecc71;">Your KYC is verified!</p>`}
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-link"></i> Referral Code</h2>
                <div class="glass text-center">
                    <p style="font-size: 14px; color:#777;">Your Unique Code:</p>
                    <p style="font-size: 24px; font-weight: 700; color: var(--primary-color);">${userData.referralCode}</p>
                </div>
            </div>
        `;
    }
    
    /** Handle KYC Submission (using URL placeholders) */
    async function handleKycSubmit(e) {
        e.preventDefault();
        const aadhaarNumber = document.getElementById('aadhaar-number').value.trim();
        const frontUrl = document.getElementById('aadhaar-front').value.trim();
        const backUrl = document.getElementById('aadhaar-back').value.trim();
        
        if (aadhaarNumber.length !== 12 || !/^\d+$/.test(aadhaarNumber)) {
            displayMessage('kyc-message', 'Please enter a valid 12-digit Aadhaar number.', true);
            return;
        }
        
        try {
            await db.ref(`users/${currentUser.uid}/kyc`).update({
                aadhaarNumber: aadhaarNumber,
                frontPhotoUrl: frontUrl,
                backPhotoUrl: backUrl,
                status: 'Pending' // Submit moves status back to Pending
            });
            
            await db.ref(`transactions/kyc_requests/${currentUser.uid}`).set({
                userId: currentUser.uid,
                aadhaarNumber: aadhaarNumber,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'Pending'
            });

            displayMessage('kyc-message', 'KYC submitted for Admin verification.', false);
            loadUserPanel('profile'); // Refresh to show pending status
            
        } catch (error) {
            displayMessage('kyc-message', `KYC Submission Failed: ${error.message}`, true);
        }
    }

    /* --- 2e) Referral & Earn --- (Simplified) */
    async function renderReferralPanel(userData) {
        const myReferralsSnapshot = await db.ref(`referrals/${currentUser.uid}`).once('value');
        const myReferrals = myReferralsSnapshot.val() || {};
        
        let referralListHtml = Object.keys(myReferrals).map(uid => {
            const ref = myReferrals[uid];
            const goldStatus = ref.goldPurchaseStatus ? 'Done' : 'Pending';
            const bonusStatus = ref.bonusCredited ? 'Credited' : 'Pending';
            return `
                <li class="history-item" style="flex-direction: column; align-items: flex-start;">
                    <span style="font-weight: 600;">${ref.name} (${ref.mobile})</span>
                    <div style="font-size: 12px; color:#777; display:flex; gap: 10px;">
                        <span>Gold Buy: <span class="history-status status-${ref.goldPurchaseStatus ? 'Successful' : 'Pending'}">${goldStatus}</span></span>
                        <span>Bonus: <span class="history-status status-${ref.bonusCredited ? 'Successful' : 'Pending'}">${bonusStatus}</span></span>
                    </div>
                </li>
            `;
        }).join('');
        
        return `
            <div class="card text-center">
                <h2><i class="fas fa-share-alt"></i> Referral & Earn</h2>
                <div class="glass" style="margin-bottom: 20px;">
                    <p style="font-size: 14px; color:#777;">Share your code and earn ₹100!</p>
                    <p style="font-size: 28px; font-weight: 700; color: var(--primary-color);">${userData.referralCode}</p>
                    <button class="btn-secondary" onclick="navigator.clipboard.writeText(document.querySelector('.glass p:last-child').textContent)">Copy Code</button>
                    <p style="font-size: 10px; margin-top: 10px;">Conditions: Referred friend buys ≥ ₹50 gold. You must have bought ≥ ₹50 gold to withdraw bonus.</p>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-users"></i> My Referrals (${Object.keys(myReferrals).length})</h2>
                <ul class="history-list">
                    ${referralListHtml || '<li class="text-center" style="color:#777;">No active referrals yet.</li>'}
                </ul>
            </div>
        `;
    }

    // ====================================
    // 3. Admin Panel
    // ====================================
    
    /** Renders the Admin Panel */
    async function loadAdminPanel(section = 'dashboard') {
        if (!isUserAdmin) return;
        
        let html = `
            <div class="admin-header">
                <i class="fas fa-shield-alt"></i> Admin Panel
                <button class="btn-small btn-secondary" style="width: auto; margin-top: 0; float: right; background: #2c3e50; color:white;" onclick="handleLogout()">Logout</button>
            </div>
            <div class="panel-container">
                <div class="card" style="display:flex; justify-content:space-around; gap:10px;">
                    <button class="btn-small" onclick="loadAdminPanel('dashboard')">Dashboard</button>
                    <button class="btn-small" onclick="loadAdminPanel('gold')">Gold Mgmt</button>
                    <button class="btn-small" onclick="loadAdminPanel('wallet')">Wallet Mgmt</button>
                    <button class="btn-small" onclick="loadAdminPanel('kyc')">KYC Mgmt</button>
                </div>
                
                <div id="admin-content-area">
                    </div>
            </div>
        `;
        loadContent(html);
        
        const contentArea = document.getElementById('admin-content-area');
        switch(section) {
            case 'dashboard':
                contentArea.innerHTML = await renderAdminDashboard();
                break;
            case 'gold':
                contentArea.innerHTML = await renderAdminGoldMgmt();
                break;
            case 'wallet':
                contentArea.innerHTML = await renderAdminWalletMgmt();
                break;
            case 'kyc':
                contentArea.innerHTML = await renderAdminKYCMgmt();
                break;
            default:
                contentArea.innerHTML = await renderAdminDashboard();
        }
    }
    
    /** Renders Admin Dashboard (Stats) */
    async function renderAdminDashboard() {
        const usersSnapshot = await db.ref('users').once('value');
        const totalUsers = usersSnapshot.numChildren();
        
        return `
            <div class="card">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <div class="glass text-center" style="flex: 1; min-width: 150px;">
                        <p style="font-size: 24px; font-weight: 700; color: var(--secondary-color);">${totalUsers}</p>
                        <p style="font-size: 14px;">Total Users</p>
                    </div>
                    </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-users"></i> All Users</h2>
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Gold (g)</th>
                                <th>Wallet (₹)</th>
                                <th>KYC</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(usersSnapshot.val() || {}).map(uid => {
                                const u = usersSnapshot.val()[uid];
                                return `
                                    <tr>
                                        <td>${u.name}</td>
                                        <td>${u.email}</td>
                                        <td>${u.balances.goldGrams.toFixed(4)}</td>
                                        <td>${u.balances.walletAmount.toFixed(2)}</td>
                                        <td><span class="history-status status-${u.kyc.status}">${u.kyc.status}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    /** Renders Admin Gold Management (Buy/Withdraw Requests) */
    async function renderAdminGoldMgmt() {
        const buySnapshot = await db.ref('transactions/gold_buy').orderByChild('status').equalTo('Pending').once('value');
        const withdrawSnapshot = await db.ref('transactions/gold_withdraw').orderByChild('status').equalTo('Pending').once('value');
        
        return `
            <div class="card">
                <h2><i class="fas fa-cart-arrow-down"></i> Gold Buy Requests (Pending)</h2>
                ${renderAdminTxnTable(buySnapshot.val(), 'gold_buy')}
            </div>
            <div class="card">
                <h2><i class="fas fa-hand-holding-usd"></i> Gold Withdraw Requests (Pending)</h2>
                ${renderAdminTxnTable(withdrawSnapshot.val(), 'gold_withdraw')}
            </div>
        `;
    }

    /** Renders Admin Wallet Management (Add/Withdraw Requests) */
    async function renderAdminWalletMgmt() {
        const addSnapshot = await db.ref('transactions/wallet_add').orderByChild('status').equalTo('Pending').once('value');
        const withdrawSnapshot = await db.ref('transactions/wallet_withdraw').orderByChild('status').equalTo('Pending').once('value');
        
        return `
            <div class="card">
                <h2><i class="fas fa-hand-holding"></i> Wallet Add Requests (Pending)</h2>
                ${renderAdminTxnTable(addSnapshot.val(), 'wallet_add')}
            </div>
            <div class="card">
                <h2><i class="fas fa-money-bill-alt"></i> Wallet Withdraw Requests (Pending)</h2>
                ${renderAdminTxnTable(withdrawSnapshot.val(), 'wallet_withdraw')}
            </div>
        `;
    }
    
    /** Renders Admin KYC Management */
    async function renderAdminKYCMgmt() {
        const kycSnapshot = await db.ref('transactions/kyc_requests').orderByChild('status').equalTo('Pending').once('value');
        const kycRequests = kycSnapshot.val() || {};
        
        let kycHtml = Object.keys(kycRequests).map(key => {
            const req = kycRequests[key];
            return `
                <tr>
                    <td>${key}</td>
                    <td>${req.aadhaarNumber}</td>
                    <td>${formatDateTime(req.timestamp)}</td>
                    <td><button class="admin-action-btn approve" onclick="handleAdminKYC('${key}', 'Verified')">Verify</button>
                        <button class="admin-action-btn reject" onclick="handleAdminKYC('${key}', 'Rejected')">Reject</button>
                    </td>
                </tr>
            `;
        }).join('');
        
        return `
            <div class="card">
                <h2><i class="fas fa-id-card-alt"></i> Pending KYC Requests</h2>
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Aadhaar</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${kycHtml || '<tr><td colspan="4" class="text-center" style="color:#777;">No Pending KYC Requests.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    /** Generic Admin Transaction Table Renderer */
    function renderAdminTxnTable(transactions, txnType) {
        if (!transactions) {
            return '<p class="text-center" style="color:#777;">No Pending Transactions.</p>';
        }

        const keys = Object.keys(transactions).reverse();
        const isWallet = txnType.includes('wallet');
        const isWithdraw = txnType.includes('withdraw');
        const isGold = txnType.includes('gold');

        const html = `
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Amount / Grams</th>
                            ${isWallet || isGold ? '<th>UTR</th>' : ''}
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${keys.map(key => {
                            const txn = transactions[key];
                            const amountDisplay = isGold ? `${txn.grams.toFixed(4)}g` : `₹${txn.amount.toFixed(2)}`;
                            const actionBtnText = isWithdraw ? 'Approve' : 'Complete';
                            return `
                                <tr>
                                    <td>${txn.userId}</td>
                                    <td>${amountDisplay}</td>
                                    ${isWallet || isGold ? `<td>${txn.utr || 'N/A'}</td>` : ''}
                                    <td>${formatDateTime(txn.timestamp)}</td>
                                    <td>
                                        <button class="admin-action-btn approve" onclick="handleAdminVerification('${txnType}', '${key}', 'Successful', '${txn.userId}', ${txn.amount || 0}, ${txn.grams || 0})">${actionBtnText}</button>
                                        <button class="admin-action-btn reject" onclick="handleAdminVerification('${txnType}', '${key}', 'Rejected', '${txn.userId}', ${txn.amount || 0}, ${txn.grams || 0})">Reject</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        return html;
    }

    /** Handle Admin Transaction Verification */
    async function handleAdminVerification(txnType, txnId, newStatus, userId, amount, grams) {
        if (!confirm(`Are you sure you want to set status to ${newStatus} for ${txnId}?`)) return;

        try {
            // 1. Update the main transaction log status to Verified/Rejected
            await db.ref(`transactions/${txnType}/${txnId}`).update({
                status: newStatus,
                verifiedBy: currentUser.uid,
                verificationTimestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // 2. Update user's history log
            const userTxnRef = db.ref(`users/${userId}/history/${txnType.includes('gold') ? 'gold' : 'wallet'}/${txnId}`);
            await userTxnRef.update({ status: newStatus });

            // 3. Update user balances and special statuses only on SUCCESSFUL transactions
            if (newStatus === 'Successful') {
                const userBalancesRef = db.ref(`users/${userId}/balances`);
                
                if (txnType === 'gold_buy') {
                    // Gold Buy: Add grams
                    await userBalancesRef.child('goldGrams').transaction(current => (current || 0) + grams);
                    
                    // Check for first gold purchase status
                    const userStatusRef = db.ref(`users/${userId}/status/firstGoldPurchase`);
                    const firstGoldStatus = (await userStatusRef.once('value')).val();
                    if (!firstGoldStatus && amount >= 50) {
                        await userStatusRef.set(true);
                        // Trigger signup bonus logic (if they used a referrer)
                        await checkAndCreditSignupBonus(userId);
                        // Trigger referral bonus check for the referrer
                        await checkAndCreditReferralBonus(userId);
                    }
                    
                } else if (txnType === 'gold_withdraw') {
                    // Gold Withdraw: Deduct grams
                    await userBalancesRef.child('goldGrams').transaction(current => (current || 0) - grams);
                    
                } else if (txnType === 'wallet_add') {
                    // Wallet Add: Add amount
                    await userBalancesRef.child('walletAmount').transaction(current => (current || 0) + amount);
                    
                } else if (txnType === 'wallet_withdraw') {
                    // Wallet Withdraw: Deduct amount
                    await userBalancesRef.child('walletAmount').transaction(current => (current || 0) - amount);
                }
            }

            alert(`Transaction ${txnId} updated to ${newStatus}.`);
            // Refresh the admin panel section
            if (txnType.includes('gold')) {
                loadAdminPanel('gold');
            } else if (txnType.includes('wallet')) {
                loadAdminPanel('wallet');
            }

        } catch (error) {
            console.error("Admin Verification Error:", error);
            alert(`Failed to update transaction: ${error.message}`);
        }
    }
    
    /** Handle Admin KYC Verification */
    async function handleAdminKYC(userId, newStatus) {
        if (!confirm(`Are you sure you want to set KYC status to ${newStatus} for User ID: ${userId}?`)) return;
        
        try {
            // 1. Update user's main KYC status
            await db.ref(`users/${userId}/kyc`).update({ status: newStatus });
            
            // 2. Update KYC Request transaction log status
            await db.ref(`transactions/kyc_requests/${userId}`).update({
                status: newStatus,
                verifiedBy: currentUser.uid,
                verificationTimestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // 3. Log to user's KYC history (optional, for detailed tracking)
            await db.ref(`users/${userId}/history/kyc`).push({
                status: newStatus,
                verifiedBy: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            alert(`User ${userId} KYC status updated to ${newStatus}.`);
            loadAdminPanel('kyc');
        } catch (error) {
            console.error("Admin KYC Error:", error);
            alert(`Failed to update KYC status: ${error.message}`);
        }
    }
    
    /** Logic for Signup Bonus Credit (Admin Verification for Gold Purchase) */
    async function checkAndCreditSignupBonus(userId) {
        const userRef = db.ref(`users/${userId}`);
        const userSnapshot = await userRef.once('value');
        const userData = userSnapshot.val();

        if (userData.status.firstGoldPurchase && !userData.status.referralBonusClaimed) {
            // Credit ₹100 signup bonus
            await userRef.child('balances/walletAmount').transaction(current => (current || 0) + 100);
            await userRef.child('status/referralBonusClaimed').set(true);

            // Log the bonus credit
            await db.ref(`users/${userId}/history/wallet`).push({
                type: 'bonus',
                amount: 100,
                utr: 'SIGNUP_BONUS',
                status: 'Successful',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            console.log(`Signup bonus of ₹100 credited to ${userData.name}.`);
        }
    }
    
    /** Logic for Referral Bonus Credit (Admin Verification for Referred Friend's Gold Purchase) */
    async function checkAndCreditReferralBonus(referredId) {
        const referredUserRef = db.ref(`users/${referredId}`);
        const referredUserData = (await referredUserRef.once('value')).val();
        const referrerId = referredUserData.referrerId;
        
        if (referrerId) {
            const referralRef = db.ref(`referrals/${referrerId}/${referredId}`);
            const referralData = (await referralRef.once('value')).val();

            if (referredUserData.status.firstGoldPurchase && !referralData.bonusCredited) {
                const referrerRef = db.ref(`users/${referrerId}`);
                
                // 1. Credit ₹100 referral bonus to referrer
                await referrerRef.child('balances/walletAmount').transaction(current => (current || 0) + 100);

                // 2. Mark the referral as credited
                await referralRef.update({
                    goldPurchaseStatus: true,
                    bonusCredited: true,
                    bonusCreditDate: firebase.database.ServerValue.TIMESTAMP
                });
                
                // 3. Log the bonus credit for the referrer
                await db.ref(`users/${referrerId}/history/wallet`).push({
                    type: 'bonus',
                    amount: 100,
                    utr: `REFERRAL_BONUS_${referredId}`,
                    status: 'Successful',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                console.log(`Referral bonus of ₹100 credited to referrer ${referrerId}.`);
            }
        }
    }


    // ====================================
    // Event Listeners (Must be attached after content load)
    // ====================================
    
    document.getElementById('main-content').addEventListener('submit', function(e) {
        if (e.target && e.target.id === 'gold-buy-form') {
            handleGoldBuy(e);
        } else if (e.target && e.target.id === 'gold-withdraw-form') {
            handleGoldWithdraw(e);
        } else if (e.target && e.target.id === 'wallet-add-form') {
            handleWalletAdd(e);
        } else if (e.target && e.target.id === 'wallet-withdraw-form') {
            handleWalletWithdraw(e);
        } else if (e.target && e.target.id === 'kyc-submit-form') {
            handleKycSubmit(e);
        }
    });

    // Initial load will be handled by onAuthStateChanged.
    // loadAuthPanel() is called if no user is logged in.

</script>

</body>
</html>
