<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Rupi - Login/Signup</title>
<style>
    body {
        font-family: 'poppins', sans-serif;
        background: linear-gradient(135deg,#ffd700,#f0e68c);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin:0;
    }
    .container {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    h2 {text-align:center; color:#fff; margin-bottom:20px;}
    input {width:100%; padding:12px 15px; margin:10px 0; border-radius:10px; border:none; box-sizing: border-box;}
    button {width:100%; padding:12px; margin:10px 0; border:none; border-radius:10px; background:#ffd700; font-weight:bold; cursor:pointer;}
    button:hover {background:#ffc107;}
    p {color:#fff; text-align:center;}
    .switch {text-align:center; cursor:pointer; color:#fff; text-decoration:underline; font-weight: bold;}
    
    /* Forgot Password Button Styling */
    .forgot-link {
        display: block;
        text-align: right;
        color: white;
        font-size: 13px;
        margin-top: -5px;
        margin-bottom: 10px;
        cursor: pointer;
        text-decoration: underline;
    }
</style>
</head>
<body>

<div class="container" id="auth-container">
    <h2 id="form-title">Login</h2>

    <input type="text" id="name" placeholder="Name (for signup)">
    <input type="email" id="email" placeholder="Email Address">
    <input type="text" id="mobile" placeholder="Mobile Number (for signup)">
    <input type="password" id="password" placeholder="Password">
    
    <span class="forgot-link" id="forgot-password">Forgot Password?</span>

    <input type="text" id="refer" placeholder="Refer code (optional)">

    <button id="auth-button">Login</button>
    <p id="toggle-text">Don't have an account? <span class="switch" id="toggle-form">Signup</span></p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
    authDomain: "smbrand-4543a.firebaseapp.com",
    databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
    projectId: "smbrand-4543a",
    storageBucket: "smbrand-4543a.firebasestorage.app",
    messagingSenderId: "720775550032",
    appId: "1:720775550032:web:0622548a007597778bad55",
    measurementId: "G-3LS5W6F8QW"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const mobileInput = document.getElementById('mobile');
const passwordInput = document.getElementById('password');
const referInput = document.getElementById('refer');
const authButton = document.getElementById('auth-button');
const formTitle = document.getElementById('form-title');
const toggleForm = document.getElementById('toggle-form');
const forgotBtn = document.getElementById('forgot-password');

let isLogin = true;

// ----------------------
// Toggle Login / Signup
// ----------------------
toggleForm.addEventListener('click', () => {
    isLogin = !isLogin;
    if(isLogin){
        formTitle.innerText = 'Login';
        authButton.innerText = 'Login';
        toggleForm.innerText = 'Signup';
        nameInput.style.display = 'none';
        mobileInput.style.display = 'none';
        referInput.style.display = 'none';
        forgotBtn.style.display = 'block';
    } else {
        formTitle.innerText = 'Signup';
        authButton.innerText = 'Signup';
        toggleForm.innerText = 'Login';
        nameInput.style.display = 'block';
        mobileInput.style.display = 'block';
        referInput.style.display = 'block';
        forgotBtn.style.display = 'none';
    }
});

// ----------------------
// Forget Password Logic (Fixed Expired Issue)
// ----------------------
forgotBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    if(!email) {
        alert("Please enter your email address first!");
        return;
    }

    // Is setting se link expired nahi hoga
    const actionCodeSettings = {
        url: window.location.href, // Link click karne ke baad wapas yahi aayega
        handleCodeInApp: true
    };

    auth.sendPasswordResetEmail(email, actionCodeSettings)
    .then(() => {
        alert("âœ… Password reset link sent! Check your Email (Inbox & Spam).\n\nTip: Link ko Chrome browser mein hi open karein.");
    })
    .catch((error) => {
        alert("Error: " + error.message);
    });
});

// ----------------------
// Auto Login Check
// ----------------------
auth.onAuthStateChanged(user => {
    if(user){
        if(user.email === "rajputsurendra562@gmail.com"){
            window.location.href = "arupe.html";
        } else {
            window.location.href = "urupe.html";
        }
    }
});

// ----------------------
// Auth Button Logic
// ----------------------
authButton.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if(isLogin){
        auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert(err.message));
    } else {
        const name = nameInput.value.trim();
        const mobile = mobileInput.value.trim();
        const referFromFriend = referInput.value.trim() || "";

        if(!name || !mobile || !email || !password){
            alert("Please fill all fields!");
            return;
        }

        try {
            const cred = await auth.createUserWithEmailAndPassword(email, password);
            const uid = cred.user.uid;
            const isAdmin = (email === "rajputsurendra562@gmail.com");
            const signupBonus = isAdmin ? 0 : 100;
            const userReferCode = 'R' + Math.floor(100000 + Math.random() * 900000);

            await db.ref("users/" + uid).set({
                name, email, mobile,
                refer: userReferCode,
                refer_from: referFromFriend || null,
                role: isAdmin ? "admin" : "user",
                wallet: signupBonus,
                signup_bonus_given: !isAdmin,
                gold_balance: 0,
                created_at: Date.now()
            });

            if(referFromFriend){
                const snap = await db.ref('users').orderByChild('refer').equalTo(referFromFriend).once('value');
                if(snap.exists()){
                    const friendUid = Object.keys(snap.val())[0];
                    await db.ref('users/' + friendUid + '/wallet').transaction(c => Number(c||0) + 50);
                }
            }
            alert("Signup Successful!");
        } catch(err){ alert(err.message); }
    }
});

// Init UI
nameInput.style.display = 'none';
mobileInput.style.display = 'none';
referInput.style.display = 'none';
</script>
</body>
</html>
