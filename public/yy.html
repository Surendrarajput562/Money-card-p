<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gold Rupi -</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script>
        // Service Worker, gtag, adsense scripts unchanged...
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker Registered', reg))
                    .catch(err => console.log('Service Worker Registration Failed', err));
            });
        }
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11380267758"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'AW'-11380267758);
    </script>

    <script async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7356424946387381"
        crossorigin="anonymous">
    </script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* [‡§Ü‡§™‡§ï‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á CSS ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§ø‡§§ ‡§∞‡§π‡•á‡§Ç‡§ó‡•á] */
        :root{
            --gold:#d4af37;
            --gold-strong:#c59b2d;
            --glass: rgba(255,255,255,0.95);
            --card-bg: #ffffff;
            --bg-color:#f8f9fa;
            --text-color:#1f2937;
            --accent:#111827;
            --success:#10b981;
            --danger:#ef4444;
            --warning:#f59e0b;
        }
        [data-theme="dark"] {
            --gold:#ffd76b;
            --gold-strong:#ffc44a;
            --glass: rgba(31, 41, 55, 0.95);
            --card-bg: #1f2937;
            --bg-color:#111827;
            --text-color:#f3f4f6;
            --accent:#f9fafb;
        }

        *{box-sizing:border-box}
        body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg-color);color:var(--text-color);padding-bottom:80px;}
        
        /* Utility */
        .field-hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex-row { display: flex; align-items: center; gap: 10px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .full-width { width: 100%; }
        
        /* Header & Nav */
        .header{position:sticky;top:0;z-index:100;background:var(--glass);backdrop-filter:blur(10px);padding:15px;box-shadow:0 2px 10px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center;}
        .logo{font-weight:800;font-size:20px;color:var(--gold-strong);letter-spacing:-1px;}
        
        .icon-btn { position: relative; font-size: 24px; margin-left: 10px; cursor: pointer; color: var(--text-color); }
        .badge-count { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 10px; border-radius: 50%; width: 16px; height: 16px; display: flex; justify-content: center; align-items: center; }

        .bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:var(--glass);display:flex;justify-content:space-around;padding:12px;border-top:1px solid rgba(0,0,0,0.05);z-index:100;}
        .nav-item{text-align:center;font-size:10px;opacity:0.6;cursor:pointer;}
        .nav-item.active{opacity:1;color:var(--gold-strong);font-weight:600;}
        .nav-item i{font-size:22px;display:block;margin-bottom:2px;}

        /* Cards & Inputs */
        .container{padding:15px;}
        .card{background:var(--card-bg);border-radius:16px;padding:16px;box-shadow:0 4px 20px rgba(0,0,0,0.04);margin-bottom:15px;}
        .gold-card{background:linear-gradient(135deg, var(--gold), var(--gold-strong));color:#fff;border:none;}
        .btn{background:var(--gold);color:#000;border:none;padding:12px 20px;border-radius:12px;font-weight:600;width:100%;font-size:14px;cursor:pointer;}
        .btn.secondary{background:transparent;border:1px solid rgba(0,0,0,0.1);color:var(--text-color);}
        [data-theme="dark"] .btn.secondary{border-color:rgba(255,255,255,0.2);}
        input, select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);background:var(--bg-color);color:var(--text-color);margin-bottom:10px;font-family:inherit;}
        
        /* Badges & Coupons */
        .badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;color:#fff;}
        .bg-pending{background:var(--warning);}
        .bg-success{background:var(--success);}
        .bg-danger{background:var(--danger);}
        
        .coupon-ticket { border: 2px dashed var(--gold); background: rgba(212, 175, 55, 0.1); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .coupon-code { font-family: monospace; font-weight: 700; letter-spacing: 1px; color: var(--gold-strong); font-size: 16px; }

        /* Notification Item */
        .notif-item { padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .notif-item:last-child { border-bottom: none; }
        .notif-title { font-weight: 600; font-size: 14px; }
        .notif-body { font-size: 12px; opacity: 0.8; margin-top: 2px; }

        /* --- LOAN DASHBOARD STYLES --- */
        .step-wizard { display: flex; justify-content: space-between; margin-bottom: 20px; position: relative; }
        .step-wizard::before { content: ''; position: absolute; top: 14px; left: 0; right: 0; height: 2px; background: #e5e7eb; z-index: 0; }
        .step-item { position: relative; z-index: 1; text-align: center; width: 20%; }
        .step-circle { width: 30px; height: 30px; background: #e5e7eb; border-radius: 50%; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #666; transition: all 0.3s; border: 2px solid var(--card-bg); }
        .step-item.active .step-circle { background: var(--gold); color: #000; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); }
        .step-item.completed .step-circle { background: var(--success); color: #fff; }
        .step-label { font-size: 9px; color: #888; font-weight: 600; text-transform: uppercase; }

        .loan-offer-card { border: 2px solid var(--gold); background: rgba(212, 175, 55, 0.05); }
        .loan-detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed rgba(0,0,0,0.1); font-size: 13px; }
        .loan-detail-row:last-child { border: none; }
        
        .progress-container { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }

        /* Modal Overlay */
        .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter: blur(5px);}
        .modal{background:var(--card-bg);width:95%;max-width:500px;border-radius:20px;padding:20px;max-height:90vh;overflow-y:auto;position: relative;}
        .close-modal{position:absolute;top:15px;right:15px;background:none;border:none;font-size:24px;color:var(--text-color);cursor:pointer;}

        .file-upload-box { border: 2px dashed rgba(0,0,0,0.2); padding: 15px; text-align: center; border-radius: 10px; margin-bottom: 10px; cursor: pointer; }
        .file-upload-box i { font-size: 24px; color: var(--gold-strong); }
        
        .timer-badge { background: #fee2e2; color: #991b1b; padding: 5px 10px; border-radius: 6px; font-weight: 700; display: inline-block; }
        /* Spin animation for pending */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* NEW: Auth Modal Styles */
        #auth-overlay .modal { padding-top: 50px; }
        .auth-tab { display: flex; margin-bottom: 20px; }
        .auth-tab button { flex: 1; padding: 10px; background: none; border: none; font-size: 16px; font-weight: 600; color: #aaa; border-bottom: 2px solid #eee; cursor: pointer; }
        .auth-tab button.active { color: var(--gold-strong); border-bottom: 2px solid var(--gold-strong); }
  

        /* --- FINAL IMPROVED: Compact & Left Aligned Button Style --- */













     


          .circular-offer-btn {
            width: 110px; /* ‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ‡§á‡§ú‡§º */
            height: 110px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--gold-strong)); 
            color: #fff; 
            font-weight: 700;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4); 
            transition: transform 0.3s;
            border: 3px solid #fff; 
            line-height: 1.1;
            font-size: 13px; 
            /* ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¨‡§æ‡§è‡§Ç ‡§∏‡•á ‡§•‡•ã‡§°‡§º‡•Ä ‡§ú‡§ó‡§π */
            margin-left: 10px; 
        }
        .circular-offer-btn:hover {
            transform: scale(1.05);
            opacity: 0.95;
        }
        .circular-offer-btn strong {
            font-size: 16px; 
            display: block;
            margin-top: 3px;
            color: #fff;
        }
        /* Dark Mode Adjustments */
        body.dark-mode .credit-offer-banner {
            background: transparent;
        }

        /* New: Floating Chat Button */
        .fab-support {
            position: fixed;
            bottom: 90px; 
            right: 20px;
            background: var(--gold-strong);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 101;
            transition: transform 0.2s;
        }
        .fab-support:hover {
            transform: scale(1.1);
        }


/* ... [‡§Ü‡§™‡§ï‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á CSS ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§ø‡§§ ‡§∞‡§π‡•á‡§Ç‡§ó‡•á] ... */

/* NEW: Chat Modal Styles */
#support-chat-modal .modal {
    padding: 0; /* Remove padding from modal */
    max-height: 90vh; 
    display: flex;
    flex-direction: column;
}
.chat-header {
    background: var(--accent); /* Dark header for contrast */
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
}
.chat-header h4 {
    margin: 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.chat-messages {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f8f9fa; /* Light background for chat area */
}
[data-theme="dark"] .chat-messages {
    background: #2b3543; 
}
.msg-bubble {
    max-width: 85%;
    padding: 10px;
    border-radius: 12px;
    margin-bottom: 10px;
    word-wrap: break-word;
    font-size: 14px;
    position: relative;
    line-height: 1.3;
}
.msg-user {
    background: var(--gold-strong);
    color: white;
    margin-left: auto; /* Aligns to the right */
    border-bottom-right-radius: 2px;
}
.msg-admin {
    background: var(--card-bg);
    color: var(--text-color);
    margin-right: auto; /* Aligns to the left */
    border: 1px solid #e5e7eb;
    border-bottom-left-radius: 2px;
}
.msg-time {
    display: block;
    font-size: 9px;
    opacity: 0.7;
    text-align: right;
    margin-top: 5px;
}
.msg-admin .msg-time {
    color: #666; 
}
[data-theme="dark"] .msg-admin .msg-time {
    color: #ccc; 
}

.chat-input-area {
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-top: 1px solid #eee;
    background: var(--card-bg);
}
.chat-input-area input {
    flex-grow: 1;
    margin-bottom: 0;
}
.chat-input-area .btn {
    width: auto;
    padding: 10px 15px;
}
/* New: Older Message Loader */
.older-messages-loader {
    text-align: center;
    margin-bottom: 10px;
    cursor: pointer;
    font-size: 12px;
    color: var(--gold-strong);
    padding: 5px;
}

/* New: Attachment Preview */
.attachment-preview {
    margin-top: 5px;
    background: rgba(255,255,255,0.2);
    padding: 5px;
    border-radius: 6px;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.attachment-preview i { margin-right: 5px; }
.attachment-preview button {
    background: none;
    border: none;
    color: red;
    font-size: 14px;
    cursor: pointer;
}















        }
        /* New: Referral Iframe Modal */
        #referral-modal .modal {
            max-width: 90%;
            height: 80vh;
            padding: 0;
        }
        #referral-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .referral-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        .referral-header h3 {
            margin: 0;
            font-size: 16px;
        }
        .referral-header .close-modal {
            position: static;
        }
        /* NEW: Referral Buttons Grid */
        .referral-buttons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            gap: 5px;
            padding-top: 10px;
        }
        .ref-btn {
            padding: 5px 2px;
            font-size: 10px;
            font-weight: 600;
            background: #e5e7eb;
            color: #4b5563;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }
        .ref-btn:nth-child(5n+1) { background: #fcd34d; color: #92400e; }
        .ref-btn:nth-child(5n+2) { background: #a7f3d0; color: #065f46; }
        /* NEW: Profile DP Styles */
        .profile-dp-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .profile-dp {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #e5e7eb;
            border: 3px solid var(--gold-strong);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #6b7280;
            overflow: hidden;
            flex-shrink: 0;
        }
        .profile-dp img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* NEW: Selfie Modal Styles */
        #selfie-modal .modal {
            max-width: 90vw;
            width: 400px;
        }
        #video-stream {
            width: 100%;
            border-radius: 10px;
            transform: scaleX(-1); /* Mirror the video */
            background: #000;
        }
        #selfie-canvas {
            width: 100%;
            border-radius: 10px;
            transform: scaleX(-1);
            display: none; /* Hide until photo is taken */
            background: #000;
        }
        #selfie-controls {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }




  /* Essential Styles for Horizontal Scrolling and Button Appearance */
    .circular-offer-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        min-width: 80px; /* Prevents button compression in flex container */
        border-radius: 50%;
        color: white;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .credit-offer-banner {
        display: flex;
        /* Enable Horizontal Scrolling: */
        overflow-x: auto; 
        overflow-y: hidden;
        white-space: nowrap; /* Keep items in one row */
        padding: 10px 0;
        gap: 10px; /* Space between ALL circular buttons */
    }
    /* Modal/Overlay styles remain the same */
    .overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0, 0, 0, 0.7); display: none; 
        justify-content: center; align-items: center; z-index: 1000;
    }
    #referral-iframe {
        width: 100%; height: 400px; border: none; margin-top: 15px;
    }





  </style>
</head>
<body data-theme="light">
<meta name="google-adsense-account" content="ca-pub-7356424946387381">
    
    <script>
      gtag('event', 'conversion', { 'send_to': 'AW-11380267758/7ERoCNPK-OIaEO61xLIq' });
    </script>

    <div id="auth-overlay" class="overlay" style="display:flex;">
        <div class="modal">
            <div class="text-center">
                <div class="logo" style="font-size:30px;">gold rupi</div>
                <p style="font-size:12px; color:#666;">Your Trusted Digital Finance Partner</p>
            </div>

            <div class="auth-tab">
                <button id="login-tab-btn" class="active" onclick="showAuthTab('login')">Login</button>
                <button id="signup-tab-btn" onclick="showAuthTab('signup')">Sign Up</button>
            </div>

            <div id="login-form">
                <input id="login-email" type="email" placeholder="Email Address">
                <input id="login-password" type="password" placeholder="Password">
                <button class="btn" onclick="loginUser()">Login</button>
                <p class="text-center" style="font-size:12px; margin-top:15px;">
                    <a href="#" style="color:var(--gold-strong);">Forgot Password?</a>
                </p>
            </div>

            <div id="signup-form" class="field-hidden">
                <input id="signup-name" placeholder="Full Name">
                <input id="signup-mobile" placeholder="Mobile Number (10 Digits)" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);">
                <input id="signup-email" type="email" placeholder="Email Address">
                <input id="signup-password" type="password" placeholder="Password (Min 6 Characters)">
                <button class="btn" onclick="signupUser()">Create Account</button>
            </div>

            <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">

            <button class="btn secondary" onclick="loginAsGuest()">Continue as Guest (Limited Access)</button>
        </div>
    </div>
    
    <div id="main-app-content" class="field-hidden">
        
        <div class="header">
            <div class="logo">gold rupi</div>
            <div class="flex-row">
                <button class="btn secondary" style="padding:6px 10px;" onclick="toggleTheme()"><i class="ri-moon-line"></i></button>
                <div style="font-size:12px;font-weight:600; margin-right:10px;">Wallet: ‚Çπ<span id="header-wallet">0</span></div>
                
                <div class="icon-btn" onclick="openNotifications()">
                    <i class="ri-notification-3-line"></i>
                    <div id="notif-badge" class="badge-count" style="display:none;">0</div>
                </div>
            </div>
        </div>

        <div class="container">



            <div id="section-home" class="page-section">
                <h2 style="margin-top:0;">Hello, <span id="user-name-display">Guest</span> üëã</h2>

                <div class="card" style="background: linear-gradient(to right, #1f2937, #111827); color: white;">
                    <div class="flex-between">
                        <div>
                            <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">Need Funds Instantly?</div>
                            <h2 style="margin:0; color:var(--gold);">Quick Personal Loan</h2>
                            <div style="font-size:11px; opacity:0.7; margin-top:5px;">Up to ‚Çπ50,000 ‚Ä¢ Approval in 5 mins</div>
                        </div>
                        <button onclick="openLoanDashboard()" class="btn" style="width:auto; padding:8px 16px; font-size:12px;">Check Status</button>
                    </div>
                </div>



<div class="credit-offer-banner" id="scrollable-buttons-container">
    
    </div>









        </div>
    <div class="card">
        <h3>Latest Products</h3>
        <div id="latest-products-list">Loading products...</div>
    </div>
</div>

















            


            <div id="section-shop" class="page-section field-hidden">
                <h2>Shop</h2>
                <div class="card product-card-inner">
                    <img src="https://via.placeholder.com/300x150" style="width:100%; border-radius:10px;">
                    <h4>Gold Coin (24k) - 1g</h4>
                    <div class="flex-between">
                        <span class="pprice">‚Çπ6500</span>
                        <button class="btn" style="width:auto;" onclick="openCheckout(6500, 'Gold Coin 1g')">Buy Now</button>
                    </div>
                </div>
                <div class="card product-card-inner">
                    <img src="https://via.placeholder.com/300x150" style="width:100%; border-radius:10px;">
                    <h4>Silver Bar - 10g</h4>
                    <div class="flex-between">
                        <span class="pprice">‚Çπ900</span>
                        <button class="btn" style="width:auto;" onclick="openCheckout(900, 'Silver Bar 10g')">Buy Now</button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>üî• Special Offers</h3>
                    <p id="lo-loading-msg" style="font-size:12px; color:#666;">Loading content...</p>
                    <iframe 
                        id="lo-iframe-content" 
                        src="about:blank" 
                        style="width: 100%; height: 350px; border: 1px solid #ccc; border-radius: 10px;"
                        title="lo.html content"
                    ></iframe>

                    <h4 style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">Referral Actions</h4>
                    <div class="referral-buttons-grid">
                        <button class="ref-btn">Share Link</button>
                        <button class="ref-btn">WhatsApp</button>
                        <button class="ref-btn">Telegram</button>
                        <button class="ref-btn">Copy Code</button>
                        <button class="ref-btn">Invite 5</button>
                        <button class="ref-btn">Offer 1</button>
                        <button class="ref-btn">Offer 2</button>
                        <button class="ref-btn">Promo 3</button>
                        <button class="ref-btn">Reward 4</button>
                        <button class="ref-btn">Bonus 5</button>
                        <button class="ref-btn">Link 6</button>
                        <button class="ref-btn">Link 7</button>
                        <button class="ref-btn">Link 8</button>
                        <button class="ref-btn">Link 9</button>
                        <button class="ref-btn">Link 10</button>
                        <button class="ref-btn">Link 11</button>
                        <button class="ref-btn">Link 12</button>
                        <button class="ref-btn">Link 13</button>
                        <button class="ref-btn">Link 14</button>
                        <button class="ref-btn">Link 15</button>
                        <button class="ref-btn">Link 16</button>
                        <button class="ref-btn">Link 17</button>
                        <button class="ref-btn">Link 18</button>
                        <button class="ref-btn">Link 19</button>
                        <button class="ref-btn">Link 20</button>
                    </div>
                </div>
                </div>
            <div id="section-profile" class="page-section field-hidden">
                <h2>Profile</h2>

                <div class="profile-dp-container">
                    <div class="profile-dp" id="profile-dp-display">
                        <i class="ri-user-3-line"></i>
                    </div>
                    <div style="flex-grow: 1;">
                        <h3 id="profile-name-display" style="margin:0;">Guest User</h3>
                        <p style="font-size:12px; color:#666; margin:2px 0;">ID: <span id="profile-uid-display">...</span></p>
                        <button class="btn secondary" style="width:auto; padding:6px 12px; font-size:12px; margin-top:5px;" onclick="openSupportChat()">
                            <i class="ri-chat-3-line"></i> Contact Support
                        </button>
                    </div>
                </div>


                <div id="profile-card" class="card">
                    <input id="profile-name" placeholder="Full Name">
                    <input id="profile-mobile" placeholder="Mobile" disabled>
                    <button class="btn" onclick="saveProfile()">Update Profile</button>
                </div>
                
                <div id="manual-pay-card" class="card" style="border-left: 4px solid var(--gold-strong); padding:10px 16px;">
                    <h3 style="margin-top:0; display:flex; align-items:center; gap:5px; color:var(--gold-strong);">
                        <i class="ri-upload-cloud-line"></i> Manual Payment Proof
                    </h3>
                    <p style="font-size:12px; color:#666; margin-top: -10px;">
                        Use this to submit proof if your EMI payment is not automatically updated.
                    </p>
                    <label style="font-size:12px;">UTR / Reference Number (12 Digits)</label>
                    <input id="manual-pay-utr" placeholder="123456789012" maxlength="12" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12);">
                    
                    <div class="file-upload-box" onclick="document.getElementById('file-payscreen').click()">
                        <i class="ri-image-line"></i><br><span id="manual-file-status" style="font-size:10px;">Upload Payment Screenshot (JPG/PNG)</span>
                        <input type="file" id="file-payscreen" accept="image/jpeg,image/png" hidden onchange="updateFileName(this, 'manual-file-status')">
                    </div>
                    
                    <button id="manual-pay-btn" class="btn" onclick="submitManualPaymentProof()">Submit Payment Proof</button>
                    <div id="manual-submission-message" style="font-size:12px; color:var(--success); margin-top:10px;" class="field-hidden">
                        <i class="ri-check-line"></i> Submission Successful. We will review your payment shortly.
                    </div>
                </div>
                <button class="btn secondary" onclick="logout()" style="margin-top:20px; color:var(--danger); border-color:var(--danger);">Logout</button>
            </div>

        </div>

        <div id="notif-overlay" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="document.getElementById('notif-overlay').style.display='none'">&times;</button>
                <h3 style="margin-top:0;">Notifications</h3>
                
                <div class="card" style="background:var(--bg-color);">
                    <h4 style="margin-top:0; display:flex; align-items:center; gap:5px;"><i class="ri-coupon-3-fill" style="color:var(--gold-strong);"></i> Active Coupons</h4>
                    <div id="coupon-list-container">
                        <div class="text-center small-muted">Loading coupons...</div>
                    </div>
                </div>

                <h4 style="margin-bottom:10px;">Updates</h4>
                <div id="notification-list" style="max-height:300px; overflow-y:auto;">
                    </div>
            </div>
        </div>

        <div id="checkout-overlay" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="document.getElementById('checkout-overlay').style.display='none'">&times;</button>
                <h3>Checkout</h3>
                
                <div class="card" style="background:#f9fafb;">
                    <div class="flex-between">
                        <strong id="checkout-item-name">Product</strong>
                        <span>‚Çπ<span id="checkout-item-price">0</span></span>
                    </div>
                </div>

                <label style="font-size:12px;">Have a Coupon Code?</label>
                <div class="flex-row" style="margin-bottom:10px;">
                    <input id="checkout-coupon-input" placeholder="Enter Code (e.g. WELCOME50)" style="margin-bottom:0;">
                    <button class="btn secondary" style="width:auto;" onclick="applyCoupon()">Apply</button>
                </div>
                <div id="coupon-msg" style="font-size:11px; margin-bottom:10px;"></div>

                <div class="flex-between" style="border-top:1px solid #ddd; padding-top:10px; margin-top:10px;">
                    <strong>Total To Pay:</strong>
                    <strong style="font-size:18px; color:var(--gold-strong);">‚Çπ<span id="checkout-total">0</span></strong>
                </div>

                <button class="btn" style="margin-top:15px;" onclick="confirmOrder()">Pay & Confirm</button>
            </div>
        </div>
        
        <div id="referral-modal" class="overlay">
            <div class="modal">
                <div class="referral-header">
                    <h3>Refer & Earn Program</h3>
                    <button class="close-modal" onclick="document.getElementById('referral-modal').style.display='none'">&times;</button>
                </div>
                <iframe id="referral-iframe" src="about:blank"></iframe>
            </div>
        </div>

        <div id="loan-dashboard" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="closeLoanDashboard()">&times;</button>
                <h3 style="margin-top:0; color:var(--gold-strong);">Loan Dashboard</h3>

                <div id="loan-wizard-header" class="step-wizard">
                    <div class="step-item" id="step-1"><div class="step-circle">1</div><div class="step-label">Basic</div></div>
                    <div class="step-item" id="step-2"><div class="step-circle">2</div><div class="step-label">KYC</div></div>
                    <div class="step-item" id="step-3"><div class="step-circle">3</div><div class="step-label">Bank</div></div>
                    <div class="step-item" id="step-4"><div class="step-circle">4</div><div class="step-label">Work</div></div>
                    <div class="step-item" id="step-5"><div class="step-circle">5</div><div class="step-label">Addr</div></div>
                </div>

                <div id="view-verification">
                    
                    <div id="form-step-1" class="step-content">
                        <h4>Step 1: Basic Information</h4>
                        <label style="font-size:12px;">Full Name</label>
                        <input id="loan-fname" placeholder="As per PAN Card">
                        <label style="font-size:12px;">Date of Birth</label>
                        <input id="loan-dob" type="date">
                        <label style="font-size:12px;">Email ID</label>
                        <input id="loan-email" type="email" placeholder="example@mail.com">
                        <button class="btn" onclick="saveStep(1)">Save & Continue</button>
                    </div>

                    <div id="form-step-2" class="step-content field-hidden">
                        <h4>Step 2: Identity Verification (KYC)</h4>
                        <label style="font-size:12px;">PAN Number</label>
                        <input id="loan-pan" placeholder="ABCDE1234F" maxlength="10" style="text-transform:uppercase;" oninput="this.value = this.value.toUpperCase().slice(0, 10);">
                        
                        <div class="flex-row">
                            <div class="file-upload-box" style="flex:1" onclick="document.getElementById('file-aadhaar-f').click()">
                                <i class="ri-id-card-line"></i><br><span style="font-size:10px;">Aadhaar Front</span>
                                <input type="file" id="file-aadhaar-f" accept="image/*,.pdf" hidden onchange="updateFileName(this)">
                            </div>
                            <div class="file-upload-box" style="flex:1" onclick="document.getElementById('file-aadhaar-b').click()">
                                <i class="ri-id-card-line"></i><br><span style="font-size:10px;">Aadhaar Back</span>
                                <input type="file" id="file-aadhaar-b" accept="image/*,.pdf" hidden onchange="updateFileName(this)">
                            </div>
                        </div>
                        <div class="file-upload-box" onclick="document.getElementById('file-pan').click()">
                            <i class="ri-file-user-line"></i><br><span style="font-size:10px;">Upload PAN Card Photo</span>
                            <input type="file" id="file-pan" accept="image/*,.pdf" hidden onchange="updateFileName(this)">
                        </div>
                        
                        <div class="file-upload-box" style="border-color:var(--gold-strong); background: rgba(212, 175, 55, 0.1);" onclick="openSelfieModal()">
                            <i class="ri-camera-fill" style="color:var(--gold-strong);"></i><br><span id="selfie-status" style="font-size:10px; color:var(--gold-strong);">Take Liveness Check Selfie (Mandatory)</span>
                            <input type="hidden" id="file-selfie-url" value=""> </div>

                        <button class="btn" onclick="saveStep(2)">Verify Identity</button>
                    </div>

                    <div id="form-step-3" class="step-content field-hidden">
                        <h4>Step 3: Bank Details (Mandatory)</h4>
                        <input id="loan-bank-name" placeholder="Bank Name">
                        <input id="loan-acc-num" placeholder="Account Number" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                        <input id="loan-ifsc" placeholder="IFSC Code" oninput="this.value = this.value.toUpperCase();">
                        <div class="file-upload-box" onclick="document.getElementById('file-passbook').click()">
                            <i class="ri-bank-card-2-line"></i><br><span style="font-size:10px;">Upload Passbook/Cheque (Mandatory)</span>
                            <input type="file" id="file-passbook" accept="image/*,.pdf" hidden onchange="updateFileName(this)">
                        </div>
                        <button class="btn" onclick="saveStep(3)">Submit Bank KYC</button>
                    </div>

                    <div id="form-step-4" class="step-content field-hidden">
                        <h4>Step 4: Work Details</h4>
                        <select id="loan-occupation">
                            <option value="salaried">Salaried</option>
                            <option value="business">Self Employed</option>
                            <option value="student">Student</option>
                        </select>
                        <input id="loan-company-name" placeholder="Company/Business Name" class="field-hidden">
                        <input id="loan-salary" type="number" placeholder="Monthly Income (‚Çπ)" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                        <div class="file-upload-box" onclick="document.getElementById('file-salary').click()">
                            <i class="ri-file-list-3-line"></i><br><span style="font-size:10px;">Upload 3 Months Salary Slip (Optional)</span>
                            <input type="file" id="file-salary" accept="image/*,.pdf" hidden onchange="updateFileName(this)">
                        </div>
                        <button class="btn" onclick="saveStep(4)">Submit Work Details</button>
                    </div>

                    <div id="form-step-5" class="step-content field-hidden">
                        <h4>Step 5: Address</h4>
                        <input id="loan-addr-perm" placeholder="Permanent Address">
                        <input id="loan-addr-curr" placeholder="Current Address">
                        <button class="btn" onclick="saveStep(5)">Save Address & Finish</button>
                    </div>
                </div>

                <div id="view-calculator" class="field-hidden">
                    <div class="card" id="good-customer-msg" style="background:#d1fae5; border:1px solid #10b981; color:#065f46; display:none;">
                        <i class="ri-medal-fill" style="margin-right:5px;"></i> **SPECIAL OFFER!** You are a **Good Customer**. Your re-apply rate is high!
                    </div>
                    <div class="card" style="background:#f9fafb; border:1px solid #ddd;">
                        <div class="flex-between">
                            <span>Status:</span>
                            <span class="badge bg-success"><i class="ri-check-double-line"></i> Profile Verified</span>
                        </div>
                    </div>
                    
                    <h4>Select Loan Amount</h4>
                    <div style="margin-bottom:20px;">
                        <div class="flex-between">
                            <span style="font-size:12px;">‚Çπ5,000</span>
                            <h2 style="margin:0; color:var(--gold-strong);">‚Çπ<span id="calc-amt-display">10000</span></h2>
                            <span style="font-size:12px;">‚Çπ50,000</span>
                        </div>
                        <input type="range" id="calc-amt" min="5000" max="50000" step="1000" value="10000" oninput="updateCalc()">
                    </div>

                    <h4>Select Tenure (Months)</h4>
                    <div style="margin-bottom:20px;">
                        <div class="flex-between">
                            <span style="font-size:12px;">3M</span>
                            <h3 style="margin:0;"><span id="calc-tenure-display">6</span> Months</h3>
                            <span style="font-size:12px;">24M</span>
                        </div>
                        <input type="range" id="calc-tenure" min="3" max="24" step="1" value="6" oninput="updateCalc()">
                    </div>

                    <div class="card loan-offer-card">
                        <div class="loan-detail-row"><span>Interest Rate:</span> <span>0% / month</span></div>
                        <div class="loan-detail-row"><span>Monthly EMI:</span> <strong id="calc-emi-display">‚Çπ1,667</strong></div>
                        <div class="loan-detail-row"><span>Total Repayment (Principal):</span> <strong id="calc-total-display">‚Çπ10,000</strong></div>
                    </div>

                    <button class="btn" onclick="submitLoanApplication()">Apply for Loan</button>
                </div>

                <div id="view-pending" class="field-hidden text-center" style="padding:40px 0;">
                    <i class="ri-loader-4-line" style="font-size:50px; color:var(--gold); animation: spin 1s linear infinite;"></i>
                    <h3>Application Submitted</h3>
                    <p style="font-size:12px; color:#666;">Your request ID: <span id="pending-id">...</span><br>The admin is reviewing your KYC and documents now.</p>
                    <button class="btn secondary" onclick="closeLoanDashboard()">Check Later</button>
                </div>
                
                <div id="view-blocked" class="field-hidden text-center" style="padding:40px 0;">
                    <i class="ri-forbid-2-line" style="font-size:50px; color:var(--danger);"></i>
                    <h3>Application Blocked</h3>
                    <p style="font-size:12px; color:#666;">Based on your previous late payment history, you cannot re-apply for a loan for the next 6 months.<br>
                    **Unblock Date:** <span id="block-end-date">...</span></p>
                    <button class="btn secondary" onclick="closeLoanDashboard()">Close</button>
                </div>

                <div id="view-offer" class="field-hidden">
                    <div style="text-align:center; margin-bottom:15px;">
                        <i class="ri-checkbox-circle-fill" style="color:var(--success); font-size:40px;"></i>
                        <h3 style="margin:5px 0;">Loan Approved!</h3>
                        <p style="font-size:12px;">Congratulations! Here is your final offer.</p>
                    </div>

                    <div class="card loan-offer-card">
                        <div class="loan-detail-row"><span>Approved Amount (Disbursal)</span> <strong style="font-size:16px;">‚Çπ<span id="offer-amt">0</span></strong></div>
                        <div class="loan-detail-row"><span>Tenure</span> <span id="offer-tenure">0</span> Months</div>
                        <div class="loan-detail-row"><span>Interest Rate</span> <span id="offer-roi">0</span>% p.m.</div>
                        <div class="loan-detail-row"><span>Processing Fee</span> <span style="color:red;">- ‚Çπ<span id="offer-fee">0</span></span></div>
                        <div style="border-top:1px solid #ccc; margin-top:5px; padding-top:5px;" class="loan-detail-row">
                            <span>Total Repayment (EMI Amt. x Tenure)</span> <strong style="color:var(--gold-strong); font-size:16px;">‚Çπ<span id="offer-total">0</span></strong>
                        </div>
                    </div>

                    <div class="card" style="padding:10px;">
                        <h5 style="margin:0 0 10px 0;">Digital Agreement & KYC</h5>
                        <div class="flex-row">
                            <input type="checkbox" id="agree-chk" style="width:20px; margin:0;">
                            <span style="font-size:11px;">I accept terms & conditions.</span>
                        </div>
                        <div style="border:1px dashed #ccc; padding:10px; margin-top:10px; text-align:center; border-radius:8px;">
                            <i class="ri-camera-lens-line"></i><br>
                            <span style="font-size:10px;">Liveness Check (Selfie) verified automatically</span>
                        </div>
                        <input id="signature" placeholder="Type Full Name to Sign" style="margin-top:10px;">
                    </div>

                    <div class="flex-row">
                        <button class="btn secondary" style="color:red; border-color:red;" onclick="rejectOffer()">Reject</button>
                        <button class="btn" onclick="acceptOffer()">Sign & Accept Loan</button>
                    </div>
                </div>

                <div id="view-disbursement" class="field-hidden text-center" style="padding:40px 0;">
                    <i class="ri-time-line" style="font-size:50px; color:var(--warning);"></i>
                    <h3>Disbursal in Review</h3>
                    <p style="font-size:12px; color:#666;">You have successfully signed the loan agreement.<br>
                    The Admin is now **reviewing the agreement** and will initiate the fund transfer shortly.</p>
                    <div class="card" style="font-size:12px; background:#fef3c7; color:#b45309;">
                        Net Disbursal Amount: <strong>‚Çπ<span id="disburse-amt">0</span></strong>
                    </div>
                    <button class="btn secondary" onclick="closeLoanDashboard()">I Understand / Check Later</button>
                </div>

                <div id="view-active" class="field-hidden">
                    <div class="card gold-card">
                        <div style="font-size:12px; opacity:0.9;">Total Outstanding</div>
                        <div style="font-size:24px; font-weight:700;">‚Çπ<span id="track-balance">0</span></div>
                        <div class="progress-container"><div id="track-progress" class="progress-bar" style="width:0%"></div></div>
                        <div class="flex-between" style="font-size:11px;">
                            <span>Paid: ‚Çπ<span id="track-paid">0</span></span>
                            <span>Total Repayment: ‚Çπ<span id="track-total">0</span></span>
                        </div>
                    </div>

                    <div class="card" style="border-left:4px solid var(--danger);">
                        <div class="flex-between">
                            <div>
                                <div style="font-size:11px; color:#666;">Next EMI Due</div>
                                <div style="font-weight:700; font-size:16px;"><span id="track-next-date">...</span></div>
                            </div>
                            <div class="timer-badge">
                                <i class="ri-alarm-warning-line"></i> <span id="track-timer">00d 00h</span>
                            </div>
                        </div>
                        <div class="flex-between" style="margin-top:10px;">
                            <strong>‚Çπ<span id="track-next-amt">0</span></strong>
                            <button class="btn" style="width:auto; padding:6px 15px; font-size:12px;" onclick="openPayModal()">Pay Now</button>
                        </div>
                    </div>

                    <div class="flex-row" style="margin-bottom:15px; overflow-x:auto;">
                        <button class="btn secondary" style="font-size:11px; white-space:nowrap;" onclick="requestForeclosure()">Request Foreclosure</button>
                        <button class="btn secondary" style="font-size:11px; white-space:nowrap;">Download Statement</button>
                        <button class="btn secondary" style="font-size:11px; white-space:nowrap;" onclick="openSupportChat()">Support Chat</button>
                    </div>

                    <h4>EMI History</h4>
                    <div id="emi-list">
                        </div>
                        
                    <h4 style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">Loan History (Closed)</h4>
                    <div id="closed-loan-history">
                        <p class="text-center small-muted">No closed loans found.</p>
                    </div>
                </div>

            </div>
        </div>

        <div id="pay-modal" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="document.getElementById('pay-modal').style.display='none'">&times;</button>
                <h3>Pay EMI</h3>
                <p>Paying: ‚Çπ<span id="pay-amount-display"></span></p>
                
                <div style="text-align:center; margin:20px 0;">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=7649070168@okbizaxis&pn=GoldRupi&am=100" style="width:150px; border-radius:10px; border:1px solid #ddd;">
                    <p style="font-size:11px;">Scan with GPay / Paytm / PhonePe</p>
                </div>
                
                <button class="btn" style="background:#4CAF50; color:#fff; margin-bottom:10px;" onclick="launchUPI()"> <i class="ri-smartphone-line"></i> Open UPI App</button>
                
                <div style="margin-top:15px;">
                    <label style="font-size:12px;">Enter UTR / Ref Number (12 Digits)</label>
                    <input id="pay-utr" placeholder="123456789012" maxlength="12" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 12);">
                    <button class="btn" onclick="submitPayment()">Submit Payment</button>
                </div>
            </div>
        </div>



<div id="support-chat-modal" class="overlay">
    <div class="modal">
        <div class="chat-header">
            <h4><i class="ri-customer-service-line"></i> Help & Support</h4>
            <button class="close-modal" style="color:white; position:static; background:none; font-size: 28px; line-height: 1;" onclick="document.getElementById('support-chat-modal').style.display='none'">&times;</button>
        </div>
        
        <div id="chat-messages" class="chat-messages">
            <div id="older-messages-loader" class="older-messages-loader">
                Click to load older messages...
            </div>
            <div class="msg-admin">
                Hi there! How can we help you today?
                <span class="msg-time">Admin - 10:00 PM</span>
            </div>
        </div>
        
        <div class="chat-input-area">
            <input type="file" id="chat-attachment-file" hidden onchange="showAttachmentPreview()">
            
            <button class="btn secondary" style="width:auto; padding:10px 15px;" onclick="document.getElementById('chat-attachment-file').click()">
                 <i class="ri-attachment-line"></i>
            </button>
            
            <input id="chat-message-input" placeholder="Type your message...">
            
            <button class="btn" id="send-chat-btn" onclick="sendChatMessage()"><i class="ri-send-plane-2-fill"></i></button>
        </div>
        
        <div id="attachment-preview-area" style="padding: 0 15px 10px; background: var(--card-bg);" class="field-hidden">
        </div>
    </div>
</div>

<div class="fab-support" onclick="openSupportChat()">
    <i id="fab-icon" class="ri-chat-3-line"></i>
</div>


        



        <div id="selfie-modal" class="overlay">
            <div class="modal">
                <button class="close-modal" onclick="closeSelfieModal()">&times;</button>
                <h3 style="margin-top:0;">Liveness Check Selfie</h3>
                <p style="font-size:12px; color:var(--danger);">Please allow camera access and look straight at the camera.</p>
                <video id="video-stream" autoplay playsinline></video>
                <canvas id="selfie-canvas" width="300" height="225"></canvas>
                <div id="selfie-controls">
                    <button id="snap-btn" class="btn secondary" style="width:45%;" onclick="capturePhoto()">
                        <i class="ri-camera-line"></i> Take Photo
                    </button>
                    <button id="upload-selfie-btn" class="btn" style="width:45%; display:none;" onclick="uploadSelfieAndSave()">
                        <i class="ri-upload-cloud-line"></i> Upload & Save
                    </button>
                    <button id="retake-btn" class="btn secondary" style="width:45%; display:none;" onclick="retakePhoto()">
                        <i class="ri-refresh-line"></i> Retake
                    </button>
                </div>
            </div>
        </div>
        <div class="fab-support" onclick="openSupportChat()">
             <i class="ri-chat-3-line"></i>
        </div>


        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('section-home', this)"><i class="ri-home-line"></i>Home</div>
            <div class="nav-item" onclick="switchTab('section-shop', this)"><i class="ri-store-2-line"></i>Shop</div>
            <div id="loan-nav-item" class="nav-item" onclick="openLoanDashboard()"><i class="ri-refund-2-line"></i>Loan</div>
            <div class="nav-item" onclick="switchTab('section-profile', this)"><i class="ri-user-line"></i>Profile</div>
        </div>
        
    </div> <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
            authDomain: "smbrand-4543a.firebaseapp.com",
            databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
            projectId: "smbrand-4543a",
            appId: "1:720775550032:web:0622548a007597778bad55"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        // üéØ UPDATED CONFIG: Cloudflare Worker URL (‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ)
        const CLOUDFLARE_WORKER_URL = 'https://ebookandapk-uploder.rajputsurendra562.workers.dev';
        const MERCHANT_UPI_ID = '7649070168@okbizaxis'; 

        // üéØ NEW: Telegram Config for Signup Alert (‡§á‡§∏‡•á ‡§¨‡§¶‡§≤‡•á‡§Ç)
        const BOT_TOKEN = "7840966662:AAHqRQbwMOk6ja6pewc3fBMkGUAF7ZKb8ZE"; // Replace with your bot token
        const CHAT_ID = "7918796164";     // Replace with your chat ID
        // üéØ END NEW: Telegram Config

        let currentUser = null;
        let currentLoanId = null;
        let isGuest = false;
        
        let notificationCount = 0; // To track new notifications
        let currentSelfieBlob = null; // To hold the captured selfie data


    // --- Initial Setup (Icons and Colors) ---
    const programData = [];
    
    // Icons: Cash, Gift, Shopping, Card, Account, Wallet, Shield, Gold, Bill, Chart, Truck, Plane
    const baseIcons = [
        "ri-cash-line", "ri-gift-line", "ri-shopping-bag-line", "ri-bank-card-line", 
        "ri-user-settings-line", "ri-wallet-line", "ri-shield-line", "ri-coin-line",
        "ri-receipt-line", "ri-line-chart-line", "ri-truck-line", "ri-plane-line"
    ];
    // Colors: Red, Green, Blue, Orange, Purple, Cyan, Pink, Dark Gray
    const colors = ["#ef4444", "#10b981", "#3b82f6", "#f59e0b", "#8b5cf6", "#06b6d4", "#f43f5e", "#4b5563"]; 

    // --- 1. Custom Defined Buttons (4 entries - As provided by User) ---

    // 1. LOAN data (program.html)
    programData.push({ 
        title: "LOAN", 
        subtitle: "INCREASE NOW", 
        file: "program.html", 
        icon: baseIcons[0], // ri-cash-line
        color: colors[0] 
    });

    // 2. REFER & EARN data (affiliated.html)
    programData.push({ 
        title: "REFER", 
        subtitle: "& EARN", 
        file: "affiliated.html", 
        icon: baseIcons[1], // ri-gift-line
        color: colors[1] 
    });

    // 3. Shop Buy (urupe.html)
    programData.push({
        title: "Shop Buy",
        subtitle: "shop",
        file: "urupe.html", 
        icon: baseIcons[2], // ri-shopping-bag-line
        color: colors[2] 
    });

    // 4. Credit Limit (etc.html)
    programData.push({
        title: "Credit Limit",
        subtitle: "Instant Limit",
        file: "etc.html", 
        icon: baseIcons[3], // ri-bank-card-line
        color: colors[3] 
    });
    
    // --- 2. Generating Remaining 23 Buttons (5 to 27 with Custom Titles) ---

    // 5. MY GOLD
    programData.push({ 
        title: "MY GOLD", 
        subtitle: "Buy/Sell 24K", 
        file: "gold_plan.html", 
        icon: baseIcons[7], 
        color: colors[4] 
    });

    // 6. INVEST
    programData.push({ 
        title: "INVEST", 
        subtitle: "SIP/Mutual", 
        file: "invest_now.html", 
        icon: baseIcons[9], 
        color: colors[5] 
    });

    // 7. INSURE
    programData.push({ 
        title: "INSURE", 
        subtitle: "Health/Life", 
        file: "insurance.html", 
        icon: baseIcons[6], 
        color: colors[6] 
    });

    // 8. UTILITY
    programData.push({ 
        title: "UTILITY", 
        subtitle: "Bill Pay", 
        file: "bill_pay.html", 
        icon: baseIcons[8], 
        color: colors[7] 
    });

    // 9. WALLET
    programData.push({ 
        title: "WALLET", 
        subtitle: "Top-Up Pay", 
        file: "wallet_manage.html", 
        icon: baseIcons[5], 
        color: colors[0] 
    });

    // 10. TAX PLAN
    programData.push({ 
        title: "TAX PLAN", 
        subtitle: "Save 80C", 
        file: "tax_filing.html", 
        icon: baseIcons[4], 
        color: colors[1] 
    });

    // 11. SAVINGS
    programData.push({ 
        title: "SAVINGS", 
        subtitle: "High Interest", 
        file: "savings_ac.html", 
        icon: baseIcons[3], 
        color: colors[2] 
    });

    // 12. FASTag
    programData.push({ 
        title: "FASTag", 
        subtitle: "Recharge", 
        file: "fastag_recharge.html", 
        icon: baseIcons[0], 
        color: colors[3] 
    });

    // 13. EMI HUB
    programData.push({ 
        title: "EMI HUB", 
        subtitle: "Manage Dues", 
        file: "emi_manager.html", 
        icon: baseIcons[8], 
        color: colors[4] 
    });

    // 14. VOUCHER
    programData.push({ 
        title: "VOUCHER", 
        subtitle: "Get Discounts", 
        file: "vouchers.html", 
        icon: baseIcons[1], 
        color: colors[5] 
    });

    // 15. TICKETS
    programData.push({ 
        title: "BOOKING", 
        subtitle: "flight Book Now", 
        file: "flight.html", 
        icon: baseIcons[2], 
        color: colors[6] 
    });

    // 16. PROFILE
    programData.push({ 
        title: "PROFILE", 
        subtitle: "KYC Update", 
        file: "profile_kyc.html", 
        icon: baseIcons[4], 
        color: colors[7] 
    });

    // 17. OFFERS
    programData.push({ 
        title: "OFFERS", 
        subtitle: "Daily Deals", 
        file: "daily_offers.html", 
        icon: baseIcons[1], 
        color: colors[0] 
    });

    // 18. LOAN+
    programData.push({ 
        title: "LOAN+", 
        subtitle: "Business Loan", 
        file: "loan_business.html", 
        icon: baseIcons[0], 
        color: colors[1] 
    });

    // 19. REWARDS
    programData.push({ 
        title: "REWARDS", 
        subtitle: "Check Points", 
        file: "rewards_center.html", 
        icon: baseIcons[1], 
        color: colors[2] 
    });

    // 20. GIFT CARD
    programData.push({ 
        title: "GIFT CARD", 
        subtitle: "Send Card", 
        file: "gift_send.html", 
        icon: baseIcons[1], 
        color: colors[3] 
    });

    // 21. PROPERTY
    programData.push({ 
        title: "PROPERTY", 
        subtitle: "Loan Query", 
        file: "property_loan.html", 
        icon: baseIcons[0], 
        color: colors[4] 
    });

    // 22. DEBIT
    programData.push({ 
        title: "DEBIT", 
        subtitle: "Request Card", 
        file: "debit_card.html", 
        icon: baseIcons[3], 
        color: colors[5] 
    });

    // 23. HELPDESK
    programData.push({ 
        title: "HELPDESK", 
        subtitle: "Support 24/7", 
        file: "support.html", 
        icon: baseIcons[6], 
        color: colors[6] 
    });

    // 24. SETTINGS
    programData.push({ 
        title: "SETTINGS", 
        subtitle: "App Control", 
        file: "app_settings.html", 
        icon: baseIcons[4], 
        color: colors[7] 
    });

    // 25. FEEDBACK
    programData.push({ 
        title: "FEEDBACK", 
        subtitle: "Give Review", 
        file: "feedback.html", 
        icon: baseIcons[4], 
        color: colors[0] 
    });

    // 26. UPGRADE
    programData.push({ 
        title: "UPGRADE", 
        subtitle: "Premium Plan", 
        file: "premium_plan.html", 
        icon: baseIcons[7], 
        color: colors[1] 
    });

    // 27. TRAVEL
    programData.push({ 
        title: "TRAVEL", 
        subtitle: "Book Flights", 
        file: "flight.html", 
        icon: baseIcons[11], 
        color: colors[2] 
    });

    // --- 3. Button Generation Function (Handles creating the HTML structure) ---
    function generateButtons() {
        const container = document.getElementById('scrollable-buttons-container');
        if (!container) return; 

        programData.forEach(program => {
            // NOTE: Using .toUpperCase() for Titles and Subtitles for bold appearance
            const buttonHTML = `
                <div class="circular-offer-btn" 
                    style="background: ${program.color}; border-color: ${program.color};"
                    onclick="openProgramModal('${program.file}', '${program.title} ${program.subtitle}')"> 
                    <i class="${program.icon}" style="font-size: 20px;"></i>
                    <strong>${program.title.toUpperCase()}</strong>
                    <span style="font-size: 9px; font-weight: 700;">${program.subtitle.toUpperCase()}</span>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', buttonHTML);
        });
    }

    // --- 4. Modal Opening Function (Handles ALL 27 buttons opening in the modal) ---
    function openProgramModal(filename, title) {
        const modal = document.getElementById('referral-modal');
        const iframe = document.getElementById('referral-iframe');
        const header = modal ? modal.querySelector('.referral-header h3') : null;

        if (modal && iframe && header) {
            iframe.src = filename; 
            header.textContent = title;
            modal.style.display = 'flex'; 
        }
    }
    
    // Initialize buttons
    window.addEventListener('DOMContentLoaded', generateButtons);
















    // Placeholder functions (You need to define these if they are used elsewhere)
    function showLoanOfferModal() {
        alert("Loading Loan Offer Modal...");
    }












        // --- UI UTILITY ---
        function updateFileName(input, statusElementId) {
            const span = statusElementId ? document.getElementById(statusElementId) : input.closest('.file-upload-box').querySelector('span');
            // Store the original text if not already stored
            if (!span.dataset.originalText) {
                span.dataset.originalText = span.innerText;
            }

            if (input.files.length > 0) {
                span.innerText = input.files[0].name.substring(0, 20) + '...';
                span.style.color = 'var(--success)';
            } else {
                span.innerText = span.dataset.originalText || 'Upload Document';
                span.style.color = '';
            }
        }
        document.querySelectorAll('.file-upload-box span').forEach(span => {
            span.dataset.originalText = span.innerText; // Store original text
        });

        // ------------------ AUTHENTICATION LOGIC ------------------

        function showAuthTab(tab) {
            document.getElementById('login-form').classList.add('field-hidden');
            document.getElementById('signup-form').classList.add('field-hidden');
            document.getElementById('login-tab-btn').classList.remove('active');
            document.getElementById('signup-tab-btn').classList.remove('active');
            
            if(tab === 'login') {
                document.getElementById('login-form').classList.remove('field-hidden');
                document.getElementById('login-tab-btn').classList.add('active');
            } else {
                document.getElementById('signup-form').classList.remove('field-hidden');
                document.getElementById('signup-tab-btn').classList.add('active');
            }
        }

        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if(!email || !password) return alert("Enter email and password.");
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert("Login Failed: " + error.message);
            }
        }

        /**
         * üéØ UPDATED: Handles signup, Firebase user creation, and non-blocking Telegram alert.
         * If Telegram alert fails, it just logs an error and continues with signup.
         */
        async function signupUser() {
            const name = document.getElementById('signup-name').value;
            const mobile = document.getElementById('signup-mobile').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if(!name || !mobile || mobile.length !== 10 || !email || password.length < 6) {
                return alert("Please fill all fields correctly (Mobile must be 10 digits, Password min 6 chars).");
            }
            
            try {
                // 1. Create Firebase User
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                // 2. Save User Data to DB
                await db.ref('users/'+uid).set({
                    name: name,
                    mobile: mobile,
                    email: email,
                    wallet: 0,
                    created_at: Date.now(),
                    payment_on_time: true,
                    late_payment_count: 0,
                    loan_blocked_until: 0, 
                    profile_dp_url: null // NEW: Field for Profile Picture
                });

                // 3. Send Telegram Alert (Non-blocking)
                sendSignupAlert(name, mobile, email, uid)
                    .then(success => {
                        if (!success) {
                            // If Telegram fails, send a notification to the user (optional)
                            db.ref(`users/${uid}/notifications`).push({
                                title: "Telegram Alert Failed",
                                message: "Account created but external alert failed. Admin may check manually. Signup successful.",
                                timestamp: Date.now()
                            });
                            console.error("Telegram alert failed, but signup successful.");
                        }
                    })
                    .catch(e => {
                        console.error("Error during non-blocking Telegram alert:", e);
                    });

                alert("Account Created! You are now logged in.");
            } catch (error) {
                alert("Sign Up Failed: " + error.message);
            }
        }

        /**
         * üéØ NEW: Function to send a non-blocking Telegram alert for new signups.
         * @returns {Promise<boolean>} True if successful, False otherwise.
         */
        async function sendSignupAlert(name, mobile, email, uid) {
            const message = `
üöÄ New User Signup
üë§ Name: ${name}
üì± Mobile: ${mobile}
üìß Email: ${email}
üîë UID: ${uid}
‚è∞ Time: ${new Date().toLocaleString()}
    `;

            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: message
                    })
                });

                const data = await response.json();
                if (data.ok) {
                    console.log("Telegram alert sent successfully.");
                    return true;
                } else {
                    console.error("Telegram API reported failure:", data);
                    return false;
                }
            } catch (err) {
                console.error("Error sending Telegram alert:", err);
                return false;
            }
        }
        
        function loginAsGuest() {
            isGuest = true;
            currentUser = { uid: 'GUEST_USER', email: 'guest@goldrupi.com' };
            initializeAppUI();
            alert("Continuing as Guest. Loan and Profile features are disabled.");
        }

        // AUTH CHECK
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                isGuest = false;
                initializeAppUI();
            } else if (!isGuest) {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('main-app-content').classList.add('field-hidden');
            }
        });
        
        function initializeAppUI() {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-app-content').classList.remove('field-hidden');
            
            if(isGuest) {
                document.getElementById('user-name-display').innerText = 'Guest';
                document.getElementById('profile-name-display').innerText = 'Guest User'; // NEW
                document.getElementById('profile-uid-display').innerText = 'GUEST_MODE'; // NEW
                document.getElementById('header-wallet').innerText = 'N/A';
                document.getElementById('loan-nav-item').onclick = () => alert("Please Login/Sign Up to access Loan services.");
                document.getElementById('loan-nav-item').style.opacity = '0.4';
                document.getElementById('profile-card').innerHTML = '<p class="text-center" style="color:red;">Login to manage profile.</p>';
                document.getElementById('manual-pay-card').classList.add('field-hidden'); // Hide new card for guest
            } else {
                document.getElementById('loan-nav-item').onclick = openLoanDashboard;
                document.getElementById('loan-nav-item').style.opacity = '1';
                document.getElementById('manual-pay-card').classList.remove('field-hidden'); // Show new card for logged in
                document.getElementById('profile-uid-display').innerText = currentUser.uid.substring(0, 8) + '...'; // NEW
                loadUserData();
                listenForLoanStatus();
                listenForNotifications();
                listenForUserNotifications(); // üéØ NEW: Start listening for user-specific notifications
                loadCoupons();
            }
            document.getElementById('latest-products-list').innerHTML = `<p class="small-muted">Products loading enabled.</p>`;
        }


        // ------------------ CORE APP LOGIC ------------------
        let userDataCache = {}; // Cache user data

        function loadUserData(){
            db.ref('users/'+currentUser.uid).on('value', snap => {
                const data = snap.val() || {};
                userDataCache = data; // Update Cache
                const name = data.name || 'User';
                
                // Header & Home
                document.getElementById('user-name-display').innerText = name.split(' ')[0];
                document.getElementById('header-wallet').innerText = (data.wallet || 0).toFixed(2);
                
                // Profile
                document.getElementById('profile-name-display').innerText = name; // NEW
                document.getElementById('profile-name').value = name;
                document.getElementById('profile-mobile').value = data.mobile || '';
                
                // Profile DP Update (NEW)
                const dpDiv = document.getElementById('profile-dp-display');
                if (data.profile_dp_url) {
                    dpDiv.innerHTML = `<img src="${data.profile_dp_url}" alt="Profile Picture">`;
                } else {
                    dpDiv.innerHTML = `<i class="ri-user-3-line"></i>`;
                }
                
                // Toggle Company Name Input
                const occ = document.getElementById('loan-occupation').value;
                const companyInput = document.getElementById('loan-company-name');
                if (occ === 'salaried' || occ === 'business') {
                    companyInput.classList.remove('field-hidden');
                } else {
                    companyInput.classList.add('field-hidden');
                }
            });
        }
        
        document.getElementById('loan-occupation').addEventListener('change', (e) => {
            const companyInput = document.getElementById('loan-company-name');
            if (e.target.value === 'salaried' || e.target.value === 'business') {
                companyInput.classList.remove('field-hidden');
                companyInput.placeholder = e.target.value === 'salaried' ? 'Employer/Company Name' : 'Business Name';
            } else {
                companyInput.classList.add('field-hidden');
            }
        });


        // ************************************************
        // ********** UPDATED switchTab FUNCTION **********
        // ************************************************
        let loContentLoaded = false; 

        function switchTab(sectionId, el) {
            document.querySelectorAll('.page-section').forEach(d => d.classList.add('field-hidden'));
            document.getElementById(sectionId).classList.remove('field-hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            
            // ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï: ‡§≤‡•ã.‡§è‡§ö‡§ü‡•Ä‡§è‡§Æ‡§è‡§≤ ‡§ï‡•ã ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ
            if (sectionId === 'section-shop') {
                const loIframe = document.getElementById('lo-iframe-content');
                const loadingMsg = document.getElementById('lo-loading-msg');
                
                if (loIframe && !loContentLoaded) {
                    // Check if it's currently blank, then load
                    if (loIframe.src.indexOf('about:blank') !== -1) {
                         loIframe.src = 'urupe.html'; 
                    }
                    loContentLoaded = true; // Set to true after trying to load
                }
                // Hide the loading message once the iframe has received content (or attempted)
                if (loadingMsg) {
                    loadingMsg.style.display = 'none'; 
                }
            }
        }
        // ************************************************
        // ********** END UPDATED switchTab FUNCTION **********
        // ************************************************
        
        function saveProfile() {
            if(isGuest) return alert("Login to save profile.");
            const name = document.getElementById('profile-name').value;
            db.ref('users/'+currentUser.uid).update({name: name});
            alert("Profile Saved");
        }

        function logout(){
            if(isGuest) {
                isGuest = false;
                currentUser = null;
                document.getElementById('main-app-content').classList.add('field-hidden');
                document.getElementById('auth-overlay').style.display = 'flex';
                return;
            }
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('main-app-content').classList.add('field-hidden');
                document.getElementById('auth-overlay').style.display = 'flex';
            });
        }
        
        function openNotifications() {
            document.getElementById('notif-overlay').style.display = 'flex';
            document.getElementById('notif-badge').style.display = 'none';
        }
        
        function appendNotification(n) {
            const html = `
                <div class="notif-item">
                    <div class="notif-title">${n.title}</div>
                    <div class="notif-body">${n.message}</div>
                    <div style="font-size:10px; color:#999; margin-top:2px;">${new Date(n.timestamp).toLocaleTimeString()}</div>
                </div>
            `;
            document.getElementById('notification-list').insertAdjacentHTML('afterbegin', html);
            
            document.getElementById('notif-badge').style.display = 'flex';
            document.getElementById('notif-badge').innerText = 'New!';
        }

        function listenForNotifications() {
            db.ref('admin_notifications').limitToLast(10).on('child_added', snap => {
                const n = snap.val();
                if(!n) return;
                appendNotification(n);
            });
        }
        
        // üéØ NEW: Function to listen for User-Specific Notifications
        function listenForUserNotifications() {
            if (isGuest || !currentUser.uid) return;
            
            db.ref('users/' + currentUser.uid + '/notifications').limitToLast(10).on('child_added', snap => {
                const n = snap.val();
                if(!n) return;
                // Add a source tag for clarity (optional)
                n.title = `[USER ALERT] ${n.title}`; 
                appendNotification(n);
            });
        }
        // üéØ END NEW FUNCTION

        function loadCoupons() {
            if(isGuest) {
                document.getElementById('coupon-list-container').innerHTML = '<div class="small-muted text-center">Login to see coupons.</div>';
                return;
            }
            db.ref('coupons').on('value', snap => {
                const coupons = snap.val();
                const container = document.getElementById('coupon-list-container');
                container.innerHTML = '';
                
                if(!coupons) {
                    container.innerHTML = '<div class="small-muted text-center">No active coupons.</div>';
                    return;
                }

                Object.keys(coupons).forEach(key => {
                    const c = coupons[key];
                    if(c.active) {
                        const div = document.createElement('div');
                        div.className = 'coupon-ticket';
                        div.innerHTML = `
                            <div>
                                <div class="coupon-code">${key}</div>
                                <div style="font-size:11px;">${c.description}</div>
                            </div>
                            <button class="btn secondary" style="padding:4px 8px; font-size:10px;" onclick="copyCode('${key}')">COPY</button>
                        `;
                        container.appendChild(div);
                    }
                });
            });
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code);
            alert("Code " + code + " copied!");
        }

        let currentCheckoutPrice = 0;
        let appliedDiscount = 0;
        let checkoutItemName = "";

        function openCheckout(price, name) {
            currentCheckoutPrice = price;
            checkoutItemName = name;
            appliedDiscount = 0;
            
            document.getElementById('checkout-item-name').innerText = name;
            document.getElementById('checkout-item-price').innerText = price;
            document.getElementById('checkout-total').innerText = price;
            document.getElementById('checkout-coupon-input').value = "";
            document.getElementById('coupon-msg').innerText = "";
            document.getElementById('checkout-overlay').style.display = 'flex';
        }

        async function applyCoupon() {
            const code = document.getElementById('checkout-coupon-input').value.toUpperCase().trim();
            if(!code) return;

            const snap = await db.ref('coupons/' + code).once('value');
            if(snap.exists() && snap.val().active) {
                const data = snap.val();
                if(data.type === 'flat') {
                    appliedDiscount = data.value;
                } else if (data.type === 'percent') {
                    appliedDiscount = Math.round((currentCheckoutPrice * data.value) / 100);
                }
                
                const finalTotal = currentCheckoutPrice - appliedDiscount;
                document.getElementById('checkout-total').innerText = finalTotal > 0 ? finalTotal : 0;
                document.getElementById('coupon-msg').innerHTML = `<span style="color:green">Applied! Saved ‚Çπ${appliedDiscount}</span>`;
            } else {
                document.getElementById('checkout-total').innerText = currentCheckoutPrice;
                document.getElementById('coupon-msg').innerHTML = `<span style="color:red">Invalid or Expired Code</span>`;
                appliedDiscount = 0;
            }
        }

        function confirmOrder() {
            alert(`Order Placed for ${checkoutItemName}! Total Paid: ‚Çπ${document.getElementById('checkout-total').innerText}`);
            document.getElementById('checkout-overlay').style.display = 'none';
        }

        function setStep(num) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('field-hidden'));
            document.getElementById(`form-step-${num}`).classList.remove('field-hidden');
            
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`#step-${num}`).classList.add('active');
        }

        function showView(id) {
            document.querySelectorAll('#loan-dashboard > .modal > div[id^="view-"]').forEach(el => el.classList.add('field-hidden'));
            document.getElementById(id).classList.remove('field-hidden');
            
            // Hide specific blocks in the calculator view
            if (id === 'view-calculator') {
                document.getElementById('good-customer-msg').style.display = 'none';
            }
        }
        
        function openLoanDashboard(){
            if(isGuest) return alert("Please Login/Sign Up to access Loan services.");
            document.getElementById('loan-dashboard').style.display = 'flex';
            checkLoanStep(); 
            loadClosedLoanHistory(); // NEW: Load closed loan history when dashboard opens
        }

        function closeLoanDashboard(){
            document.getElementById('loan-dashboard').style.display = 'none';
        }
        
        // ------------------ LOAN DASHBOARD LOGIC ------------------

        async function checkLoanStep(targetStep = 0){ 
            if(isGuest) {
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                showView('view-pending');
                document.getElementById('pending-id').innerText = 'GUEST_MODE';
                document.querySelector('#view-pending h3').innerText = 'Login Required';
                document.querySelector('#view-pending p').innerText = 'Please sign up or login to apply for a loan.';
                return;
            }
            
            ['view-verification','view-calculator','view-pending','view-offer','view-disbursement','view-active', 'view-blocked'].forEach(id => {
                document.getElementById(id).classList.add('field-hidden');
            });
            document.getElementById('loan-wizard-header').classList.remove('field-hidden');

            const appSnap = await db.ref('users/'+currentUser.uid+'/loan_app').once('value');
            const app = appSnap.val() || {};
            
            // 0. CHECK FOR BLOCK
            const now = Date.now();
            if (userDataCache.loan_blocked_until && userDataCache.loan_blocked_until > now) {
                const blockedUntilDate = new Date(userDataCache.loan_blocked_until).toLocaleDateString();
                document.getElementById('block-end-date').innerText = blockedUntilDate;
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                showView('view-blocked');
                return;
            }
            
            // 1. ACTIVE Loan (Final Stage - Admin must change status to 'active')
            if(app.status === 'active') {
                showView('view-active');
                loadActiveLoanData(app.loan_id); 
                document.getElementById('loan-wizard-header').classList.add('field-hidden'); 
                return;
            }
            
            // 2. USER ACCEPTED OFFER (Disbursal in Review)
            if(app.status === 'accepted') { 
                showView('view-disbursement');
                loadDisbursementData(app.loan_id); 
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                return;
            }
            
            // 3. REVIEWED (Admin sent an offer, User sees 'Review & Sign' Screen)
            if(app.status === 'reviewed') {
                showView('view-offer');
                loadOfferData(app.loan_id);
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                return;
            }
            
            // 4. PENDING (User applied, waiting for admin review)
            if(app.status === 'pending') {
                showView('view-pending');
                document.getElementById('pending-id').innerText = app.loan_id;
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                return;
            }
            
            // 5. LOAN CLOSED/REJECTED/REJECTED_BY_USER: Show Calculator or Verification
            if (['closed', 'rejected', 'rejected_by_user'].includes(app.status)) {
                // Check if all steps are completed for a re-apply (Step 5)
                const vSnap = await db.ref('users/'+currentUser.uid+'/loan_verification').once('value');
                const v = vSnap.val() || {};
                
                if(v.step5_completed) {
                    document.getElementById('loan-wizard-header').classList.add('field-hidden');
                    showView('view-calculator');
                    updateCalc();
                    
                    // NEW: Show good customer message if applicable
                    if (userDataCache.payment_on_time === true) {
                         document.getElementById('good-customer-msg').style.display = 'block';
                    }
                    
                } else {
                    // If steps are not complete, go to the last completed step
                    document.querySelector('#view-pending h3').innerText = 'Loan Application Closed';
                    document.querySelector('#view-pending p').innerText = 'You can apply for a new loan once you complete all verification steps.';
                    showView('view-pending'); 
                }
                return;
            }

            // 6. VERIFICATION STEPS (Initial Application)
            const vSnap = await db.ref('users/'+currentUser.uid+'/loan_verification').once('value');
            const v = vSnap.val() || {};
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('completed', 'active'));
            // NEW: Reset selfie status for new/pending applications
            if (v.step2_data && v.step2_data.selfie_url) {
                document.getElementById('selfie-status').innerText = 'Selfie Taken!';
                document.getElementById('selfie-status').style.color = 'var(--success)';
                document.getElementById('file-selfie-url').value = v.step2_data.selfie_url;
            } else {
                 document.getElementById('selfie-status').innerText = 'Take Liveness Check Selfie (Mandatory)';
                 document.getElementById('selfie-status').style.color = 'var(--gold-strong)';
                 document.getElementById('file-selfie-url').value = '';
            }


            let stepToShow = 1;

            if(v.step1_completed) { 
                document.querySelector('#step-1').classList.add('completed');
                stepToShow = 2;
                // Auto-fill Step 1 inputs
                if(v.step1_data) {
                    document.getElementById('loan-fname').value = v.step1_data.fname || '';
                    document.getElementById('loan-dob').value = v.step1_data.dob || '';
                    document.getElementById('loan-email').value = v.step1_data.email || '';
                }
            }
            
            if(v.step2_completed) { 
                document.querySelector('#step-2').classList.add('completed');
                stepToShow = 3;
                // Auto-fill Step 2 inputs
                if(v.step2_data) {
                    document.getElementById('loan-pan').value = v.step2_data.pan || '';
                }
            }

            if(v.step3_completed) { 
                document.querySelector('#step-3').classList.add('completed');
                stepToShow = 4;
                // Auto-fill Step 3 inputs
                 if(v.step3_data) {
                    document.getElementById('loan-bank-name').value = v.step3_data.bank_name || '';
                    document.getElementById('loan-acc-num').value = v.step3_data.account_number || '';
                    document.getElementById('loan-ifsc').value = v.step3_data.ifsc_code || '';
                }
            }
            
            if(v.step4_completed) { 
                document.querySelector('#step-4').classList.add('completed');
                stepToShow = 5;
                // Auto-fill Step 4 inputs
                if(v.step4_data) {
                    document.getElementById('loan-salary').value = v.step4_data.monthly_income || '';
                    document.getElementById('loan-occupation').value = v.step4_data.occupation || 'salaried';
                    document.getElementById('loan-company-name').value = v.step4_data.company_name || '';
                }
            }
            
            if(v.step5_completed) { 
                document.querySelector('#step-5').classList.add('completed');
                
                document.getElementById('loan-wizard-header').classList.add('field-hidden');
                showView('view-calculator');
                updateCalc();
                return;
            }
            
            const finalStep = targetStep > 0 ? targetStep : stepToShow;

            setStep(finalStep); 
            showView('view-verification');
        }
        
        async function acceptOffer() {
            if(!document.getElementById('agree-chk').checked) return alert("Accept T&C first");
            const sig = document.getElementById('signature').value;
            if(!sig) return alert("Digital Signature required (Type your full name)");

            const updates = {};
            // STATUS CHANGE: User accepts, sets to 'accepted' which is now the Disbursal Review state for Admin.
            updates['loan_requests/'+currentLoanId+'/status'] = 'accepted';
            updates['loan_requests/'+currentLoanId+'/signature'] = sig;
            // User app status is also updated
            updates['users/'+currentUser.uid+'/loan_app/status'] = 'accepted';
            updates['users/'+currentUser.uid+'/loan_app/accepted_at'] = Date.now();

            db.ref().update(updates).then(() => {
                alert("Loan Agreement Signed and Offer Accepted! Funds are now pending Admin review for disbursal.");
                checkLoanStep(); 
            });
        }
        
        // ------------------ FILE UPLOAD & STEP SAVE LOGIC (‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§î‡§∞ ‡§∏‡§π‡•Ä) ------------------

        async function uploadFile(fileInputId, fileBlob) {
            let file;
            let fileInput;
            let fileName;
            let isBlob = false;

            if (fileBlob) {
                file = fileBlob;
                fileName = file.name || 'selfie.jpeg'; // Use a default name for blobs
                isBlob = true;
            } else {
                fileInput = document.getElementById(fileInputId);
                file = fileInput.files[0];
                fileName = file.name;
            }

            if (!file || file.size === 0) return { url: null, error: "No file selected or file is empty." };
            
            let formData = new FormData();
            formData.append('file', file, fileName);

            const spanElement = isBlob ? document.getElementById('selfie-status') : fileInput.parentNode.querySelector('span');
            
            const originalText = spanElement.dataset.originalText || spanElement.innerText;
            if(!isBlob) spanElement.dataset.originalText = originalText;


            try {
                spanElement.innerText = 'Uploading...';
                spanElement.style.color = 'var(--warning)';

                // üéØ Worker Endpoint ‡§™‡§∞ POST Request
                const res = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Cloudflare Upload Failed: HTTP ${res.status} - ${errorText.substring(0, 100)}`);
                }
                
                const data = await res.json();
                
                // Worker response check: { ok: true, key: filename, publicURL }
                if (data.publicURL) {
                    spanElement.innerText = isBlob ? 'Selfie Uploaded!' : 'Uploaded!'; 
                    spanElement.style.color = 'var(--success)';
                    return { url: data.publicURL, error: null };
                } else {
                    throw new Error("Worker did not return a valid publicURL in response: " + JSON.stringify(data));
                }

            } catch(e) {
                console.error("Cloudflare Image upload failed:", e);
                spanElement.innerText = originalText; // Revert text on failure
                spanElement.style.color = 'var(--danger)';
                // Return original file name for debugging if needed, but error message is key
                return { url: "UPLOAD_FAILED_PLACEHOLDER", error: e.message }; 
            }
        }
        // Helper function to handle failed uploads and revert button state
        function handleUploadFail(btn, originalBtnText, msg) {
            btn.disabled = false;
            btn.innerText = originalBtnText;
            alert(msg);
        }

        async function saveStep(stepNum) {
            const uid = currentUser.uid;
            let data = {};
            let isComplete = false;
            let nextStep = stepNum + 1;

            const btn = document.querySelector(`#form-step-${stepNum} .btn`);
            const originalBtnText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Saving... Please Wait';
            
            const fail = (msg) => {
                handleUploadFail(btn, originalBtnText, msg);
                return false; // Return false to stop execution
            }
            
            const success = () => {
                btn.disabled = false;
                btn.innerText = originalBtnText;
            }


            if(stepNum === 1) {
                const email = document.getElementById('loan-email').value;
                const dob = document.getElementById('loan-dob').value;
                const fname = document.getElementById('loan-fname').value;
                if(!email || !dob || !fname) { return fail("Step 1: Fill all fields."); }
                data = { email, dob, fname, saved_at: Date.now() };
                isComplete = true;
            }
            else if(stepNum === 2) {
                const panNum = document.getElementById('loan-pan').value.toUpperCase().trim();
                const aadhaarF_file = document.getElementById('file-aadhaar-f').files[0];
                const aadhaarB_file = document.getElementById('file-aadhaar-b').files[0];
                const panFile_file = document.getElementById('file-pan').files[0];
                const selfieUrl = document.getElementById('file-selfie-url').value; // NEW: Get selfie URL
                
                if(!panNum || panNum.length !== 10) { return fail("Step 2: Enter valid 10-digit PAN Number."); }
                if(!aadhaarF_file || !aadhaarB_file || !panFile_file) { return fail("Step 2: Upload all three documents (Aadhaar Front/Back, PAN File)."); }
                if(!selfieUrl) { return fail("Step 2: Mandatory Liveness Check Selfie is missing. Please take a photo."); } // NEW CHECK
                
                // --- UPLOAD LOGIC ---
                btn.innerText = 'Uploading documents (1/3)...';
                const result1 = await uploadFile('file-aadhaar-f');
                if(result1.error) { return fail("Aadhaar Front upload failed: " + result1.error); }
                
                btn.innerText = 'Uploading documents (2/3)...';
                const result2 = await uploadFile('file-aadhaar-b');
                if(result2.error) { return fail("Aadhaar Back upload failed: " + result2.error); }

                btn.innerText = 'Uploading documents (3/3)...';
                const result3 = await uploadFile('file-pan');
                if(result3.error) { return fail("PAN File upload failed: " + result3.error); }
                // --- UPLOAD LOGIC END ---

                data = { 
                    pan: panNum, 
                    aadhaar_front_url: result1.url, 
                    aadhaar_back_url: result2.url, 
                    pan_img_url: result3.url,
                    selfie_url: selfieUrl, // NEW: Save selfie URL
                    saved_at: Date.now() 
                };
                isComplete = true;
            }
            else if(stepNum === 3) {
                const bank = document.getElementById('loan-bank-name').value;
                const acc = document.getElementById('loan-acc-num').value;
                const ifsc = document.getElementById('loan-ifsc').value;
                const passbookFile = document.getElementById('file-passbook').files[0];
                
                // NEW: Bank details are mandatory now
                if(!bank || !acc || !ifsc) { return fail("Step 3: Fill all bank details."); }
                if(!passbookFile) { return fail("Step 3: Uploading Passbook/Cheque is mandatory."); }
                
                // --- UPLOAD LOGIC ---
                btn.innerText = 'Uploading document...';
                const result = await uploadFile('file-passbook');
                if(result.error) { return fail("Passbook/Cheque upload failed: " + result.error); }
                // --- UPLOAD LOGIC END ---

                data = { bank_name: bank, account_number: acc, ifsc_code: ifsc, passbook_url: result.url, saved_at: Date.now() };
                isComplete = true;
            }
            else if(stepNum === 4) {
                const salary = document.getElementById('loan-salary').value;
                const occ = document.getElementById('loan-occupation').value;
                const companyName = document.getElementById('loan-company-name').value;
                const salaryFile = document.getElementById('file-salary').files[0];
                const fileIsOptional = (occ === 'business' || occ === 'student'); // Only optional for these
                
                if(!salary || !occ) { return fail("Step 4: Enter occupation and monthly income."); }
                
                let salarySlipUrl = null;
                if(salaryFile) {
                    // --- UPLOAD LOGIC ---
                    btn.innerText = 'Uploading document...';
                    const result = await uploadFile('file-salary');
                    if(result.error) { return fail("Salary Slip upload failed: " + result.error); }
                    salarySlipUrl = result.url;
                    // --- UPLOAD LOGIC END ---
                } else if (!fileIsOptional) {
                    // If Salaried and file is missing, warn the user but let them proceed (as per original logic where it wasn't mandatory)
                    alert("Warning: For salaried employees, uploading the Salary Slip is highly recommended for faster approval.");
                }

                data = { monthly_income: salary, occupation: occ, company_name: companyName, salary_slip_url: salarySlipUrl, saved_at: Date.now() };
                isComplete = true;
            }
            else if(stepNum === 5) {
                const addr = document.getElementById('loan-addr-perm').value;
                const curr = document.getElementById('loan-addr-curr').value;
                if(!addr || !curr) { return fail("Step 5: Enter both permanent and current addresses."); }
                
                data = { permanent_address: addr, current_address: curr, saved_at: Date.now() };
                isComplete = true;
                nextStep = 0; // Moves to calculator view
            }

            if(isComplete) {
                try {
                    await db.ref(`users/${uid}/loan_verification/step${stepNum}_data`).set(data);
                    await db.ref(`users/${uid}/loan_verification/step${stepNum}_completed`).set(true);
                    success();
                    checkLoanStep(nextStep); 
                } catch (error) {
                    fail("Error saving data to Firebase: " + error.message);
                }
            }
        }


        function updateCalc() {
            const amt = parseInt(document.getElementById('calc-amt').value);
            const tenure = parseInt(document.getElementById('calc-tenure').value);
            
            // üéØ LOGIC: Approved amount is the total repayment amount
            const total = amt; 
            const emi = total / tenure;
            const roi = 0; 

            document.getElementById('calc-amt-display').innerText = amt.toLocaleString();
            document.getElementById('calc-tenure-display').innerText = tenure;
            document.getElementById('calc-emi-display').innerText = '‚Çπ' + Math.round(emi).toLocaleString();
            document.getElementById('calc-total-display').innerText = '‚Çπ' + Math.round(total).toLocaleString();
            document.querySelector('.loan-detail-row:first-child span:last-child').innerText = roi + '% / month';
        }

        async function submitLoanApplication() {
            const btn = document.querySelector('#view-calculator .btn');
            btn.disabled = true;
            btn.innerText = 'Submitting...';
            
            // NEW: Block Check for Late Payers
            if (userDataCache.loan_blocked_until && userDataCache.loan_blocked_until > Date.now()) {
                const blockedUntilDate = new Date(userDataCache.loan_blocked_until).toLocaleDateString();
                alert(`You are blocked from re-applying until ${blockedUntilDate} due to late payments.`);
                btn.disabled = false;
                btn.innerText = 'Apply for Loan';
                checkLoanStep(); // Re-route to blocked view
                return;
            }


            const amt = document.getElementById('calc-amt').value;
            const tenure = document.getElementById('calc-tenure').value;
            const lid = 'L' + Date.now();

            const vSnap = await db.ref(`users/${currentUser.uid}/loan_verification`).once('value');
            const v = vSnap.val();

            if(!v || !v.step5_completed) { 
                btn.disabled = false; btn.innerText = 'Apply for Loan';
                return alert("Error: All 5 verification steps must be completed before applying.");
            }
            
            // üéØ NEW: DUPLICATE CHECK LOGIC
            const currentPan = v.step2_data.pan;
            const currentAcc = v.step3_data.account_number;
            const currentBank = v.step3_data.bank_name;
            const currentEmail = v.step1_data.email;
            
            // Check for duplicate PAN/Account/Email in other users' data
            const allUsersSnap = await db.ref('users').once('value');
            const allUsers = allUsersSnap.val();
            let isDuplicate = false;

            for (const uid in allUsers) {
                if (uid === currentUser.uid) continue; // Skip current user
                const otherUser = allUsers[uid];
                const otherV = (otherUser.loan_verification) || {};

                if (otherV.step2_data && otherV.step2_data.pan === currentPan) {
                    isDuplicate = true; break;
                }
                if (otherV.step3_data && otherV.step3_data.account_number === currentAcc && otherV.step3_data.bank_name === currentBank) {
                    isDuplicate = true; break;
                }
                if (otherUser.email === currentEmail) {
                    isDuplicate = true; break;
                }
            }

            if (isDuplicate) {
                btn.disabled = false; btn.innerText = 'Apply for Loan';
                return alert("Application Blocked: Duplicate PAN, Bank Account, or Email ID found with another user's profile. Only one application per person is allowed.");
            }
            // üéØ END DUPLICATE CHECK

            const monthlyEMI = Math.round(parseInt(amt) / parseInt(tenure));

            const payload = {
                id: lid,
                user_id: currentUser.uid,
                mobile: userDataCache.mobile, 
                amount_req: amt,
                tenure_req: tenure,
                status: 'pending',
                created_at: Date.now(),
                approved_amount: parseInt(amt), 
                approved_tenure: parseInt(tenure),
                processing_fee: 0, 
                net_disbursal: parseInt(amt),
                emi_amount: monthlyEMI,
                total_repayment: parseInt(amt),
                verification_data: {
                    basic: v.step1_data,
                    identity: v.step2_data,
                    bank: v.step3_data,
                    work: v.step4_data,
                    address: v.step5_data
                },
                emis: {} 
            };

            for(let i = 1; i <= parseInt(tenure); i++) {
                const dueDate = new Date();
                dueDate.setMonth(dueDate.getMonth() + i);
                dueDate.setDate(5); 
                
                payload.emis['emi_' + i] = {
                    id: 'emi_' + i,
                    num: i,
                    amount: monthlyEMI,
                    due_date: dueDate.getTime(),
                    status: 'pending' 
                };
            }


            try {
                await db.ref('loan_requests/'+lid).set(payload);
                await db.ref('users/'+currentUser.uid+'/loan_app').set({loan_id: lid, status: 'pending', applied_at: Date.now()});

                alert("Application Submitted! Admin has received your documents and request.");
                checkLoanStep();
            } catch (error) {
                alert("Submission failed: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Apply for Loan';
            }
        }

        function listenForLoanStatus() {
            if(isGuest) return;
            // Listen for any change to the loan_app object, which triggers a UI refresh
            db.ref('users/'+currentUser.uid+'/loan_app').on('value', snap => {
                const val = snap.val();
                if(val) { 
                    checkLoanStep(); 
                }
            });
        }

        async function loadOfferData(lid) {
            const snap = await db.ref('loan_requests/'+lid).once('value');
            const data = snap.val();
            
            currentLoanId = lid;
            
            const amt = data.approved_amount || data.amount_req; 
            const tenure = data.approved_tenure || data.tenure_req;
            const fee = data.processing_fee || 0;
            const net = data.net_disbursal || amt;
            const roi = 0;

            document.getElementById('offer-amt').innerText = parseInt(net).toLocaleString(); 
            document.getElementById('offer-tenure').innerText = tenure;
            document.getElementById('offer-roi').innerText = roi;
            document.getElementById('offer-fee').innerText = fee;
            document.getElementById('offer-total').innerText = parseInt(amt).toLocaleString(); 
        }
        
        async function loadDisbursementData(lid) {
            const snap = await db.ref('loan_requests/'+lid).once('value');
            const data = snap.val();
            const net = data.net_disbursal || 0;
            document.getElementById('disburse-amt').innerText = parseInt(net).toLocaleString();
        }
        
        function rejectOffer() {
            if(confirm("Are you sure you want to reject this loan offer?")) {
                db.ref('users/'+currentUser.uid+'/loan_app/status').set('rejected_by_user');
                db.ref('loan_requests/'+currentLoanId+'/status').set('rejected_by_user');
                alert("Loan offer rejected. You can re-apply.");
                checkLoanStep(); 
            }
        }
        
        // NEW: Load Closed Loan History
        async function loadClosedLoanHistory() {
            if (isGuest) return;
            const historyDiv = document.getElementById('closed-loan-history');
            historyDiv.innerHTML = '<p class="text-center small-muted">Loading loan history...</p>';
            
            const snapshot = await db.ref('loan_requests')
                .orderByChild('user_id')
                .equalTo(currentUser.uid)
                .once('value');
            
            const allLoans = snapshot.val() || {};
            const closedLoans = Object.values(allLoans).filter(loan => loan.status === 'closed');

            if (closedLoans.length === 0) {
                historyDiv.innerHTML = '<p class="text-center small-muted">No closed loans found.</p>';
                return;
            }
            
            historyDiv.innerHTML = ''; // Clear loading message

            closedLoans.sort((a, b) => b.closed_at - a.closed_at); // Sort by newest closed first

            closedLoans.forEach(loan => {
                const closedAt = new Date(loan.closed_at || loan.created_at).toLocaleDateString();
                const onTimeBadge = loan.payment_on_time === true ? 
                    `<span class="badge bg-success"><i class="ri-check-line"></i> PAID ON TIME</span>` : 
                    `<span class="badge bg-danger"><i class="ri-close-line"></i> LATE PAYMENTS</span>`;

                const itemHtml = `
                    <div class="card" style="padding: 10px; margin-bottom: 10px;">
                        <div class="flex-between">
                            <div style="font-size: 14px; font-weight: 600;">Loan ID: ${loan.id}</div>
                            ${onTimeBadge}
                        </div>
                        <div style="font-size: 12px; margin-top: 5px;">
                            Amount: **‚Çπ${(loan.total_repayment || loan.approved_amount).toLocaleString()}**
                            <br>Closed on: ${closedAt}
                        </div>
                    </div>
                `;
                historyDiv.insertAdjacentHTML('beforeend', itemHtml);
            });
        }


        function loadActiveLoanData(lid) {
            currentLoanId = lid;
            
            db.ref('loan_requests/'+lid).on('value', snap => {
                const data = snap.val();
                if (!data) return; 
                
                const emis = data.emis || {};
                const totalRepayment = data.total_repayment ? parseInt(data.total_repayment) : 0; 

                let totalPaid = 0;
                let nextEmi = null;

                const listDiv = document.getElementById('emi-list');
                listDiv.innerHTML = ''; 

                const sortedEmis = Object.values(emis).sort((a,b) => a.num - b.num);
                
                let calculatedTotalRepayment = 0;
                
                sortedEmis.forEach(e => {
                    const emiAmount = parseInt(e.amount) || 0;
                    calculatedTotalRepayment += emiAmount; 
                    
                    if(e.status === 'paid') {
                        totalPaid += emiAmount;
                    }
                    
                    const dueDate = new Date(e.due_date).getTime();
                    const isOverdue = dueDate < Date.now() && e.status === 'pending';

                    if((e.status !== 'paid') && (!nextEmi || e.num < nextEmi.num)) {
                        nextEmi = e;
                    }
                    
                    if (e.id && e.num && e.amount) {
                        const item = document.createElement('div');
                        item.className = 'card';
                        item.style.padding = '10px';
                        let statusColor = 'var(--warning)';
                        let statusBadge = e.status.toUpperCase().replace('_', ' ');
                        
                        if(e.status === 'paid') {
                            statusColor = 'var(--success)';
                            statusBadge = 'PAID';
                        } else if(e.status === 'payment_submitted') {
                            statusColor = 'var(--gold)';
                            statusBadge = 'VERIFYING UTR';
                        } else if (isOverdue) {
                            statusColor = 'var(--danger)';
                            statusBadge = 'OVERDUE (DEFAULT)';
                        } else {
                            statusColor = 'var(--warning)';
                            statusBadge = 'PENDING';
                        }

                        item.style.borderLeft = `4px solid ${statusColor}`;
                        item.innerHTML = `
                            <div class="flex-between">
                                <div>
                                    <strong>EMI ${e.num}</strong> <span style="font-size:12px; color:#666;">${new Date(e.due_date).toLocaleDateString()}</span>
                                </div>
                                <div style="text-align:right;">
                                    <strong>‚Çπ${emiAmount.toLocaleString()}</strong><br>
                                    <span class="badge ${e.status==='paid'?'bg-success':(e.status==='payment_submitted'?'bg-pending':'bg-danger')}">${statusBadge}</span>
                                </div>
                            </div>
                            ${(e.status !== 'paid' && e.status !== 'payment_submitted') ? `<button onclick="openPayModal(${emiAmount}, '${e.id}')" class="btn secondary" style="margin-top:5px; padding:4px 8px; font-size:11px;">Pay Now</button>` : ''}
                        `;
                        listDiv.appendChild(item);
                    }
                });

                const finalTotalRepayment = totalRepayment > 0 ? totalRepayment : calculatedTotalRepayment;
                
                const remaining = finalTotalRepayment - totalPaid;
                const progress = finalTotalRepayment > 0 ? (totalPaid / finalTotalRepayment) * 100 : 0;
                
                document.getElementById('track-balance').innerText = Math.round(remaining).toLocaleString();
                document.getElementById('track-paid').innerText = Math.round(totalPaid).toLocaleString();
                document.getElementById('track-total').innerText = Math.round(finalTotalRepayment).toLocaleString(); 
                document.getElementById('track-progress').style.width = progress + '%';

                if(nextEmi) {
                    const nextEmiAmount = parseInt(nextEmi.amount) || 0;
                    document.getElementById('track-next-date').innerText = new Date(nextEmi.due_date).toDateString();
                    document.getElementById('track-next-amt').innerText = nextEmiAmount.toLocaleString();
                    const diff = nextEmi.due_date - Date.now();
                    const days = Math.floor(diff / (1000*60*60*24));
                    
                    const isOverdue = nextEmi.status === 'pending' && days < 0;

                    const timerBadge = document.getElementById('track-timer').parentElement;
                    const mainCard = document.querySelector('#view-active .card:nth-child(2)');

                    if(days >= 0) {
                        document.getElementById('track-timer').innerText = days + 'd remaining';
                        mainCard.style.borderLeftColor = days < 7 ? 'var(--warning)' : 'var(--success)';
                        timerBadge.style.backgroundColor = '#ecfdf5'; 
                        timerBadge.style.color = '#065f46'; 
                    } else {
                        document.getElementById('track-timer').innerText = Math.abs(days) + 'd overdue';
                        mainCard.style.borderLeftColor = 'var(--danger)';
                        timerBadge.style.backgroundColor = '#fee2e2'; 
                        timerBadge.style.color = '#991b1b'; 
                    }
                    
                    const mainPayBtn = document.querySelector('#view-active .card:nth-child(2) button');
                    if (nextEmi.status !== 'paid' && nextEmi.status !== 'payment_submitted') {
                        mainPayBtn.onclick = () => openPayModal(nextEmiAmount, nextEmi.id);
                        mainPayBtn.style.display = 'block';
                    } else {
                        mainPayBtn.style.display = 'none';
                    }


                } else {
                    document.getElementById('track-next-date').innerText = "Loan Closed";
                    document.getElementById('track-timer').innerText = "0d 00h";
                    document.querySelector('#view-active .card:nth-child(2)').style.borderLeftColor = 'var(--success)';
                    document.querySelector('#view-active .card:nth-child(2) button').style.display = 'none';
                    document.getElementById('track-next-amt').innerText = '0';
                    
                    const timerBadge = document.getElementById('track-timer').parentElement;
                    timerBadge.style.backgroundColor = '#ecfdf5';
                    timerBadge.style.color = '#065f46';
                }
            });
        }

        let selectedEmiId = null;
        function openPayModal(amt, eid) {
            if(!amt || !eid) {
                db.ref('loan_requests/'+currentLoanId+'/emis').once('value').then(snap => {
                    const emis = snap.val() || {};
                    const nextEmi = Object.values(emis).sort((a,b) => a.num - b.num).find(e => e.status !== 'paid' && e.status !== 'payment_submitted');
                    
                    if(nextEmi) {
                         selectedEmiId = nextEmi.id;
                         document.getElementById('pay-amount-display').innerText = nextEmi.amount;
                         document.getElementById('pay-modal').style.display = 'flex';
                         document.querySelector('#pay-modal img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=${MERCHANT_UPI_ID}&pn=GoldRupi&am=${nextEmi.amount}&cu=INR`;
                    } else {
                        alert("No pending EMI found to pay.");
                    }
                });
                return;
            }
            
            selectedEmiId = eid;
            document.getElementById('pay-amount-display').innerText = amt;
            document.getElementById('pay-modal').style.display = 'flex';
            
            document.querySelector('#pay-modal img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=${MERCHANT_UPI_ID}&pn=GoldRupi&am=${amt}&cu=INR`;
        }

        function launchUPI() {
            const amt = document.getElementById('pay-amount-display').innerText;
            window.location.href = `upi://pay?pa=${MERCHANT_UPI_ID}&pn=GoldRupi&am=${amt}&tn=EMI Payment&cu=INR`;
        }

        function submitPayment() {
            const utr = document.getElementById('pay-utr').value;
            const payAmount = document.getElementById('pay-amount-display').innerText;

            if (!utr || utr.length !== 12) return alert("Invalid UTR (Must be 12 Digits)");
            if (!currentLoanId || !selectedEmiId) return alert("Error: Loan or EMI ID missing. Please reload dashboard.");

            const newPaymentReqId = 'P' + Date.now();
            
            const paymentPayload = {
                id: newPaymentReqId,
                loan_id: currentLoanId, 
                emi_id: selectedEmiId,
                user_id: currentUser.uid,
                amount: parseInt(payAmount),
                utr_number: utr,
                timestamp: Date.now(),
                status: 'verification_pending' 
            };
            
            // This set() will trigger the allowed rule for payment_requests (create new record with user_id and status: verification_pending)
            db.ref('payment_requests/' + newPaymentReqId).set(paymentPayload)
                .then(() => {
                    // This set() will trigger the allowed rule for loan_requests/$id/emis/$emi_id (update status to payment_submitted)
                    return db.ref(`loan_requests/${currentLoanId}/emis/${selectedEmiId}/status`).set('payment_submitted');
                })
                .then(() => {
                    alert("Payment Submitted! Admin will verify your UTR shortly. (You can submit up to 3 UTRs per EMI.)");
                    
                    document.getElementById('pay-modal').style.display = 'none';
                    document.getElementById('pay-utr').value = '';
                    checkLoanStep(); 
                })
                .catch(error => {
                    console.error("Payment Submission Error:", error);
                    alert("Error submitting payment: " + error.message);
                });
        }

        function requestForeclosure() {
            alert("Foreclosure Request Sent to Admin. They will contact you with the final settlement amount.");
        }

        function toggleTheme() {
            const body = document.body;
            body.setAttribute('data-theme', body.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
        }

// ------------------ NEW MANUAL PAYMENT PROOF LOGIC (‡§Ü‡§™‡§ï‡•á ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§™‡§∞) ------------------

        async function submitManualPaymentProof() {
            if(isGuest) return alert("Please Login/Sign Up to submit payment proof.");

            const utr = document.getElementById('manual-pay-utr').value.trim();
            const screenshotFile = document.getElementById('file-payscreen').files[0];
            const btn = document.getElementById('manual-pay-btn');
            const statusMsg = document.getElementById('manual-submission-message');
            const originalBtnText = btn.innerText;

            if (!utr || utr.length !== 12) {
                return alert("‡§ï‡•É‡§™‡§Ø‡§æ 12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ UTR / ‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§");
            }
            if (!screenshotFile) {
                return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§");
            }

            btn.disabled = true;
            btn.innerText = 'Uploading...';
            statusMsg.classList.add('field-hidden');

            // 1. Upload Screenshot to Cloudflare
            // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø uploadFile ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à
            const uploadResult = await uploadFile('file-payscreen');

            if (uploadResult.error) {
                btn.disabled = false;
                btn.innerText = originalBtnText;
                return alert("‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§∂‡•â‡§ü ‡§Ö‡§™‡§≤‡•ã‡§° ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ: " + uploadResult.error);
            }

            // 2. Save Submission to Firebase
            const newSubmissionId = 'MANUAL_' + Date.now();
            
            const payload = {
                id: newSubmissionId,
                userId: currentUser.uid,             // <-- FIXED: Changed from user_id to userId
                utr: utr,                          // <-- FIXED: Changed from utr_number to utr
                screenshotUrl: uploadResult.url,   // <-- FIXED: Changed from screenshot_url to screenshotUrl
                timestamp: Date.now(),
                status: 'pending_admin_review'     // Firebase rule requires 'status'
            };
            

            try {
                btn.innerText = 'Saving Data...';
                await db.ref('manual_payment_submissions/' + newSubmissionId).set(payload);

                // 3. Success Feedback
                statusMsg.style.color = 'var(--success)';
                statusMsg.innerHTML = '<i class="ri-check-line"></i> Submission Successful. We will review your payment shortly.';
                statusMsg.classList.remove('field-hidden');

                // Clear inputs for next submission
                document.getElementById('manual-pay-utr').value = '';
                document.getElementById('file-payscreen').value = '';
                // Revert file upload status span
                const fileSpan = document.getElementById('manual-file-status');
                fileSpan.innerText = fileSpan.dataset.originalText || 'Upload Payment Screenshot (JPG/PNG)';
                fileSpan.style.color = '';

            } catch (error) {
                statusMsg.style.color = 'var(--danger)';
                // Log the full error to the console for debugging
                console.error("Firebase Submission Error:", error); 
                statusMsg.innerHTML = '<i class="ri-error-warning-line"></i> Error saving submission: ' + error.message;
                statusMsg.classList.remove('field-hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = originalBtnText;
            }
        }
// ------------------ END NEW MANUAL PAYMENT PROOF LOGIC ------------------




// ------------------ NEW SELFIE/CAMERA LOGIC ------------------

        let currentStream; // To hold the media stream

        function openSelfieModal() {
            document.getElementById('selfie-modal').style.display = 'flex';
            document.getElementById('video-stream').style.display = 'block';
            document.getElementById('selfie-canvas').style.display = 'none';
            document.getElementById('snap-btn').style.display = 'block';
            document.getElementById('upload-selfie-btn').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'none';
            currentSelfieBlob = null;
            
            // Request camera access
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }) // Use front camera
                    .then(stream => {
                        currentStream = stream;
                        document.getElementById('video-stream').srcObject = stream;
                    })
                    .catch(err => {
                        alert("Camera access denied or failed: " + err.message);
                        console.error("Camera access failed:", err);
                        closeSelfieModal();
                    });
            } else {
                alert("Your browser does not support camera access.");
                closeSelfieModal();
            }
        }
        
        function closeSelfieModal() {
            document.getElementById('selfie-modal').style.display = 'none';
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        
        function capturePhoto() {
            const video = document.getElementById('video-stream');
            const canvas = document.getElementById('selfie-canvas');
            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match the video feed (important for quality)
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw the video frame onto the canvas (Apply mirror effect)
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            context.setTransform(1, 0, 0, 1, 0, 0); // Reset transform

            // Convert canvas image to Blob
            canvas.toBlob(blob => {
                blob.name = 'selfie_' + Date.now() + '.jpeg'; // Give the blob a name
                currentSelfieBlob = blob;
            }, 'image/jpeg', 0.9); // JPEG format, 90% quality

            // Switch UI views
            video.style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('snap-btn').style.display = 'none';
            document.getElementById('upload-selfie-btn').style.display = 'block';
            document.getElementById('retake-btn').style.display = 'block';

            // Stop the stream to free the camera
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        }
        
        function retakePhoto() {
            closeSelfieModal();
            openSelfieModal(); // Restart the process
        }
        
        async function uploadSelfieAndSave() {
            if (!currentSelfieBlob) return alert("Please take a photo first.");

            const btn = document.getElementById('upload-selfie-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ri-loader-4-line spin"></i> Uploading...';
            
            // 1. Upload Selfie Blob
            const uploadResult = await uploadFile(null, currentSelfieBlob);

            if (uploadResult.error) {
                btn.disabled = false;
                btn.innerHTML = originalText;
                return alert("Selfie upload failed: " + uploadResult.error);
            }
            
            // 2. Save URL to hidden field & Firebase
            const selfieUrl = uploadResult.url;
            document.getElementById('file-selfie-url').value = selfieUrl;
            
            try {
                // Save selfie URL to loan_verification (Step 2 Data)
                await db.ref(`users/${currentUser.uid}/loan_verification/step2_data/selfie_url`).set(selfieUrl);
                // Also update Profile DP
                await db.ref(`users/${currentUser.uid}/profile_dp_url`).set(selfieUrl);
                
                alert("Selfie uploaded and saved successfully!");
                closeSelfieModal();
                checkLoanStep(); // Refresh loan steps
            } catch (error) {
                alert("Error saving selfie URL to database: " + error.message);
                console.error("Firebase Selfie Save Error:", error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
// ------------------ END NEW SELFIE/CAMERA LOGIC ------------------

// ... (‡§Ü‡§™‡§ï‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§î‡§∞ ‡§µ‡•à‡§∞‡§ø‡§è‡§¨‡§≤ ‡§Ø‡§π‡§æ‡§Å) ...

// ------------------ NEW CHAT SUPPORT LOGIC (UPDATED) ------------------

let isChatListening = false;
let chatAttachmentFile = null;

// Function to handle the FAB toggle (Close/Open)
function openSupportChat() {
    if (isGuest) return alert("Please Login/Sign Up to access Support Chat.");
    const chatModal = document.getElementById('support-chat-modal');
    const fabIcon = document.getElementById('fab-icon');

    if (chatModal.style.display === 'flex') {
        chatModal.style.display = 'none';
        fabIcon.className = 'ri-chat-3-line';
    } else {
        chatModal.style.display = 'flex';
        fabIcon.className = 'ri-close-line'; // Change FAB icon to 'X' when open
        if (!isChatListening) {
            listenForChatMessages();
        }
        const chatBox = document.getElementById('chat-messages');
        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

function closeSupportChat() {
    document.getElementById('support-chat-modal').style.display = 'none';
    document.getElementById('fab-icon').className = 'ri-chat-3-line';
}

function formatChatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const dateStr = date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
    const timeStr = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
    return { date: dateStr, time: timeStr };
}

let lastMessageDate = null;

function appendChatMessage(message) {
    const chatBox = document.getElementById('chat-messages');
    const { date, time } = formatChatTimestamp(message.timestamp);
    const isUser = message.sender === 'user';
    const senderName = isUser ? 'You' : 'Support';
    
    // Date Separator (To show date change)
    if (date !== lastMessageDate) {
        const dateDiv = document.createElement('div');
        dateDiv.style = "text-align: center; margin: 15px 0 10px; font-size: 10px; color: #999; text-transform: uppercase;";
        dateDiv.innerText = date;
        chatBox.appendChild(dateDiv);
        lastMessageDate = date;
    }

    const div = document.createElement('div');
    div.className = 'msg-bubble ' + (isUser ? 'msg-user' : 'msg-admin');
    
    let messageContent = message.text;
    
    // Handle File Attachment
    if(message.fileUrl) {
        const fileLink = `<a href="${message.fileUrl}" target="_blank" style="color: ${isUser ? 'white' : 'var(--gold-strong)'}; text-decoration: underline;">
                            <i class="ri-file-line"></i> ${message.fileName || 'Attachment'}
                         </a>`;
        messageContent = (message.text ? message.text + '<br><br>' : '') + fileLink;
    }
    
    div.innerHTML = messageContent;

    const timeSpan = document.createElement('span');
    timeSpan.className = 'msg-time';
    timeSpan.innerHTML = `${senderName} - ${time}`;
    
    div.appendChild(timeSpan);
    chatBox.appendChild(div);
    
    // Scroll to bottom only if it's a new message
    chatBox.scrollTop = chatBox.scrollHeight;
}

function listenForChatMessages() {
    isChatListening = true;
    const chatBox = document.getElementById('chat-messages');
    
    // Clear initial messages (except loader)
    const initialAdminMsg = chatBox.querySelector('.msg-admin');
    if (initialAdminMsg) initialAdminMsg.remove();
    
    const loader = document.getElementById('older-messages-loader');
    loader.onclick = loadOlderMessages;
    loader.style.display = 'none'; 

    // Listen to new messages
    db.ref('loan_support_chat/' + currentUser.uid).limitToLast(1).on('child_added', snap => {
        const message = snap.val();
        if (!message) return;
        
        // Use setImmediate or similar for initial load handling
        setTimeout(() => {
             // To ensure older messages load only once on initial open, then new messages stream
             if (chatBox.children.length > 2) { 
                 appendChatMessage(message);
             }
        }, 10);
    });
    
    // Load last 15 messages on initial open
    loadChatMessages(15);
}

// Function to load a batch of chat messages
function loadChatMessages(limit, endAtKey = null) {
    const chatBox = document.getElementById('chat-messages');
    const loader = document.getElementById('older-messages-loader');
    loader.innerText = 'Loading...';
    loader.style.display = 'block';

    let query = db.ref('loan_support_chat/' + currentUser.uid)
                  .orderByKey()
                  .limitToLast(limit);
                  
    if (endAtKey) {
        // To get messages *before* the oldest one currently shown
        query = db.ref('loan_support_chat/' + currentUser.uid)
                  .orderByKey()
                  .endBefore(endAtKey)
                  .limitToLast(limit);
    }
    
    query.once('value')
        .then(snapshot => {
            const messages = snapshot.val();
            if (!messages) {
                loader.innerText = 'No more older messages.';
                setTimeout(() => loader.style.display = 'none', 3000);
                return;
            }

            const messageKeys = Object.keys(messages).sort();
            const oldestKey = messageKeys[0];
            
            // Collect new messages and prepend them (reverse order because of limitToLast)
            const fragment = document.createDocumentFragment();
            let newLastMessageDate = null; // Re-calculate dates for loaded batch

            messageKeys.forEach(key => {
                const message = messages[key];
                const { date, time } = formatChatTimestamp(message.timestamp);
                const isUser = message.sender === 'user';
                const senderName = isUser ? 'You' : 'Support';

                // Date Separator for PREPENDING
                if (date !== newLastMessageDate) {
                    const dateDiv = document.createElement('div');
                    dateDiv.style = "text-align: center; margin: 15px 0 10px; font-size: 10px; color: #999; text-transform: uppercase;";
                    dateDiv.innerText = date;
                    fragment.appendChild(dateDiv);
                    newLastMessageDate = date;
                }
                
                const div = document.createElement('div');
                div.className = 'msg-bubble ' + (isUser ? 'msg-user' : 'msg-admin');
                div.dataset.key = key; // Store key for next load

                let messageContent = message.text;
                if(message.fileUrl) {
                    const fileLink = `<a href="${message.fileUrl}" target="_blank" style="color: ${isUser ? 'white' : 'var(--gold-strong)'}; text-decoration: underline;">
                                        <i class="ri-file-line"></i> ${message.fileName || 'Attachment'}
                                     </a>`;
                    messageContent = (message.text ? message.text + '<br><br>' : '') + fileLink;
                }
                div.innerHTML = messageContent;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'msg-time';
                timeSpan.innerHTML = `${senderName} - ${time}`;
                div.appendChild(timeSpan);
                fragment.appendChild(div);
            });
            
            // Prepend the new messages/fragment after the loader
            chatBox.insertBefore(fragment, loader.nextSibling);

            // Update loader's key for the next batch
            loader.dataset.oldestKey = oldestKey;
            loader.innerText = 'Click to load older messages...';
            loader.style.display = 'block';

            // If initial load, scroll to bottom. If older load, maintain position.
            if (!endAtKey) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }

        })
        .catch(error => {
            loader.innerText = 'Error loading messages.';
            console.error("Firebase Chat Load Error:", error);
        });
}

function loadOlderMessages() {
    const loader = document.getElementById('older-messages-loader');
    const oldestKey = loader.dataset.oldestKey;
    if (oldestKey) {
        loadChatMessages(15, oldestKey);
    } else {
        loader.innerText = 'Loading initial messages...';
        loadChatMessages(15);
    }
}


function showAttachmentPreview() {
    const fileInput = document.getElementById('chat-attachment-file');
    const previewArea = document.getElementById('attachment-preview-area');
    
    if (fileInput.files.length > 0) {
        chatAttachmentFile = fileInput.files[0];
        previewArea.innerHTML = `
            <div class="attachment-preview">
                <span><i class="ri-file-text-line"></i> ${chatAttachmentFile.name.substring(0, 30)}${chatAttachmentFile.name.length > 30 ? '...' : ''}</span>
                <button onclick="clearAttachment()">&times;</button>
            </div>
        `;
        previewArea.classList.remove('field-hidden');
    } else {
        clearAttachment();
    }
}

function clearAttachment() {
    document.getElementById('chat-attachment-file').value = ''; 
    document.getElementById('attachment-preview-area').innerHTML = '';
    document.getElementById('attachment-preview-area').classList.add('field-hidden');
    chatAttachmentFile = null;
}

// Custom file upload for chat
async function uploadChatFile() {
    if (!chatAttachmentFile) return { url: null, error: "No file attached." };

    const btn = document.getElementById('send-chat-btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>';

    const formData = new FormData();
    formData.append('file', chatAttachmentFile, chatAttachmentFile.name);

    try {
        const res = await fetch(CLOUDFLARE_WORKER_URL, {
            method: 'POST',
            body: formData,
        });
        const data = await res.json();
        
        if (data.publicURL) {
            return { url: data.publicURL, error: null };
        } else {
            throw new Error(data.error || "Upload failed: Invalid response.");
        }
    } catch(e) {
        console.error("Chat File upload failed:", e);
        return { url: null, error: e.message };
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}


async function sendChatMessage() {
    const input = document.getElementById('chat-message-input');
    let text = input.value.trim();
    const isAttachment = !!chatAttachmentFile;
    
    if (!text && !isAttachment) return;
    
    const btn = document.getElementById('send-chat-btn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>';

    let fileUrl = null;
    let fileName = null;

    if (isAttachment) {
        const uploadResult = await uploadChatFile();
        if (uploadResult.error) {
            alert("File Upload Failed: " + uploadResult.error);
            btn.disabled = false;
            btn.innerHTML = originalText;
            return;
        }
        fileUrl = uploadResult.url;
        fileName = chatAttachmentFile.name;
    }

    const messagePayload = {
        text: text,
        sender: 'user', 
        timestamp: Date.now(),
        user_id: currentUser.uid,
        fileUrl: fileUrl,
        fileName: fileName
    };
    
    // Clear inputs immediately after gathering payload
    input.value = ''; 
    clearAttachment();

    db.ref('loan_support_chat/' + currentUser.uid).push(messagePayload)
        .then(() => {
            // Success: UI already updated by listener, just restore button
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            // Manually append the message immediately for smooth UX, even before Firebase listener catches up
            appendChatMessage(messagePayload);
        })
        .catch(error => {
            alert("Failed to send message: " + error.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
}

// ------------------ END NEW CHAT SUPPORT LOGIC ------------------

// ... (‡§Ö‡§®‡•ç‡§Ø ‡§∏‡§≠‡•Ä ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§î‡§∞ ‡§ï‡•ç‡§≤‡•ã‡§ú‡§ø‡§Ç‡§ó ‡§ü‡•à‡§ó) ...




    </script>
</body>
</html>



