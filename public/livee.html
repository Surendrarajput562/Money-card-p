<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Streaming App</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=BAADaL9tcLlRLdHvYLi4BBA8PSLVY31pLHE7hyR08DcMzdre2unAWtxgjFemGYqd0gnV5cyCaXmCYK_sU0&components=hosted-buttons&disable-funding=venmo&currency=USD"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
      /* --- CSS Styles --- */
      :root { --bg: #0f0f13; --card: #1a1a24; --primary: #ff0055; --text: #ffffff; --sub: #888; }
      body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; }
      .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; }
      .active { display: flex; }
      .auth-box { margin: auto; padding: 20px; background: var(--card); border-radius: 12px; width: 80%; max-width: 400px; text-align: center; }
      input { width: 90%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; }
      .btn { background: var(--primary); color: #fff; border: none; padding: 12px 20px; border-radius: 30px; font-weight: bold; width: 100%; cursor: pointer; }
      .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10; }
      .tabs { display: flex; gap: 15px; font-size: 14px; font-weight: bold; text-transform: lowercase; color: var(--sub); }
      .tab-active { color: #fff; border-bottom: 2px solid var(--primary); }
      .feed-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; overflow-y: auto; flex: 1; }
      .room-card { 
        background: var(--card); border-radius: 10px; height: 200px; position: relative; overflow: hidden; background-size: cover; 
        background-position: center; cursor: pointer;
      }
      .room-card:before { content: attr(data-title); position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; background: rgba(0,0,0,0.7); color: #fff; font-weight: bold; font-size: 14px; z-index: 2; }
      .live-badge { position: absolute; top: 10px; left: 10px; background: var(--primary); padding: 2px 8px; font-size: 10px; border-radius: 4px; z-index: 2; }
      .player-container { flex: 1; position: relative; background: #000; }
      video { width: 100%; height: 100%; object-fit: cover; }
      .overlay-ui { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; box-sizing: border-box; }
      .chat-area { height: 150px; overflow-y: scroll; pointer-events: auto; margin-bottom: 60px; mask-image: linear-gradient(to bottom, transparent, black 20%); }
      .chat-msg, .gift-msg { font-size: 13px; margin-bottom: 5px; text-shadow: 1px 1px 2px #000; }
      .chat-msg b { color: #ffd700; }
      .gift-msg { color: #ff9900; font-weight: bold; } 
      .controls { position: absolute; bottom: 10px; width: 90%; display: flex; gap: 10px; pointer-events: auto; }
      .gift-btn { background: linear-gradient(45deg, #ff9900, #ff0055); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid #fff; box-shadow: 0 0 10px var(--primary); }
      .menu-list { overflow-y: auto; padding: 20px; }
      .menu-item { padding: 15px 0; border-bottom: 1px solid #333; font-size: 14px; color: #ddd; display: flex; justify-content: space-between; text-transform: lowercase; }
      .balance-card { background: linear-gradient(135deg, #222, #333); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
      .nav { height: 60px; background: #000; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #222; z-index: 100; }
      .nav-icon { font-size: 24px; color: #555; cursor: pointer; }
      .nav-icon.active-icon { color: #fff; }
      .go-live-btn { width: 50px; height: 50px; background: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #000; font-size: 28px; margin-top: -20px; border: 4px solid #000; }
      #sticker-panel { 
        position: absolute; bottom: 70px; right: 10px; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); padding: 10px; border-radius: 8px; max-height: 200px; 
        overflow-y: auto; display: none; flex-wrap: wrap; gap: 10px; justify-content: center; pointer-events: auto; width: 250px;
      }
      .sticker-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px; border-radius: 5px; border: 1px solid transparent; width: 55px; }
      .sticker-item:hover { border-color: var(--primary); }
      .sticker-item img { width: 40px; height: 40px; }
      .sticker-item span { font-size: 10px; color: #ffd700; margin-top: 2px; }
      .gift-animation-container { position: absolute; top: 100px; right: 10px; width: 200px; z-index: 10; }
      .gift-pop { background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border-radius: 20px; margin-bottom: 10px; display: flex; align-items: center; animation: slideIn 0.3s ease-out; }
      .gift-pop img { width: 30px; height: 30px; margin-right: 5px; }
      .gift-pop .combo { font-size: 20px; font-weight: bold; color: var(--primary); margin-left: 5px; }
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

  <div id="auth-screen" class="screen active">
    <div class="auth-box">
      <h2 style="color:var(--primary)">live app</h2>
      <input type="text" id="username" placeholder="display name">
      <input type="email" id="email" placeholder="email">
      <input type="password" id="password" placeholder="password">
      <button class="btn" onclick="handleAuth()">login / signup</button>
      <p style="font-size:12px; color:#666; margin-top:10px;">if account not exists, it will be created.</p>
    </div>
  </div>

  <div id="home-screen" class="screen">
    <div class="header">
      <div class="tabs">
        <div class="tab-active" onclick="changeTab(this, 'for you')">for you</div>
        <div onclick="changeTab(this, 'following')">following</div>
        <div onclick="changeTab(this, 'explore')">explore</div>
        <div onclick="changeTab(this, 'coins')">coins</div>
      </div>
      <div id="my-diamonds" style="font-size:12px; background:#222; padding:5px 10px; border-radius:20px;">üíé 0</div>
    </div>
    
    <div class="feed-grid" id="room-list"></div>

    <div class="nav">
      <div class="nav-icon active-icon" onclick="showScreen('home-screen'); loadLiveRooms();">üè†</div>
      <div class="nav-icon">üîç</div>
      <div class="go-live-btn" onclick="goLivePrompt()">+</div> <div class="nav-icon">üí¨</div>
      <div class="nav-icon" onclick="showScreen('profile-screen')">üë§</div>
    </div>
  </div>

  <div id="room-screen" class="screen" style="background: black;">
    <div class="player-container">
      <video id="video-player" autoplay playsinline muted></video>
      
      <div id="tap-to-play-overlay" 
           style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; justify-content: center; align-items: center; cursor: pointer;"
           onclick="retryUnmutedPlayback()">
          <div style="background: var(--primary); padding: 15px 30px; border-radius: 30px; font-weight: bold; color: #fff; font-size: 16px;">
              TAP TO PLAY LIVE üîä
          </div>
      </div>
      <div class="gift-animation-container" id="gift-animation-area"></div>
      <div style="position:absolute; top:20px; right:20px; color:white; font-size:20px; z-index:100; pointer-events: auto;" onclick="leaveRoom()">‚úï</div>
      
      <button id="end-stream-btn" class="btn" onclick="leaveRoom(true)" 
          style="position:absolute; top:20px; left:20px; background: red; width: auto; padding: 8px 15px; font-size: 14px; z-index:100; display: none;">
          End Stream
      </button>

      <div class="overlay-ui">
        <div class="chat-area" id="chat-box"></div>
        <div id="sticker-panel"></div>
        <div class="controls">
          <input type="text" id="chat-input" placeholder="say something..." style="background:rgba(255,255,255,0.2); border:none; flex-grow: 1;">
          <button class="btn" style="width:auto; padding: 10px 15px;" onclick="sendChat()">send</button>
          <div class="gift-btn" onclick="toggleStickerPanel()">üéÅ</div>
        </div>
      </div>
      
      <div id="host-controls" style="position:absolute; top:50%; left:10%; right:10%; background:#222; padding:20px; display:none; border-radius:10px; text-align:center; z-index:101;">
        <h3>broadcasting live</h3>
        <p style="font-size:11px; color:#aaa;">Your stream is pushing directly from the browser.</p>
        <button class="btn" onclick="document.getElementById('host-controls').style.display='none'">close & monitor</button>
      </div>
    </div>
  </div>

  <div id="profile-screen" class="screen">
    <div class="header"><span>me</span> <span style="cursor:pointer;" onclick="showScreen('home-screen')">‚úï</span></div>
    <div style="padding:20px; text-align:center;">
      <div style="width:80px; height:80px; background:#333; border-radius:50%; margin:0 auto;"></div>
      <h2 id="profile-name">User Name</h2>
      <p id="profile-uid" style="font-size:10px; color:#555;"></p>
    </div>

    <div class="menu-list">
      <div class="balance-card">
        <h3>wallet</h3>
        <h1 id="wallet-balance">üíé 0 | ü™ô 0</h1>
        <div id="paypal-container-LDLU6UV2GPRQE" style="margin-top: 15px;">
           </div> 
      </div>
      <div class="menu-item">agency program <span>></span></div>
      <div class="menu-item">vip loyalty <span>></span></div>
      <div class="menu-item">myvip store <span>></span></div>
      <div class="menu-item">live cards auction <span>></span></div>
      <div class="menu-item">settings <span>></span></div>
      <div class="menu-item">account <span>></span></div>
      <div class="menu-item">payments <span>></span></div>
      <div class="menu-item">notifications <span>></span></div>
      <div class="menu-item">privacy & terms <span>></span></div>
      <div class="menu-item">general <span>></span></div>
      <div class="menu-item">dark theme <span>‚óè</span></div>
      <div style="margin-top:20px; color:var(--primary); font-size:12px; font-weight:bold;">creator tools</div>
      <div class="menu-item">get money <span>></span></div>
      <div class="menu-item">statistics <span>></span></div>
      <div class="menu-item">my fans <span>></span></div>
      <div style="margin-top:20px; color:var(--sub); font-size:12px;">help center</div>
      <div class="menu-item">legal information <span>></span></div>
      <div class="menu-item">customer support <span>></span></div>
      <div class="menu-item" onclick="firebase.auth().signOut()">logout</div>
    </div>
  </div>

  <div id="live-prompt-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 200;">
        <div style="background: var(--card); padding: 30px; border-radius: 12px; width: 90%; max-width: 400px;">
            <h3 style="color:var(--primary); margin-top:0;">Start Live Stream</h3>
            <input type="text" id="live-title-input" placeholder="Enter Room Title" style="width: 100%; margin-bottom: 15px;">
            <label style="display: block; color: #fff; margin-bottom: 5px; font-size: 14px; text-align: left;">Upload Cover Image:</label>
            <input type="file" id="cover-image-input" accept="image/*" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #333;">
            <button class="btn" style="background: green;" onclick="goLive()">Start Streaming</button> <button class="btn" style="background: #555; margin-top: 10px;" onclick="document.getElementById('live-prompt-modal').style.display='none'">Cancel</button>
        </div>
    </div>


  <script>
    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
      authDomain: "smbrand-4543a.firebaseapp.com",
      databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
      projectId: "smbrand-4543a",
      storageBucket: "smbrand-4543a.firebasestorage.app",
      messagingSenderId: "720775550032",
      appId: "1:720775550032:web:0622548a007597778bad55",
      measurementId: "G-3LS5W6F8QW"
    };
    firebase.initializeApp(firebaseConfig);
    
    const auth = firebase.auth();
    const db = firebase.database();
    
    const WORKER_URL = "https://dawn-heart-dc55.rajputsurendra562.workers.dev";
    const UPLOADER_WORKER_URL = "https://ebookandapk-uploder.rajputsurendra562.workers.dev/"; 
    
    let currentUser = null;
    let currentRoomId = null;
    let hls = null;
    let localStream = null;
    let publisherConnection = null; 
    let stickersData = {}; 
    let chatListener = null;
    let giftListener = null;
    
    let hlsRetryCount = 0;
    const MAX_HLS_RETRIES = 5;
    
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- HOME FEED & CHAT/GIFT LOGIC ---
    function createRoomCard(roomId, data) {
        const card = document.createElement('div');
        card.className = 'room-card';
        card.setAttribute('data-title', data.title);
        const thumbnailUrl = data.thumbnailUrl || `https://picsum.photos/300/400?random=${roomId.replace('room-', '')}`;
        card.style.backgroundImage = `url('${thumbnailUrl}')`; 
        card.onclick = () => {
            enterRoom(roomId, false, data);
        };
        card.innerHTML = `
            <div class="live-badge">LIVE</div>
            <p style="position:absolute; top:10px; right:10px; font-size:12px; background:rgba(0,0,0,0.5); padding:2px 8px; border-radius:4px; z-index:2;">${data.hostName || 'Streamer'}</p>
        `;
        return card;
    }

    async function loadLiveRooms() {
        const roomListElement = document.getElementById('room-list');
        roomListElement.innerHTML = '';
        
        const snapshot = await db.ref('liveRooms').orderByChild('status').equalTo('live').once('value');
        
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const roomId = childSnapshot.key;
                const roomData = childSnapshot.val();
                
                if (currentUser && roomId !== 'room-' + currentUser.uid) {
                    const card = createRoomCard(roomId, roomData);
                    roomListElement.appendChild(card);
                }
            });
        }
        
        if (roomListElement.children.length === 0) {
            roomListElement.innerHTML = '<p style="padding: 20px; color: var(--sub);">No live streams available right now.</p>';
        }
    }
    
    function addMessageToChat(message, type) {
        const chatBox = document.getElementById('chat-box');
        const msgDiv = document.createElement('div');
        msgDiv.className = type === 'chat' ? 'chat-msg' : 'gift-msg';

        if (type === 'chat') {
            msgDiv.innerHTML = `<b>${message.userName || 'User'}:</b> ${message.text}`;
        } else { 
            const stickerName = message.name || 'Gift';
            msgDiv.innerHTML = `üéâ <b>${message.fromName || 'User'}</b> sent a ${stickerName}! (${message.value} üíé)`;
        }
        
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function setupRoomListeners(roomId) {
        if (chatListener) db.ref('chats/' + roomId).off('child_added', chatListener);
        if (giftListener) db.ref('gifts/' + roomId).off('child_added', giftListener);

        chatListener = db.ref('chats/' + roomId).limitToLast(50).on('child_added', snapshot => {
            addMessageToChat(snapshot.val(), 'chat');
        });

        giftListener = db.ref('gifts/' + roomId).limitToLast(10).on('child_added', snapshot => {
            const giftData = snapshot.val();
            // animateGift(giftData); // Assuming this is defined elsewhere or not critical for core function
            addMessageToChat(giftData, 'gift');
        });
    }

    function removeRoomListeners(roomId) {
        if (chatListener) db.ref('chats/' + roomId).off('child_added', chatListener);
        if (giftListener) db.ref('gifts/' + roomId).off('child_added', giftListener);
        chatListener = null;
        giftListener = null;
    }

    function sendChat() { 
        const chatInput = document.getElementById('chat-input');
        const text = chatInput.value.trim();
        
        if (!text || !currentRoomId || !currentUser) return;

        db.ref(`chats/${currentRoomId}`).push({
            userId: currentUser.uid,
            userName: document.getElementById('profile-name').innerText,
            text: text,
            time: firebase.database.ServerValue.TIMESTAMP
        });
        
        chatInput.value = '';
    }

    function updateWalletDisplay(diamonds) {
        document.getElementById('my-diamonds').innerText = `üíé ${diamonds || 0}`;
        const currentCoins = document.getElementById('wallet-balance').innerText.split('|')[1];
        document.getElementById('wallet-balance').innerText = `üíé ${diamonds || 0} | ${currentCoins ? currentCoins.trim() : 'ü™ô 0'}`;
    }

    // --- WebRTC Publish Logic (CRLF fix remains) --- 
    async function startWebRTCPublishing(stream, publishUrl) {
        const peerConnection = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });
        
        stream.getTracks().forEach(track => {
            peerConnection.addTrack(track, stream);
        });
        
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        await new Promise(resolve => {
            let timeout = setTimeout(() => {
                resolve();
            }, 3000); 

            peerConnection.onicecandidate = ({ candidate }) => {
                if (!candidate) { 
                    clearTimeout(timeout);
                    resolve();
                }
            };
        });
        
        let sdpToSend = peerConnection.localDescription.sdp; 
        
        if (!sdpToSend || sdpToSend.length < 50) {
            throw new Error("Local SDP Offer is too short or invalid.");
        }
        
        // ‚ö†Ô∏è CRITICAL FIX: Ensure correct CRLF formatting for Cloudflare SDP
        sdpToSend = sdpToSend.replace(/\r?\n/g, '\r\n');
        if (!sdpToSend.endsWith('\r\n')) {
            sdpToSend += '\r\n';
        }

        const raw = await fetch(publishUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/sdp' }, 
            body: sdpToSend 
        });
        
        const sdpText = await raw.text(); 
        
        if (raw.ok && sdpText) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription({ sdp: sdpText, type: 'answer' }));
            return peerConnection;
        } else {
            throw new Error(`Failed to get WebRTC Answer from Cloudflare. Status: ${raw.status}. Response: ${sdpText.substring(0, 150)}`);
        }
    }
    
    // --- STREAMING (GO LIVE) ---
    function goLivePrompt() {
        if (!currentUser) {
            alert("Login required to go live.");
            showScreen('auth-screen');
            return;
        }
        document.getElementById('live-title-input').value = '';
        document.getElementById('cover-image-input').value = '';
        document.getElementById('live-prompt-modal').style.display = 'flex';
    }

    async function goLive() {
      const title = document.getElementById('live-title-input').value.trim();
      const imageFile = document.getElementById('cover-image-input').files[0];

      if (!title) {
          alert("Room Title is required.");
          return;
      }

      document.getElementById('live-prompt-modal').style.display = 'none';
      const btn = document.querySelector('.go-live-btn');
      btn.innerText = "‚Üª";

      let finalCoverImageUrl = '';
      const userRef = db.ref('users/' + currentUser.uid);
      const userSnapshot = await userRef.once('value');
      const userData = userSnapshot.val() || {};
      const existingCoverUrl = userData.thumbnailUrl || '';

      // Image Upload/Reuse Logic
      if (imageFile) {
          try {
              const formData = new FormData();
              formData.append('file', imageFile); 
              const uploadResp = await fetch(UPLOADER_WORKER_URL, {
                  method: 'POST',
                  body: formData 
              });
              const uploadData = await uploadResp.json();
              if (uploadResp.ok && uploadData.url) {
                  finalCoverImageUrl = uploadData.url;
                  await userRef.update({ thumbnailUrl: finalCoverImageUrl }); 
              } else {
                  finalCoverImageUrl = existingCoverUrl;
              }
          } catch (e) {
              finalCoverImageUrl = existingCoverUrl;
          }
      } else if (existingCoverUrl) {
          finalCoverImageUrl = existingCoverUrl;
      }
      
      if (!finalCoverImageUrl) {
          finalCoverImageUrl = `https://picsum.photos/300/400?random=${currentUser.uid}`;
      }

      // Start Camera
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        
        const video = document.getElementById('video-player');
        video.srcObject = localStream; 
        video.muted = true; // Host view should always be muted to avoid feedback
        video.play().catch(e => console.warn("Host video play error:", e));
        
      } catch (err) {
        alert("Camera/Mic access denied. Cannot go live: " + err.message);
        btn.innerText = "+";
        return;
      }

      showScreen('room-screen');
      document.getElementById('host-controls').style.display = 'block';
      document.getElementById('end-stream-btn').style.display = 'block';

      // Get WebRTC Input URL from Worker
      const fetchResp = await fetch(WORKER_URL + '/create-live', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid: currentUser.uid })
      });
      
      const responseText = await fetchResp.text(); 
      let data;
      
      try {
          data = JSON.parse(responseText);
      } catch (e) {
          alert("FATAL WORKER ERROR: Invalid JSON response from /create-live. Response: " + responseText.substring(0, 150));
          leaveRoom(true); 
          btn.innerText = "+";
          return;
      }
      
      if(data.ok) {
        const roomId = "room-" + currentUser.uid;
        const roomData = {
          uid: currentUser.uid,
          hostName: document.getElementById('profile-name').innerText,
          title: title,
          status: 'live',
          webRTCPublishUrl: data.webRTCPublishUrl,
          playbackUrl: data.playbackUrl, 
          thumbnailUrl: finalCoverImageUrl,
          startedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        console.log("Waiting 2.5 seconds for Cloudflare Live Input to activate...");
        await delay(2500); 

        // Start WebRTC Publish Connection
        try {
            publisherConnection = await startWebRTCPublishing(localStream, data.webRTCPublishUrl);
            await db.ref('liveRooms/' + roomId).set(roomData);
            enterRoom(roomId, true, roomData, localStream); 
            
        } catch (e) {
            alert("WebRTC publishing failed: " + e.message);
            leaveRoom(true); 
        }

      } else {
        alert("Could not start stream: Worker Error! Details: " + (data.msg || data.error || data.detail || "Unknown Worker Error"));
        leaveRoom(true);
      }
      btn.innerText = "+";
    }

    // --- NEW: Playback Fallback Retry ---
    function retryUnmutedPlayback() {
        const video = document.getElementById('video-player');
        const overlay = document.getElementById('tap-to-play-overlay');
        
        video.muted = false;
        
        video.play().then(() => {
            overlay.style.display = 'none';
            console.log("Unmuted playback started after user interaction.");
        }).catch(e => {
            console.error("Playback failed even after tap:", e);
        });
    }

    // --- ROOM ENTRY / LEAVE LOGIC (UPDATED) ---
    function enterRoom(roomId, isHost, roomData, stream = null) {
      currentRoomId = roomId;
      removeRoomListeners(currentRoomId); 
      showScreen('room-screen');
      document.getElementById('chat-box').innerHTML = "";
      hlsRetryCount = 0;
      
      const video = document.getElementById('video-player');
      const tapToPlayOverlay = document.getElementById('tap-to-play-overlay');
      tapToPlayOverlay.style.display = 'none'; 

      if(!isHost) {
        document.getElementById('host-controls').style.display = 'none';
        document.getElementById('end-stream-btn').style.display = 'none'; 
        video.srcObject = null; 
        
        const playUrl = roomData.playbackUrl;
        
        if (!playUrl) {
             alert("Stream is not yet ready or playback URL is missing.");
             return;
        }

        // üí° FIX: Set video UNMUTED as requested.
        video.muted = false; 
        
        // Function to handle HLS load and playback
        const startHlsPlayback = () => {
            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls({ debug: true }); 
                
                hls.loadSource(playUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    // ‚≠êÔ∏è Unmuted Play Attempt with HACK
                    setTimeout(() => {
                        video.play().catch(e => {
                            console.error("Autoplay Blocked:", e.name, e.message);
                            // üö® FALLBACK: If play fails, show the TAP TO PLAY overlay
                            tapToPlayOverlay.style.display = 'flex'; 
                        });
                    }, 100); 
                });

                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        console.error('HLS Fatal Error:', data.type, data.details);
                        if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                            hls.recoverMediaError();
                        } else if (data.type === Hls.ErrorTypes.NETWORK_ERROR && hlsRetryCount < MAX_HLS_RETRIES) {
                            hlsRetryCount++;
                            const delayMs = hlsRetryCount * 2000;
                            console.warn(`HLS Network Error, retrying in ${delayMs / 1000}s. Attempt ${hlsRetryCount}/${MAX_HLS_RETRIES}`);
                            setTimeout(startHlsPlayback, delayMs); 
                        } else if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                             tapToPlayOverlay.innerHTML = '<div style="background: red; padding: 15px 30px; border-radius: 30px; font-weight: bold; color: #fff; font-size: 16px;">STREAM OFFLINE/ERROR</div>';
                             tapToPlayOverlay.style.display = 'flex';
                        }
                    }
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native Safari/iOS support
                video.src = playUrl;
                video.play().catch(e => {
                    console.error("Native Playback Blocked:", e.name, e.message);
                    tapToPlayOverlay.style.display = 'flex';
                });
            } else {
                 alert("Your browser does not support this stream format.");
            }
        };
        
        startHlsPlayback(); 
        
      } else {
        // Host logic 
        if(stream) {
            video.srcObject = stream;
            video.muted = true;
            video.play().catch(e => console.warn("Host play error:", e));
        }
        document.getElementById('host-controls').style.display = 'block';
        document.getElementById('end-stream-btn').style.display = 'block'; 
      }
      
      setupRoomListeners(roomId); 
    }
    
    function leaveRoom(isHostAction = false) {
      const wasHost = currentRoomId && currentRoomId === ('room-' + currentUser.uid);
      
      if(hls) { hls.destroy(); hls = null; }
      if(publisherConnection) { publisherConnection.close(); publisherConnection = null; }
      if(localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
      
      removeRoomListeners(currentRoomId); 
      document.getElementById('tap-to-play-overlay').style.display = 'none';

      if(wasHost || isHostAction) {
         db.ref(`liveRooms/${currentRoomId}`).update({ status: 'offline' });
         fetch(WORKER_URL + '/end-live', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ roomId: currentRoomId }) 
         });
         document.getElementById('end-stream-btn').style.display = 'none';
      }
      
      currentRoomId = null;
      document.getElementById('video-player').srcObject = null; 
      
      showScreen('home-screen');
      loadLiveRooms(); 
    }

    // --- PAYPAL / DIAMOND PURCHASE LOGIC (Unchanged) ---
    function setupPayPalButton() {
      if (!paypal.HostedButtons) {
          console.error("PayPal Hosted Buttons SDK failed to load.");
          return;
      }

      const HOSTED_BUTTON_ID = "LDLU6UV2GPRQE"; 

      if (document.getElementById('paypal-container-LDLU6UV2GPRQE').children.length > 0) return;

      paypal.HostedButtons({
          hostedButtonId: HOSTED_BUTTON_ID,
          container: '#paypal-container-LDLU6UV2GPRQE',
          onApprove: async function(data, actions) {
              const orderId = data.orderID;
              const verificationResp = await fetch(WORKER_URL + '/verify-payment', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ orderId: orderId })
              });

              const verificationData = await verificationResp.json();

              if (verificationData.ok && currentUser) {
                  const diamonds = verificationData.diamondsToCredit;
                  
                  const userRef = db.ref('users/' + currentUser.uid + '/wallet/diamonds');
                  const currentDiamonds = (await userRef.once('value')).val() || 0;
                  
                  const newDiamonds = currentDiamonds + diamonds;
                  await userRef.set(newDiamonds);

                  updateWalletDisplay(newDiamonds);
                  alert(`Purchase successful! ${diamonds} üíé credited to your account.`);
              } else {
                  alert("Payment verification failed. Please contact support. Details: " + (verificationData.msg || 'Unknown error.'));
              }
          }
      }).render();
    }

    function changeTab(element, tabName) {
      document.querySelectorAll('.tabs > div').forEach(div => div.classList.remove('tab-active'));
      element.classList.add('tab-active');
      console.log(`Switched to tab: ${tabName}`);
      loadLiveRooms(); 
    }

    // --- üîë AUTH FLOW (Unchanged) üîë --- 
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        
        db.ref('users/' + user.uid).once('value', snap => {
            const data = snap.val();
            const wallet = (data && data.wallet) || { diamonds: 100, coins: 0 }; 
            
            if (data && data.isBanned) {
                auth.signOut();
                alert("Account is banned. Please contact support.");
            } else {
                document.getElementById('profile-name').innerText = data.displayName || 'User';
                document.getElementById('profile-uid').innerText = user.uid;
                updateWalletDisplay(wallet.diamonds);
                
                loadLiveRooms(); 
                showScreen('home-screen');
                setupPayPalButton(); 
            }
        });
      } else {
        showScreen('auth-screen');
      }
    });

    // --- üìù HANDLE LOGIN / SIGNUP FUNCTION (Unchanged) ---
    async function handleAuth() {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value;
      const name = document.getElementById('username').value.trim() || 'user_' + Math.random().toString(36).substr(2, 5);
      
      if (!email || !pass || pass.length < 6) {
          alert("Error: Email is required, and Password must be at least 6 characters.");
          return;
      }
      
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        
      } catch (loginError) {
        if (loginError.code === 'auth/user-not-found' || loginError.code === 'auth/wrong-password') {
            try {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                
                await db.ref('users/' + res.user.uid).set({
                  displayName: name,
                  email: email,
                  wallet: { diamonds: 100, coins: 0 }, 
                  isBanned: false,
                  createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                
            } catch (signupError) { 
                alert("Signup Failed: " + signupError.message);
            }
        } else {
             alert("Login Error: " + loginError.message);
        }
      }
    }
    
  </script>
</body>
</html>


