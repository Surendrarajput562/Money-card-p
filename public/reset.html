<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Check - Gold Rupi</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #ffd700; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .reset-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 350px; text-align: center; display: none; }
        .loader-box { text-align: center; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); border-left-color: #333; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        h3 { margin-bottom: 20px; color: #333; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #333; color: #ffd700; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #status-msg { margin-top: 15px; font-size: 14px; color: red; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading-screen" class="loader-box">
    <div class="spinner"></div>
    <h2 id="msg">Link ki janch ho rahi hai...</h2>
</div>

<div id="reset-ui" class="reset-box">
    <h3>Naya Password Set Karein</h3>
    <input type="password" id="new-pw" placeholder="Naya Password Dalein">
    <input type="password" id="confirm-pw" placeholder="Password Confirm Karein">
    <button id="update-btn">Password Badlein</button>
    <p id="status-msg"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
    authDomain: "smbrand-4543a.firebaseapp.com",
    projectId: "smbrand-4543a",
};
firebase.initializeApp(firebaseConfig);

const urlParams = new URLSearchParams(window.location.search);
const mode = urlParams.get('mode');
const actionCode = urlParams.get('oobCode');

window.onload = async () => {
    if (!actionCode) {
        handleError("Security Error: Link invalid hai.");
        return;
    }

    if (mode === 'verifyEmail') {
        // --- EMAIL VERIFICATION LOGIC ---
        firebase.auth().applyActionCode(actionCode)
        .then(() => {
            // Success: User verify ho gaya, index pe bhejo
            window.location.href = "fo.html?verified=true";
        })
        .catch(err => {
            handleError("Link Expired: Ye verification link ab valid nahi hai.");
        });
    } 
    else if (mode === 'resetPassword') {
        // --- PASSWORD RESET LOGIC ---
        // Pehle check karo ki link expired toh nahi hui
        firebase.auth().verifyPasswordResetCode(actionCode)
        .then(() => {
            // Code sahi hai, form dikhao
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('reset-ui').style.display = 'block';
        })
        .catch(err => {
            handleError("Link Expired: Reset link ki samay-seema khatam ho gayi hai.");
        });
    }
};

function handleError(errorMessage) {
    document.getElementById('loading-screen').style.display = 'none';
    const ui = document.getElementById('reset-ui');
    ui.style.display = 'block';
    ui.innerHTML = `<h3 style="color:red;">❌ Error</h3>
                    <p>${errorMessage}</p>
                    <button onclick="window.location.href='index.html'">Wapas Login Par Jayein</button>`;
}

document.getElementById('update-btn').addEventListener('click', () => {
    const newPw = document.getElementById('new-pw').value;
    const confirmPw = document.getElementById('confirm-pw').value;
    const status = document.getElementById('status-msg');

    if (newPw !== confirmPw) {
        status.innerText = "Dono password alag hain!";
        return;
    }
    if (newPw.length < 6) {
        status.innerText = "Password kam se kam 6 akshar ka hona chahiye.";
        return;
    }

    firebase.auth().confirmPasswordReset(actionCode, newPw)
    .then(() => {
        alert("✅ Password Update Success! Ab login karein.");
        window.location.href = "index.html";
    })
    .catch(err => {
        status.innerText = "Error: Link expire ho gayi hai, naya request bhejein.";
    });
});
</script>
</body>
</html>

