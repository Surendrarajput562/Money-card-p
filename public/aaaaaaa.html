<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>gold rupi - user (updated)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root{
            --gold:#d4af37;
            --gold-strong:#c59b2d;
            --glass: rgba(255,255,255,0.8);
            --card-bg: rgba(255,255,255,0.95);
            --bg-grad: linear-gradient(135deg,#fff7e1,#ffe9a6);
            --accent:#1f2937;
            --text-color:#1f2937;
            --bg-color:#fffaf0;
            --card-shadow:0 6px 24px rgba(0,0,0,0.06);
            --history-border: var(--gold-strong);
        }
        [data-theme="dark"] {
            --gold:#ffd76b;
            --gold-strong:#ffc44a;
            --glass: rgba(31, 41, 55, 0.7);
            --card-bg: rgba(31, 41, 55, 0.9);
            --bg-grad: linear-gradient(135deg,#2e3a47,#4f5f70);
            --accent:#f3f4f6;
            --text-color:#f3f4f6;
            --bg-color:#111827;
            --card-shadow:0 6px 24px rgba(0,0,0,0.4);
            --history-border: var(--gold);
        }

        *{box-sizing:border-box}
        body{
            margin:0;
            font-family:'Poppins',sans-serif;
            background: var(--bg-color);
            color:var(--text-color);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            transition: background-color 0.3s, color 0.3s;
        }
        .header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:14px 16px;
            background:var(--glass);
            backdrop-filter:blur(8px);
            position:sticky;
            top:0;
            z-index:1000;
        }
        .brand{ display:flex;align-items:center;gap:10px; }
        .logo{
            width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--gold-strong));
            display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);
            box-shadow:0 6px 20px rgba(197,155,45,0.18);
        }
        .h1{font-weight:700;font-size:18px;color:var(--text-color)}
        .top-right{display:flex;gap:10px;align-items:center}
        .search-bar{padding:10px;border-radius:12px;border:none;width:100%;background:var(--card-bg);margin:12px 16px;display:flex;gap:10px;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
        [data-theme="dark"] .search-bar{background:rgba(255,255,255,0.1); box-shadow:none;}
        .search-bar input, .search-bar select{border:none;background:transparent;outline:none;width:100%;font-size:15px;color:var(--text-color)}
        .container{padding:12px 16px 100px}
        .section{display:none}
        .section.active{display:block}
        .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));gap:12px}
        .card{
            background:var(--card-bg);
            border-radius:14px;padding:12px;box-shadow:var(--card-shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .product-img{width:100%;height:140px;object-fit:cover;border-radius:10px;margin-bottom:8px}
        /* Updated Product Card Look */
        .product-card-inner { position: relative; }
        .product-card-inner .product-img { height: 120px; margin-bottom: 6px; }
        .product-card-inner .pmeta { display: block; margin-bottom: 4px; }
        .product-card-inner .pname { font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-card-inner .pprice { font-weight: 800; color:var(--gold-strong); font-size: 14px; }
        .small{font-size:12px;color:var(--text-color);opacity:0.8;}
        .small-muted{font-size:11px;color:var(--text-color);opacity:0.6;}
        .field-hidden{display:none;}
        
        /* cart list */
        .cart-list .card{display:flex;gap:10px;align-items:center;padding:10px;margin-bottom:10px;border-left:4px solid var(--gold);}
        .cart-list img{width:72px;height:72px;object-fit:cover;border-radius:8px}

        /* profile */
        .profile-top{display:flex;gap:12px;align-items:center}
        .profile-photo{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid var(--card-bg);box-shadow:0 6px 18px rgba(0,0,0,0.08)}
        .field{margin-top:8px}
        input:not([type="file"]), select, textarea{
            width:100%;
            padding:10px;
            border-radius:8px;
            border:1px solid rgba(0,0,0,0.1);
            margin-top:4px;
            margin-bottom:8px;
            background:var(--card-bg);
            color:var(--text-color);
            transition: border-color 0.3s;
        }
        [data-theme="dark"] input:not([type="file"]), [data-theme="dark"] select, [data-theme="dark"] textarea {
            border:1px solid rgba(255,255,255,0.2);
            background:rgba(255,255,255,0.05);
        }

        /* buttons */
        .btn{background:var(--gold);border:none;padding:10px 14px;border-radius:10px;color:var(--accent);font-weight:600;cursor:pointer;transition:background-color 0.3s, opacity 0.3s;}
        .btn:hover{opacity:0.9;}
        .btn.secondary{background:transparent;border:1px solid rgba(0,0,0,0.1);color:var(--text-color)}
        [data-theme="dark"] .btn.secondary{border:1px solid rgba(255,255,255,0.2);color:var(--text-color)}
        .row{display:flex;gap:10px;flex-wrap:wrap}

        /* bottom nav */
        .bottom-nav{position:fixed;left:0;right:0;bottom:0;height:66px;background:var(--glass);backdrop-filter:blur(8px);display:flex;justify-content:space-around;z-index:9999;box-shadow:0 -2px 10px rgba(0,0,0,0.05)}
        .navbtn{display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;color:var(--text-color);opacity:0.7;cursor:pointer;flex:1}
        .navbtn i{font-size:22px;margin-bottom:2px;color:var(--text-color)}
        .navbtn.active{opacity:1;color:var(--gold-strong);font-weight:600}
        .navbtn.active i{color:var(--gold-strong)}

        /* gold/wallet section */
        .gold-box{background:linear-gradient(90deg, rgba(212,175,55,0.15), rgba(212,175,55,0.08));padding:16px;border-radius:12px;margin:8px 0;border-left:5px solid var(--gold-strong);}
        [data-theme="dark"] .gold-box{background:rgba(212,175,55,0.08);}
        .note{font-size:13px;color:var(--text-color);opacity:0.7;}
        .balance-display{font-weight:800;font-size:24px;color:var(--gold-strong);margin-top:4px;}
        .balance-label{font-weight:700;font-size:14px;opacity:0.8;}

        /* history styling */
        .history .card{background:var(--card-bg);border-left:4px solid var(--history-border);margin-bottom:8px;padding:10px;font-size:13px;}

        /* detail overlay & modals */
        .overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:10000}
        .overlay .modal{width:92%;max-width:760px;background:var(--bg-color);padding:20px;border-radius:16px;max-height:90vh;overflow:auto;color:var(--text-color);box-shadow:var(--card-shadow);}
        .overlay .images{display:flex;gap:8px;overflow-x:auto;margin-bottom:8px}
        .overlay img{height:220px;object-fit:cover;border-radius:8px}
        .modal-row{display:flex;gap:8px;align-items:center}
        
        .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}

        /* Order Status Badge */
        .badge{padding:4px 8px;border-radius:6px;font-weight:600;font-size:12px;display:inline-block;text-transform:capitalize;color:#fff;}
        .badge-pending{background-color:#f59e0b;}
        .badge-paid{background-color:#06b6d4;}
        .badge-processing{background-color:#6366f1;}
        .badge-delivered, .badge-completed{background-color:#10b981;}
        .badge-rejected{background-color:#ef4444;}
        .badge-withdraw{background-color:#f97316;}
        .badge-add{background-color:#059669;}
        .badge-loan{background-color:#3b82f6;}
        .badge-eligible{background-color: #6d28d9;}
        /* Home Latest Product Look */
        #latest-products img {
            width: 100% !important;
            height: 120px !important;
            object-fit: cover !important;
            border-radius: 10px;
            display: block !important;
        }
        .quick-actions{ display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .product-actions{ display: flex; gap: 6px; align-items: center; margin-top: 8px; }
        .product-actions .btn, .product-actions .btn.secondary { padding: 6px 10px; font-size: 12px; }
        .rating { font-size: 14px; color: gold; }

        /* New crypto exchange styles */
        .crypto-widget-container {
            margin-top: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            max-width: 100%;
            height: 0; /* start collapsed */
            transition: height 0.5s ease-out;
        }
        .crypto-widget-container.expanded {
            height: 400px; /* Adjust as needed for the largest widget */
        }
        .crypto-widget-container iframe {
            display: block;
            width: 100%;
            border: none;
            min-height: 350px;
        }
        .exchange-widget-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        /* Loan Dashboard Styles */
        .loan-step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .loan-step {
            flex: 1;
            text-align: center;
            font-size: 10px;
            color: #ccc;
            position: relative;
            padding-top: 25px;
        }
        .loan-step::before {
            content: attr(data-step);
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            line-height: 20px;
            border-radius: 50%;
            background: #ccc;
            color: white;
            font-weight: 700;
        }
        .loan-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #ccc;
            z-index: -1;
            transform: translateX(10px);
        }
        .loan-step.active::before,
        .loan-step.completed::before {
            background: var(--gold-strong);
        }
        .loan-step.completed ~ .loan-step::after {
            background: var(--gold-strong);
        }
        .loan-step-content {
            padding: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-top: 10px;
        }
        .loan-step-content h4 { margin-top: 0; }

        .loan-offer-details div {
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
        }
        .loan-offer-details div:last-child { border-bottom: none; }

.full-btn {
    width: 100%;
    margin-top: 6px;
    text-align: center;
}
    </style>
</head>
<body data-theme="light">
    <div class="header">
        <div class="brand">
            <div class="logo">gr</div>
            <div>
                <div class="h1">gold rupi</div>
                <div class="small">buy gold ‚Ä¢ shop ‚Ä¢ wallet</div>
            </div>
        </div>
        <div class="top-right" style="display:flex;align-items:center;gap:12px">
            <div class="small" id="goldrate-display">rate: ‚Çπ6500 / g</div>
            <div class="small" id="wallet-mini">wallet: ‚Çπ0</div>
            <button class="btn secondary" onclick="toggleTheme()" style="padding: 6px 8px;"><i id="theme-icon" class="ri-moon-line"></i></button>
            <div class="cart-icon" onclick="showTab('cart')" title="Cart" style="position:relative;">
                <i class="ri-shopping-cart-line" style="font-size:24px;"></i>
                <div id="cart-count" class="cart-count" style="display:none; position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:16px; height:16px; font-size:10px; display:flex; justify-content:center; align-items:center;">0</div>
            </div>
            <div class="cart-icon" onclick="showNotificationCenter()" title="Notifications" style="position:relative;">
                <i class="ri-notification-line" style="font-size:24px;"></i>
                <div id="notification-count" class="cart-count" style="display:none; position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:16px; height:16px; font-size:10px; display:flex; justify-content:center; align-items:center;">0</div>
            </div>
            <button class="btn secondary" onclick="logout()" style="padding: 6px 8px;" title="Logout"><i class="ri-logout-box-r-line"></i></button>
        </div>
    </div>
    


<div class="search-bar">
    <input id="search-input" placeholder="search products, brand, color, category..." />

    <select id="category-filter">
        <option value="">all categories</option>
    </select>
</div>

    <div class="container">
        <div id="home" class="section active">
            <div class="section-title">
                <h2>welcome back <span id="welcome-name">üëã</span></h2>
                <div class="small-muted" id="signup-bonus-note"></div>
            </div>
            <div class="card gold-box">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div class="balance-label">current gold rate</div>
                        <div class="balance-display">‚Çπ <span id="gold-rate">6500</span> / g</div>
                        <div class="note" style="margin-top:8px;">your gold balance: <strong id="gold-balance-display">0.0000</strong> g</div>
                    </div>
                    <div style="text-align:right">
                        <div class="balance-label">fast actions</div>
                        <div class="row" style="margin-top:10px">
                            <button class="btn" onclick="showTab('shop')"><i class="ri-store-line"></i> Shop</button>
                            <button class="btn" onclick="showTab('gold')"><i class="ri-coin-line"></i> Buy Gold</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="quick-actions" id="quick-category-buttons">
                </div>
            <h3 style="margin-top:16px">latest products</h3>
            <div id="latest-products" class="grid"></div>
        </div>

        <div id="shop" class="section">
            <div class="section-title">
                <h2>shop</h2>
                <button class="btn secondary" onclick="showTab('wishlist')"><i class="ri-heart-line"></i> Wishlist</button>
            </div>
            <div class="card">
                <div style="display:flex;gap:8px;align-items:center">
                    <input id="search-shop" placeholder="search in shop..." style="flex:1">
                    <select id="cat-shop" style="min-width:140px"><option value="">all categories</option></select>
                    <select id="sort-shop" style="min-width:120px; padding:8px;">
                        <option value="newest">Newest</option>
                        <option value="price_asc">Price Low to High</option>
                        <option value="price_desc">Price High to Low</option>
                    </select>
                    <button class="btn" onclick="searchShop()">search</button>
                </div>
            </div>
            <div id="product-list" class="grid" style="margin-top:12px"></div>
        </div>

        <div id="cart" class="section">
            <h2>cart</h2>
            <div id="cart-list" class="cart-list"></div>
            <div style="margin-top:12px">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>subtotal:</strong> ‚Çπ <span id="cart-subtotal">0</span></div>
                        <div style="display:flex;gap:8px">
                            <button class="btn secondary" onclick="clearCart()">clear</button>
                            <button class="btn" onclick="openCheckoutModal()">buy / checkout</button>
                        </div>
                    </div>
                    <div style="margin-top:8px" class="small-muted">Delivery address and UTR will be confirmed at checkout.</div>
                </div>
            </div>
        </div>

        <div id="gold" class="section">
            <h2>buy gold</h2>
            <div class="card gold-box">
                <div class="balance-label">Your Current Gold Balance</div>
                <div class="balance-display"><span id="gold-balance-main">0.0000</span> g</div>
                <div class="note" style="margin-top:4px;">(equivalent to: ‚Çπ<span id="gold-value-main">0</span>)</div>
            </div>
            <div class="card" style="margin-top:12px;">
                <h4 style="margin-top:0;">purchase gold</h4>
                <div style="display:flex;gap:10px;align-items:flex-start">
                    <div style="flex:1">
                        <label class="small">enter amount (‚Çπ, min 50)</label>
                        <input id="gold-amount" type="number" placeholder="amount in ‚Çπ" oninput="calculateGoldGrams()">
                        <div class="note small" style="margin-bottom:8px;">will get: <strong id="gold-grams-calc">0.0000 g</strong></div>
                        <label class="small">enter utr (12 digits)</label>
                        <input id="gold-utr" type="text" placeholder="12 digit utr">
                        <div style="margin-top:8px" class="small-muted">scan the upi qr and paste utr then submit.</div>
                    </div>
                    <div style="width:160px;text-align:center;flex-shrink:0;">
                        <img id="gold-qr-img" src="https://i.ibb.co/CKTVnyGq/Screenshot-20251126-043755-GPay-Business.jpg" style="width:140px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);">
                        <div class="small" style="margin-top:6px">scan & pay</div>
                        <button class="btn secondary" onclick="launchUPIPayment('gold')" style="margin-top:8px;"><i class="ri-bank-card-line"></i> Quick Pay</button>
                    </div>
                </div>
                <div style="margin-top:12px;display:flex;gap:8px">
                    <button class="btn" onclick="buyGold()">submit request</button>
                    <button class="btn secondary" onclick="showHistory('gold')">my gold history</button>
                </div>
            </div>
            <div class="card" style="margin-top:16px;">
                <h4 style="margin-top:0;">Gold Price Trend (Last 30 Days)</h4>
                <div id="gold-chart-placeholder" style="height:150px; background:#f0f0f0; border-radius:8px; display:flex; justify-content:center; align-items:center;">
                    <span class="small-muted">üìà Placeholder for Price Chart Integration</span>
                </div>
            </div>
            <h4 style="margin-top:16px;">my gold history</h4>
            <div id="gold-status-list" class="history"></div>
        </div>

        <div id="wallet" class="section">
            <h2>wallet</h2>
            <div class="card gold-box">
                <div class="balance-label">current balance</div>
                <div class="balance-display">‚Çπ <span id="wallet-balance-main">0</span></div>
            </div>
            <div class="card" style="margin-top:12px">
                <h4 style="margin-top:0;">add money</h4>
                <div style="display:flex;gap:12px;align-items:flex-start">
                    <div style="flex:1">
                        <label class="small">add amount</label>
                        <input id="wallet-add-amount" type="number" placeholder="amount">
                        <label class="small">enter utr (12 digits)</label>
                        <input id="wallet-utr" type="text" placeholder="12 digit utr">
                        <div style="display:flex;gap:8px;margin-top:8px">
                            <button class="btn" onclick="addWallet()">request add</button>
                            <button class="btn secondary" onclick="openWithdrawModal()"><i class="ri-bank-card-line"></i> withdraw</button>
                        </div>
                    </div>
                    <div style="min-width:140px;text-align:center;">
                        <img id="wallet-qr" src="https://i.ibb.co/CKTVnyGq/Screenshot-20251126-043755-GPay-Business.jpg" style="width:100px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);">
                        <div class="small-muted" style="margin-top:4px;">scan to pay</div>
                        <button class="btn secondary" onclick="launchUPIPayment('wallet')" style="margin-top:8px;"><i class="ri-bank-card-line"></i> Quick Pay</button>
                    </div>
                </div>
            </div>
            <h4 style="margin-top:16px;">wallet history</h4>
            <div id="wallet-history-list" class="history"></div>
        </div>
        
        <div id="wishlist" class="section">
            <h2>my wishlist ‚ù§Ô∏è</h2>
            <div id="wishlist-list" class="grid" style="margin-top:12px;">
                <div class="card" style="grid-column: 1 / -1; text-align:center;">Your wishlist is empty.</div>
            </div>
        </div>

        <div id="profile" class="section">
            <div class="section-title">
                <h2>profile üë§</h2>
                <div>
                    <button class="btn secondary" onclick="showHistory('orders')">my orders</button>
                </div>
            </div>
 
<!-- ALL SERVICES START -->
<div class="card" style="margin-top:15px;">

    <button 
        onclick="toggleServices()" 
        style="
            width:100%;
            padding:12px;
            font-size:16px;
            font-weight:600;
            border:none;
            background:#f0f0f0;
            border-radius:6px;
            cursor:pointer;
        ">
        all services ‚ñº
    </button>

    <div id="servicesBox" style="display:none; margin-top:12px;">
        
        <!-- 20 buttons one below another -->
        <button class="btn secondary full-btn" onclick="window.location.href='aaaaaaaaaa.html'">my loan</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 2</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 3</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 4</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 5</button>

        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 6</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 7</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 8</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 9</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 10</button>

        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 11</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 12</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 13</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 14</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 15</button>

        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 16</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 17</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 18</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 19</button>
        <button class="btn secondary full-btn" onclick="window.location.href='example.html'">open page 20</button>

    </div>
</div>
<!-- ALL SERVICES END -->
 
            <div class="card profile-top">
                <img id="profile-photo" class="profile-photo" src="https://via.placeholder.com/84" alt="profile">
                <div style="flex:1">
                    <div id="profile-view">
                        <div style="display:flex;gap:8px;align-items:center">
                            <div style="flex:1">
                                <div id="profile-name-display" style="font-weight:700">Name</div>
                                <div id="profile-mobile-display" class="small-muted">Mobile</div>
                            </div>
                            <div>
                                <button class="btn secondary" onclick="toggleProfileEdit()">edit</button>
                            </div>
                        </div>
                    </div>
                    <div id="profile-edit" class="field-hidden" style="margin-top:8px">
                        <input id="profile-name" placeholder="name">
                        <input id="profile-mobile" placeholder="mobile">
                        <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                            <input type="file" id="profile-upload" style="flex:1">
                            <button class="btn secondary" onclick="uploadProfile()" style="min-width:100px;">upload</button>
                        </div>
                        <div style="margin-top:8px">
                            <button class="btn" onclick="saveProfile()">save profile</button>
                            <button class="btn secondary" onclick="toggleProfileEdit(true)">cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:12px">
                <h3 style="margin-top:0;">delivery address</h3>
                <div id="address-view">
                    <div class="small-muted" id="address-display">No saved address</div>
                    <div style="margin-top:8px"><button class="btn secondary" onclick="toggleAddressEdit()"><i class="ri-home-4-line"></i> edit address</button></div>
                </div>
                <div id="address-edit" class="field-hidden" style="margin-top:8px">
                    <input id="addr-house" placeholder="house / street">
                    <input id="addr-city" placeholder="city">
                    <input id="addr-district" placeholder="district">
                    <input id="addr-country" placeholder="country">
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button class="btn" onclick="saveAddress()"><i class="ri-save-line"></i> save address</button>
                        <button class="btn secondary" onclick="toggleAddressEdit(true)">cancel</button>
                    </div>
                </div>
                <div class="small-muted" style="margin-top:8px">Saved address will autofill at checkout.</div>
            </div>

            <div class="card" style="margin-top:12px">
                <h3 style="margin-top:0;">kyc (aadhaar)</h3>
                <div id="kyc-block">
                    <input id="kyc-name" placeholder="aadhaar name">
                    <input id="kyc-number" placeholder="aadhaar number (12 digits)">
                    <label class="small">Aadhaar Front Photo</label><input type="file" id="kyc-front">
                    <label class="small">Aadhaar Back Photo</label><input type="file" id="kyc-back">
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button class="btn" onclick="uploadKYC()"><i class="ri-file-upload-line"></i> submit kyc</button>
                        <button class="btn secondary" onclick="showKYCStatus()">view status</button>
                    </div>
                    <div id="kyc-status" style="margin-top:10px"></div>
                </div>
            </div>

            <div class="card" style="margin-top:12px">
                <h3 style="margin-top:0;">refer & earn (Affiliate Refer Program)</h3>
                <p class="badge badge-eligible" style="margin-bottom:8px;">ü•≥ Congratulations! You are eligible to the Affiliate Refer Program!</p>
                <div class="small">your refer code: <strong id="my-refer">N/A</strong></div>
                <p class="small-muted">terms: referred friend must buy gold ‚â• ‚Çπ50. only first friend counts. admin approval required.</p>
                <input id="refer-friend-name" placeholder="friend name">
                <input id="refer-friend-mobile" placeholder="friend mobile">
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button class="btn" onclick="submitRefer()"><i class="ri-send-plane-line"></i> submit refer</button>
                    <button class="btn secondary" onclick="shareReferralLink()"><i class="ri-share-line"></i> Share Link</button>
                    <button class="btn secondary" onclick="showHistory('refer')">refer history</button>
                </div>
                <div id="refer-history-list" class="history" style="margin-top:10px"></div>
            </div>

            <div class="card" style="margin-top:12px">
                <h3 style="margin-top:0;">quick loan</h3>
                <div id="loan-request-view">
                    <div class="small-muted" style="margin-bottom:8px;">Need quick cash? Apply now.</div>
                    <button class="btn" onclick="openLoanModal()"><i class="ri-money-dollar-circle-line"></i> apply for loan</button>
                </div>
                <div id="loan-status-view" class="field-hidden">
                    <div style="font-weight:700;margin-bottom:8px;">Active Loan Status:</div>
                    <div id="active-loan-details"></div>
                    <div id="loan-emi-list" style="margin-top:10px;" class="history"></div>
                </div>
            </div>

            <div class="card" style="margin-top:12px">
                <h3 style="margin-top:0;">chat support üí¨</h3>
                <div id="chat-messages" style="max-height:200px;overflow-y:auto;border:1px solid rgba(0,0,0,0.1);padding:10px;border-radius:8px;margin-bottom:8px;">
                    </div>
                <textarea id="chat-input" placeholder="type your message..." rows="2"></textarea>
                <button class="btn" onclick="sendChatMessage()">send message</button>
            </div>

            <div class="card" style="margin-top:12px">
                <h3 style="margin-top:0;"><i class="ri-bit-coin-line"></i> Crypto Exchange</h3>
                <p class="small-muted" style="margin-bottom:8px;">Exchange crypto currencies instantly. **Simple to exchange your crypto any wallet address instantly.**</p>
                
                <div class="exchange-widget-button-group">
                    <button class="btn secondary" onclick="toggleCryptoWidget('changenow')">ChangeNOW</button>
                    <button class="btn secondary" onclick="toggleCryptoWidget('swapspace')">SwapSpace</button>
                    <button class="btn secondary" onclick="toggleCryptoWidget('swapzone')">SwapZone</button>
                    <button class="btn secondary" onclick="toggleCryptoWidget('simpleswap')">SimpleSwap</button>
                </div>

                <div id="crypto-widget-container" class="crypto-widget-container">
                    <iframe id='changenow-frame' src='https://changenow.io/embeds/exchange-widget/v2/widget.html?FAQ=true&amount=0.01&amountFiat=1500&backgroundColor=FFFFFF&darkMode=false&from=btc&fromFiat=eur&horizontal=false&isFiat&lang=en-US&link_id=942d0e81f5df42&locales=true&logo=true&primaryColor=00C26F&to=eth&toFiat=eth&toTheMoon=true' style="display:none;" title="ChangeNOW Widget"></iframe>

                    <iframe id='swapspace-frame' src="https://swapspace.co/widget/9a41d9bf6a322549757d6df8" style="display:none;" title="SwapSpace Widget"></iframe>

                    <div id="swapzoneExchangeWidget" data-logo="true" data-size="full" data-refid="j-P5VziTG1" data-from="btc" data-to="eth" style="display:none;"></div>
                    
                    <iframe id="simpleswap-frame-widget" name="SimpleSwap Widget" src="https://simpleswap.io/widget/1f545e09-264a-46d1-becd-4e76bde2895c" style="display:none;" title="SimpleSwap Widget"></iframe>

                </div>
            </div>
            <div class="card history" style="margin-top:12px">
                <h3 style="margin-top:0;">quick history</h3>
                <div id="quick-history"></div>
            </div>

            <div id="orders-full-list" style="margin-top:16px;">
                </div>

            <div class="small-muted" style="text-align:center; margin-top:20px; padding-bottom:10px;">
                App Version: 1.2.6 (GoldRupi)
            </div>
        </div>

        <div id="notifications" class="section">
            <div class="section-title">
                <h2>notification center üîî</h2>
                <button class="btn secondary" onclick="markAllAsRead()">Mark All Read</button>
            </div>
            <div id="notification-list" class="history">
                <div class="card" style="border-left: 4px solid #3b82f6;">
                    <div style="font-weight:600;">Welcome to Gold Rupi!</div>
                    <div class="small-muted" style="margin-top:2px;">Your account is ready. Explore the app!</div>
                </div>
            </div>
        </div>
    </div>

    <div id="loan-dashboard-overlay" class="overlay">
        <div class="modal" style="max-width: 600px;">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700">Quick Loan Dashboard</div>
                <button class="btn secondary" onclick="closeLoanModal()"><i class="ri-close-line"></i></button>
            </div>
            
            <div class="loan-step-indicator" id="loan-steps">
                <div class="loan-step" data-step="1" id="loan-step-1">Verification</div>
                <div class="loan-step" data-step="2" id="loan-step-2">Calculator</div>
                <div class="loan-step" data-step="3" id="loan-step-3">Offer</div>
                <div class="loan-step" data-step="4" id="loan-step-4">Agreement</div>
                <div class="loan-step" data-step="5" id="loan-step-5">EMI Plan</div>
            </div>
            
            <div id="loan-dashboard-content">
                <div id="loan-view-verification" class="loan-step-content" style="display:block;">
                    <h4 style="margin-top:0; color:var(--gold-strong);"><i class="ri-shield-check-line"></i> Step 1: Profile Verification</h4>
                    <div id="verification-messages" class="small-muted" style="margin-bottom:10px;">Please complete all KYC and profile details below to be eligible for a loan.</div>
                    
                    <div class="card" style="margin-bottom:10px;">
                        <h5 style="margin-top:0;">Basic Info (Step 1/5)</h5>
                        <input id="loan-name-step" placeholder="Full Name (Auto-filled)" disabled>
                        <input id="loan-mobile-step" placeholder="Phone (Auto-filled)" disabled>
                        <input id="loan-email-step" placeholder="Email ID" type="email">
                        <input id="loan-dob-step" placeholder="Date of Birth" type="date">
                        <button class="btn" onclick="saveLoanStep1()">Save & Continue</button>
                    </div>

                    <div class="card" style="margin-bottom:10px;">
                        <h5 style="margin-top:0;">Identity Verification (Step 2/5)</h5>
                        <input id="loan-pan-number" placeholder="PAN Number (10 digits)">
                        <label class="small">Aadhaar Front & Back Photos:</label>
                        <div style="display:flex; gap:8px;">
                            <input type="file" id="loan-aadhaar-front" style="flex:1;">
                            <input type="file" id="loan-aadhaar-back" style="flex:1;">
                        </div>
                        <label class="small">PAN Card Photo:</label>
                        <input type="file" id="loan-pan-photo">
                        <button class="btn secondary" onclick="submitLoanStep2()">Verify Identity</button>
                    </div>

                    <div class="card" style="margin-bottom:10px;">
                        <h5 style="margin-top:0;">Bank Details (Step 3/5)</h5>
                        <input id="loan-bank-name" placeholder="Bank Name">
                        <input id="loan-account-number" placeholder="Account Number">
                        <input id="loan-ifsc-code" placeholder="IFSC Code">
                        <input id="loan-branch" placeholder="Branch">
                        <label class="small">Passbook/Cheque Photo:</label>
                        <input type="file" id="loan-passbook-photo">
                        <button class="btn secondary" onclick="submitLoanStep3()">Submit Bank KYC</button>
                    </div>

                    <div class="card" style="margin-bottom:10px;">
                        <h5 style="margin-top:0;">Employment/Work Details (Step 4/5)</h5>
                        <select id="loan-occupation">
                            <option value="">Select Occupation</option>
                            <option value="job">Salaried (Job)</option>
                            <option value="business">Self-Employed (Business)</option>
                            <option value="student">Student</option>
                            <option value="other">Other</option>
                        </select>
                        <input id="loan-company-name" placeholder="Company Name / Business Name">
                        <input id="loan-salary" type="number" placeholder="Salary/Income Per Month (‚Çπ)">
                        <label class="small">Last 3 Salary Slips:</label><input type="file" id="loan-salary-slips" multiple>
                        <label class="small">Last 6 Bank Statements:</label><input type="file" id="loan-bank-statements" multiple>
                        <button class="btn secondary" onclick="submitLoanStep4()">Submit Employment Details</button>
                    </div>

                    <div class="card">
                        <h5 style="margin-top:0;">Address Details (Step 5/5)</h5>
                        <input id="loan-perm-addr" placeholder="Permanent Address">
                        <input id="loan-curr-addr" placeholder="Current Address">
                        <label class="small">Address Proof (e.g., Electricity Bill):</label>
                        <input type="file" id="loan-address-proof">
                        <button class="btn secondary" onclick="submitLoanStep5()">Save Address</button>
                    </div>

                    <div style="margin-top:15px; text-align:center;">
                        <button class="btn" onclick="showLoanView('calculator')">Go to Loan Calculator <i class="ri-arrow-right-line"></i></button>
                    </div>
                </div>

                <div id="loan-view-calculator" class="loan-step-content field-hidden">
                    <h4 style="margin-top:0; color:var(--gold-strong);"><i class="ri-calculator-line"></i> Step 2: Loan Calculator</h4>
                    <p class="small-muted">Estimate your EMI and loan details.</p>

                    <label class="small">Loan Amount (‚Çπ500 - ‚Çπ50,000)</label>
                    <input type="range" min="500" max="50000" value="5000" id="calc-amount-range" oninput="updateLoanCalc()">
                    <div style="font-weight:700; margin-bottom:10px;">Amount: ‚Çπ<span id="calc-amount-display">5,000</span></div>

                    <label class="small">Tenure (3 - 24 Months)</label>
                    <input type="range" min="3" max="24" value="12" id="calc-tenure-range" oninput="updateLoanCalc()">
                    <div style="font-weight:700; margin-bottom:15px;">Tenure: <span id="calc-tenure-display">12</span> Months</div>
                    
                    <div class="card" style="padding:10px;">
                        <div style="display:flex;justify-content:space-between;">
                            <span class="small-muted">Interest Rate (ROI):</span>
                            <span style="font-weight:600;"><span id="calc-roi-display">1.5</span>% p.m.</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:5px;">
                            <span class="small-muted">Estimated Monthly EMI:</span>
                            <span class="pprice">‚Çπ<span id="calc-emi-display">463</span></span>
                        </div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <button class="btn" onclick="submitNewLoanApplication()">Apply for Loan</button>
                        <button class="btn secondary" onclick="showLoanView('verification')">Back to Verification</button>
                    </div>
                </div>

                <div id="loan-view-offer" class="loan-step-content field-hidden">
                    <h4 style="margin-top:0; color:var(--gold-strong);"><i class="ri-file-text-line"></i> Step 3 & 4: Loan Offer & Agreement</h4>
                    <div id="loan-offer-pending" class="badge badge-pending" style="margin-bottom:15px;">Loan application is under review. Please wait for an offer.</div>
                    
                    <div id="loan-offer-display" class="field-hidden">
                        <div class="card gold-box" style="margin-bottom:15px;">
                            <h5 style="margin-top:0;">Your Approved Offer!</h5>
                            <div class="loan-offer-details">
                                <div><strong>Approved Amount:</strong> ‚Çπ<span id="offer-approved-amount">0</span></div>
                                <div><strong>Interest Rate (ROI):</strong> <span id="offer-roi">0</span>% p.m.</div>
                                <div><strong>Tenure:</strong> <span id="offer-tenure">0</span> Months</div>
                                <div><strong>Processing Fee:</strong> -‚Çπ<span id="offer-fee">0</span></div>
                                <div><strong>Net Disbursal:</strong> ‚Çπ<span id="offer-net-disbursal">0</span></div>
                                <div style="font-weight:700; border-top: 1px solid rgba(0,0,0,0.1);">Monthly EMI: ‚Çπ<span id="offer-emi">0</span></div>
                            </div>
                        </div>

                        <div id="loan-agreement-section">
                            <h5 style="margin-top:0;">Digital Agreement</h5>
                            <div class="small-muted" style="margin-bottom:10px; border:1px solid #ccc; padding:10px; border-radius:8px;">
                                By checking this box and clicking 'Sign Loan Agreement', you digitally agree to the terms and conditions of the Gold Rupi Quick Loan, including the repayment schedule and interest rate.
                            </div>
                            <div style="margin-bottom:10px;">
                                <input type="checkbox" id="agreement-check" style="width:20px; margin-right:5px;"><label for="agreement-check" class="small">I agree to the terms and conditions.</label>
                            </div>
                            <input id="agreement-signature" placeholder="Type Full Name for Digital Signature">
                        </div>

                        <div style="display:flex; gap:8px; margin-top:15px;">
                            <button class="btn" onclick="acceptLoanOffer()">Sign Loan Agreement (Accept Offer)</button>
                            <button class="btn secondary" onclick="rejectLoanOffer()">Reject Offer</button>
                        </div>
                    </div>
                </div>

                <div id="loan-view-emi-plan" class="loan-step-content field-hidden">
                    <h4 style="margin-top:0; color:var(--gold-strong);"><i class="ri-calendar-line"></i> Step 5: EMI Plan & Tracker</h4>
                    <div id="loan-tracker-display" class="card gold-box" style="margin-bottom:15px;">
                        <div style="font-weight:700;">Loan Status: <span id="tracker-status"></span></div>
                        <div style="margin-top:5px; font-size:14px;">Remaining Balance: ‚Çπ<strong id="tracker-balance">0</strong></div>
                        <div class="small-muted">Loan ID: <span id="tracker-loan-id"></span></div>
                        <div style="margin-top:10px; padding:5px 0; border-top:1px dashed #ccc;">
                            <div class="small-muted" style="margin-bottom:5px;">Next EMI Due: <span id="tracker-next-emi-date">N/A</span></div>
                            <div id="tracker-timer" style="font-weight:800; color:#ef4444;"></div>
                        </div>
                    </div>

                    <h5 style="margin-top:0;">EMI Schedule</h5>
                    <div id="loan-emi-schedule-list" class="history">
                        </div>

                    <div style="display:flex; gap:8px; margin-top:15px;">
                        <button class="btn secondary" onclick="requestLoanForeclosure()"><i class="ri-money-dollar-circle-line"></i> Request Foreclosure</button>
                        <button class="btn secondary" onclick="sendChatMessage()"><i class="ri-question-answer-line"></i> Chat with Support</button>
                    </div>

                    <h5 style="margin-top:15px;">Payment History</h5>
                    <div id="loan-payment-history" class="history">
                        <div class="small-muted" style="text-align:center;">Payment history will appear here.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="order-details-overlay" class="overlay">
        <div class="modal">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700" id="order-modal-title">Order Details</div>
                <button class="btn secondary" onclick="closeOrderDetailsModal()"><i class="ri-close-line"></i></button>
            </div>
            <div id="order-details-content" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="overlay" class="overlay" onclick="overlayClicked(event)">
        <div class="modal" id="overlay-modal">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700" id="modal-title">Product</div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div id="modal-price" style="font-weight:800;color:var(--gold-strong)"></div>
                    <button class="btn" onclick="modalAddToCart()"><i class="ri-add-line"></i> Add to Cart</button>
                    <button class="btn secondary" onclick="closeOverlay()"><i class="ri-close-line"></i></button>
                </div>
            </div>
            <div class="images" id="modal-images" style="margin-top:8px"></div>
            <div id="modal-desc" style="margin-top:8px;opacity:0.8;"></div>
            <div class="small-muted" id="modal-meta" style="margin-top:8px;"></div>
            <div style="margin-top:8px;">
                <span class="rating" id="modal-rating"></span> <span class="small-muted" id="modal-reviews-count"></span>
            </div>
        </div>
    </div>

    <div id="checkout-overlay" class="overlay">
        <div class="modal">
            <h3>Checkout Confirmation</h3>
            <div id="checkout-items" style="max-height:200px;overflow:auto;margin-bottom:12px;padding:8px;border:1px solid rgba(0,0,0,0.1);border-radius:8px;"></div>
            <div style="margin-top:8px;">
                <h4 style="margin:0 0 6px 0;">Delivery address</h4>
                <div id="checkout-address-form">
                    <input id="co-addr-house" placeholder="house / street">
                    <input id="co-addr-city" placeholder="city">
                    <input id="co-addr-district" placeholder="district">
                    <input id="co-addr-country" placeholder="country">
                </div>
            </div>
            <div style="margin-top:8px">
                <label class="small">Enter UTR (12 digits)</label>
                <input id="checkout-utr" placeholder="UTR">
            </div>
            <div style="display:flex;gap:8px;margin-top:16px">
                <button class="btn" onclick="confirmCheckout()"><i class="ri-check-line"></i> Submit Order</button>
                <button class="btn secondary" onclick="closeCheckoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="withdraw-overlay" class="overlay">
        <div class="modal">
            <h3>Withdraw from Wallet</h3>
            <div>
                <label class="small">Amount (Current Balance: ‚Çπ<span id="withdraw-balance">0</span>)</label>
                <input id="withdraw-amount" placeholder="amount">
                <label class="small" style="margin-top:8px">UPI / Account details (required for admin)</label>
                <input id="withdraw-note" placeholder="UPI ID or Bank Account Details">
            </div>
            <div style="display:flex;gap:8px;margin-top:12px">
                <button class="btn" onclick="submitWithdraw()"><i class="ri-bank-card-line"></i> Submit Request</button>
                <button class="btn secondary" onclick="closeWithdrawModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="loan-overlay" class="overlay field-hidden"></div>

    <div id="loan-action-overlay" class="overlay">
        <div class="modal" id="loan-action-modal">
            </div>
    </div>

    <div id="emi-payment-overlay" class="overlay">
        <div class="modal">
            <h3>Pay EMI Installment</h3>
            <div id="emi-details-modal"></div>
            <div style="display:flex;gap:10px;align-items:flex-start;margin-top:12px">
                <div style="flex:1">
                    <label class="small">Enter UTR (12 digits)</label>
                    <input id="emi-utr" type="text" placeholder="12 digit utr">
                    <div style="margin-top:8px" class="small-muted">scan the upi qr and paste utr then submit.</div>
                </div>
                <div style="width:160px;text-align:center;flex-shrink:0;">
                    <img src="https://i.ibb.co/CKTVnyGq/Screenshot-20251126-043755-GPay-Business.jpg" style="width:140px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);">
                    <div class="small" style="margin-top:6px">scan & pay for EMI</div>
                    <button class="btn secondary" onclick="launchUPIPayment('emi', document.getElementById('emi-payment-overlay').dataset.emiAmount)" style="margin-top:8px;"><i class="ri-bank-card-line"></i> Quick Pay</button>
                </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:16px">
                <button class="btn" onclick="submitEmiPayment()"><i class="ri-check-line"></i> Submit Payment</button>
                <button class="btn secondary" onclick="closeEmiPaymentModal()">Cancel</button>
            </div>
        </div>
    </div>


    <div class="bottom-nav">
        <div class="navbtn active" data-target="home" onclick="navClick(event)">
            <i class="ri-home-4-fill"></i><div>home</div>
        </div>
        <div class="navbtn" data-target="shop" onclick="navClick(event)">
            <i class="ri-store-line"></i><div>shop</div>
        </div>
        <div class="navbtn" data-target="gold" onclick="navClick(event)">
            <i class="ri-coin-line"></i><div>gold</div>
        </div>
        <div class="navbtn" data-target="wallet" onclick="navClick(event)">
            <i class="ri-wallet-line"></i><div>wallet</div>
        </div>
        <div class="navbtn" data-target="profile" onclick="navClick(event)">
            <i class="ri-user-line"></i><div>profile</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://swapzone.io/script/exchange-widget.js"></script>
    <script>
        // ---------- config ----------
        const firebaseConfig = {
            apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
            authDomain: "smbrand-4543a.firebaseapp.com",
            databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
            projectId: "smbrand-4543a",
            storageBucket: "smbrand-4543a.firebasestorage.app",
            messagingSenderId: "720775550032",
            appId: "1:720775550032:web:0622548a007597778bad55",
            measurementId: "G-3LS5W6F8QW"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const paymentRequestsRef = db.ref('payment_requests');
        const imgbbKey = '021a2437b889915669b66554687bf17f';

        // ---------- state ----------
        let currentUser = null;
        let productsData = {};
        let cart = {};
        let wishlist = {};
        let modalProductId = null;
        const GOLD_RATE = 6500;
        const SIGNUP_BONUS = 100;
        const REFERRAL_GOLD_MIN = 50;
        const LOAN_MIN_AMOUNT = 500;
        const LOAN_MAX_AMOUNT = 50000;
        const LOAN_MIN_TENURE = 3;
        const LOAN_MAX_TENURE = 24;
        const LOAN_ROI_PER_MONTH = 0.015; // 1.5% per month

        const CATEGORIES_LIST = {
            "mens": { name: "Men's Fashion", image: "https://via.placeholder.com/50?text=M" },
            "women": { name: "Women's Fashion", image: "https://via.placeholder.com/50?text=W" },
            "fashion": { name: "Accessories", image: "https://via.placeholder.com/50?text=A" },
            "sari": { name: "Sarees", image: "https://via.placeholder.com/50?text=S" },
            "electronics": { name: "Electronics", image: "https://via.placeholder.com/50?text=E" },
            "home": { name: "Home & Kitchen", image: "https://via.placeholder.com/50?text=H" },
            "beauty": { name: "Beauty & Grooming", image: "https://via.placeholder.com/50?text=B" },
            "sports": { name: "Sports & Fitness", image: "https://via.placeholder.com/50?text=F" }
        };

        let categoriesData = CATEGORIES_LIST;

        // Initialize Quick Category Buttons
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('quick-category-buttons');
            Object.keys(CATEGORIES_LIST).slice(0, 5).forEach(catId => {
                const cat = CATEGORIES_LIST[catId];
                const button = document.createElement('button');
                button.className = 'btn secondary';
                button.textContent = cat.name;
                button.onclick = () => filterByCategory(catId);
                container.appendChild(button);
            });
            updateLoanCalc(); // Initial calc render
        });

function toggleServices() {
    const box = document.getElementById('servicesBox');
    box.style.display = (box.style.display === "none") ? "block" : "none";
}

        // Overlay & Modals
        function openOverlay(){ document.getElementById('overlay').style.display = 'flex'; }
        function closeOverlay(){ document.getElementById('overlay').style.display = 'none'; modalProductId = null; }
        function overlayClicked(e){ if(e.target === document.getElementById('overlay')) closeOverlay(); }
        function closeCheckoutModal(){ document.getElementById('checkout-overlay').style.display = 'none'; }
        function openWithdrawModal(){ 
            db.ref('users/'+currentUser.uid+'/wallet').once('value').then(snap=>{
                document.getElementById('withdraw-balance').innerText = snap.val() || 0;
                document.getElementById('withdraw-overlay').style.display = 'flex'; 
            });
        }
        function closeWithdrawModal(){ document.getElementById('withdraw-overlay').style.display = 'none'; }
        // Updated openLoanModal to show the Dashboard
        function openLoanModal(){ 
            document.getElementById('loan-dashboard-overlay').style.display = 'flex'; 
            loadLoanDashboardState();
        }
        function closeLoanModal(){ 
            document.getElementById('loan-dashboard-overlay').style.display = 'none'; 
            clearInterval(loanTimer); 
        }
        function openLoanActionModal(){ document.getElementById('loan-action-overlay').style.display = 'flex'; }
        function closeLoanActionModal(){ document.getElementById('loan-action-overlay').style.display = 'none'; }
        // EMI Modals
        function openEmiPaymentModal(emiId, amount){
            document.getElementById('emi-details-modal').innerHTML = `
                <p><strong>Installment Amount:</strong> ‚Çπ${amount}</p>
                <p class="small-muted">EMI ID: ${emiId}</p>
            `;
            document.getElementById('emi-payment-overlay').dataset.emiId = emiId;
            document.getElementById('emi-payment-overlay').dataset.emiAmount = amount;
            document.getElementById('emi-utr').value = '';
            document.getElementById('emi-payment-overlay').style.display = 'flex';
        }
        function closeEmiPaymentModal(){
            document.getElementById('emi-payment-overlay').style.display = 'none';
            delete document.getElementById('emi-payment-overlay').dataset.emiId;
            delete document.getElementById('emi-payment-overlay').dataset.emiAmount;
        }

        // New Modal Functions
        function openOrderDetailsModal(orderId) {
            db.ref('users/' + currentUser.uid + '/order_history/' + orderId).once('value').then(snap => {
                const order = snap.val();
                if (!order) return alert('Order not found.');

                document.getElementById('order-modal-title').innerText = `Order: ${order.id.substring(0, 12)}...`;
                let content = `
                    <p><strong>Status:</strong> ${renderStatusBadge(order.status)}</p>
                    <p><strong>Total:</strong> ‚Çπ${order.total}</p>
                    <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                    <h4>Delivery Address</h4>
                    <p class="small-muted">${order.address.house}, ${order.address.city}, ${order.address.district}, ${order.address.country}</p>
                    <h4>Items</h4>
                    <div style="max-height:150px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); padding:8px; border-radius:8px;">
                `;
                
                Object.keys(order.items).forEach(pid => {
                    const item = order.items[pid];
                    const name = item.name || 'Unknown Product';
                    const price = item.price || 'N/A';
                    const qty = item.qty || 0;
                    content += `
                        <div style="display:flex; gap:10px; margin-bottom:8px; border-bottom:1px dashed #ccc; padding-bottom:5px;">
                            <img src="${item.image || 'https://via.placeholder.com/50'}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;">
                            <div>
                                <strong>${name}</strong> x ${qty}<br>
                                <span class="small-muted">‚Çπ${price * qty} (unit: ‚Çπ${price})</span>
                            </div>
                        </div>
                    `;
                });
                content += `</div>`;

                document.getElementById('order-details-content').innerHTML = content;
                document.getElementById('order-details-overlay').style.display = 'flex';
            });
        }
        function closeOrderDetailsModal() {
            document.getElementById('order-details-overlay').style.display = 'none';
        }
        function showNotificationCenter() {
            showTab('notifications');
        }
        function markAllAsRead() {
             // In a real app, this would update Firebase or mark client-side state
             alert('All notifications marked as read (Demo).');
        }
        function shareReferralLink() {
            const referCode = document.getElementById('my-refer').innerText;
            const link = `https://goldrupi.app/signup?refer=${referCode}`;
            if (navigator.share) {
                navigator.share({
                    title: 'Gold Rupi Referral',
                    text: `Join Gold Rupi and get ‚Çπ${SIGNUP_BONUS} bonus! Use my code: ${referCode}`,
                    url: link,
                }).catch(error => console.error('Sharing failed', error));
            } else {
                navigator.clipboard.writeText(link);
                alert(`Referral link copied to clipboard! Share this link: ${link}`);
            }
        }
        function launchUPIPayment(type, amountOverride) {
            let amount;
            let note;
            let upiId = 'merchant@upi'; // Default Loan UPI ID as per request

            if (type === 'gold') {
                amount = document.getElementById('gold-amount').value;
                note = 'Payment for Gold Rupi Gold Purchase';
                upiId = '7649070168@okbizaxis'; // Previous UPI ID for Gold/Wallet
            } else if (type === 'wallet') {
                amount = document.getElementById('wallet-add-amount').value;
                note = 'Payment for Gold Rupi Wallet Add';
                upiId = '7649070168@okbizaxis'; // Previous UPI ID for Gold/Wallet
            } else if (type === 'emi') {
                amount = amountOverride;
                note = 'Payment for Gold Rupi EMI Repayment';
            }
            
            if (!amount || Number(amount) < 1) {
                alert('Please enter a valid amount first.');
                return;
            }

            const url = `upi://pay?pa=${upiId}&pn=GoldRupi&am=${amount}&cu=INR&tn=${note}`;
            
            // This will try to open a UPI app on mobile
            window.location.href = url;
            alert('Attempting to open UPI app... Please note the UTR after payment.');
        }

        function navClick(e){
            document.querySelectorAll('.navbtn').forEach(n=>n.classList.remove('active'));
            e.currentTarget.classList.add('active');
            showTab(e.currentTarget.dataset.target);
        }
        function showTab(id){
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const el = document.getElementById(id);
            if(el) el.classList.add('active');
            closeOverlay(); closeCheckoutModal(); closeWithdrawModal(); closeLoanModal(); closeLoanActionModal(); closeOrderDetailsModal(); closeEmiPaymentModal();
            if (id === 'wishlist') loadWishlist();
        }

        function toggleTheme(){
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon').className = newTheme === 'light' ? 'ri-moon-line' : 'ri-sun-line';
        }

        // UUID Generator for Refer Code
        function generateReferCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Logout
        function logout(){
            auth.signOut().then(()=> location.href='rupe.html');
        }

        // ---------- auth check / initial setup ----------
        auth.onAuthStateChanged(async user=>{
            if(!user) return window.location.href='rupe.html';
            currentUser = user;

            await initialDataSetup(user);
            
            document.getElementById('gold-rate').innerText = GOLD_RATE;
            document.getElementById('goldrate-display').innerText = `rate: ‚Çπ${GOLD_RATE} / g`;

            loadUserProfile();
            loadProducts(); // This includes updating latest products and rendering categories
            loadCartFromDb();
            loadWishlistFromDb();
            loadQuickHistory();
            loadReferHistory();
            loadWalletHistory();
            loadGoldHistory();
            loadOrderHistory();
            loadChatHistory();
            checkAndLoadActiveLoan();
            
            listenPaymentRequests();
        });

        async function initialDataSetup(user) {
            try {
                const uSnap = await db.ref('users/'+user.uid).once('value');
                const userData = uSnap.val() || {};

                if(!userData.signup_bonus_given) {
                    const newReferCode = generateReferCode();
                    await db.ref('users/'+user.uid).update({
                        wallet: SIGNUP_BONUS,
                        refer: newReferCode,
                        signup_bonus_given: true,
                    });
                    const bonusId = 'bonus_'+Date.now();
                    await db.ref('users/'+user.uid+'/wallet_history/'+bonusId).set({id:bonusId, amount:SIGNUP_BONUS, type:'bonus', status:'completed', created_at:Date.now()});
                    document.getElementById('signup-bonus-note').innerText = `‚Çπ${SIGNUP_BONUS} signup bonus added`;
                    setTimeout(()=>document.getElementById('signup-bonus-note').innerText = '', 5000);
                } else if (!userData.refer) {
                    await db.ref('users/'+user.uid+'/refer').set(generateReferCode());
                }
            } catch(e) {
                console.error('Initial data setup failed:', e);
            }
        }

        // Gold Grams Calculation
        function calculateGoldGrams() {
            const amount = Number(document.getElementById('gold-amount').value);
            if (!amount || amount < 0) {
                document.getElementById('gold-grams-calc').innerText = '0.0000 g';
                return;
            }
            const grams = (amount / GOLD_RATE).toFixed(4);
            document.getElementById('gold-grams-calc').innerText = `${grams} g`;
        }


        // ---------- user profile & listeners (No major changes here) ----------
        let loanTimer = null;
        function loadUserProfile(){
            db.ref('users/'+currentUser.uid).on('value',snap=>{
                const d = snap.val()||{};
                
                // UI View Updates
                const name = d.name || 'Unnamed';
                document.getElementById('welcome-name').innerText = name.split(' ')[0] + ' üëã';
                document.getElementById('profile-name-display').innerText = name;
                document.getElementById('profile-mobile-display').innerText = d.mobile || 'Add Mobile Number';
                document.getElementById('profile-name').value = d.name||'';
                document.getElementById('profile-mobile').value = d.mobile||'';
                document.getElementById('profile-photo').src = d.photo||'https://via.placeholder.com/84';
                document.getElementById('my-refer').innerText = d.refer||'N/A';

                // Loan Step 1 Prefill
                document.getElementById('loan-name-step').value = name;
                document.getElementById('loan-mobile-step').value = d.mobile || '';

                // Balances
                const walletBalance = Number(d.wallet||0);
                const goldBalance = Number(d.gold_balance||0);
                const goldValue = Math.round(goldBalance * GOLD_RATE);

                document.getElementById('wallet-balance-main').innerText = walletBalance.toFixed(2);
                document.getElementById('wallet-mini').innerText = `wallet: ‚Çπ${walletBalance.toFixed(2)}`;
                document.getElementById('gold-balance-display').innerText = goldBalance.toFixed(4);
                document.getElementById('gold-balance-main').innerText = goldBalance.toFixed(4);
                document.getElementById('gold-value-main').innerText = goldValue.toFixed(0);
                
                // Address
                if(d.address){
                    const a = d.address;
                    const ad = `${a.house||''}, ${a.city||''}, ${a.district||''}, ${a.country||''}`;
                    document.getElementById('address-display').innerText = ad;
                    document.getElementById('addr-house').value = a.house||'';
                    document.getElementById('addr-city').value = a.city||'';
                    document.getElementById('addr-district').value = a.district||'';
                    document.getElementById('addr-country').value = a.country||'';
                } else {
                    document.getElementById('address-display').innerText = 'No saved address';
                }

                // KYC
                const kycStatus = (d.kyc && d.kyc.status) || 'not submitted';
                const kycBlock = document.getElementById('kyc-block');
                if(kycStatus === 'verified'){
                    kycBlock.innerHTML = `<div class="small badge badge-completed" style="margin-bottom:8px;">KYC Verified</div><div class="small-muted">Aadhaar: ${d.kyc.number}</div>`;
                } else if (kycStatus === 'pending') {
                    kycBlock.innerHTML = `<div class="small badge badge-pending" style="margin-bottom:8px;">KYC Submitted (Pending Admin Review)</div><div class="small-muted">You will be notified upon verification.</div><button class="btn secondary" style="margin-top:10px;" onclick="showKYCStatus()">view status</button>`;
                } else {
                    if(!kycBlock.querySelector('input')) kycBlock.innerHTML = `
                        <input id="kyc-name" placeholder="aadhaar name">
                        <input id="kyc-number" placeholder="aadhaar number (12 digits)">
                        <label class="small">Aadhaar Front Photo</label><input type="file" id="kyc-front">
                        <label class="small">Aadhaar Back Photo</label><input type="file" id="kyc-back">
                        <div style="display:flex;gap:8px;margin-top:8px">
                            <button class="btn" onclick="uploadKYC()"><i class="ri-file-upload-line"></i> submit kyc</button>
                            <button class="btn secondary" onclick="showKYCStatus()">view status</button>
                        </div>
                        <div id="kyc-status" style="margin-top:10px"></div>
                    `;
                }
            });
        }

        function toggleProfileEdit(forceHide){
            const edit = document.getElementById('profile-edit');
            const view = document.getElementById('profile-view');
            if(forceHide){ edit.classList.add('field-hidden'); view.classList.remove('field-hidden'); return; }
            edit.classList.toggle('field-hidden');
            view.classList.toggle('field-hidden');
        }

        function saveProfile(){
            const name = document.getElementById('profile-name').value.trim();
            const mobile = document.getElementById('profile-mobile').value.trim();
            db.ref('users/'+currentUser.uid).update({name,mobile}).then(()=>{
                alert('profile saved');
                toggleProfileEdit(true);
            }).catch(e=>alert('save failed: ' + e.message));
        }

        async function uploadProfile(){
            const file = document.getElementById('profile-upload').files[0];
            if(!file){ alert('select photo'); return; }
            const form = new FormData(); form.append('image', file);
            try {
                const res = await axios.post('https://api.imgbb.com/1/upload?key='+imgbbKey, form);
                const url = res.data.data.url;
                await db.ref('users/'+currentUser.uid+'/photo').set(url);
                alert('photo uploaded');
            } catch(e) {
                alert('upload failed');
                console.error('Image upload failed:', e);
            }
        }

        function toggleAddressEdit(forceHide){
            const edit = document.getElementById('address-edit');
            const view = document.getElementById('address-view');
            if(forceHide){ edit.classList.add('field-hidden'); view.classList.remove('field-hidden'); return; }
            edit.classList.toggle('field-hidden');
            view.classList.toggle('field-hidden');
        }

        function saveAddress(){
            const house = document.getElementById('addr-house').value.trim();
            const city = document.getElementById('addr-city').value.trim();
            const district = document.getElementById('addr-district').value.trim();
            const country = document.getElementById('addr-country').value.trim();
            if(!house || !city || !district || !country) return alert('fill all address fields');
            
            const addr = {house,city,district,country};
            
            db.ref('users/'+currentUser.uid+'/address').set(addr).then(()=>{
                alert('address saved successfully');
                toggleAddressEdit(true);
            }).catch(e=>{
                alert('address save failed. Check Firebase rules: ' + e.message);
                console.error('Address save failed:', e);
            });
        }

        // ---------- products (Updated rendering for look and feel) ----------
        function calcDiscountPrice(price, discount){
            if(!price) return 0;
            const p = Number(price);
            if(!discount) return p;
            return Math.round((p * (100 - Number(discount))) / 100);
        }

        function loadProducts(){
            db.ref('products').on('value', snap => {
                productsData = snap.val() || {};

                // FIX: convert string images ‚Üí array images, and add default rating/reviews
                Object.keys(productsData).forEach(id => {
                    const p = productsData[id];
                    if (typeof p.images === "string") {
                        p.images = p.images.split(',').map(x => x.trim());
                    }
                    if (!p.rating) p.rating = (Math.random() * 2 + 3).toFixed(1); // Default rating 3.0 to 5.0
                    if (!p.reviews_count) p.reviews_count = Math.floor(Math.random() * 50) + 10;
                });

                const keys = Object.keys(productsData || {});
                renderProducts(keys.reverse());
                populateCategories();
                updateLatestPreview();
            });
        }
        
        // Wishlist Toggle
        function toggleWishlist(e, pid) {
            e.stopPropagation();
            if (wishlist[pid]) {
                delete wishlist[pid];
                e.currentTarget.innerHTML = `<i class="ri-heart-line"></i>`;
            } else {
                wishlist[pid] = true;
                e.currentTarget.innerHTML = `<i class="ri-heart-fill" style="color:red;"></i>`;
            }
            saveWishlistToDb();
            if (document.getElementById('wishlist').classList.contains('active')) loadWishlist(); // Reload if on wishlist tab
        }

        function isProductInWishlist(pid) {
            return !!wishlist[pid];
        }

        function renderRatingStars(rating) {
            const fullStars = Math.floor(rating);
            let html = '';
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    html += `<i class="ri-star-fill"></i>`;
                } else if (i === fullStars && rating % 1 !== 0) {
                    html += `<i class="ri-star-half-fill"></i>`;
                } else {
                    html += `<i class="ri-star-line"></i>`;
                }
            }
            return html;
        }

        function updateLatestPreview(){
            db.ref('products').limitToLast(6).once('value').then(snap=>{
                const data = snap.val()||{};
                const keys = Object.keys(data||{}).reverse();
                const cont = document.getElementById('latest-products'); cont.innerHTML='';
                keys.forEach(k=>{
                    const p = data[k];
                    p.images = Array.isArray(p.images) ? p.images : Object.values(p.images || {});
                    const price = calcDiscountPrice(p.price, p.discount);
                    const div = document.createElement('div'); div.className='card product-card-inner';
                    div.innerHTML = `
                        <img class="product-img" src="${(p.images && p.images[0])||'https://via.placeholder.com/300'}" alt="${p.name}">
                        <div class="pmeta">
                            <div class="pname" title="${p.name}">${p.name}</div>
                            <div class="pprice">‚Çπ${price}</div>
                        </div>
                        <div class="small" style="font-size:11px;">
                             <span class="rating" style="font-size:11px;">${renderRatingStars(p.rating)}</span> ${p.rating}
                        </div>
                        <div class="product-actions">
                             <button class="btn" onclick="addToCart('${k}')" style="flex:1;"><i class="ri-add-line"></i> Cart</button>
                             <button class="btn secondary" onclick="openProductModal('${k}')" style="min-width:40px;"><i class="ri-eye-line"></i></button>
                             <button class="btn secondary" onclick="toggleWishlist(event, '${k}')" title="Wishlist">${isProductInWishlist(k) ? `<i class="ri-heart-fill" style="color:red;"></i>` : `<i class="ri-heart-line"></i>`}</button>
                        </div>
                    `;
                    cont.appendChild(div);
                });
            });
        }

        function renderProducts(keys){
            const cont = document.getElementById('product-list'); 
            cont.innerHTML='';

            if(!keys || keys.length===0){ 
                cont.innerHTML = '<div class="card" style="grid-column: 1 / -1;">no products found</div>'; 
                return; 
            }

            keys.forEach(k=>{
                const p = productsData[k];

                const priceHtml = `
                    <div style="display:flex;align-items:center;gap:8px">
                        <div class="pprice">‚Çπ${calcDiscountPrice(p.price,p.discount)}</div>
                        ${p.discount ? `<div class="small" style="text-decoration:line-through;color:#888;font-size:11px;">‚Çπ${p.price}</div>
                        <div class="small" style="color:#e60000;font-size:11px;">${p.discount}% OFF</div>` : ''}
                    </div>
                `;

                const card = document.createElement('div'); 
                card.className='card product-card-inner';

                card.innerHTML = `
                    <img class="product-img" src="${(p.images && p.images[0])||'https://via.placeholder.com/300'}" alt="${p.name}" />
                    <div class="pmeta">
                        <div class="pname" title="${p.name}">${p.name}</div>
                        ${priceHtml}
                    </div>
                    <div class="small" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>${p.brand ? p.brand : ''} ${p.color ? '‚Ä¢ '+p.color : ''} ${p.size ? '‚Ä¢ '+p.size : ''}</div>
                        <div class="rating" style="font-size:11px;">${renderRatingStars(p.rating)}</div>
                    </div>

                    <div class="product-actions">
                        <button class="btn" onclick="addToCart('${k}')" style="flex:1;"><i class="ri-add-line"></i> Cart</button>
                        <button class="btn secondary" onclick="openProductModal('${k}')" style="min-width:40px;"><i class="ri-eye-line"></i></button>
                        <button class="btn secondary" onclick="toggleWishlist(event, '${k}')" title="Wishlist">${isProductInWishlist(k) ? `<i class="ri-heart-fill" style="color:red;"></i>` : `<i class="ri-heart-line"></i>`}</button>
                    </div>
                `;

                cont.appendChild(card);
            });
        }   

        function openProductModal(id){
            const p = productsData[id];
            if(!p) return alert('product not found');

            modalProductId = id;

            document.getElementById('modal-title').innerText = p.name;
            document.getElementById('modal-price').innerText = 
                `‚Çπ${calcDiscountPrice(p.price,p.discount)} ${p.discount ? '(was ‚Çπ'+p.price+')':''}`;

            const imgs = document.getElementById('modal-images'); 
            imgs.innerHTML='';
            (p.images||[]).forEach(url=>{
                const img = document.createElement('img'); 
                img.src = url; 
                imgs.appendChild(img);
            });

            document.getElementById('modal-desc').innerText = p.description || '';
            document.getElementById('modal-rating').innerHTML = renderRatingStars(p.rating) + ' ' + p.rating;
            document.getElementById('modal-reviews-count').innerText = `(${p.reviews_count} Reviews)`;


            document.getElementById('modal-meta').innerText = 
                `category: ${p.category ? categoriesData[p.category]?.name || p.category : 'N/A'} ‚Ä¢ brand: ${p.brand||'N/A'} ${p.color ? '‚Ä¢ color: '+p.color : ''} ${p.size ? '‚Ä¢ size: '+p.size : ''}`;

            openOverlay();
        }

        function populateCategories(){
            const sel = document.getElementById('category-filter');
            const sel2 = document.getElementById('cat-shop');

            [sel, sel2].forEach(s=>{
                if(!s) return;

                s.innerHTML = '<option value="">all categories</option>';

                Object.keys(CATEGORIES_LIST).forEach(catId=>{
                    const cat = CATEGORIES_LIST[catId];
                    const opt = document.createElement('option');
                    opt.value = catId;
                    opt.innerText = `üì¶ ${cat.name}`;
                    s.appendChild(opt);
                });
            });
        }

        function filterByCategory(cat){
            document.getElementById('category-filter').value = cat;
            document.getElementById('cat-shop').value = cat;
            searchShop(); 
            showTab('shop');
        }
        function searchShop(){
            const q = (document.getElementById('search-shop').value || document.getElementById('search-input').value).trim().toLowerCase();
            const cat = (document.getElementById('cat-shop').value || document.getElementById('category-filter').value);
            const sort = document.getElementById('sort-shop').value;

            let keys = Object.keys(productsData||{});
            keys = keys.filter(k=>{
                const p = productsData[k];
                if(!p) return false;
                if(cat && p.category!==cat) return false;
                if(!q) return true;
                const text = `${p.name} ${p.description} ${p.brand||''} ${p.color||''} ${p.category||''}`.toLowerCase();
                return text.indexOf(q) !== -1;
            });
            
            // Apply sorting (New Feature)
            keys.sort((a, b) => {
                const pA = productsData[a];
                const pB = productsData[b];
                const priceA = calcDiscountPrice(pA.price, pA.discount);
                const priceB = calcDiscountPrice(pB.price, pB.discount);

                if (sort === 'price_asc') return priceA - priceB;
                if (sort === 'price_desc') return priceB - priceA;
                return pB.created_at - pA.created_at; // Newest (default)
            });

            renderProducts(keys);
        }

        // ---------- cart (Fixed) ----------
        function addToCart(pid){
            cart[pid] = (cart[pid]||0)+1;
            saveCartToDb();
            renderCart();
            updateCartCount();
            alert('item added to cart');
        }
        function modalAddToCart(){
            if(modalProductId) addToCart(modalProductId);
            closeOverlay();
        }
        function renderCart(){
            const cont = document.getElementById('cart-list'); cont.innerHTML='';
            let subtotal = 0;
            const cartKeys = Object.keys(cart);
            if(cartKeys.length === 0) {
                cont.innerHTML = '<div class="card" style="text-align:center;padding:20px;">Your cart is empty. Start shopping!</div>';
                document.getElementById('cart-subtotal').innerText = 0;
                return;
            }

            cartKeys.forEach(pid=>{
                const p = productsData[pid];
                if(!p) return;
                const qty = cart[pid];
                const price = calcDiscountPrice(p.price,p.discount);
                subtotal += Number(price || 0) * qty;
                const div = document.createElement('div'); div.className='card';
                div.innerHTML = `
                    <img src="${(p.images && p.images[0])||'https://via.placeholder.com/100'}" />
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;align-items:center"><strong>${p.name}</strong><div>‚Çπ${price * qty}</div></div>
                        <div class="small-muted">unit: ‚Çπ${price}</div>
                        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                            <div class="small">qty: <strong>${qty}</strong></div>
                            <button class="btn secondary" onclick="decrement('${pid}')" style="padding:6px 10px;">-</button>
                            <button class="btn" onclick="increment('${pid}')" style="padding:6px 10px;">+</button>
                            <button class="btn secondary" onclick="removeFromCart('${pid}')" style="padding:6px 10px;margin-left:auto;"><i class="ri-delete-bin-line"></i></button>
                        </div>
                    </div>
                `;
                cont.appendChild(div);
            });
            document.getElementById('cart-subtotal').innerText = subtotal;
            updateCartCount();
        }

        function increment(pid){ cart[pid] = (cart[pid]||0)+1; saveCartToDb(); renderCart(); }
        function decrement(pid){ if(!cart[pid]) return; cart[pid] = cart[pid]-1; if(cart[pid]<=0) delete cart[pid]; saveCartToDb(); renderCart(); }
        function removeFromCart(pid){ delete cart[pid]; saveCartToDb(); renderCart(); }
        function clearCart(){ cart = {}; saveCartToDb(); renderCart(); }
        function saveCartToDb(){ if(currentUser) db.ref('carts/'+currentUser.uid).set(cart); }
        function loadCartFromDb(){
            if(!currentUser) return;
            db.ref('carts/'+currentUser.uid).on('value',snap=>{
                cart = snap.val() || {};
                renderCart();
            });
        }
        function updateCartCount(){
            const count = Object.values(cart).reduce((s,v)=>s+v,0);
            const el = document.getElementById('cart-count');
            if(count>0){ el.style.display='flex'; el.innerText = count; } else { el.style.display='none'; }
        }
        
        // ---------- Wishlist (New) ----------
        function saveWishlistToDb(){ if(currentUser) db.ref('users/'+currentUser.uid+'/wishlist').set(wishlist); }
        function loadWishlistFromDb(){
            if(!currentUser) return;
            db.ref('users/'+currentUser.uid+'/wishlist').on('value',snap=>{
                wishlist = snap.val() || {};
                updateLatestPreview(); // Update heart icons on home
            });
        }
        function loadWishlist(){
            const cont = document.getElementById('wishlist-list'); 
            cont.innerHTML = '';
            const wishlistKeys = Object.keys(wishlist).filter(k => wishlist[k]);
            
            if (wishlistKeys.length === 0) {
                 cont.innerHTML = '<div class="card" style="grid-column: 1 / -1; text-align:center;">Your wishlist is empty. Start adding products!</div>';
                 return;
            }

            const wishlistProducts = wishlistKeys.map(k => productsData[k]).filter(p => p);
            
            wishlistProducts.forEach(p => {
                const k = Object.keys(productsData).find(key => productsData[key] === p);
                const priceHtml = `...`; // Reusing product rendering logic for clean code, simplified here
                const card = document.createElement('div'); 
                card.className='card product-card-inner';

                card.innerHTML = `
                    <img class="product-img" src="${(p.images && p.images[0])||'https://via.placeholder.com/300'}" alt="${p.name}" />
                    <div class="pmeta">
                        <div class="pname" title="${p.name}">${p.name}</div>
                        <div class="pprice">‚Çπ${calcDiscountPrice(p.price, p.discount)}</div>
                    </div>
                    <div class="small" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>${p.brand ? p.brand : ''}</div>
                        <div class="rating" style="font-size:11px;">${renderRatingStars(p.rating)}</div>
                    </div>

                    <div class="product-actions">
                        <button class="btn" onclick="addToCart('${k}')" style="flex:1;"><i class="ri-add-line"></i> Cart</button>
                        <button class="btn secondary" onclick="openProductModal('${k}')" style="min-width:40px;"><i class="ri-eye-line"></i></button>
                        <button class="btn secondary" onclick="toggleWishlist(event, '${k}')" title="Remove from Wishlist"><i class="ri-heart-fill" style="color:red;"></i></button>
                    </div>
                `;
                cont.appendChild(card);
            });
        }

        // ---------- checkout / orders (Added Order Details Click) ----------
        async function openCheckoutModal(){
            if(Object.keys(cart).length===0) return alert('cart empty');
            // Populate Checkout Address Form
            const userSnap = await db.ref('users/'+currentUser.uid+'/address').once('value');
            const address = userSnap.val() || {};
            document.getElementById('co-addr-house').value = address.house || '';
            document.getElementById('co-addr-city').value = address.city || '';
            document.getElementById('co-addr-district').value = address.district || '';
            document.getElementById('co-addr-country').value = address.country || '';

            // Populate Checkout Items
            const checkoutItemsDiv = document.getElementById('checkout-items');
            checkoutItemsDiv.innerHTML = '';
            let subtotal = 0;
            Object.keys(cart).forEach(pid => {
                const p = productsData[pid];
                if(!p) return;
                const qty = cart[pid];
                const price = calcDiscountPrice(p.price,p.discount);
                subtotal += Number(price || 0) * qty;

                checkoutItemsDiv.innerHTML += `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span class="small-muted">${p.name.substring(0, 25)}... x ${qty}</span>
                        <span style="font-weight:600;">‚Çπ${price * qty}</span>
                    </div>
                `;
            });
            checkoutItemsDiv.innerHTML += `<div style="border-top:1px solid #ccc; margin-top:5px; padding-top:5px; display:flex; justify-content:space-between;"><strong>Total:</strong> <strong>‚Çπ${subtotal}</strong></div>`;

            document.getElementById('checkout-overlay').style.display = 'flex';
        }

        async function confirmCheckout(){
            const utr = (document.getElementById('checkout-utr').value||'').trim();
            if(!utr || utr.length !== 12) return alert('enter valid 12-digit UTR');
            
            // Get/Save Address from Checkout form
            const house = document.getElementById('co-addr-house').value.trim();
            const city = document.getElementById('co-addr-city').value.trim();
            const district = document.getElementById('co-addr-district').value.trim();
            const country = document.getElementById('co-addr-country').value.trim();
            if(!house || !city || !district || !country) return alert('fill all delivery address fields');
            
            const addr = {house,city,district,country};
            await db.ref('users/'+currentUser.uid+'/address').set(addr); // Save address to profile

            const orderId = 'o'+Date.now();
            const subtotal = Number(document.getElementById('cart-subtotal').innerText) || 0;
            if(subtotal === 0) return alert('cart is empty');

            // Collect full product details for the order for admin/user ease (name, price, etc.)
            const detailedItems = {};
            Object.keys(cart).forEach(pid => {
                const p = productsData[pid];
                if (p) {
                    detailedItems[pid] = {
                        qty: cart[pid],
                        name: p.name,
                        price: calcDiscountPrice(p.price, p.discount),
                        image: (p.images && p.images[0]) || 'https://via.placeholder.com/50'
                    };
                }
            });

            const order = {
                id: orderId,
                user: currentUser.uid,
                items: detailedItems, // Storing detailed items
                total: subtotal,
                address: addr,
                utr,
                status: 'payment_pending',
                created_at: Date.now()
            };
            
            await db.ref('orders/'+orderId).set(order);
            await db.ref('users/'+currentUser.uid+'/order_history/'+orderId).set(order);
            await db.ref('payment_requests/'+orderId).set({type:'cart', user:currentUser.uid, orderId, amount: subtotal, utr, status:'pending', created_at:Date.now()});
            
            cart = {}; saveCartToDb(); renderCart();
            closeCheckoutModal();
            alert('order request sent. Payment is pending admin verification.');
            showTab('profile'); loadOrderHistory();
        }

        // ... (rest of gold, wallet, refer, kyc, chat functions are the same) ...
        function buyGold(){
            const amount = Number(document.getElementById('gold-amount').value);
            const utr = (document.getElementById('gold-utr').value||'').trim();
            if(!amount || amount < REFERRAL_GOLD_MIN) return alert(`minimum ‚Çπ${REFERRAL_GOLD_MIN} gold purchase required`);
            if(!utr || utr.length !== 12) return alert('enter 12-digit utr');
            
            const id = 'g'+Date.now();
            const grams = (amount / GOLD_RATE).toFixed(4);
            const payload = { id, user: currentUser.uid, amount, gold_rate: GOLD_RATE, grams: Number(grams), utr, status: 'pending', created_at: Date.now() };
            
            db.ref('gold_requests/'+id).set(payload);
            db.ref('users/'+currentUser.uid+'/gold_history/'+id).set(payload);
            db.ref('payment_requests/'+id).set({type:'gold', user:currentUser.uid, id, amount, utr, status:'pending', created_at:Date.now()});
            
            alert('gold purchase request sent to admin');
            
            document.getElementById('gold-amount').value = '';
            document.getElementById('gold-utr').value = '';
            document.getElementById('gold-grams-calc').innerText = '0.0000 g';
            showHistory('gold');
        }
        function addWallet(){
            const amount = Number(document.getElementById('wallet-add-amount').value);
            const utr = (document.getElementById('wallet-utr').value||'').trim();
            if(!amount || amount < 10) return alert('enter valid amount (min 10)');
            if(!utr || utr.length !== 12) return alert('enter 12-digit utr');
            
            const id = 'w_add_'+Date.now();
            const req = { id, user: currentUser.uid, amount, utr, status:'pending', type:'add', created_at: Date.now() };
            
            db.ref('wallet_requests/'+id).set(req);
            db.ref('users/'+currentUser.uid+'/wallet_history/'+id).set(req);
            db.ref('payment_requests/'+id).set({type:'wallet', user:currentUser.uid, id, amount, utr, status:'pending', created_at:Date.now()});
            
            alert('wallet add request sent to admin');
            
            document.getElementById('wallet-add-amount').value = '';
            document.getElementById('wallet-utr').value = '';
            showHistory('wallet');
        }
        function submitWithdraw(){
            const amount = Number(document.getElementById('withdraw-amount').value);
            const note = (document.getElementById('withdraw-note').value||'').trim();
            const currentBalance = Number(document.getElementById('withdraw-balance').innerText);

            if(!amount || amount < 50) return alert('min withdraw ‚Çπ50');
            if(amount > currentBalance) return alert('withdraw amount exceeds wallet balance');
            if(!note) return alert('UPI/Account details required for admin to process');

            const wid = 'w_wd_'+Date.now();
            const payload = { id: wid, user: currentUser.uid, amount, note, status:'pending', type:'withdraw', created_at: Date.now() };
            
            db.ref('users/'+currentUser.uid+'/wallet').transaction(curr => (curr || 0) - amount);

            db.ref('withdrawRequests/'+wid).set(payload);
            db.ref('users/'+currentUser.uid+'/wallet_history/'+wid).set(payload);
            
            alert('withdraw request sent to admin. Amount deducted and pending admin approval.');
            closeWithdrawModal();
            showHistory('wallet');
        }
        function submitRefer(){
            const name = document.getElementById('refer-friend-name').value.trim();
            const mobile = document.getElementById('refer-friend-mobile').value.trim();
            
            if(!name || !mobile) return alert('fill friend details');

            const id = 'r'+Date.now();
            const req = { id, user: currentUser.uid, name, mobile, status:'pending', created_at: Date.now() };

            db.ref('refer_cash_requests/'+id).set(req);
            db.ref('users/'+currentUser.uid+'/refer_history/'+id).set(req);

            alert('refer request sent to admin');
            document.getElementById('refer-friend-name').value = '';
            document.getElementById('refer-friend-mobile').value = '';
            showHistory('refer');
        }
        async function uploadKYC(){
            const existingSnap = await db.ref('users/'+currentUser.uid+'/kyc').once('value');
            const existing = existingSnap.val();
            if(existing && existing.status === 'verified') return alert('KYC already verified ‚Äî cannot resubmit');

            const name = document.getElementById('kyc-name').value.trim();
            const number = document.getElementById('kyc-number').value.trim();
            const front = document.getElementById('kyc-front').files[0];
            const back = document.getElementById('kyc-back').files[0];

            if(!name || !number || number.length !== 12 || !front || !back) return alert('fill all kyc fields correctly (Aadhaar number must be 12 digits)');

            try {
                // Upload Front
                let f1 = new FormData(); f1.append('image', front);
                const r1 = await axios.post('https://api.imgbb.com/1/upload?key='+imgbbKey, f1);
                const u1 = r1.data.data.url;

                // Upload Back
                let f2 = new FormData(); f2.append('image', back);
                const r2 = await axios.post('https://api.imgbb.com/1/upload?key='+imgbbKey, f2);
                const u2 = r2.data.data.url;

                const id = 'k'+Date.now();
                const payload = {
                    id, user: currentUser.uid, name, number,
                    front_url: u1, back_url: u2,
                    status:'pending',
                    created_at: Date.now()
                };

                await db.ref('kyc_requests/'+id).set(payload);
                await db.ref('users/'+currentUser.uid+'/kyc').set({status:'pending', id, number});

                alert('kyc submitted to admin successfully');
                document.getElementById('kyc-status').innerText = 'submitted (pending)';
            } catch(e) {
                alert('KYC submission failed (upload error or Firebase error).');
                console.error('KYC failed:', e);
            }
        }
        function showKYCStatus(){
            db.ref('users/'+currentUser.uid+'/kyc').once('value').then(snap=>{
                const v = snap.val();
                if(!v || !v.id) return alert('no kyc submitted');

                db.ref('kyc_requests/'+v.id).once('value').then(snap2=>{
                    const r = snap2.val();
                    alert(`status: ${r.status.toUpperCase()}
admin_note: ${r.admin_note||'none'}`);
                }).catch(e => {
                    alert('Could not fetch detailed status.');
                    console.error(e);
                });
            });
        }
        
        // --- NEW LOAN DASHBOARD LOGIC ---

        // Helper function to switch views in the dashboard
        function showLoanView(view) {
            document.querySelectorAll('#loan-dashboard-content > div').forEach(div => {
                div.classList.add('field-hidden');
            });
            document.getElementById(`loan-view-${view}`).classList.remove('field-hidden');
            
            // Update Step Indicators
            document.querySelectorAll('.loan-step').forEach(step => step.classList.remove('active'));
            if (view === 'verification') document.getElementById('loan-step-1').classList.add('active');
            if (view === 'calculator') document.getElementById('loan-step-2').classList.add('active');
            if (view === 'offer') document.getElementById('loan-step-3').classList.add('active');
            if (view === 'agreement') document.getElementById('loan-step-4').classList.add('active');
            if (view === 'emi-plan') document.getElementById('loan-step-5').classList.add('active');
        }

        // Simulates the five-step verification save/submit
        function saveLoanStep1() {
            const email = document.getElementById('loan-email-step').value.trim();
            const dob = document.getElementById('loan-dob-step').value.trim();
            if (!email || !dob) return alert('Please enter email and DOB.');

            db.ref('users/' + currentUser.uid + '/loan_verification/step1').set({ email, dob, completed: true }).then(() => {
                alert('Basic Info Saved.');
                loadLoanDashboardState();
            });
        }
        async function submitLoanStep2() {
            const pan = document.getElementById('loan-pan-number').value.trim();
            const front = document.getElementById('loan-aadhaar-front').files[0];
            const back = document.getElementById('loan-aadhaar-back').files[0];
            const panPhoto = document.getElementById('loan-pan-photo').files[0];

            if(!pan || pan.length !== 10 || !front || !back || !panPhoto) return alert('Fill all identity fields (PAN must be 10 digits and upload all photos).');
            
            alert('Identity Uploading (Demo: This will take time in a real app).');
            // Simplified: In a real app, this would upload the 3 files.
            db.ref('users/' + currentUser.uid + '/loan_verification/step2').set({ pan, files_uploaded: true, completed: true }).then(() => {
                alert('Identity Verification Submitted.');
                loadLoanDashboardState();
            });
        }
        async function submitLoanStep3() {
            const bank = document.getElementById('loan-account-number').value.trim();
            const ifsc = document.getElementById('loan-ifsc-code').value.trim();
            const passbook = document.getElementById('loan-passbook-photo').files[0];

            if(!bank || !ifsc || !passbook) return alert('Fill all bank details and upload passbook photo.');
            
            alert('Bank KYC Submitted (Demo).');
            db.ref('users/' + currentUser.uid + '/loan_verification/step3').set({ bank, ifsc, completed: true }).then(() => {
                alert('Bank KYC Submitted.');
                loadLoanDashboardState();
            });
        }
        async function submitLoanStep4() {
            const salary = document.getElementById('loan-salary').value.trim();
            if(!salary || Number(salary) < 1) return alert('Enter a valid monthly income.');

            alert('Employment Details Submitted (Demo).');
            db.ref('users/' + currentUser.uid + '/loan_verification/step4').set({ salary: Number(salary), completed: true }).then(() => {
                alert('Employment Details Submitted.');
                loadLoanDashboardState();
            });
        }
        async function submitLoanStep5() {
            const perm = document.getElementById('loan-perm-addr').value.trim();
            const curr = document.getElementById('loan-curr-addr').value.trim();
            if(!perm || !curr) return alert('Enter both permanent and current addresses.');

            alert('Address Saved (Demo).');
            db.ref('users/' + currentUser.uid + '/loan_verification/step5').set({ perm, curr, completed: true }).then(() => {
                alert('Address Saved.');
                loadLoanDashboardState();
            });
        }

        // Loan Calculator Logic
        function updateLoanCalc() {
            const amount = Number(document.getElementById('calc-amount-range').value);
            const tenure = Number(document.getElementById('calc-tenure-range').value);

            // Simple Flat Interest Calculation (for display purposes)
            const rate = LOAN_ROI_PER_MONTH;
            const totalInterest = amount * rate * tenure;
            const totalRepayment = amount + totalInterest;
            const emi = totalRepayment / tenure;

            document.getElementById('calc-amount-display').innerText = amount.toLocaleString();
            document.getElementById('calc-tenure-display').innerText = tenure;
            document.getElementById('calc-roi-display').innerText = (rate * 100).toFixed(1);
            document.getElementById('calc-emi-display').innerText = Math.round(emi).toLocaleString();
        }

        // Submit New Loan Application
        async function submitNewLoanApplication() {
            const amount = Number(document.getElementById('calc-amount-range').value);
            const tenure = Number(document.getElementById('calc-tenure-range').value);
            
            if (amount < LOAN_MIN_AMOUNT) return alert(`Loan amount must be at least ‚Çπ${LOAN_MIN_AMOUNT}`);

            const loanId = 'loan_'+Date.now();
            const payload = {
                id: loanId,
                user: currentUser.uid,
                requested_amount: amount,
                requested_tenure: tenure,
                status: 'pending',
                created_at: Date.now()
            };

            await db.ref('loan_requests/'+loanId).set(payload);
            await db.ref('users/'+currentUser.uid+'/loan_application').set({id: loanId, status:'pending'});
            
            alert('Loan application submitted for review.');
            loadLoanDashboardState();
        }

        // Accept/Reject Loan Offer (Step 3/4)
        async function acceptLoanOffer() {
            const agreementCheck = document.getElementById('agreement-check').checked;
            const signature = document.getElementById('agreement-signature').value.trim();
            const loanId = document.getElementById('loan-dashboard-overlay').dataset.activeLoanId;

            if (!agreementCheck) return alert('You must agree to the terms and conditions.');
            if (!signature) return alert('Please enter your full name as digital signature.');

            if (!confirm('Are you sure you want to accept this loan offer and sign the agreement?')) return;

            // 1. Update Loan Status
            await db.ref('loan_requests/' + loanId).update({
                status: 'approved',
                agreement_signed_at: Date.now(),
                digital_signature: signature,
            });
            await db.ref('users/' + currentUser.uid + '/loan_application/status').set('approved');

            // 2. Simulate EMI Schedule creation (Admin function, simplified here)
            const offer = loanDetailsCache;
            const emiAmount = Math.round(offer.total_repayment / offer.tenure);
            const emiDetails = {};
            let currentDate = new Date();
            currentDate.setDate(currentDate.getDate() + 30); // First EMI due in 30 days

            for (let i = 1; i <= offer.tenure; i++) {
                const emiId = `emi_${loanId}_${i}`;
                emiDetails[emiId] = {
                    id: emiId,
                    loan_id: loanId,
                    amount: emiAmount,
                    due_date: currentDate.getTime(),
                    status: 'due',
                    emi_number: i
                };
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            await db.ref('users/' + currentUser.uid + '/loan_emis').set(emiDetails);
            
            // 3. Disburse Loan (Credit Wallet)
            const creditAmount = offer.net_disbursal;
            await db.ref('users/' + currentUser.uid + '/wallet').transaction(curr => (curr || 0) + creditAmount);
            const creditId = 'loan_credit_' + Date.now();
            await db.ref('users/' + currentUser.uid + '/wallet_history/' + creditId).set({id:creditId, amount:creditAmount, type:'loan_credit', status:'completed', note:'Loan Disbursal', created_at:Date.now()});


            alert(`Loan accepted! ‚Çπ${creditAmount} disbursed to your wallet. EMI schedule created.`);
            loadLoanDashboardState();
        }

        async function rejectLoanOffer() {
            const loanId = document.getElementById('loan-dashboard-overlay').dataset.activeLoanId;
            if (!confirm('Are you sure you want to reject this loan offer?')) return;

            await db.ref('loan_requests/' + loanId).update({ status: 'rejected' });
            await db.ref('users/' + currentUser.uid + '/loan_application').set({id: loanId, status:'rejected'});
            alert('Loan offer rejected.');
            loadLoanDashboardState();
        }
        
        // Foreclosure Request
        async function requestLoanForeclosure() {
            const loanId = document.getElementById('loan-dashboard-overlay').dataset.activeLoanId;
            const remainingBalance = Number(document.getElementById('tracker-balance').innerText);
            
            if (remainingBalance <= 0) return alert('Loan is already fully repaid!');
            if (!confirm(`Are you sure you want to request foreclosure? Remaining balance is ~‚Çπ${remainingBalance.toFixed(0)}.`)) return;

            const closureId = 'foreclosure_'+Date.now();
            const payload = { id: closureId, loanId, user: currentUser.uid, status: 'pending', amount: remainingBalance.toFixed(2), created_at: Date.now() };

            await db.ref('loan_closure_requests/'+closureId).set(payload);
            await db.ref('loan_requests/' + loanId).update({ status: 'pending_closure' });

            alert('Foreclosure request sent to admin. You will be notified with the final amount to pay.');
            loadLoanDashboardState();
        }

        // Main Loan Dashboard Loader
        let loanDetailsCache = null;
        async function loadLoanDashboardState() {
            const userLoanSnap = await db.ref('users/' + currentUser.uid + '/loan_application').once('value');
            const userLoan = userLoanSnap.val() || {};
            const verificationSnap = await db.ref('users/' + currentUser.uid + '/loan_verification').once('value');
            const verificationData = verificationSnap.val() || {};

            const stepsCompleted = Object.keys(verificationData).filter(k => verificationData[k].completed).length;
            document.querySelectorAll('.loan-step').forEach((el, i) => {
                el.classList.remove('completed', 'active');
                if (i < stepsCompleted) el.classList.add('completed');
            });
            document.getElementById('verification-messages').innerHTML = `**${stepsCompleted}/5 Steps Completed.** You need to complete all steps to apply.`;

            // --- Check Loan Status and Navigate View ---

            if (!userLoan.id || userLoan.status === 'rejected' || userLoan.status === 'closed') {
                // No active loan / Rejected / Closed - Show Verification or Calculator
                if (stepsCompleted < 5) {
                    showLoanView('verification');
                } else {
                    showLoanView('calculator');
                }
                document.getElementById('loan-status-view').classList.add('field-hidden');
                document.getElementById('loan-request-view').classList.remove('field-hidden');
                return;
            }

            const loanReqSnap = await db.ref('loan_requests/' + userLoan.id).once('value');
            const loanDetails = loanReqSnap.val();
            loanDetailsCache = loanDetails; // Cache for offer acceptance

            document.getElementById('loan-dashboard-overlay').dataset.activeLoanId = userLoan.id;
            
            if (loanDetails.status === 'pending') {
                showLoanView('offer');
                document.getElementById('loan-offer-pending').innerText = `Loan application for ‚Çπ${loanDetails.requested_amount} is under review.`;
                document.getElementById('loan-offer-pending').classList.remove('field-hidden');
                document.getElementById('loan-offer-display').classList.add('field-hidden');
            } 
            else if (loanDetails.status === 'reviewed') {
                // Offer is ready
                showLoanView('offer');
                document.getElementById('loan-offer-pending').classList.add('field-hidden');
                document.getElementById('loan-offer-display').classList.remove('field-hidden');

                // Simulate Admin Approval Params
                const approvedAmount = loanDetails.approved_amount || loanDetails.requested_amount;
                const tenure = loanDetails.tenure || loanDetails.requested_tenure;
                const roi = loanDetails.roi || 0.015; // 1.5% p.m.
                const fee = approvedAmount * 0.02; // 2% fee

                const totalInterest = approvedAmount * roi * tenure;
                const totalRepayment = approvedAmount + totalInterest;
                const emi = totalRepayment / tenure;
                const netDisbursal = approvedAmount - fee;

                document.getElementById('offer-approved-amount').innerText = approvedAmount.toLocaleString();
                document.getElementById('offer-roi').innerText = (roi * 100).toFixed(1);
                document.getElementById('offer-tenure').innerText = tenure;
                document.getElementById('offer-fee').innerText = fee.toFixed(2);
                document.getElementById('offer-net-disbursal').innerText = netDisbursal.toFixed(2);
                document.getElementById('offer-emi').innerText = Math.round(emi).toLocaleString();

                loanDetailsCache = { ...loanDetails, approved_amount: approvedAmount, tenure, roi, total_repayment: totalRepayment, net_disbursal: netDisbursal, emi: Math.round(emi) };

            } 
            else if (loanDetails.status === 'approved' || loanDetails.status === 'pending_closure') {
                // Active Loan / EMI Plan
                showLoanView('emi-plan');
                
                db.ref('users/'+currentUser.uid+'/loan_emis').on('value', emiSnap => {
                    const emis = emiSnap.val() || {};
                    const emiArray = Object.values(emis).sort((a,b) => a.due_date - b.due_date);
                    
                    const paidAmount = emiArray.filter(e => e.status === 'paid').reduce((sum, e) => sum + e.amount, 0);
                    const remainingEmis = emiArray.filter(e => e.status !== 'paid').length;
                    const remainingAmount = emiArray.filter(e => e.status !== 'paid').reduce((sum, e) => sum + e.amount, 0);
                    
                    document.getElementById('tracker-status').innerText = loanDetails.status === 'approved' ? 'Active' : 'Closure Requested';
                    document.getElementById('tracker-balance').innerText = remainingAmount.toFixed(2);
                    document.getElementById('tracker-loan-id').innerText = loanDetails.id;
                    
                    const nextEmi = emiArray.find(e => e.status !== 'paid');
                    if (nextEmi) {
                        const dueDate = nextEmi.due_date;
                        document.getElementById('tracker-next-emi-date').innerText = new Date(dueDate).toLocaleDateString();
                        
                        // Start/Update Timer
                        clearInterval(loanTimer);
                        loanTimer = setInterval(() => {
                            const diff = dueDate - Date.now();
                            if (diff < 0) {
                                document.getElementById('tracker-timer').innerText = 'OVERDUE!';
                                clearInterval(loanTimer);
                            } else {
                                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                document.getElementById('tracker-timer').innerText = `${days}d ${hours}h ${minutes}m`;
                            }
                        }, 60000); // Update every minute
                    } else {
                         document.getElementById('tracker-next-emi-date').innerText = 'Fully Repaid!';
                         document.getElementById('tracker-timer').innerText = '';
                    }

                    // Render EMI Schedule
                    const scheduleDiv = document.getElementById('loan-emi-schedule-list');
                    scheduleDiv.innerHTML = '';
                    emiArray.forEach(emi => {
                        const isPaid = emi.status === 'paid';
                        const isOverdue = !isPaid && emi.due_date < Date.now();
                        const statusColor = isPaid ? '#10b981' : isOverdue ? '#ef4444' : '#3b82f6';
                        const actionButton = isPaid ? '' : `<button class="btn secondary" style="padding:6px 10px;" onclick="openEmiPaymentModal('${emi.id}', ${emi.amount})"><i class="ri-wallet-line"></i> Pay Now</button>`;

                        scheduleDiv.innerHTML += `
                            <div class="card history" style="border-left: 4px solid ${statusColor}; margin-bottom:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <strong>EMI ${emi.emi_number}: ‚Çπ${emi.amount}</strong><br>
                                        <span class="small-muted">Due: ${new Date(emi.due_date).toLocaleDateString()}</span>
                                    </div>
                                    <div style="text-align:right;">
                                        ${renderStatusBadge(emi.status)}
                                        <div style="margin-top:5px;">${actionButton}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    // Render Payment History (Simplified to only show paid/pending)
                    const paymentHistoryDiv = document.getElementById('loan-payment-history');
                    paymentHistoryDiv.innerHTML = '<h5>Recent Payments</h5>';
                    emiArray.filter(e => e.status === 'paid' || e.status === 'pending_payment').forEach(emi => {
                        paymentHistoryDiv.innerHTML += `
                            <div class="card" style="border-left: 4px solid ${emi.status === 'paid' ? '#10b981' : '#f59e0b'}; margin-bottom:8px; padding:8px;">
                                <div style="display:flex; justify-content:space-between;">
                                    <strong>EMI ${emi.emi_number} Payment</strong>
                                    <span style="font-weight:600;">‚Çπ${emi.amount}</span>
                                </div>
                                <div class="small-muted" style="margin-top:2px;">
                                    ${emi.status === 'paid' ? 'Paid on '+ new Date(emi.paid_at || Date.now()).toLocaleDateString() : 'Pending UTR Verification'}
                                </div>
                            </div>
                        `;
                    });
                });
            }
        }

        async function submitEmiPayment() {
            const emiId = document.getElementById('emi-payment-overlay').dataset.emiId;
            const amount = document.getElementById('emi-payment-overlay').dataset.emiAmount;
            const utr = (document.getElementById('emi-utr').value || '').trim();

            if (!emiId || !amount) return alert('EMI details missing.');
            if (!utr || utr.length !== 12) return alert('Enter valid 12-digit UTR.');

            const paymentId = 'emi_pay_'+Date.now();
            const payload = {
                id: paymentId,
                emiId,
                user: currentUser.uid,
                amount: Number(amount),
                utr,
                status: 'pending',
                type: 'emi_repayment',
                created_at: Date.now()
            };

            // 1. Create payment request
            await db.ref('payment_requests/'+paymentId).set(payload);
            
            // 2. Update EMI status to pending_payment
            await db.ref('users/'+currentUser.uid+'/loan_emis/'+emiId+'/status').set('pending_payment');

            alert('EMI payment submitted. Pending admin verification.');
            closeEmiPaymentModal();
            loadLoanDashboardState(); // Reload loan status view
        }

        function loadChatHistory(){
            const chatDiv = document.getElementById('chat-messages');
            chatDiv.innerHTML = '';
            db.ref('chat_support/'+currentUser.uid).on('value', snap => {
                chatDiv.innerHTML = '';
                const messages = snap.val() || {};
                Object.values(messages).sort((a,b) => a.created_at - b.created_at).forEach(msg => {
                    const d = document.createElement('div');
                    const isUser = msg.sender === 'user';
                    d.style.textAlign = isUser ? 'right' : 'left';
                    d.style.marginBottom = '8px';
                    d.innerHTML = `
                        <div style="display:inline-block;padding:8px 12px;border-radius:12px;max-width:80%;
                            background:${isUser ? 'var(--gold)' : 'var(--card-bg)'};
                            color:${isUser ? 'var(--accent)' : 'var(--text-color)'};">
                            ${msg.message}
                            <div class="small-muted" style="margin-top:4px;font-size:10px;">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    `;
                    chatDiv.appendChild(d);
                });
                chatDiv.scrollTop = chatDiv.scrollHeight; // Scroll to bottom
            });
        }
        function sendChatMessage(){
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if(!message) return;

            const id = 'm'+Date.now();
            db.ref('chat_support/'+currentUser.uid+'/'+id).set({
                id, 
                sender: 'user', 
                message, 
                created_at: Date.now()
            }).then(() => {
                input.value = '';
            }).catch(e => {
                alert('failed to send message.');
                console.error(e);
            });
        }
        function showHistory(type){
            if(type==='orders') { showTab('profile'); loadOrderHistory(); }
            else if(type==='wallet') { showTab('wallet'); loadWalletHistory(); }
            else if(type==='gold') { showTab('gold'); loadGoldHistory(); }
            else if(type==='refer'){ showTab('profile'); loadReferHistory(); }
        }
        function renderStatusBadge(status){
            status = status || 'pending';
            const statusClass = {
                'payment_pending': 'badge-pending',
                'pending': 'badge-pending',
                'paid': 'badge-paid',
                'processing': 'badge-processing',
                'out_for_delivery': 'badge-processing',
                'delivered': 'badge-completed',
                'completed': 'badge-completed',
                'rejected': 'badge-rejected',
                'failed': 'badge-rejected',
                'withdraw': 'badge-withdraw',
                'add': 'badge-add',
                'bonus': 'badge-add',
                'loan_credit': 'badge-loan',
                'approved': 'badge-completed',
                'eligible_for_bonus': 'badge-eligible', // New status for refer
                'pending_payment': 'badge-pending',
                'due': 'badge-loan',
                'closed': 'badge-completed',
                'pending_closure': 'badge-pending'
            }[status] || 'badge-pending';
            return `<span class="badge ${statusClass}">${status.replace(/_/g, ' ')}</span>`;
        }
        
        function loadOrderHistory(){
            const container = document.getElementById('orders-full-list');
            container.innerHTML = '<h3 style="margin-top:0;">My Orders</h3><div class="small-muted" style="text-align:center;padding:10px;">loading orders...</div>';

            db.ref('users/'+currentUser.uid+'/order_history').on('value',snap=>{
                container.innerHTML = '<h3 style="margin-top:0;">My Orders</h3>';
                const wrapper = document.createElement('div');

                const data = snap.val()||{};
                const items = Object.values(data).sort((a,b)=>b.created_at - a.created_at);
                
                if (items.length === 0) {
                    wrapper.innerHTML = '<div class="small-muted" style="text-align:center;padding:10px;">No orders placed yet.</div>';
                    container.appendChild(wrapper);
                    return;
                }

                items.forEach(o=>{
                    const itemKeys = Object.keys(o.items || {});
                    const firstItem = o.items[itemKeys[0]];
                    const itemsSummary = itemKeys.map(pid=>{
                            return (o.items[pid].name ? o.items[pid].name.substring(0,10)+'...' : pid.substring(0,5)) + (o.items[pid].qty ? ' x'+o.items[pid].qty : '');
                        }).join(', ');

                    const d = document.createElement('div');
                    d.className='card';
                    d.style.marginBottom = '12px';
                    d.innerHTML = `
                        <div style="display:flex;gap:10px;align-items:flex-start; cursor:pointer;" onclick="openOrderDetailsModal('${o.id}')">
                            <img src="${firstItem?.image || 'https://via.placeholder.com/60'}" style="width:60px; height:60px; object-fit:cover; border-radius:6px; flex-shrink:0;">
                            <div style="flex:1;">
                                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                                    <div style="font-weight:700">Order ID: ${o.id.substring(0,8)}...</div>
                                    <div style="text-align:right">
                                        ${renderStatusBadge(o.status)}
                                        <div class="small-muted" style="margin-top:4px;font-size:10px;">Total: ‚Çπ${o.total||0}</div>
                                    </div>
                                </div>
                                <div class="small-muted" style="margin-top:4px; font-size:11px;">Items: ${itemsSummary}</div>
                                <div class="small-muted" style="font-size:10px;">${new Date(o.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                    `;
                    wrapper.appendChild(d);
                });
                container.appendChild(wrapper);
            });
        }
        
        // --- Loan Dashboard Status Check - Simplified to direct to dashboard logic ---
        function checkAndLoadActiveLoan(){
            // This function is kept for the profile page view, but it primarily calls listeners/updates now.
            // Loan logic is centralized in loadLoanDashboardState for the modal.
            // For the profile quick view:
            db.ref('users/'+currentUser.uid+'/loan_application').on('value', async snap => {
                const userLoan = snap.val();
                const reqView = document.getElementById('loan-request-view');
                const statusView = document.getElementById('loan-status-view');
                const detailsDiv = document.getElementById('active-loan-details');
                
                if (!userLoan || userLoan.status === 'rejected' || userLoan.status === 'closed') {
                    reqView.classList.remove('field-hidden');
                    statusView.classList.add('field-hidden');
                    detailsDiv.innerHTML = '';
                    return;
                }

                reqView.classList.add('field-hidden');
                statusView.classList.remove('field-hidden');

                if (userLoan.status === 'pending') {
                    detailsDiv.innerHTML = `<div class="badge badge-pending">Application Pending Review...</div><p class="small-muted">Go to Loan Dashboard for details.</p>`;
                } else if (userLoan.status === 'reviewed') {
                    detailsDiv.innerHTML = `<div class="badge badge-loan">Offer Ready!</div><p class="small-muted">Please accept the offer in the Loan Dashboard.</p>`;
                } else if (userLoan.status === 'approved' || userLoan.status === 'pending_closure') {
                     // Get remaining balance for a quick view
                    const emiSnap = await db.ref('users/'+currentUser.uid+'/loan_emis').once('value');
                    const emiArray = Object.values(emiSnap.val() || {}).filter(e => e.status !== 'paid');
                    const remainingAmount = emiArray.reduce((sum, e) => sum + e.amount, 0);

                    detailsDiv.innerHTML = `
                        <div class="badge badge-completed">Active Loan</div>
                        <p>Remaining: ‚Çπ<strong>${remainingAmount.toFixed(2)}</strong></p>
                        <button class="btn secondary" onclick="openLoanModal()">Manage Loan</button>
                    `;
                }
            });
        }

        // ---------- Crypto Exchange Toggle Function ----------
        let activeWidget = null;

        function toggleCryptoWidget(widgetId) {
            const container = document.getElementById('crypto-widget-container');
            const widgets = container.querySelectorAll('iframe, [id^="swapzone"]');
            
            // Collapse if the same widget is clicked
            if (activeWidget === widgetId) {
                container.classList.remove('expanded');
                widgets.forEach(w => w.style.display = 'none');
                activeWidget = null;
                return;
            }

            // Expand to the new widget
            container.classList.add('expanded');
            widgets.forEach(w => w.style.display = 'none');
            activeWidget = widgetId;
            
            if (widgetId === 'changenow') {
                document.getElementById('changenow-frame').style.display = 'block';
            } else if (widgetId === 'swapspace') {
                document.getElementById('swapspace-frame').style.display = 'block';
            } else if (widgetId === 'simpleswap') {
                document.getElementById('simpleswap-frame-widget').style.display = 'block';
            } else if (widgetId === 'swapzone') {
                const swapzoneDiv = document.getElementById('swapzoneExchangeWidget');
                swapzoneDiv.style.display = 'block';
                // Trigger SwapZone's script if needed, though it usually runs on load
                // For a dynamic widget, you might need to re-initialize or force a refresh here.
                // Since the script tag is loaded, hiding/showing the div might be enough.
                // If it doesn't work, you'd need to re-insert the script or call a re-initialization function.
            }

            // Update button styles (optional but good for UX)
            document.querySelectorAll('.exchange-widget-button-group .btn').forEach(btn => {
                btn.classList.remove('btn');
                btn.classList.add('btn', 'secondary');
            });
            event.currentTarget.classList.remove('secondary');
        }


        // ... (rest of history, listeners, and referral logic is the same) ...
        
        // Include remaining dummy history loaders and payment listeners here if they were in the original JS:
        function loadQuickHistory() {
            document.getElementById('quick-history').innerHTML = `
                <div class="card" style="border-left: 4px solid #10b981; margin-bottom:8px; padding:8px;">
                    <div style="font-weight:600;">Wallet Credit (Bonus)</div>
                    <div class="small-muted">‚Çπ100.00 | Nov 28, 2025</div>
                </div>
                <div class="card" style="border-left: 4px solid var(--gold-strong); margin-bottom:8px; padding:8px;">
                    <div style="font-weight:600;">Gold Purchase (Pending)</div>
                    <div class="small-muted">1.5385 g | Nov 27, 2025</div>
                </div>
            `;
        }
        function loadReferHistory() {
             document.getElementById('refer-history-list').innerHTML = `
                <div class="card" style="border-left: 4px solid #6d28d9; margin-bottom:8px; padding:8px;">
                    <div style="font-weight:600;">Referral: Jane Doe</div>
                    <div class="small-muted">Status: Eligible for Bonus | Nov 26, 2025</div>
                </div>
            `;
        }
        function loadWalletHistory() {
            document.getElementById('wallet-history-list').innerHTML = `
                <div class="card" style="border-left: 4px solid #059669; margin-bottom:8px; padding:8px;">
                    <div style="font-weight:600;">Wallet Add (Completed)</div>
                    <div class="small-muted">‚Çπ500.00 | Nov 28, 2025</div>
                </div>
            `;
        }
        function loadGoldHistory() {
             document.getElementById('gold-status-list').innerHTML = `
                <div class="card" style="border-left: 4px solid var(--gold-strong); margin-bottom:8px; padding:8px;">
                    <div style="font-weight:600;">Gold Purchase (Pending)</div>
                    <div class="small-muted">1.5385 g | Nov 27, 2025</div>
                </div>
            `;
        }
        function listenPaymentRequests() {
            // Simplified for the front-end demo
            console.log('Listening for payment updates (simulated)...');
        }

    </script>
</body>
</html>

