<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gold Rupi - Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root{
            --gold:#d4af37;
            --card-bg: #ffffff;
            --bg-color:#f8f9fa;
            --text-color:#1f2937;
            --success:#10b981;
            --danger:#ef4444;
            --warning:#f59e0b;
            --info: #3b82f6;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg-color);color:var(--text-color);padding:20px;}
        
        .header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #ddd; padding-bottom:15px;}
        .logo{font-weight:800;font-size:24px;color:var(--gold);letter-spacing:-1px;}
        
        .card{background:var(--card-bg);border-radius:12px;padding:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05);margin-bottom:15px;}
        .btn{background:var(--gold);color:#000;border:none;padding:8px 15px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;}
        .btn.secondary{background:#e5e7eb; color:var(--text-color); border:1px solid #ddd;}
        .btn.danger{background:var(--danger); color:#fff;}
        
        .tab-nav{display:flex; margin-bottom:20px; border-bottom:1px solid #ddd; overflow-x: auto;}
        .tab-item{padding:10px 15px; cursor:pointer; font-weight:600; opacity:0.6; white-space: nowrap;}
        .tab-item.active{opacity:1; color:var(--gold); border-bottom:2px solid var(--gold);}

        .request-item { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #eee; }
        .request-item:last-child { border-bottom:none; }
        .req-id { font-weight:600; font-size:14px; color:var(--gold); }
        .req-status-badge { padding:4px 8px; border-radius:10px; font-size:10px; font-weight:600; }
        .bg-pending { background:var(--warning); color:#fff; }
        .bg-active { background:var(--success); color:#fff; }
        .bg-reviewed { background:var(--info); color:#fff; }
        .bg-rejected { background:var(--danger); color:#fff; }
        .bg-paid { background:var(--success); color:#fff; }
        .bg-submitted { background:var(--warning); color:#fff; }
        .bg-overdue { background:var(--danger); color:#fff; }
        .bg-closed { background:#3b82f6; color:#fff; }
        
        /* Modal Styles */
        .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter: blur(5px);}
        .modal{background:var(--card-bg);width:90%;max-width:600px;border-radius:12px;padding:20px;max-height:95vh;overflow-y:auto;position: relative;}
        .close-modal{position:absolute;top:15px;right:15px;background:none;border:none;font-size:24px;color:var(--text-color);cursor:pointer;}
        
        .detail-row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee; font-size:14px; }
        .detail-row strong { font-weight:600; }
        
        .action-btns { margin-top:20px; display:flex; gap:10px; }
        .document-link { color:var(--gold); text-decoration:none; font-size:12px; margin-top:5px; display:block; }

        .verification-status { padding: 8px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; font-weight: 600; }
        .verification-pending { background:#fef3c7; color:var(--warning); }
        .verification-success { background:#d1fae5; color:var(--success); }

        /* Input styling for modals */
        .modal input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }

        /* EMI History Table Styling */
        .emi-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .emi-table th, .emi-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .emi-table th { background: #f4f4f4; font-weight: 600; color: #666; }
        .emi-table tr:last-child td { border-bottom: none; }
        .emi-table .bg-submitted { background: #fef3c7; color: var(--warning); border-radius: 4px; padding: 2px 6px; }
        .emi-table .bg-paid { background: #d1fae5; color: var(--success); border-radius: 4px; padding: 2px 6px; }
        .emi-table .bg-pending, .emi-table .bg-overdue { background: #fee2e2; color: var(--danger); border-radius: 4px; padding: 2px 6px; }

    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Admin: Gold Rupi</div>
        <button class="btn secondary" onclick="logout()">Logout</button>
    </div>

    <div class="tab-nav">
        <div class="tab-item active" onclick="switchTab('tab-pending', this)">Pending Requests (<span id="count-pending">0</span>)</div>
        <div class="tab-item" onclick="switchTab('tab-payments', this)">Payment Verification (<span id="count-payments">0</span>)</div>
        <div class="tab-item" onclick="switchTab('tab-active', this)">Active Loans (<span id="count-active">0</span>)</div>
        <div class="tab-item" onclick="switchTab('tab-history', this)">EMI History (<span id="count-history">...</span>)</div>
    </div>

    <div id="tab-pending" class="tab-content">
        <h2>New Loan Applications / Disbursals</h2>
        <div class="card" id="pending-list">
            Loading...
        </div>
    </div>

    <div id="tab-payments" class="tab-content" style="display:none;">
        <h2>Payment Verification</h2>
        <div class="card" id="payment-list">
            No payments pending verification.
        </div>
    </div>

    <div id="tab-active" class="tab-content" style="display:none;">
        <h2>Active Loans (Tracking)</h2>
        <div class="card" id="active-list">
            No active loans currently being tracked.
        </div>
    </div>

    <div id="tab-history" class="tab-content" style="display:none;">
        <h2>All Loan History (Active & Closed)</h2>
        <div class="card" id="history-list">
            Loading all loans...
        </div>
    </div>
    
    <div id="review-modal" class="overlay">
        <div class="modal">
            <button class="close-modal" onclick="closeModal('review-modal')">&times;</button>
            <h3 style="margin-top:0;">Review Loan Application: <span id="modal-lid"></span></h3>
            
            <div class="card" id="user-info-full">
                <h4>Applicant Details</h4>
                <div class="detail-row"><span>Name:</span> <strong id="modal-name"></strong></div>
                <div class="detail-row"><span>Email:</span> <strong id="modal-email"></strong></div>
                <div class="detail-row"><span>Mobile:</span> <strong id="modal-mobile"></strong></div>
                <div class="detail-row"><span>Address:</span> <strong id="modal-address"></strong></div>
                <div class="detail-row"><span>PAN:</span> <strong id="modal-pan"></strong></div>
                <div class="detail-row"><span>User ID:</span> <strong id="modal-uid"></strong></div>
                <hr style="margin: 8px 0; border: none; border-top: 1px dashed #ddd;">
                <div class="detail-row"><span>Monthly Income:</span> <strong id="modal-income"></strong></div>
                <div class="detail-row"><span>Requested Amount:</span> <strong id="modal-amt"></strong></div>
            </div>

            <h4 style="margin-top:20px;">Verification Documents</h4>
            <div id="documents-container">
                </div>
            
            <h4 style="margin-top:20px;">Loan Offer Decision</h4>
            <div class="card">
                <label style="font-size:12px;">Approved Amount (₹)</label>
                <input id="approve-amt" type="number" min="5000" max="50000" value="10000">
                <label style="font-size:12px;">Approved Tenure (Months)</label>
                <input id="approve-tenure" type="number" min="3" max="24" value="6">
            </div>

            <div class="action-btns">
                <button class="btn" style="flex:1;" onclick="sendOffer()">Send Offer</button>
                <button class="btn danger" style="flex:1;" onclick="rejectLoan()">Reject</button>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="overlay">
        <div class="modal">
            <button class="close-modal" onclick="closeModal('payment-modal')">&times;</button>
            <h3 style="margin-top:0;">Verify Payment: <span id="pay-req-id"></span></h3>
            
            <div class="card" id="pay-user-info-full">
                <h4>Payer Details</h4>
                <div class="detail-row"><span>Name:</span> <strong id="pay-name"></strong></div>
                <div class="detail-row"><span>Email:</span> <strong id="pay-email"></strong></div>
                <div class="detail-row"><span>Mobile:</span> <strong id="pay-mobile"></strong></div>
                <div class="detail-row"><span>Loan ID:</span> <strong id="pay-lid"></strong></div>
                <div class="detail-row"><span>EMI ID:</span> <strong id="pay-emi-id"></strong></div>
            </div>
            
            <div class="card" style="border-left:4px solid var(--warning);">
                <div class="detail-row"><span>Amount Paid:</span> <strong style="font-size:18px; color:var(--success);" id="pay-amount"></strong></div>
                <div class="detail-row"><span>UTR Number:</span> <strong id="pay-utr"></strong></div>
            </div>

            <h4 style="margin-top:20px;">Verification Action</h4>
            <div class="action-btns">
                <button class="btn" style="flex:1; background:var(--success);" onclick="verifyPayment('verified')">Mark as Paid</button>
                <button class="btn danger" style="flex:1;" onclick="verifyPayment('failed')">UTR Invalid</button>
            </div>
        </div>
    </div>

    <div id="disbursement-modal" class="overlay">
        <div class="modal">
            <button class="close-modal" onclick="closeModal('disbursement-modal')">&times;</button>
            <h3 style="margin-top:0;">Disburse Funds: <span id="disburse-lid"></span></h3>
            
            <div class="card" id="disburse-user-info-full">
                <h4>Recipient Details</h4>
                <div class="detail-row"><span>Name:</span> <strong id="disburse-name"></strong></div>
                <div class="detail-row"><span>Mobile:</span> <strong id="disburse-mobile"></strong></div>
                <div class="detail-row"><span>Loan ID:</span> <strong id="disburse-lid-info"></strong></div>
            </div>
            
            <div class="card" style="border-left:4px solid var(--gold);">
                <h4>Final Loan Details</h4>
                <div class="detail-row"><span>Approved Amount:</span> <strong id="disburse-approved-amt"></strong></div>
                <div class="detail-row"><span>Processing Fee (2%):</span> <strong style="color:var(--danger);" id="disburse-fee"></strong></div>
                <div class="detail-row"><span>**Net Disbursal (Sent to Bank):**</span> <strong style="font-size:18px; color:var(--success);" id="disburse-net"></strong></div>
                <div class="detail-row"><span>Tenure (Months):</span> <strong id="disburse-tenure"></strong></div>
            </div>

            <div class="verification-status verification-success" style="margin-top:20px;">
                <i class="ri-check-line"></i> User has **Accepted** the offer and is ready for funding.
            </div>

            <h4 style="margin-top:20px;">Action</h4>
            <div class="action-btns">
                <button class="btn" style="flex:1; background:var(--gold);" onclick="disburseFunds()">Confirm & Disburse Funds</button>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="overlay">
        <div class="modal">
            <button class="close-modal" onclick="closeModal('history-modal')">&times;</button>
            <h3 style="margin-top:0;">Loan History: <span id="history-lid"></span></h3>
            
            <div class="card" id="history-user-info-full">
                <h4>User & Loan Details</h4>
                <div class="detail-row"><span>Name:</span> <strong id="history-name"></strong></div>
                <div class="detail-row"><span>Mobile:</span> <strong id="history-mobile"></strong></div>
                <div class="detail-row"><span>Email:</span> <strong id="history-email"></strong></div>
                <div class="detail-row"><span>Address:</span> <strong id="history-address"></strong></div>
                <hr style="margin: 8px 0; border: none; border-top: 1px dashed #ddd;">
            </div>
            
            <div class="card" style="border-left:4px solid var(--info);">
                <h4>Loan Summary</h4>
                <div class="detail-row"><span>Loan Status:</span> <strong id="history-status"></strong></div>
                <div class="detail-row"><span>Total Repayment:</span> <strong id="history-total-repay"></strong></div>
                <div class="detail-row"><span>Monthly EMI:</span> <strong id="history-emi-amt"></strong></div>
                <div class="detail-row"><span>Total EMIs Paid:</span> <strong id="history-paid-count"></strong></div>
                <div class="detail-row"><span>Outstanding Balance:</span> <strong id="history-outstanding" style="color:var(--danger);"></strong></div>
            </div>
            
            <h4 style="margin-top:20px;">EMI Payment History</h4>
            <div id="emi-history-table-container">
                </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // CONFIG (Use the same config as the user app)
        const firebaseConfig = {
            apiKey: "AIzaSyCZ5P2t5xRhy5d0IXV6UWcvbkUWXqyPENA",
            authDomain: "smbrand-4543a.firebaseapp.com",
            databaseURL: "https://smbrand-4543a-default-rtdb.firebaseio.com",
            projectId: "smbrand-4543a",
            appId: "1:720775550032:web:0622548a007597778bad55"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentReviewLoanId = null;
        let currentPaymentRequestId = null;

        // --- UTILITY FUNCTIONS ---

        // Function to fetch full user details
        async function fetchUserDetails(uid) {
            const userSnap = await db.ref('users/' + uid).once('value');
            const userData = userSnap.val() || {};
            
            const name = userData.name || 'N/A';
            const email = userData.email || 'N/A';
            const mobile = userData.mobile || 'N/A';
            const pan = userData.kyc?.pan || 'N/A';
            
            let address = 'N/A';
            if (userData.address && userData.address.house && userData.address.city) {
                address = `${userData.address.house}, ${userData.address.city}, ${userData.address.district}`;
            }

            return { name, email, mobile, pan, address, uid };
        }

        // --- AUTH & INITIALIZATION ---
        
        auth.onAuthStateChanged(user => {
            if(!user) {
                return window.location.href = 'rupe.html'; 
            }
            
            // Start listening for all data streams
            listenForRequests();
            listenForPayments();
            listenForActiveLoans();
            listenForAllHistory(); // New listener for history tab
        });

        function logout(){
            auth.signOut().then(() => window.location.href = 'rupe.html'); // Redirect to login page
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // function sendUserNotification(uid, type, message) {
        //     const notificationRef = db.ref(`users/${uid}/notifications`).push();
        //     notificationRef.set({
        //         id: notificationRef.key,
        //         type: type, 
        //         message: message,
        //         timestamp: Date.now(),
        //         read: false
        //     });
        // }

        // --- 1. PENDING REQUESTS (DUAL FETCH LOGIC) ---
        
        async function listenForRequests() {
            const listDiv = document.getElementById('pending-list');
            listDiv.innerHTML = 'Loading...';
            
            let pendingRequests = {};

            const primarySnap = await db.ref('loan_requests').once('value');
            const loanRequests = primarySnap.val() || {};

            Object.keys(loanRequests).forEach(lid => {
                const req = loanRequests[lid];
                if (req.status === 'pending' || req.status === 'reviewed' || req.status === 'accepted') {
                    pendingRequests[lid] = req;
                }
            });
            
            const keys = Object.keys(pendingRequests);
            
            listDiv.innerHTML = '';
            const sortedKeys = keys.sort((a, b) => {
                const statusA = pendingRequests[a].status;
                const statusB = pendingRequests[b].status;
                
                if (statusA === 'accepted' && statusB !== 'accepted') return -1;
                if (statusA !== 'accepted' && statusB === 'accepted') return 1;

                if (statusA === 'pending' && statusB !== 'pending') return -1;
                if (statusA !== 'pending' && statusB === 'pending') return 1;

                return 0; 
            });

            sortedKeys.forEach(lid => {
                const req = pendingRequests[lid];
                listDiv.insertAdjacentHTML('beforeend', renderRequestItem(req));
            });
            
            if (keys.length === 0) {
                 listDiv.innerHTML = '<div class="card text-center">No pending loan applications.</div>';
            }

            document.getElementById('count-pending').innerText = keys.length;
        }


        function renderRequestItem(req) {
            let statusClass = 'bg-pending';
            let buttonText = 'Review';
            let actionFunction = `openReviewModal('${req.id}')`; 

            if (req.status === 'accepted') {
                 statusClass = 'bg-active';
                 buttonText = '<i class="ri-send-plane-fill"></i> Disburse Funds'; 
                 actionFunction = `openDisbursementModal('${req.id}')`; 
            } else if (req.status === 'reviewed') {
                statusClass = 'bg-reviewed';
                buttonText = 'Re-Review (Offer Sent)';
                actionFunction = `openReviewModal('${req.id}')`;
            } else if (req.status === 'pending') {
                 statusClass = 'bg-warning';
                 buttonText = 'Review Application';
            }
            
            return `
                <div class="request-item">
                    <div>
                        <div class="req-id">${req.id}</div>
                        <div style="font-size:12px; opacity:0.7;">User: ${req.user_id.substring(0, 8)}... | Req Amt: ₹${parseInt(req.amount_req).toLocaleString()}</div>
                    </div>
                    <div>
                        <span class="req-status-badge ${statusClass}">${req.status.toUpperCase()}</span>
                        <button class="btn" style="margin-left:10px; padding:5px 10px; ${req.status === 'accepted' ? 'background:var(--success); color:#fff;' : ''}" onclick="${actionFunction}">${buttonText}</button>
                    </div>
                </div>
            `;
        }

        async function openReviewModal(lid) {
            const snap = await db.ref('loan_requests/' + lid).once('value');
            const data = snap.val();
            if (!data) return alert("Request not found.");

            currentReviewLoanId = lid;
            document.getElementById('modal-lid').innerText = lid;
            
            const userData = await fetchUserDetails(data.user_id);

            // Populate Full User Details (NEW)
            document.getElementById('modal-name').innerText = userData.name;
            document.getElementById('modal-email').innerText = userData.email;
            document.getElementById('modal-mobile').innerText = userData.mobile;
            document.getElementById('modal-address').innerText = userData.address;
            document.getElementById('modal-pan').innerText = userData.pan;
            document.getElementById('modal-uid').innerText = userData.uid;

            // Populate Loan Summary
            document.getElementById('modal-income').innerText = '₹' + (data.verification_data?.work?.monthly_income || 'N/A');
            document.getElementById('modal-amt').innerText = '₹' + parseInt(data.amount_req).toLocaleString();
            
            document.getElementById('approve-amt').value = data.approved_amount || data.amount_req;
            document.getElementById('approve-tenure').value = data.approved_tenure || data.tenure_req;
            
            // Populate Documents
            const docContainer = document.getElementById('documents-container');
            docContainer.innerHTML = '';

            const identity = data.verification_data?.identity;
            const bank = data.verification_data?.bank;
            const work = data.verification_data?.work;

            docContainer.insertAdjacentHTML('beforeend', renderDocSection('PAN Card', identity?.pan, identity?.pan_img_url));
            docContainer.insertAdjacentHTML('beforeend', renderDocSection('Aadhaar Front', 'N/A', identity?.aadhaar_front_url));
            docContainer.insertAdjacentHTML('beforeend', renderDocSection('Passbook/Cheque', bank?.account_number, bank?.passbook_url));
            docContainer.insertAdjacentHTML('beforeend', renderDocSection('Salary Slip', work?.monthly_income, work?.salary_slip_url));

            document.getElementById('review-modal').style.display = 'flex';
        }

        function renderDocSection(title, textValue, url) {
            const isValidUrl = url && url !== "https://via.placeholder.com/300?text=Upload+Error" && url !== "https://via.placeholder.com/300?text=No+Image";
            const status = isValidUrl ? 'verification-success' : 'verification-pending';
            const statusText = isValidUrl ? 'Verified' : 'Missing/Failed';
            
            return `
                <div class="card" style="margin-top:5px; padding:10px; border-left:4px solid ${status === 'verification-success' ? 'var(--success)' : 'var(--danger)'}">
                    <div class="detail-row">
                        <span>${title}:</span>
                        <span class="${status}">${statusText}</span>
                    </div>
                    <div style="font-size:12px; margin-top:5px;">Details: ${textValue}</div>
                    ${isValidUrl ? `<a href="${url}" target="_blank" class="document-link">View Document <i class="ri-external-link-line"></i></a>` : ''}
                </div>
            `;
        }

        function sendOffer() {
            const approvedAmt = document.getElementById('approve-amt').value;
            const approvedTenure = document.getElementById('approve-tenure').value;
            const uid = document.getElementById('modal-uid').innerText;

            if(!approvedAmt || !approvedTenure || parseInt(approvedAmt) < 5000) return alert("Invalid amount or tenure.");

            const fee = Math.round(parseInt(approvedAmt) * 0.02); // 2% fee
            const net = parseInt(approvedAmt) - fee;

            const updates = {
                status: 'reviewed', 
                approved_amount: parseInt(approvedAmt),
                approved_tenure: parseInt(approvedTenure),
                processing_fee: fee,
                net_disbursal: net,
                reviewed_by: auth.currentUser?.uid || 'Admin', 
                reviewed_at: Date.now()
            };

            db.ref('loan_requests/' + currentReviewLoanId).update(updates).then(() => {
                db.ref('users/' + uid + '/loan_app/status').set('reviewed');
                alert(`Offer of ₹${approvedAmt} sent to user for request ${currentReviewLoanId}.`);
                closeModal('review-modal');
                listenForRequests(); 
            }).catch(e => {
                alert("Error sending offer: " + e.message);
            });
        }

        function rejectLoan() {
            if(!confirm("Are you sure you want to reject this loan application?")) return;

            const uid = document.getElementById('modal-uid').innerText;
            
            db.ref('loan_requests/' + currentReviewLoanId).update({
                status: 'rejected',
                rejected_by: auth.currentUser?.uid || 'Admin', 
                rejected_at: Date.now()
            }).then(() => {
                db.ref('users/' + uid + '/loan_app').update({status: 'rejected', loan_id: currentReviewLoanId});
                alert(`Loan ${currentReviewLoanId} rejected.`);
                closeModal('review-modal');
                listenForRequests(); 
            }).catch(e => {
                alert("Error rejecting loan: " + e.message);
            });
        }
        
        function generateEmiSchedule(approvedAmount, tenure, emiAmount, loanId) {
            const emis = {};
            const disbursementDate = new Date();
            
            const monthlyEMI = parseFloat(emiAmount);
            
            const firstDueDate = new Date(disbursementDate);
            firstDueDate.setMonth(firstDueDate.getMonth() + 1);

            for (let i = 1; i <= tenure; i++) {
                const dueDate = new Date(firstDueDate);
                dueDate.setMonth(dueDate.getMonth() + (i - 1));

                emis[`emi_${i}`] = {
                    id: `EMI_${loanId}_${i}`,
                    num: i,
                    amount: monthlyEMI,
                    due_date: dueDate.getTime(),
                    status: 'pending'
                };
            }
            return emis;
        }
        
        // 2. DISBURSEMENT LOGIC
        
        async function openDisbursementModal(lid) {
            const snap = await db.ref('loan_requests/' + lid).once('value');
            const data = snap.val();
            if (!data) return alert("Loan request not found.");

            if (data.status !== 'accepted') return alert("Loan status is not 'accepted'. Cannot disburse.");

            currentReviewLoanId = lid; 
            
            const userData = await fetchUserDetails(data.user_id);
            
            document.getElementById('disburse-name').innerText = userData.name;
            document.getElementById('disburse-mobile').innerText = userData.mobile;
            document.getElementById('disburse-lid-info').innerText = lid;
            
            document.getElementById('disburse-lid').innerText = lid;
            document.getElementById('disburse-approved-amt').innerText = '₹' + parseInt(data.approved_amount).toLocaleString();
            document.getElementById('disburse-fee').innerText = '- ₹' + parseInt(data.processing_fee).toLocaleString();
            document.getElementById('disburse-net').innerText = '₹' + parseInt(data.net_disbursal).toLocaleString();
            document.getElementById('disburse-tenure').innerText = data.approved_tenure;

            document.getElementById('disbursement-modal').style.display = 'flex';
        }

        function disburseFunds() {
            if(!confirm("Are you absolutely sure you want to DISBURSE these funds and mark the loan as ACTIVE? This action cannot be easily undone.")) return;

            const lid = currentReviewLoanId;
            const uid = document.getElementById('disburse-user-info-full').querySelector('[id="disburse-name"]').closest('.card').querySelector('[id="disburse-lid-info"]').innerText.substring(0, 20); // Get UID from the loan ID prefix, less reliable, we need the direct UID
            // Re-fetch UID from the loan request
            db.ref('loan_requests/' + lid).once('value').then(snap => {
                const uid = snap.val().user_id;

                const approvedAmtText = document.getElementById('disburse-approved-amt').innerText.replace(/[₹,]/g, '');
                const netDisbursalText = document.getElementById('disburse-net').innerText.replace(/[₹,]/g, '');
                const tenureText = document.getElementById('disburse-tenure').innerText;
                
                const approvedAmount = parseInt(approvedAmtText);
                const netDisbursal = parseInt(netDisbursalText);
                const tenure = parseInt(tenureText);
                
                const INTEREST_RATE = 0.08; 
                const totalRepayment = approvedAmount + Math.round(approvedAmount * INTEREST_RATE);
                const monthlyEMI = Math.round(totalRepayment / tenure); 

                const emiSchedule = generateEmiSchedule(approvedAmount, tenure, monthlyEMI, lid);
                
                const updates = {
                    status: 'active',
                    disbursed_by: auth.currentUser?.uid || 'Admin', 
                    disbursed_at: Date.now(),
                    disbursed_amount: netDisbursal, 
                    approved_tenure: tenure,
                    emi_amount: monthlyEMI,
                    emis: emiSchedule, 
                    total_repayment: totalRepayment, 
                    total_emis_paid: 0,
                    outstanding_balance: totalRepayment
                };
                
                db.ref('loan_requests/' + lid).update(updates).then(() => {
                    
                    db.ref('disbursements').push({
                        loanId: lid,
                        userId: uid,
                        amount: netDisbursal,
                        timestamp: Date.now(),
                        status: 'disbursed'
                    });
                    
                    db.ref('users/' + uid + '/loan_app/status').set('active');
                    
                    alert(`Funds successfully DISBURSED for Loan ${lid}. Loan is now ACTIVE.`);
                    closeModal('disbursement-modal');
                    listenForRequests(); 
                    listenForActiveLoans(); 
                }).catch(e => {
                    alert("Error disbursing funds: " + e.message);
                });
            }).catch(e => alert("Could not retrieve UID for disbursement: " + e.message));
        }
        
        // --- 3. PAYMENT VERIFICATION ---
        
        function listenForPayments() {
            const listDiv = document.getElementById('payment-list');
            listDiv.innerHTML = 'Loading...';
            
            db.ref('payment_requests').orderByChild('status').equalTo('verification_pending').on('value', snap => {
                const requests = snap.val() || {};
                const keys = Object.keys(requests);
                
                listDiv.innerHTML = keys.length === 0 ? '<div class="card text-center">No payments pending verification.</div>' : '';

                keys.forEach(prid => {
                    const req = requests[prid];
                    listDiv.insertAdjacentHTML('afterbegin', renderPaymentItem(req));
                });
                document.getElementById('count-payments').innerText = keys.length;
            });
        }

        function renderPaymentItem(req) {
             return `
                <div class="request-item">
                    <div>
                        <div class="req-id">${req.id}</div>
                        <div style="font-size:12px; opacity:0.7;">Loan: ${req.loan_id} | EMI: ${req.emi_id} | Amt: ₹${req.amount.toLocaleString()}</div>
                    </div>
                    <div>
                        <span class="req-status-badge bg-pending">VERIFY UTR</span>
                        <button class="btn" style="margin-left:10px; padding:5px 10px;" onclick="openPaymentModal('${req.id}', '${req.user_id}')">View</button>
                    </div>
                </div>
            `;
        }

        async function openPaymentModal(prid, uid) {
            const snap = await db.ref('payment_requests/' + prid).once('value');
            const data = snap.val();
            if (!data) return alert("Payment request not found.");

            const userData = await fetchUserDetails(uid);

            currentPaymentRequestId = prid;
            document.getElementById('pay-req-id').innerText = prid;
            
            // Populate User Info (NEW)
            document.getElementById('pay-name').innerText = userData.name;
            document.getElementById('pay-email').innerText = userData.email;
            document.getElementById('pay-mobile').innerText = userData.mobile;
            document.getElementById('pay-lid').innerText = data.loan_id;
            document.getElementById('pay-emi-id').innerText = data.emi_id;
            document.getElementById('pay-amount').innerText = parseInt(data.amount).toLocaleString();
            document.getElementById('pay-utr').innerText = data.utr_number;

            document.getElementById('payment-modal').style.display = 'flex';
        }

        
        // CORE FIX: Handles EMI Status, Payment Request Status, Loan Summary Update, and Notification
        async function verifyPayment(action) {
            const prid = currentPaymentRequestId;
            const lid = document.getElementById('pay-lid').innerText;
            const eid = document.getElementById('pay-emi-id').innerText;
            const amountText = document.getElementById('pay-amount').innerText.replace(/[₹,]/g, '');
            const amount = parseInt(amountText);
            
            // Fetch UID from the loan request (more reliable than modal UI)
            const loanSnapForUID = await db.ref(`loan_requests/${lid}`).once('value');
            const uid = loanSnapForUID.val().user_id; // Get the user_id

            if (action === 'verified') {
                try {
                    // 1. Mark EMI Status as Paid in loan_requests
                    await db.ref(`loan_requests/${lid}/emis/${eid}`).update({
                        status: 'paid',
                        paid_at: Date.now(),
                        verified_by: auth.currentUser?.uid || 'Admin'
                    });
                    
                    // 2. Mark Payment Request as verified
                    await db.ref('payment_requests/' + prid).update({
                        status: 'verified',
                        verified_by: auth.currentUser?.uid || 'Admin',
                        verified_at: Date.now(),
                        admin_note: 'Payment successfully verified and EMI marked as paid.'
                    });

                    // 3. Recalculate Loan Summary (FIXED NaN LOGIC)
                    const loanSnap = await db.ref(`loan_requests/${lid}`).once('value');
                    const loanData = loanSnap.val();
                    const allEmis = Object.values(loanData.emis || {});

                    const paidCount = allEmis.filter(e => e.status === 'paid').length;
                    
                    // The outstanding_balance field must be checked for validity before calculation
                    // This handles the NaN error by defaulting totalRepayment and existing balance if needed
                    const totalRepayment = parseFloat(loanData.total_repayment || 0); 
                    const totalPaid = allEmis.filter(e => e.status === 'paid').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
                    
                    // Use a safety check: if calculation yields NaN, prevent write, though the above defaults should fix it
                    let outstanding = totalRepayment - totalPaid;
                    if (isNaN(outstanding)) outstanding = 0; 
                    if (outstanding < 0) outstanding = 0; // Prevent negative balance

                    // 4. Update the loan summary fields
                    await db.ref(`loan_requests/${lid}`).update({
                        total_emis_paid: paidCount,
                        outstanding_balance: outstanding,
                        last_payment_date: Date.now(),
                        // Check if all EMIs are paid and close the loan
                        status: (paidCount === allEmis.length) ? 'closed' : loanData.status 
                    });

                    // 5. Send User Notification - REMOVED AS REQUESTED

                    // 6. Close modal and refresh lists
                    alert(`EMI ${eid} marked as PAID. Loan Summary Updated. Status: ${paidCount === allEmis.length ? 'CLOSED' : 'ACTIVE'}.`);
                    closeModal('payment-modal');
                    listenForActiveLoans(); 
                    listenForPayments(); 
                    listenForAllHistory(); 

                } catch (e) {
                    alert("Error verifying payment and updating summary: " + e.message);
                }

            } else if (action === 'failed') {
                try {
                    await db.ref('payment_requests/' + prid).update({
                        status: 'failed',
                        failed_by: auth.currentUser?.uid || 'Admin',
                        failed_at: Date.now(),
                        admin_note: 'UTR verification failed. Please contact support or resubmit payment.'
                    });

                    // Send User Notification - REMOVED AS REQUESTED
                    
                    alert(`Payment ${prid} marked as FAILED.`);
                    closeModal('payment-modal');
                    listenForPayments();
                } catch (e) {
                     alert("Error failing payment: " + e.message);
                }
            }
        }


        // --- 4. ACTIVE LOANS (VIEW HISTORY UPDATED FOR OVERDUE LOGIC) ---

        function listenForActiveLoans() {
            const listDiv = document.getElementById('active-list');
            listDiv.innerHTML = 'Loading...';

            db.ref('loan_requests').orderByChild('status').equalTo('active').on('value', snap => {
                const requests = snap.val() || {};
                const keys = Object.keys(requests);
                
                listDiv.innerHTML = ''; 

                keys.forEach(lid => {
                    const req = requests[lid];
                    let paidEmis = req.total_emis_paid || 0;
                    let totalEmis = Object.keys(req.emis || {}).length;
                    let progressText = `${paidEmis} / ${totalEmis} EMIs Paid`;

                    listDiv.insertAdjacentHTML('afterbegin', renderActiveLoanItem(req, progressText));
                });

                if (keys.length === 0) {
                     listDiv.innerHTML = '<div class="card text-center">No active loans currently being tracked.</div>';
                }
                
                document.getElementById('count-active').innerText = keys.length;
            });
        }

        function renderActiveLoanItem(req, progressText) {
            return `
                <div class="request-item">
                    <div>
                        <div class="req-id">${req.id} (${req.user_id.substring(0, 8)}...)</div>
                        <div style="font-size:12px; opacity:0.7;">Amt: ₹${parseInt(req.approved_amount || 0).toLocaleString()} | ${progressText}</div>
                    </div>
                    <div>
                        <span class="req-status-badge bg-active">ACTIVE</span>
                        <button class="btn secondary" style="margin-left:10px; padding:5px 10px;" onclick="viewLoanHistory('${req.id}', '${req.user_id}')">View History</button>
                    </div>
                </div>
            `;
        }
        
        // **UPDATED viewLoanHistory**
        async function viewLoanHistory(lid, uid) {
            const snap = await db.ref('loan_requests/' + lid).once('value');
            const data = snap.val();

            if (!data || !data.emis) {
                return alert("EMI history not found for this loan.");
            }
            
            const userData = await fetchUserDetails(uid);
            
            // Populate Full User Details (NEW)
            document.getElementById('history-name').innerText = userData.name;
            document.getElementById('history-email').innerText = userData.email;
            document.getElementById('history-mobile').innerText = userData.mobile;
            document.getElementById('history-address').innerText = userData.address;


            const emis = Object.values(data.emis).sort((a, b) => a.num - b.num);
            
            const totalRepayment = data.total_repayment || 0;
            const paidCount = data.total_emis_paid || 0; 
            const outstanding = data.outstanding_balance || 0;
            const totalEmis = emis.length;

            // Populate Summary
            document.getElementById('history-lid').innerText = lid;
            document.getElementById('history-status').innerText = data.status.toUpperCase();
            document.getElementById('history-total-repay').innerText = '₹' + totalRepayment.toLocaleString();
            document.getElementById('history-emi-amt').innerText = '₹' + (data.emi_amount || 0).toLocaleString();
            document.getElementById('history-paid-count').innerText = `${paidCount} / ${totalEmis}`;
            document.getElementById('history-outstanding').innerText = '₹' + outstanding.toLocaleString();

            const today = new Date();
            const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime(); 
            
            // Populate EMI Table
            let tableHTML = `
                <table class="emi-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Paid At</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            emis.forEach(e => {
                let statusClass = '';
                let statusText = e.status.toUpperCase().replace('_', ' ');
                let paidAt = e.paid_at ? new Date(e.paid_at).toLocaleDateString() : 'N/A';
                
                if (e.status === 'paid') {
                    statusClass = 'bg-paid';
                } else if (e.status === 'payment_submitted') {
                    statusClass = 'bg-submitted';
                    statusText = 'PAYMENT SUBMITTED';
                } else if (e.status === 'pending' && e.due_date < startOfToday) {
                    statusClass = 'bg-overdue';
                    statusText = 'OVERDUE';
                } else {
                    statusClass = 'bg-pending';
                    statusText = 'PENDING';
                }
                
                const dueDate = e.due_date ? new Date(e.due_date).toLocaleDateString() : 'N/A';


                tableHTML += `
                    <tr>
                        <td>${e.num}</td>
                        <td>₹${(e.amount || 0).toLocaleString()}</td>
                        <td>${dueDate}</td>
                        <td><span class="${statusClass}" style="font-size:10px; font-weight:700;">${statusText}</span></td>
                        <td>${paidAt}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('emi-history-table-container').innerHTML = tableHTML;
            document.getElementById('history-modal').style.display = 'flex';
        }

        // --- 5. FULL HISTORY TAB ---

        function listenForAllHistory() {
            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = 'Loading all loans...';

            // Fetch all loan requests
            db.ref('loan_requests').on('value', async snap => {
                const requests = snap.val() || {};
                const keys = Object.keys(requests);
                
                if (keys.length === 0) {
                     listDiv.innerHTML = '<div class="card text-center">No loan history available.</div>';
                     document.getElementById('count-history').innerText = 0;
                     return;
                }

                listDiv.innerHTML = '';
                
                // Fetch user details for all loans concurrently
                const loanDataWithUsers = await Promise.all(keys.map(async lid => {
                    const req = requests[lid];
                    const userData = await fetchUserDetails(req.user_id);
                    return { ...req, userData, id: lid };
                }));

                // Sort by status (Active first, then Closed)
                loanDataWithUsers.sort((a, b) => {
                    if (a.status === 'active' && b.status !== 'active') return -1;
                    if (a.status !== 'active' && b.status === 'active') return 1;
                    return 0;
                });


                loanDataWithUsers.forEach(req => {
                    listDiv.insertAdjacentHTML('beforeend', renderAllHistoryItem(req));
                });
                
                document.getElementById('count-history').innerText = keys.length;
            });
        }

        function renderAllHistoryItem(req) {
            let statusClass = 'bg-closed'; 
            let statusText = req.status.toUpperCase();
            
            if (req.status === 'active') {
                statusClass = 'bg-active';
            } else if (req.status === 'rejected') {
                statusClass = 'bg-rejected';
            } else if (req.status === 'reviewed' || req.status === 'pending') {
                statusClass = 'bg-reviewed';
            }

            const amount = parseInt(req.approved_amount || req.amount_req || 0).toLocaleString();

             return `
                <div class="request-item">
                    <div>
                        <div class="req-id">${req.id}</div>
                        <div style="font-size:12px; opacity:0.7;">User: ${req.userData.name} (${req.userData.mobile}) | Amt: ₹${amount}</div>
                    </div>
                    <div>
                        <span class="req-status-badge ${statusClass}">${statusText}</span>
                        <button class="btn secondary" style="margin-left:10px; padding:5px 10px;" onclick="viewLoanHistory('${req.id}', '${req.user_id}')">View Details</button>
                    </div>
                </div>
            `;
        }

    </script>
</body>
</html>

